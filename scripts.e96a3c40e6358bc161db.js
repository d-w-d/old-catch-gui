var JS9,Module,$jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");e!=Array.prototype&&e!=Object.prototype&&(e[t]=a.value)},$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global?global:e},$jscomp.global=$jscomp.getGlobal(this),$jscomp.SYMBOL_PREFIX="jscomp_symbol_",$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){},$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)},$jscomp.symbolCounter_=0,$jscomp.Symbol=function(e){return $jscomp.SYMBOL_PREFIX+(e||"")+$jscomp.symbolCounter_++},$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator")),"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}}),$jscomp.initSymbolIterator=function(){}},$jscomp.arrayIterator=function(e){var t=0;return $jscomp.iteratorPrototype(function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}})},$jscomp.iteratorPrototype=function(e){return $jscomp.initSymbolIterator(),(e={next:e})[$jscomp.global.Symbol.iterator]=function(){return this},e},$jscomp.array=$jscomp.array||{},$jscomp.iteratorFromArray=function(e,t){$jscomp.initSymbolIterator(),e instanceof String&&(e+="");var a=0,i={next:function(){if(a<e.length){var s=a++;return{value:t(s,e[s]),done:!1}}return i.next=function(){return{done:!0,value:void 0}},i.next()}};return i[Symbol.iterator]=function(){return i},i},$jscomp.polyfill=function(e,t,a,i){if(t){for(a=$jscomp.global,e=e.split("."),i=0;i<e.length-1;i++){var s=e[i];s in a||(a[s]={}),a=a[s]}(t=t(i=a[e=e[e.length-1]]))!=i&&null!=t&&$jscomp.defineProperty(a,e,{configurable:!0,writable:!0,value:t})}},$jscomp.polyfill("Array.prototype.keys",function(e){return e||function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6-impl","es3"),$jscomp.polyfill("Math.asinh",function(e){return e||function(e){if(0===(e=Number(e)))return e;var t=Math.log(Math.abs(e)+Math.sqrt(e*e+1));return 0>e?-t:t}},"es6-impl","es3"),$jscomp.polyfill("Math.sinh",function(e){if(e)return e;var t=Math.exp;return function(e){return 0===(e=Number(e))?e:(t(e)-t(-e))/2}},"es6-impl","es3"),$jscomp.findInternal=function(e,t,a){e instanceof String&&(e=String(e));for(var i=e.length,s=0;s<i;s++){var r=e[s];if(t.call(a,r,s,e))return{i:s,v:r}}return{i:-1,v:void 0}},$jscomp.polyfill("Array.prototype.find",function(e){return e||function(e,t){return $jscomp.findInternal(this,e,t).v}},"es6-impl","es3"),$jscomp.polyfill("Array.prototype.fill",function(e){return e||function(e,t,a){var i=this.length||0;for(0>t&&(t=Math.max(0,i+t)),(null==a||a>i)&&(a=i),0>(a=Number(a))&&(a=Math.max(0,i+a)),t=Number(t||0);t<a;t++)this[t]=e;return this}},"es6-impl","es3"),$jscomp.polyfill("Math.log10",function(e){return e||function(e){return Math.log(e)/Math.LN10}},"es6-impl","es3"),"object"!=typeof Module&&(Module={}),JS9=function(){var e={NAME:"JS9",VERSION:"2.3",COPYRIGHT:"Copyright (c) 2012-2019 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",WORKERFILE:"js9worker.js",ZINDEX:0,SHAPEZINDEX:4,MESSZINDEX:80,BTNZINDEX:90,MENUZINDEX:1e3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK:300,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,RESIZEFUDGE:5,RAWID0:"raw0",RAWIDX:"alt",IDFMT:"  (%s)",MINZOOM:.125,MAXZOOM:32,ADDZOOM:.1,CHROMEFILEWARNING:!0,CLIPBOARDERROR:"the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?",CLIPBOARDERROR2:"the local clipboard (which only holds data copied from within JS9) does not contain any regions",URLEXP:/^(https?|ftp):\/\//};return e.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints,e.BROWSER=function(){var e,t=navigator.platform,a=navigator.appName,i=navigator.userAgent,s=i.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return e=i.match(/version\/([\.\d]+)/i),s&&null!==e&&(s[2]=e[1]),(s=s?[s[1],s[2],t]:[a,navigator.appVersion,"-?",t]).push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(i)),s}(),e.PIXEL_RATIO=function(){var e=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1)}(),e.globalOpts={helperType:"none",helperPort:2718,requireHelper:!1,allinoneHelper:!1,requireFits2Fits:!1,quietReturn:!1,useWasm:!0,allowFileWasm:!1,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2fits:"never",fits2png:!1,prependJS9Dir:!0,dataDir:null,alerts:!0,valposTarget:null,valposWidth:"medium",internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,wcsCrosshair:!1,regionsToClipboard:!0,magnifierRegions:!0,pannerDirections:!0,htimeout:1e4,lhtimeout:1e4,ehtimeout:5e3,ehretries:10,xtimeout:18e4,extlist:"EVENTS STDEVT",imopts:"IMOPTS",imcmap:"IMCMAP",table:{xdim:4096,ydim:4096,bin:1},image:{xdim:4096,ydim:4096,bin:1},reproj:{xdim:4096,ydim:4096},reprojSwitches:"",binMode:"s",clearImageMemory:"heap",helperProtocol:location.protocol,reloadRefresh:!1,reloadRefreshReg:!0,panWithinDisplay:!1,svgBorder:!0,unremoveReg:100,maxMemory:75e7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,imsectionURL:"params/imsection.html",postMessage:!1,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,cloneNewDisplay:!0,logoDisplay:!1,lightWinClose:"ask",regionDisplay:"lightwin",regionConfigSize:"medium",refreshDragDrop:!0,reduceMosaic:"js9",reduceRegcnts:!0,plot3d:{cube:"*:*:all",mode:"avg",areaunits:"pixels",color:"green"},imexamLineHeight:1,copyWcsPosFormat:"$ra $dec $sys",floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{b:"toggle selected region: source/background",c:"toggle crosshair",d:"send selected region to back",e:"toggle selected region: include/exclude","M-e":"edit selected region",i:"refresh image",I:"display full image","M-i":"display selected cutouts","M-k":"toggle keyboard actions plugin",l:"toggle active shape layers","M-l":"new JS9 light window","M-m":"toggle mouse/touch plugin","M-o":"open local file",P:"paste regions from local clipboard",p:"paste regions to current position",u:"undo remove of region(s)","M-,":"toggle preferences plugin","M-p":"toggle preferences plugin",r:"copy selected region to clipboard",R:"copy all regions to clipboard",s:"select region",S:"select all regions","M-s":"toggle shape layers plugin","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom","=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",">":"display next image","<":"display previous image",delete:"remove selected region",leftArrow:"move region/position left",upArrow:"move region/position up",rightArrow:"move region/position right",downArrow:"move region/position down"},mousetouchZoom:!0,toolbarTooltips:!1,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,dynamicSelect:"click",dynamicHighlight:!0,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$xreg.data.ra $xreg.data.dec"},topColormaps:"grey heat cool viridis magma sls red green blue".split(" "),infoBox:"file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),infoBoxResize:!0,menuBar:"file edit view zoom scale color region wcs analysis help".split(" "),menubarStyle:"classic",userMenus:!1,userMenuDivider:"&nbsp;&nbsp;&nbsp;",imagesFileSubmenu:5,toolBar:"annulus box circle ellipse line polygon text linear log zoom+ zoom- zoom1".split(" "),syncOps:"colormap contrastbias pan regions scale wcs zoom".split(" "),syncReciprocate:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz",wcsUnits:{FK4:"sexagesimal",FK5:"sexagesimal",ICRS:"sexagesimal",galactic:"degrees",ecliptic:"degrees",linear:"degrees",physical:"pixels",image:"pixels"},regionTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",localTemplates:".fits,.fts",controlsMatchRegion:!1,internalColorPicker:!0,newWindowWidth:530,newWindowHeight:625,debug:0},e.desktopOpts={currentPath:!0,sessionPath:!0},e.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,exp:1e3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",scalemin:Number.NaN,scalemax:Number.NaN,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!0,listonchange:!1,whichonchange:"selected"},e.regionOpts={},e.catalogOpts={},e.crosshairOpts={},e.gridOpts={},e.emscriptenOpts={},e.blendOpts={active:!0,mode:"screen",opacity:1},e.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"},e.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",lcloseWin:"width=512px,height=190px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=235px,center=1,resize=1,scrolling=1",regWin0:"width=600px,height=72px,center=1,resize=1,scrolling=1",regWin:"width=600px,height=235px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=598px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"},lcloseURL:"params/lightclose.html"},e.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"},e.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0}},e.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},desktop:{heading:"JS9Help",type:"help",url:"desktop.html",title:"JS9 on the Desktop"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},archives:{heading:"JS9Help",type:"help",url:"archives.html",title:"Accessing Data Archives"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}},e.images=[],e.displays=[],e.colormaps=[],e.commands=[],e.plugins=[],e.preloads=[],e.auxFiles=[],e.supermenus=[],e.publics={},e.helper={},e.fits={},e.userOpts={},e.preloadwaiting={},e.scales="linear log histeq power sqrt squared asinh sinh".split(" "),e.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" "),e.wcsunitss=["degrees","sexagesimal","pixels"],e.bugs={},e.bugs.hide_menu=!1,"Firefox"===e.BROWSER[0]&&0<=e.BROWSER[2].search(/Linux/)&&(e.bugs.firefox_linux=!0),"Chrome"!==e.BROWSER[0]&&"Safari"!==e.BROWSER[0]||(e.bugs.webkit_resize=!0),"Chrome"!==e.BROWSER[0]&&(e.globalOpts.imageTemplates+=",.gz"),/iPad|iPhone|iPod/.test(navigator.platform)&&/11_2_(?:[2-9])/.test(navigator.userAgent)&&(e.globalOpts.useWasm=!1),e.BROWSER[3]&&(e.globalOpts.maxMemory=Math.min(e.globalOpts.maxMemory,35e7),e.globalOpts.table.xdim=2048,e.globalOpts.table.ydim=2048,e.globalOpts.image.xdim=2048,e.globalOpts.image.ydim=2048,e.imageOpts.crosshair=!1,e.globalOpts.reproj={xdim:2048,ydim:2048}),window.hasOwnProperty("Jupyter")&&(e.globalOpts.useWasm=!1),window.isElectron&&("Chrome"===e.BROWSER[0]&&66<=parseFloat(e.BROWSER[1])&&(e.globalOpts.allowFileWasm=!0),(!window.electronVersion||5>parseInt(window.electronVersion,10))&&(e.globalOpts.internalColorPicker=!1),e.hasNode="object"==typeof process&&"function"==typeof require,e.hasNode&&(e.localMount=require("os").hostname())),e.Image=function(t,a,i){var s,r,n,o=this,l=null,c=0,p=0,d=function(t){e.isNull((t=t||{}).scaleclipping)?"zscale"===this.params.scaleclipping?this.zscale(!0):"zmax"===this.params.scaleclipping&&this.zscale("zmax"):"zscale"===t.scaleclipping?this.zscale(!0):"zmax"===t.scaleclipping&&this.zscale("zmax"),e.notNull(t.scalemin)&&(this.params.scalemin=t.scalemin),e.notNull(t.scalemax)&&(this.params.scalemax=t.scalemax)},h=function(t){var a,i,s,r,n,o=e.globalOpts.imopts,c=e.globalOpts.imcmap;if(this.display.clearMessage(),e.images.push(this),this.notifyHelper(),l&&l.regions&&this.addShapes("regions",l.regions),n=e.globalOpts.alerts,e.globalOpts.alerts=!1,this.raw&&this.raw.header&&this.raw.header[c]){try{s=JSON.parse(this.raw.header[c])}catch(p){s=null}if(s)try{e.AddColormap(s)}catch(p){}}if(this.raw&&this.raw.header&&this.raw.header[c+"1"]){for(a=1,i="";100>a&&(r=c+String(a),this.raw.header[r]);a++)i+=this.raw.header[r];if(i){try{s=JSON.parse(i)}catch(p){s=null}if(s)try{e.AddColormap(s)}catch(p){}}}if(this.raw&&this.raw.header&&this.raw.header[o]){try{s=JSON.parse(this.raw.header[o])}catch(p){s=null}if(s)try{this.setParam("all",s)}catch(p){}}if(this.raw&&this.raw.header&&this.raw.header[o+"1"]){for(a=1,i="";100>a&&(r=o+String(a),this.raw.header[r]);a++)i+=this.raw.header[r];if(i){try{s=JSON.parse(i)}catch(p){s=null}if(s)try{this.setParam("all",s)}catch(p){}}}if(e.globalOpts.alerts=n,this.xeqPlugins("image","onimageload"),this.updateshapes&&this.updateShapes("regions","all","update"),this.status.load="complete",e.waiting(!1),t)try{e.xeqByName(t,window,this)}catch(p){e.error("in image onload callback",p,!1)}if(t=(i=this.proxyURL||this.file).replace(/\[.*\]/,""),(e.preloadwaiting[i]||e.preloadwaiting[t])&&(delete e.preloadwaiting[i],delete e.preloadwaiting[t],!Object.keys(e.preloadwaiting).length&&e.notNull(e.globalOpts.onpreload)))try{e.xeqByName(e.globalOpts.onpreload,window,this)}catch(p){e.error("in onpreload callback",p,!1)}};if(a&&("object"==typeof a?(l=a).display&&(s=l.display):s=a),s||(s=0<e.displays.length?e.displays[0].id:e.DEFID),this.type="image",this.display=e.lookupDisplay(s),this.params={},this.regstack=[],this.tmp={},this.params.xeqonchange=!0,this.params=$.extend(!0,this.params,e.imageOpts,l),this.display.image&&(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params))),a=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setColormap(this.params.colormap),e.globalOpts.xeqPlugins=a,this.displayMode=!0,this.clickState=0,this.clickInRegion=!1,this.clickInLayer=null,this.queried=!1,l&&l.proxyFile&&(this.proxyFile=l.proxyFile),l&&l.proxyURL&&(this.proxyURL=l.proxyURL),l&&l.parentFile&&(this.parentFile=l.parentFile),l&&l.parent&&(this.parent=l.parent,this.parent.cardstr&&this.parent.ncard)){for(this.parent.raw={header:{},history:[],comments:[]},a=0;a<this.parent.ncard;a++)s=this.parent.cardstr.slice(80*a,80*(a+1)),void 0!==(s=e.cardpars(s))&&("HISTORY"===s[0]?this.parent.raw.header[s[0]+"__"+c++]=s[1]:"COMMENT"===s[0]?this.parent.raw.header[s[0]+"__"+p++]=s[1]:this.parent.raw.header[s[0]]=s[1]);this.parent.lcs={},e.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}if(l&&l.id&&(this.id=l.id),this.iy=this.ix=0,this.png={},this.png.image=new Image,this.status={},this.rgb={},this.rgb.sect={zoom:1,ozoom:1},this.layers={},this.zlayer=e.SHAPEZINDEX,this.lcs={},this.aux={},this.binning={bin:1,obin:1},this.raws=[],this.blend=$.extend(!0,{},e.blendOpts),this.updateshapes=!1,t)switch(e.waiting(!0,this.display),typeof t){case"object":this.source=l.source||"fits",this.mkRawDataFromHDU(t,$.extend({},{file:t.filename},l)),d.call(this,l),this.params.zoom&&(n=this.parseZoom(this.params.zoom),this.rgb.sect.zoom=n,this.rgb.sect.ozoom=n),this.mkSection(),l&&l.rgbFile?(this.rgbFile=l.rgbFile,$(this.png.image).on("load",function(){var t;o.png.image.width===o.raw.width&&o.png.image.height===o.raw.height||(t=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",o.png.image.width,o.png.image.height,o.raw.width,o.raw.height),e.error(t)),o.mkOffScreenCanvas(),o.displayImage("all",l),h.call(o,i)}).on("error",function(){e.waiting(!1),o.status.load="error",e.error("could not load image: "+o.id)}),this.png.image.src=this.rgbFile):(this.displayImage("all",l),h.call(this,i));break;case"string":this.source=l.source||"fits2png",this.imtab="image",this.file=e.cleanPath(t),this.id0=this.file.split("/").reverse()[0],this.id=e.getImageID(this.id0,this.display.id),this.status.load="loading",$(this.png.image).on("load",function(){o.mkOffScreenCanvas(),o.mkRawDataFromPNG(),o.params.zoom&&(n=o.parseZoom(o.params.zoom),o.rgb.sect.zoom=n,o.rgb.sect.ozoom=n),d.call(o,l),o.mkSection(),(r=(function(t){var a=1,i=[];return e.notNull((t=t||{}).bin)&&(a="string"==typeof t.bin?parseInt(t.bin,10):t.bin),e.notNull(t.xcen)&&i.push(t.xcen/a),e.notNull(t.ycen)&&i.push(t.ycen/a),e.notNull(t.zoom)&&(t=this.parseZoom(t.zoom))&&i.push(t),i}).call(l)).length&&o.mkSection.apply(o,r),o.displayImage("all",l),h.call(o,i),e.DEBUG&&e.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",o.file,o.raw.width,o.raw.height,o.raw.dmin,o.raw.dmax)}).on("error",function(){e.waiting(!1),o.status.load="error",e.error("could not load image: "+o.id)}),this.png.image.src=t;break;default:e.log("unknown specification type for Load: "+typeof t)}},e.Image.prototype.getImageData=function(e){var t=null;if(e)if("array"===e)t=Array.prototype.slice.call(this.raw.data);else if("base64"===e){e="";var a=new Uint8Array(this.raw.data.buffer),i=a.byteLength;for(t=0;t<i;t++)e+=String.fromCharCode(a[t]);t=window.btoa(e)}else e&&"false"!==e&&(t=this.raw.data);return e=this.fileDimensions(),{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,fwidth:e.xdim,fheight:e.ydim,dwidth:this.display.width,dheight:this.display.height,data:t}},e.Image.prototype.closeImage=function(t){var a,i,s,r,n=!1;if(i=e.images.length,"string"==typeof(t=t||{}))try{t=JSON.parse(t)}catch(o){e.error("can't parse closeImage opts: "+t,o)}for(r=e.Dysel.getDisplayOr(this.display),a=0;a<i;a++)if(this===e.images[a]){if((i=e.images[a])===i.display.image&&(n=a+1),n)for(s in!1!==t.clear&&(i.display.clearMessage(),i.display.context.clear()),i.layers)i.layers.hasOwnProperty(s)&&("main"!==i.layers[s].dlayer.dtype&&i.display!==r||i.showShapeLayer(s,!1,{local:!0}));switch(i.xeqPlugins("image","onimageclose"),n&&(i.display.image=null),i.cmapObj.name){case"red":e.globalOpts.rgb.rim=null;break;case"green":e.globalOpts.rgb.gim=null;break;case"blue":e.globalOpts.rgb.bim=null}for(t=0;t<i.raws.length;t++)(s=i.raws[t]).hdu&&s.hdu.fits&&1>=(r=e.lookupVfile(s.hdu.fits.vfile)).length&&e.cleanupFITSFile(s,!0),s.altwcs&&this.freeWCS(s);i.removeProxyFile(),i.rgb=null,i.offscreen=null,i.raw=null,i.colorData=null,i.colorCells=null,i.psColors=null,i.psInverse=null,e.images.splice(a,1);break}if(n){for(a=n-=2;0<=a;a--)if(this.display===(i=e.images[a]).display){i.displayImage("all"),i.refreshLayers(),n=e.images.length;break}for(a=e.images.length-1;a>n;a--)if(this.display===(i=e.images[a]).display){i.displayImage("all"),i.refreshLayers();break}}},e.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={},this.offscreen.canvas=document.createElement("canvas"),this.offscreen.canvas.setAttribute("width",this.png.image.width),this.offscreen.canvas.setAttribute("height",this.png.image.height),this.offscreen.context=this.offscreen.canvas.getContext("2d"),e.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=!1),this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(t){e.CHROMEFILEWARNING&&"Chrome"===e.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this},e.Image.prototype.initLCS=function(t){var a,i,s=[[0,0,0],[0,0,0],[0,0,0]],r=(t=t||this.raw.header).CRPIX1||1,n=t.CRPIX2||1,o=-(t.CROTA2||0)*Math.PI/180,l=Math.sin(o),c=Math.cos(o);return o&&((i=[[0,0,0],[0,0,0],[0,0,0]])[0][0]=c,i[0][1]=-l,i[0][2]=0,i[1][0]=l,i[1][1]=c,i[1][2]=0,(a=e.invertMatrix3(i))||(i=null)),s[0][0]=t.LTM1_1||1,s[1][0]=t.LTM2_1||0,s[0][1]=t.LTM1_2||0,s[1][1]=t.LTM2_2||1,s[2][0]=t.LTV1||0,s[2][1]=t.LTV2||0,"image"===this.imtab&&this.params.ltvbug&&(void 0!==t.LTV1&&1>s[0][0]&&(s[2][0]+=.5*s[0][0]),void 0!==t.LTV2&&1>s[1][1]&&(s[2][1]+=.5*s[1][1])),this.lcs.physical={forward:$.extend(!0,[],s),reverse:e.invertMatrix3(s)},this.lcs.physical.reverse?i&&(this.lcs.physical.frot=$.extend(!0,[],i),this.lcs.physical.rrot=$.extend(!0,[],a),this.lcs.physical.cx=r-s[2][0]-1,this.lcs.physical.cy=n-s[2][1]-1):delete this.lcs.physical,s[0][0]=t.DTM1_1||1,s[1][0]=t.DTM2_1||0,s[0][1]=t.DTM1_2||0,s[1][1]=t.DTM2_2||1,s[2][0]=t.DTV1||0,s[2][1]=t.DTV2||0,this.lcs.detector={forward:$.extend(!0,[],s),reverse:e.invertMatrix3(s)},this.lcs.detector.reverse?i&&(this.lcs.detector.frot=$.extend(!0,[],i),this.lcs.detector.rrot=$.extend(!0,[],a),this.lcs.detector.cx=r-s[2][0]-1,this.lcs.detector.cy=n-s[2][1]-1):delete this.lcs.detector,s[0][0]=t.ATM1_1||1,s[1][0]=t.ATM2_1||0,s[0][1]=t.ATM1_2||0,s[1][1]=t.ATM2_2||1,s[2][0]=t.ATV1||0,s[2][1]=t.ATV2||0,this.lcs.amplifier={forward:$.extend(!0,[],s),reverse:e.invertMatrix3(s)},this.lcs.amplifier.reverse?i&&(this.lcs.amplifier.frot=$.extend(!0,[],i),this.lcs.amplifier.rrot=$.extend(!0,[],a),this.lcs.amplifier.cx=r-s[2][0]-1,this.lcs.amplifier.cy=n-s[2][1]-1):delete this.lcs.amplifier,this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image"),this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs),this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical)),this},e.Image.prototype.mkRawDataFromIMG=function(t){var a,i,s,r,n;if(t){for(a=t.height,i=t.width,s=t.data,this.raws.push({from:"img"}),this.raw=this.raws[this.raws.length-1],this.raw.id=e.RAWID0,this.raw.data=new Float32Array(a*i),n=t=0;n<a;n++)for(r=0;r<i;r++)this.raw.data[(a-n)*i+r]=.299*s[t]+.587*s[t+1]+.114*s[t+2],t+=4;return this.raw.width=i,this.raw.height=a,this.raw.bitpix=-32,e.Image.prototype.dataminmax.call(this),this.source="png",this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix},this.initWCS(),this.initLCS(),this.xeqPlugins("image","onrawdata"),this}},e.Image.prototype.mkRawDataFromPNG=function(){var t,a,i,s,r,n,o,l,c,p=[];n=r=0,i=new ArrayBuffer(8);var d=new Uint8Array(i),h=new DataView(i);if(!this.offscreen.img)return this;for(this.raws.push({from:"png"}),this.raw=this.raws[this.raws.length-1],this.raw.id=e.RAWID0,s=this.offscreen.img.data,t=i=0;i<s.length&&0!==s[i];i++)if(255!==s[i]&&(p[t]=String.fromCharCode(s[i]),t++),15===t&&'{"js9Protocol":'!==p.join("")){c=!0;break}if(!(15>t||c)){t=p.join(""),2<e.DEBUG&&e.log("jsonHeader: %s",t);try{a=JSON.parse(t)}catch(g){e.error("can't read FITS header from PNG file: "+t,g)}if(1===a.js9Protocol)this.raw.header=a,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=a.js9Endian,this.raw.protocol=a.js9Protocol,this.raw.cardstr=a.cardstr,this.raw.ncard=a.ncard,this.raw.header={},a=this.raw.ncard,t=0;t<a;t++)c=this.raw.cardstr.slice(80*t,80*(t+1)),void 0!==(c=e.cardpars(c))&&("HISTORY"===c[0]?this.raw.header[c[0]+"__"+r++]=c[1]:"COMMENT"===c[0]?this.raw.header[c[0]+"__"+n++]=c[1]:this.raw.header[c[0]]=c[1]);switch(i+=1,this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:e.error("NAXIS1 missing from PNG-based FITS header"),this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:e.error("NAXIS2 missing from PNG-based FITS header"),this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:e.error("BITPIX missing from PNG-based FITS header"),"little"===this.raw.endian?l=!0:"big"===this.raw.endian?l=!1:e.error("js9Endian missing from PNG-based FITS header"),this.object=this.raw.header.OBJECT,this.telescope=this.raw.header.TELESCOP,this.instrument=this.raw.header.INSTRUME,r=this.raw.width*this.raw.height,n=i%4,this.raw.bitpix){case 8:for(this.raw.data=new Uint8Array(r),t=0;t<r;t++){switch(n){case 0:o=s[i],i+=1,n=1;break;case 1:o=s[i],i+=1,n=2;break;case 2:o=s[i],i+=2,n=0;break;case 3:o=s[i+1],i+=2,n=1}this.raw.data[t]=o}break;case 16:case-16:for(16===this.raw.bitpix?(this.raw.data=new Int16Array(r),a=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(r),a=DataView.prototype.getUint16),t=0;t<r;t++){switch(n){case 0:d[0]=s[i],d[1]=s[i+1],o=a.call(h,0,l),i+=2,n=2;break;case 1:d[0]=s[i],d[1]=s[i+1],o=a.call(h,0,l),i+=3,n=0;break;case 2:d[0]=s[i],d[1]=s[i+2],o=a.call(h,0,l),i+=3,n=1;break;case 3:d[0]=s[i+1],d[1]=s[i+2],o=a.call(h,0,l),i+=3,n=2}this.raw.data[t]=o}break;case 32:case-32:for(32===this.raw.bitpix?(this.raw.data=new Int32Array(r),a=DataView.prototype.getInt32):(this.raw.data=new Float32Array(r),a=DataView.prototype.getFloat32),t=0;t<r;t++){switch(n){case 0:d[0]=s[i],d[1]=s[i+1],d[2]=s[i+2],d[3]=s[i+4],o=a.call(h,0,l),i+=5,n=1;break;case 1:d[0]=s[i],d[1]=s[i+1],d[2]=s[i+3],d[3]=s[i+4],o=a.call(h,0,l),i+=5,n=2;break;case 2:d[0]=s[i],d[1]=s[i+2],d[2]=s[i+3],d[3]=s[i+4],o=a.call(h,0,l),i+=6,n=0;break;case 3:d[0]=s[i+1],d[1]=s[i+2],d[2]=s[i+3],d[3]=s[i+5],o=a.call(h,0,l),i+=6,n=1}this.raw.data[t]=o}break;case-64:for(this.raw.data=new Float64Array(r),t=0;t<r;t++){switch(n){case 0:case 4:d[0]=s[i],d[1]=s[i+1],d[2]=s[i+2],d[3]=s[i+4],d[4]=s[i+5],d[5]=s[i+6],d[6]=s[i+8],d[7]=s[i+9],o=h.getFloat64(0,l),i+=10,n=2;break;case 1:case 5:d[0]=s[i],d[1]=s[i+1],d[2]=s[i+3],d[3]=s[i+4],d[4]=s[i+5],d[5]=s[i+7],d[6]=s[i+8],d[7]=s[i+9],o=h.getFloat64(0,l),i+=11,n=0;break;case 2:case 6:d[0]=s[i],d[1]=s[i+2],d[2]=s[i+3],d[3]=s[i+4],d[4]=s[i+6],d[5]=s[i+7],d[6]=s[i+8],d[7]=s[i+10],o=h.getFloat64(0,l),i+=11,n=1;break;case 3:case 7:d[0]=s[i+1],d[1]=s[i+2],d[2]=s[i+3],d[3]=s[i+5],d[4]=s[i+6],d[5]=s[i+7],d[6]=s[i+9],d[7]=s[i+10],o=h.getFloat64(0,l),i+=11,n=2}this.raw.data[t]=o}break;default:e.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}return this.dataminmax(),this.offscreen.img=null,this.initWCS(),this.initLCS(),this.xeqPlugins("image","onrawdata"),this}e.Image.prototype.mkRawDataFromIMG.call(this,this.offscreen.img)},e.Image.prototype.mkRawDataFromHDU=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m,f,y=this;if(h=d=0,a=a||{},$.isArray(t)||e.isTypedArray(t)||t instanceof ArrayBuffer?($.isArray(t[0])&&(t=t.reduce(function(e,t){return e.concat(t)})),n={image:t}):"object"==typeof t?n=t:e.error("unknown or missing input for HDU creation"),n.data&&!n.image&&(n.image=n.data),n.image||e.error("data missing from JS9 FITS object"+JSON.stringify(n)),2>n.naxis&&e.error("can't image a FITS file with less than 2 dimensions"),this.raw&&(l=this.raw,g=this.raw.width,u=this.raw.height,m=this.raw.bitpix,c=this.raw.header.LTM1_1||1,p=this.params.wcssys,f=this.params.wcsunits,this.freeWCS()),this.raws=this.raws||[],o=this.raws.length){for(a.rawid=a.rawid||e.RAWIDX,i=r=0;i<o;i++)if(a.rawid===this.raws[i].id){this.raws[i]={from:s=this.raws[i].from,id:a.rawid},this.raw=this.raws[i],r++;break}r||(this.raws.push({from:"hdu",id:a.rawid}),this.raw=this.raws[o],l=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[o],this.raw.id=e.RAWID0;if(this.raw.hdu=n,n.axis?(this.raw.width=n.axis[1],this.raw.height=n.axis[2]):n.naxis1&&n.naxis2?(this.raw.width=n.naxis1,this.raw.height=n.naxis2):g&&u&&(this.raw.width=g,this.raw.height=u),n.bitpix?this.raw.bitpix=n.bitpix:m&&(this.raw.bitpix=m),"base64"===n.encoding)for(s=window.atob(n.image),n.image=new ArrayBuffer(s.length),r=new Uint8Array(n.image),i=0;i<s.length;i++)r[i]=s.charCodeAt(i);switch($.isArray(n.image[0])&&(n.image=n.image.reduce(function(e,t){return e.concat(t)})),this.raw.bitpix){case 8:this.raw.data=new Uint8Array(n.image);break;case 16:this.raw.data=new Int16Array(n.image);break;case-16:this.raw.data=new Uint16Array(n.image);break;case 32:this.raw.data=new Int32Array(n.image);break;case-32:this.raw.data=new Float32Array(n.image);break;case-64:this.raw.data=new Float64Array(n.image)}if(this.raw.card=n.card,this.raw.cardstr=n.cardstr,this.raw.ncard=n.ncard,n.head)this.raw.header=n.head;else if(this.raw.card)for(this.raw.header={},r=this.raw.card.length,i=0;i<r;i++)void 0!==(o=e.cardpars(this.raw.card[i]))&&("HISTORY"===o[0]?this.raw.header[o[0]+"__"+d++]=o[1]:"COMMENT"===o[0]?this.raw.header[o[0]+"__"+h++]=o[1]:this.raw.header[o[0]]=o[1]);else if(this.raw.cardstr)for(this.raw.header={},r=this.raw.ncard,i=0;i<r;i++)o=this.raw.cardstr.slice(80*i,80*(i+1)),void 0!==(o=e.cardpars(o))&&("HISTORY"===o[0]?this.raw.header[o[0]+"__"+d++]=o[1]:"COMMENT"===o[0]?this.raw.header[o[0]+"__"+h++]=o[1]:this.raw.header[o[0]]=o[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;i=this.raw.header,l||this.parentFile||this.parent||void 0===i.LTV1&&void 0===i.LTV2&&void 0===i.LTM1_1&&void 0===i.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},i)},this.parent.lcs={},e.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)),("image"===n.imtab&&void 0!==n.x1&&1!==n.x1||void 0!==n.y1&&1!==n.y1||void 0===n.bin||1!==n.bin)&&(r=n.bin||1,d=void 0!==n.x1?n.x1:0,h=void 0!==n.y1?n.y1:0,void 0!==i.CRPIX1&&(i.CRPIX1=(i.CRPIX1-d)/r+.5),void 0!==i.CRPIX2&&(i.CRPIX2=(i.CRPIX2-h)/r+.5),void 0!==i.CDELT1&&(i.CDELT1*=r),void 0!==i.CDELT2&&(i.CDELT2*=r),void 0!==i.CD1_1&&(i.CD1_1*=r),void 0!==i.CD1_2&&(i.CD1_2*=r),void 0!==i.CD2_1&&(i.CD2_1*=r),void 0!==i.CD2_2&&(i.CD2_2*=r),i.LTM1_1=i.LTM1_1||1,i.LTM1_1/=r,i.LTM2_1=i.LTM2_1||0,i.LTM2_1/=r,i.LTM1_2=i.LTM1_2||0,i.LTM1_2/=r,i.LTM2_2=i.LTM2_2||1,i.LTM2_2/=r,i.LTV1=i.LTV1||0,i.LTV1=(i.LTV1-d)/r+.5,i.LTV2=i.LTV2||0,i.LTV2=(i.LTV2-h)/r+.5),a.file&&a.file!==this.file?(this.file=a.file,this.id=null):a.filename&&a.filename!==this.file?(this.file=a.filename,this.id=null):n.filename&&n.filename!==this.file&&(this.file=n.filename,this.id=null),this.file0=this.file=this.file||e.ANON+e.uniqueID(),a.id&&(this.id0=a.id,this.id=e.getImageID(a.id,this.display.id,this)),this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(a.extname||a.extnum?(a.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",a.extname)):a.extnum&&0<a.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",a.extnum)),n&&n.fits&&(a.extname&&(n.fits.extname=a.extname),a.extnum&&0<a.extnum&&(n.fits.extnum=a.extnum))):n.fits?n.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",n.fits.extname)):n.fits.extnum&&0<n.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",n.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME))),this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=e.getImageID(this.id0,this.display.id,this)),a.proxyFile&&(this.proxyFile=a.proxyFile),this.raw.filter=a.filter||"",this.imtab=n.imtab?n.imtab:n.table?"table":"image",this.raw.imtab=this.imtab,void 0!==n.dmin&&void 0!==n.dmax?this.dataminmax(n.dmin,n.dmax):this.dataminmax(),this.object=this.raw.header.OBJECT,this.telescope=this.raw.header.TELESCOP,this.instrument=this.raw.header.INSTRUME,this.binning.bin="table"===this.imtab&&n.table?n.table.bin||1:n.bin?n.bin:1,a.ltm2obin&&i.LTM1_1?this.binning.obin=i.LTM1_1/c:l||(this.binning.obin=this.binning.bin),this.initWCS(),p&&this.setWCSSys(p),f&&this.setWCSUnits(f),this.initLCS();try{a.hdus?y.hdus=a.hdus:this.parentFile&&e.helper.connected&&e.helper.js9helper?(t={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},e.helper.send("listhdus",t,function(e){e.stderr||e.errcode||!e.stdout||(y.hdus=JSON.parse(e.stdout))})):this.raw&&this.raw.hdu&&this.raw.hdu.fits&&(s=e.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(s))}catch(b){}if(this.raw.hdu.fits&&this.raw.hdu.fits.vfile){for(s=!1===(s=e.globalOpts.clearImageMemory)?["never"]:!0===s?["always"]:s.toLowerCase().split(/[,>]/),p=l=!1,i=0,c=!1;i<s.length&&!c;i++)switch(s[i]){case"never":l=!1,c=!0;break;case"always":c=l=!0;break;case"heap":p=!0;break;case"auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?l=!0:(l=!1,c=!0);break;case"nocube":2>=this.raw.header.NAXIS?l=!0:(l=!1,c=!0);break;case"noext":this.hdus&&1!==this.hdus.length?(l=!1,c=!0):l=!0;break;case"size":s[i+1]&&e.vsize(n.fits.vfile)>1e6*s[i+1]?l=!0:(l=!1,c=!0)}l?(2<e.DEBUG&&e.log("removing underlying FITS vfile for %s: %s",this.id,this.raw.hdu.fits.vfile),e.cleanupFITSFile(this.raw,!0)):p&&this.raw.hdu.fits.heap&&(2<e.DEBUG&&e.log("freeing heap space for %s: %s",this.id,this.raw.hdu.fits.vfile),e.vfree(this.raw.hdu.fits.heap),this.raw.hdu.fits.heap=null)}return this.xeqPlugins("image","onrawdata"),this},e.Image.prototype.mkSection=function(t,a,i){var s,r=this.rgb.sect;switch(r.ozoom=r.zoom,arguments.length){case 0:r.xcen=Math.floor(this.raw.width/2),r.ycen=Math.floor(this.raw.height/2),r.width=Math.min(this.raw.width,this.display.canvas.width),r.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:e.isNumber(t)||e.error("invalid input for generating section"),r.zoom=parseFloat(t),r.width=Math.min(this.raw.width*r.zoom,this.display.canvas.width),r.height=Math.min(this.raw.height*r.zoom,this.display.canvas.height);break;case 2:e.isNumber(t)&&e.isNumber(a)||e.error("invalid input for generating section"),r.xcen=parseFloat(t),r.ycen=parseFloat(a),e.notNull(r.ix)&&(r.width=Math.min(this.raw.width*r.zoom,this.display.canvas.width)),e.notNull(r.iy)&&(r.height=Math.min(this.raw.height*r.zoom,this.display.canvas.height));break;case 3:e.isNumber(t)&&e.isNumber(a)&&e.isNumber(i)||e.error("invalid input for generating section"),r.xcen=parseFloat(t),r.ycen=parseFloat(a),r.zoom=parseFloat(i),r.width=Math.min(this.raw.width*r.zoom,this.display.canvas.width),r.height=Math.min(this.raw.height*r.zoom,this.display.canvas.height)}return delete r.ix,delete r.iy,r.width=Math.floor(r.width),r.height=Math.floor(r.height),r.x0=Math.floor(r.xcen-r.width/(2*r.zoom)),r.y0=Math.floor(r.ycen-r.height/(2*r.zoom)),r.x1=Math.floor(r.xcen+r.width/(2*r.zoom)),r.y1=Math.floor(r.ycen+r.height/(2*r.zoom)),0>r.x0&&(e.globalOpts.panWithinDisplay?r.x1-=r.x0:r.ix=r.x0*r.zoom,r.x0=0),0>r.y0&&(e.globalOpts.panWithinDisplay?r.y1-=r.y0:r.iy=r.y0*r.zoom,r.y0=0),r.x1>this.raw.width&&(e.globalOpts.panWithinDisplay?r.x0-=r.x1-this.raw.width:r.ix=(r.x1-this.raw.width)*r.zoom,r.x1=this.raw.width),r.y1>this.raw.height&&(e.globalOpts.panWithinDisplay?r.y0-=r.y1-this.raw.height:r.iy=(r.y1-this.raw.height)*r.zoom,r.y1=this.raw.height),r.ix&&1>r.zoom&&(0<r.x0&&(r.x0-=s=r.x0,r.ix+=s*r.zoom),r.x1<this.raw.width&&(r.x1+=s=this.raw.height-r.x1,r.ix-=s*r.zoom)),r.iy&&1>r.zoom&&(0<r.y0&&(r.y0-=s=r.y0,r.iy+=s*r.zoom),r.y1<this.raw.height&&(r.y1+=s=this.raw.height-r.y1,r.iy-=s*r.zoom)),r.x0=Math.max(0,r.x0),r.x1=Math.min(this.raw.width,r.x1),r.y0=Math.max(0,r.y0),r.y1=Math.min(this.raw.height,r.y1),r.width=Math.ceil((r.x1-r.x0)*r.zoom),r.height=Math.ceil((r.y1-r.y0)*r.zoom),this.offscreenRGB=null,this.params.zoom=r.zoom,this},e.Image.prototype.mkColorData=function(){var t,a,i=e.SCALESIZE,s=this.params.scalemin,r=this.params.scalemax,n=this.raw.width*this.raw.height,o=(i-1)/(r-s);for(this.colorData||(this.colorData=[]),t=0;t<n;t++)this.colorData[t]=(a=this.raw.data[t])<=s?0:a>=r?i-1:Math.floor((a-s)*o+.5);return this},e.Image.prototype.calcContrastBias=function(t){var a=e.COLORSIZE,i=this.params.bias,s=this.params.contrast;return 1e-4>i-.5&&1e-4>s-1?t:(this.params.invert&&(i=1-i),0>(t=Math.floor(((t/a-i)*s+.5)*a))?0:t>=a?a-1:t)},e.Image.prototype.mkColorCells=function(){var t,a,i=e.COLORSIZE;for(this.colorCells||(this.colorCells=[]),t=0;t<i;t++)a=this.calcContrastBias(a=this.params.invert?i-t-1:t),this.colorCells[t]=this.cmapObj.mkColorCell(a);return this},e.Image.prototype.mkScaledCells=function(){var t,a,i,s,r,n,o,l,c,p,d,h;o=e.COLORSIZE;var g=e.SCALESIZE,u=e.INVSIZE;if(r=e.HISTSIZE,!this.colorCells)return this;if(!this.psColors){for(i=this.psColors=[],l=[],"#"===(a=this.params.nancolor).charAt(0)&&(a=a.slice(1)),a=a.toUpperCase(),t=n=0;6>n;n+=2,t++)h="0123456789ABCDEF".indexOf(a.charAt(n)),s="0123456789ABCDEF".indexOf(a.charAt(n+1)),l[t]=16*h+s;i.NaN=l}switch(this.psInverse||(this.psInverse=[],this.psInverse.NaN=0),a=this.params.scalemax-this.params.scalemin,n=this.params.scalemin,this.params.scale){case"linear":for(i=0;i<g;i++)t=i/g,t=Math.floor(t*o),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)this.psInverse[i]=(t=i/u)*a+n;break;case"log":for(r=this.params.exp,i=0;i<g;i++)t=Math.log(r*i/g+1)/Math.log(r),(t=Math.floor(t*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)t=(Math.pow(r,i/u)-1)/r,this.psInverse[i]=t*a+n;break;case"power":for(r=this.params.exp,i=0;i<g;i++)t=(Math.pow(r,i/g)-1)/r,(t=Math.floor(t*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)t=Math.log(r*i/u+1)/Math.log(r),this.psInverse[i]=t*a+n;break;case"sqrt":for(i=0;i<g;i++)t=i/g,(t=Math.floor(Math.sqrt(t)*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)this.psInverse[i]=(t=i/u)*t*a+n;break;case"squared":for(i=0;i<g;i++)t=i/g,(t=Math.floor(t*t*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)t=Math.sqrt(i/u),this.psInverse[i]=t*a+n;break;case"asinh":for(i=0;i<g;i++)t=i/g,(t=Math.floor(Math.asinh(10*t)/3*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)t=i/u,t=Math.sinh(3*t)/10,this.psInverse[i]=t*a+n;break;case"sinh":for(i=0;i<g;i++)t=i/g,(t=Math.floor(Math.sinh(3*t)/10*o))>=o&&(t=o-1),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++)t=i/u,t=Math.asinh(10*t)/3,this.psInverse[i]=t*a+n;break;case"histeq":if(l=this.raw.data,c=this.raw.width*this.raw.height,a=this.raw.dmax-this.raw.dmin,d=this.raw.dmax,n=this.raw.dmin,p=t=0,h=[],!this.hist||!this.hist.length){for(this.hist=[],i=0;i<r;i++)h[i]=0;for(i=0;i<c;i++)l[i]>=n&&l[i]<=d&&(s=Math.floor((l[i]-n)/a*r+.5))<r&&(h[s]+=1);for(i=0;i<r;i++)p+=h[i];for(s=p/r,i=l=0;i<r&&l<r;i++)for(this.hist[i]=l/r,t+=h[i];t>=s&&l<r;)t-=s,l++;for(t=(r-1)/r;i<r;)this.hist[i++]=t}for(i=0;i<g;i++)t=this.hist[i*r/g],t=Math.floor(t*o),this.psColors[i]=this.colorCells[t];for(i=0;i<u;i++){for(o=i/u,s=0;s<r-1&&!(this.hist[s]>o);s++);this.psInverse[i]=(t=s/r)*a+n}break;default:e.log("unknown scale '"+this.params.scale+"'")}return this},e.Image.prototype.mkRGBImage=function(){var t,a,i,s,r,n,o,l,c,p,d,h,g,u,m,f,y,b,S,v,w,x,J=null,k=null,C=null,I=!1;if(!this.rgb)return this;if(!e.globalOpts.rgb.active||this!==e.globalOpts.rgb.rim&&this!==e.globalOpts.rgb.gim&&this!==e.globalOpts.rgb.bim||(I=!0,e.globalOpts.rgb.rim&&(J=e.globalOpts.rgb.rim),e.globalOpts.rgb.gim&&(k=e.globalOpts.rgb.gim),e.globalOpts.rgb.bim&&(C=e.globalOpts.rgb.bim)),o=this.display.context,a=(t=this.rgb).sect,this.MakeRGBImage&&"function"==typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"==typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){if(s=this.offscreen.context.getImageData(i=a.x0,s=this.offscreen.canvas.height-1-(a.y0+(n=a.height/a.zoom)),r=a.width/a.zoom,n),1===a.zoom)t.img=s;else for(t.img=o.createImageData(a.width,a.height),t=t.img,h=p=0;p<s.height;p++,h++)for(b=p*s.width,u=h*a.zoom,d=o=0;o<s.width;o++,d++)for(i=4*(b+o),g=d*a.zoom,m=0;m<a.zoom;m++)for(S=(f=Math.floor(u+m))*a.width,f=0;f<a.zoom;f++)y=Math.floor(g+f),t.data[y=4*(S+y)]=s.data[i],t.data[y+1]=s.data[i+1],t.data[y+2]=s.data[i+2],t.data[y+3]=s.data[i+3];return this}if(t.img&&t.img.width===a.width&&t.img.height===a.height||(t.img=o.createImageData(a.width,a.height)),t=t.img,!this.psColors)return this;for(v=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255,this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(s=255*this.params.opacity,r=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(s=this.params.alpha2,r=this.params.alpha1):(s=0,r=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(s=255*this.params.maskOpacity,r=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(s=this.params.alpha1,r=this.params.alpha2):(s=255,r=0)),l=Math.max(1,Math.floor(1/a.zoom)),c=a.zoom*l,p=a.y1-1,h=0;p>=a.y0;p-=l,h++)for(b=p*this.raw.width,u=h*c,o=a.x0,d=0;o<a.x1;o+=l,d++){if(I){if(w=k?k.colorData[b+o]:0,x=C?C.colorData[b+o]:0,void 0===(n=J?J.colorData[b+o]:0)||void 0===w||void 0===x)return e.globalOpts.rgb.active=!1,e.error("RGB images are incompatible. Turning off RGB mode.","",!1),e.Image.prototype.mkRGBImage.call(this),this}else i=this.colorData[b+o];for(this.maskData&&(v=0<this.maskData[b+o]?s:r),g=d*c,m=0;m<a.zoom;m++)for(S=(f=Math.ceil(u+m))*a.width,f=0;f<a.zoom;f++)(y=4*(S+(y=Math.ceil(g+f))))<t.data.length&&(I?(t.data[y]=J?J.psColors[n][0]:0,t.data[y+1]=k?k.psColors[w][1]:0,t.data[y+2]=C?C.psColors[x][2]:0):(t.data[y]=this.psColors[i][0],t.data[y+1]=this.psColors[i][1],t.data[y+2]=this.psColors[i][2]),t.data[y+3]=v)}return this},e.Image.prototype.blendImage=function(t,a,i){return 0===arguments.length?this.blend:!0===t||!1===t||"true"===t||"false"===t?("true"===t?t=!0:"false"===t&&(t=!1),this.blend.active=t,this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.displayImage(),this):((e.notNull(t)||e.notNull(a))&&(e.notNull(t)&&(/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i.test(t)||e.error("invalid composite/blend operation: "+t),this.blend.mode=t),e.notNull(a)&&("string"==typeof a?a=parseFloat(a):"number"!=typeof a&&e.error("invalid opacity: "+a),this.blend.opacity=Math.min(Math.max(a,0),1)),e.notNull(i)&&("true"===i?i=!0:"false"===i&&(i=!1),this.blend.active=i),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.blend.active&&this.displayImage()),this)},e.Image.prototype.calcDisplayOffsets=function(t){var a,i,s=this.rgb.sect;return this.ix=Math.floor((this.display.canvas.width-this.rgb.img.width)/2),this.iy=Math.floor((this.display.canvas.height-this.rgb.img.height)/2),e.notNull(s.ix)&&(this.ix-=s.ix/2),e.notNull(s.iy)&&(this.iy+=s.iy/2),t&&this.wcsAlign()&&(t=(a=this.wcsim).rgb.sect,a=e.pix2pix(a,this,a.getPan()),i=e.globalOpts.panWithinDisplay,e.globalOpts.panWithinDisplay=!0,this.mkSection(a.x,a.y,t.zoom),e.globalOpts.panWithinDisplay=i,this.ix-=(s.xcen-(s.x0+s.x1)/2)*t.zoom,this.iy+=(s.ycen-(s.y0+s.y1)/2)*t.zoom),this},e.Image.prototype.putImage=function(t){var a=this.rgb,i=this.display.context;return t=t||{},"reproject"===this.rawDataLayer()&&t.wcsim&&(this.wcsim=t.wcsim),this.calcDisplayOffsets(!0),e.notNull(t.opacity)||e.notNull(t.blend)?(i.save(),void 0!==t.opacity&&(i.globalAlpha=t.opacity),void 0!==t.blend&&(i.globalCompositeOperation=t.blend),i.drawImage(function(t,a){var i,s;return t.offscreenRGB||(i=(s=document.createElement("canvas")).getContext("2d"),s.width=a.width,s.height=a.height,e.ANTIALIAS||(i.imageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1),i.putImageData(a,0,0),t.offscreenRGB={canvas:s,context:i}),t.offscreenRGB.canvas}(this,a.img),this.ix,this.iy),i.restore()):i.putImageData(a.img,this.ix,this.iy),this},e.Image.prototype.displayImage=function(t,a){var i,s,r;r=0;var n=[],o={};if(!1===t)return this.displayMode=!1,this;if(!0===t&&(this.displayMode=!0,t="all"),!this.displayMode)return this;if("object"==typeof t&&(a=t,t=null),t?"all"===t?(t="colors,scaled,rgb,display,plugins",o.notify=!0):"rgbonly"===t?(t="rgb,nodisplay",o.notify=!0):"display"===t&&(o.notify=!0):t="rgb",t.split(",").forEach(function(e,t,a){switch(e=e.trim(),o[e]=!0,e){case"colors":o.scaled=!0,o.rgb=!0;break;case"scaled":o.rgb=!0}}),o.display=!0,o.plugins=!0,this.rgbFile&&(o.colors=!1,o.scaled=!1),"string"==typeof a)try{a=JSON.parse(a)}catch(l){e.error("can't parse displayImage opts: "+a,l)}if(a=a||{},this.display.blendMode&&!1!==a.blendMode)for(i=0;i<e.images.length;i++)(s=e.images[i]).display===this.display&&s.blend.active&&(n.push(s),r++);if(o.colors&&(this.mkColorData(),this.offscreenRGB=null),o.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null),o.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,r))for(i=n.length-1;0<=i;i--)(s=n[i]).mkRGBImage(),s.offscreenRGB=null;if(o.nodisplay)return this;if(o.display){if(this.display.context.clear(),r){for(i=n.length-1;0<=i;i--)n[i].calcDisplayOffsets(!1);for(i=n.length-1;0<=i;i--)(s=n[i]).putImage(r={wcsim:a.wcsim,blend:s.blend.mode,opacity:s.blend.opacity}),s===this&&s.displayShapeLayers()}else this.putImage(a),this.displayShapeLayers();if(this.display.image=this,this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)i=this.delayedShapes.shift(),this.addShapes(i.layer,i.shape,i.opts);delete this.delayedShapes}}return this.xeqPlugins("image","onimagedisplay"),this},e.Image.prototype.refreshImage=function(t,a){var i,s;if("string"==typeof a)try{a=JSON.parse(a)}catch(r){e.error("can't parse refresh opts: "+a,r)}if(a=a||{},t&&"string"!=typeof t){if(a.rawid=a.rawid||e.RAWID0,"function"==typeof a&&(a={onrefresh:a}),!a.onrefresh&&e.imageOpts.onrefresh&&(a.onrefresh=e.imageOpts.onrefresh),s=this.imageToLogicalPos({x:this.rgb.sect.xcen,y:this.rgb.sect.ycen}),i=this.rgb.sect.zoom,this.binning.obin=this.binning.bin,this.mkRawDataFromHDU(t,a),a.resetSection?(this.mkSection(),this.mkSection(i)):(s=this.logicalToImagePos({x:s.x,y:s.y}),this.mkSection(s.x,s.y,i)),this.displayImage("colors",a),this.notifyHelper(),(a.refreshRegions||a.resetSection||this.binning.obin!==this.binning.bin)&&(this.refreshLayers(),this.updateShapes("regions","all","binning")),this.xeqPlugins("image","onimagerefresh"),e.waiting(!1),a.onrefresh)try{e.xeqByName(a.onrefresh,window,this)}catch(r){e.error("in image refresh callback",r)}return this}a.onrefresh&&(a.onload=a.onrefresh,delete a.onrefresh),a.refresh=this,e.Load(document.domain?t||this.file:t||this.fitsFile||this.file,a,{display:this.display})},e.Image.prototype.fileDimensions=function(){var e,t;return this.parent&&"BINTABLE"!==this.parent.raw.header.XTENSION?(e=this.parent.raw.header.TABDIM1?this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1,t=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:this.parent.raw.header.NAXIS2):(e=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,t=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2),{xdim:e,ydim:t}},e.Image.prototype.maybePhysicalToImage=function(t){var a;return"image"===this.imtab&&this.parent&&this.parent.lcs&&t.x&&t.y&&(t=e.Image.prototype.logicalToImagePos.call(this.parent,t={x:t.x,y:t.y},"ophysical"),a={x:Math.floor(t.x+.5),y:Math.floor(t.y+.5)}),a},e.Image.prototype.displaySection=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m=this,f=function(t,a,i){var s;return e.isNull(t)?e.isNull(a)||(s=a):s=t,s||i},y=function(t,i){var s,n;if(s="",c=$.extend(!0,{},i||{}),e.isNull(c.refreshRegions)&&(c.refreshRegions=!0),e.isNull(c.resetSection)&&(c.resetSection=!0),!1!==c.waiting&&e.waiting(!0,m.display),t.fits.extname?s=sprintf("[%s]",t.fits.extname):t.fits.extnum&&0<t.fits.extnum?s=sprintf("[%s]",t.fits.extnum):m.parent&&(m.parent.extname?s=sprintf("[%s]",m.parent.extname):m.parent.extnum&&0<m.parent.extnum&&(s=sprintf("[%s]",m.parent.extnum))),s=m.id.replace(/\[.*\]/,"")+s,c.separate){if(delete c.xcen,delete c.ycen,c.id=s,"string"==typeof c.separate){switch((n=c.separate.split(":")).length){case 1:s=n[0];break;default:s=n[0],c.id=n[1]}c.display=e.lookupDisplay(s)}else c.display=m.display;"parentFile"===r&&m.fitsFile&&(s=e.lookupImage(m.fitsFile),c.parentFile=s&&s.parentFile?s.parentFile:m.fitsFile),o=m.listRegions("all",{mode:1}),(l=new e.Image(t,c,a=c.ondisplaysection||c.onrefresh||a)).binning.obin=l.binning.bin,o&&!1!==c.refreshRegions&&l.addShapes("regions",o)}else if("string"==typeof c.refresh){switch(delete c.xcen,delete c.ycen,c.id=s,(n=c.refresh.split(":")).length){case 1:s=n[0];break;default:s=n[0],c.id=n[1]}c.display=e.lookupDisplay(s),c.display.image?(c.rawid=m.raw.id,c.onrefresh=c.ondisplaysection||c.onrefresh||a,c.display.image.refreshImage(t,c)):("parentFile"===r&&m.fitsFile&&(s=e.lookupImage(m.fitsFile),c.parentFile=s&&s.parentFile?s.parentFile:m.fitsFile),o=m.listRegions("all",{mode:1}),(l=new e.Image(t,c,a=c.ondisplaysection||c.onrefresh||a)).binning.obin=l.binning.bin,o&&l.addShapes("regions",o))}else c.id=s,c.rawid=m.raw.id,c.onrefresh=c.ondisplaysection||c.onrefresh||a,m.refreshImage(t,c);e.waiting(!1)};if(this.raw&&this.raw.hdu&&this.raw.hdu.fits||e.error("invalid image for displaySection"),"full"===t)p=this.fileDimensions(),t={xdim:p.xdim,ydim:p.ydim,xcen:0,ycen:0};else{if("selected"===t)return void this.selectShapes("regions","selected",function(e){var t,i,s=0,r=0,n=1e6,o=0,l=1e6,p=0,d=(e=e.pub).shape;switch(e.lcs&&(e=e.lcs),d){case"annulus":t=2*e.radii[e.radii.length-1],i=2*e.radii[e.radii.length-1];break;case"box":t=e.width,i=e.height;break;case"circle":t=2*e.radius,i=2*e.radius;break;case"ellipse":t=2*e.r1,i=2*e.r2;break;case"polygon":case"line":for(t=0;t<e.pts.length;t++)s+=e.pts[t].x,r+=e.pts[t].y,e.pts[t].x>o&&(o=e.pts[t].x),e.pts[t].x<n&&(n=e.pts[t].x),e.pts[t].y>p&&(p=e.pts[t].y),e.pts[t].y<l&&(l=e.pts[t].y);e.x=s/e.pts.length,e.y=r/e.pts.length,"line"===e.shape&&2===e.pts.length?(t=Math.sqrt((e.pts[0].x-e.pts[1].x)*(e.pts[0].x-e.pts[1].x)+(e.pts[0].y-e.pts[1].y)*(e.pts[0].y-e.pts[1].y)),i=1):(t=o-n,i=p-l);break;case"text":i=t=10}this.displaySection(c={xcen:e.x,ycen:e.y,xdim:t,ydim:i,separate:!0,refreshRegions:!1,resetSection:!0},a)});if("string"==typeof t)try{t=JSON.parse(t)}catch(b){e.error("can't parse section opts: "+t,b)}}if(s=(t=t||{}).separate?$.extend(!0,{},this.raw.hdu):this.raw.hdu,(r=t.from)||(r=this.parentFile&&e.helper.connected&&e.helper.js9helper?"parentFile":"virtualFile"),s.table?p=s.table:("parentFile"===r&&this.raw.header&&e.notNull(this.raw.header.LTM1_1)?(h=1,g=this.raw.header.LTM1_1):(h=s.bin||1,g=1),d=this.imageToLogicalPos(p={x:this.raw.width/2,y:this.raw.height/2}),(p={}).bin=Math.floor(h/g+.5),p.xcen=Math.floor(d.x+.5*(p.bin-1)),p.ycen=Math.floor(d.y+.5*(p.bin-1)),(h=this.maybePhysicalToImage({x:p.xcen,y:p.ycen}))&&(p.xcen=h.x,p.ycen=h.y),p.xdim=Math.floor(s.naxis1*p.bin),p.ydim=Math.floor(s.naxis2*p.bin),p.filter=this.raw.filter||""),"string"==typeof t.bin)switch(t.bin.match(/[as]$/)&&(t.binMode=t.bin.slice(-1),t.bin=t.bin.slice(0,-1)),h=p.bin||this.binning.bin,t.bin.charAt(0)){case"*":case"x":case"X":t.bin=h*parseInt(t.bin.slice(1),10);break;case"/":t.bin=h/parseInt(t.bin.slice(1),10);break;case"+":t.bin=h+parseInt(t.bin.slice(1),10);break;case"-":t.bin=h-parseInt(t.bin.slice(1),10);break;case"i":case"I":t.bin=2*h;break;case"o":case"O":t.bin=h/2;break;default:e.isNumber(t.bin)?t.bin=parseInt(t.bin,10):e.error("invalid bin for displaySection: "+t.bin)}switch(t.xcen=f(t.xcen,p.xcen,0),t.ycen=f(t.ycen,p.ycen,0),this.imtab){case"table":t.xdim=f(t.xdim,p.xdim,e.fits.options.table.xdim),t.ydim=f(t.ydim,p.ydim,e.fits.options.table.ydim),t.bin=f(t.bin,p.bin,e.fits.options.table.bin);break;default:t.xdim=f(t.xdim,p.xdim,e.fits.options.image.xdim),t.ydim=f(t.ydim,p.ydim,e.fits.options.image.ydim),t.bin=f(t.bin,p.bin,e.fits.options.image.bin)}t.binMode=f(t.binMode,p.binMode,e.globalOpts.binMode),"string"==typeof t.bin&&(t.bin.match(/[as]$/)&&(t.binMode=t.bin.slice(-1)),t.bin=parseInt(t.bin,10)),t.bin=Math.max(1,t.bin||1),t.filter=f(t.filter,p.filter,""),this.raw.filter=t.filter||"",!1!==t.waiting&&e.waiting(!0,m.display),window.setTimeout(function(){switch(r){case"parentFile":i=m.proxyFile,(u=[]).push({name:"xcen",value:t.xcen}),delete t.xcen,u.push({name:"ycen",value:t.ycen}),delete t.ycen,u.push({name:"xdim",value:t.xdim}),u.push({name:"ydim",value:t.ydim}),void 0!==t.xdim&&(t.xdim=0),void 0!==t.ydim&&(t.ydim=0),t.binMode&&(t.bin=sprintf("%s%s",t.bin,t.binMode),delete t.binMode),u.push({name:"bin",value:t.bin}),delete t.bin,u.push({name:"filter",value:t.filter||""}),u.push({name:"slice",value:t.slice||""}),delete t.slice,(n={id:m.expandMacro("$id"),image:m.file,fits:m.parentFile,rtype:"text"}).cmd="js9Xeq imsection "+m.parentFile,t.extension&&(n.cmd=n.cmd.replace(/\[.*\]/,""),n.cmd+="["+t.extension+"]",delete t.extension),n.cmd+=m.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",u),e.helper.send("imsection",n,function(a){var s,r;if((a="object"==typeof a?a:0<=a.search(e.analOpts.epattern)?{stderr:a}:{stdout:a}).stderr)e.error(a.stderr);else if(a.errcode)e.error("in displaySection: "+a.errcode);else{if(r=a.stdout.split(/\n/),"/"!==(a=e.cleanPath(r[0])).charAt(0)&&(a=e.InstallDir(a)),t.proxyFile=a,i&&i!==t.proxyFile&&m.removeProxyFile(i),r[1]){try{s=JSON.parse(r[1])}catch(n){e.log("couldn't parse imsection as JSON: %s",a),s=null}s&&(t.extname=s.extname,t.extnum=s.extnum,t.hdus=s.hdus,t.parent=s)}r[2]&&(s=e.cleanPath(r[2]),t.parentFile=s),t.ltm2obin=!0,e.fetchURL(a,a,t,function(a){e.cleanupFITSFile(m.raw,!0),!1!==t.waiting&&e.waiting(!0,m.display),e.fits.handleFITSFile(a,t,y)})}});break;case"virtualFile":e.cleanupFITSFile(m.raw,!1),e.getFITSImage(s.fits,s,t,function(e){y(e,t)});break;default:e.error("image section cannot be extracted from this data file")}},e.SPINOUT)},e.Image.prototype.displayExtension=function(t,a,i){var s,r,n,o;if("string"==typeof a)try{a=JSON.parse(a)}catch(l){e.error("can't parse extension opts: "+a,l)}if((a=a||{}).waiting=!1,this.hdus||e.error("no FITS HDUs found for displayExtension()"),void 0===t&&e.error("missing extname/extnum for displayExtension()"),"string"==typeof t){for(a.extension=t,n=t.toLowerCase(),r=s=0;s<this.hdus.length;s++)if(this.hdus[s].name&&this.hdus[s].name.toLowerCase()===n){r++;break}r||e.error(sprintf("no FITS HDU %s for displayExtension()",t))}else"number"==typeof t&&(a.extension=t,this.hdus[t]?n=this.hdus[t].name||t.toString():e.error(sprintf("no FITS HDU %s for displayExtension()",t)));if(a.separate){for(s=sprintf("[%s]",n),t=this.id.replace(/\[.*\]/,"")+s,r=s=0;s<e.images.length;s++)if(t===(o=e.images[s]).id&&0<$("#"+o.display.id).length&&this.display.id===o.display.id){r++;break}if(r)return o.displayImage("display",a),void o.display.clearMessage()}return e.cleanupFITSFile(this.raw,!1),this.displaySection(a,i),this},e.Image.prototype.displaySlice=function(t,a,i){var s;if("string"==typeof a)try{a=JSON.parse(a)}catch(r){e.error("can't parse slice opts: "+a,r)}if((a=a||{}).waiting=!1,void 0===t&&e.error("missing slice for displaySlice()"),"all"===t&&3===this.raw.header.NAXIS)for(this.displaySlice(1,s,i),t=2;t<=this.raw.header.NAXIS3;t++)s=$.extend(!0,{},a,{separate:!0}),this.displaySlice(t,s,i);else a.slice=e.isNumber(t)?sprintf("*:*:%s",t):t,e.cleanupFITSFile(this.raw,!1),this.displaySection(a,i);return this},e.Image.prototype.toArray=function(t){var a,i,s,r,n,o,l,c,p=this.raw.data.buffer;for((t=t||{}).simple=!0,2880==(o=2880-(t=e.raw2FITS(this.raw,t)).length%2880)&&(o=0),a=0;a<o;a++)t+=" ";for(2880==(o=2880-p.byteLength%2880)&&(o=0),a=new ArrayBuffer(t.length+p.byteLength+o),l=new Uint8Array(a),a=0;a<t.length;a++)l[a]=t.charCodeAt(a);if(0<new Int8Array(new Int16Array([1]).buffer)[0])for(n=t.length,r=Math.abs(this.raw.bitpix)/8,c=new Uint8Array(p),a=0;a<c.byteLength;a+=r)for(i=a+r-1,s=0;s<r;i--,s++)l[n++]=c[i];else l.set(new Uint8Array(p),t.length);for(n=t.length+p.byteLength,a=0;a<o;a++)l[n++]=0;return l},e.Image.prototype.wcsAlign=function(){return this.wcsim&&this.params.wcsalign&&this.display===this.wcsim.display},e.Image.prototype.getPan=function(){var t=this.rgb.sect,a=(t.x0+t.x1)/2,i=(t.y0+t.y1)/2;return e.notNull(t.ix)&&(a+=t.ix/(2*t.zoom)),e.notNull(t.iy)&&(i+=t.iy/(2*t.zoom)),{x:a,y:i,ox:t.xcen,oy:t.ycen,x0:t.x0,y0:t.y0,x1:t.x1,y1:t.y1,ix:t.ix||0,iy:t.iy||0}},e.Image.prototype.setPan=function(t,a){var i,s,r,n,o,l;if(!(0<=$.inArray("pan",this.params.disable))){if(0===arguments.length&&(t=this.raw.width/2,a=this.raw.height/2),1===arguments.length&&"string"==typeof t)try{t=JSON.parse(t)}catch(c){e.error("can't parse setPan JSON: "+t,c)}if("object"==typeof t&&(e.notNull((i=t).x)&&e.notNull(i.y)&&(t=i.x,a=i.y),e.notNull(i.px)&&e.notNull(i.py)&&(t=(n=this.logicalToImagePos({x:i.px,y:i.py})).x,a=n.y),"string"==typeof i.wcs&&(n=i.wcs.trim().split(/ +/),i.ra=n[0],i.dec=n[1],3<=n.length&&(i.wcssys=n[2])),e.notNull(i.ra)&&e.notNull(i.dec)&&0<this.raw.wcs&&(i.wcssys&&(r=this.getWCSSys(),o=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(i.wcssys)),"string"==typeof i.ra&&(i.ra=e.saostrtod(i.ra),":"===String.fromCharCode(e.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(i.ra*=15)),"string"==typeof i.dec&&(i.dec=e.saostrtod(i.dec)),n=e.wcs2pix(this.raw.wcs,i.ra,i.dec).trim().split(/ +/),t=parseFloat(n[0]),a=parseFloat(n[1]),r&&(this.setWCSSys(r),e.globalOpts.xeqPlugins=o))),e.isNumber(t)&&e.isNumber(a)||e.error("invalid input for setPan: "+t+" "+a),this.wcsAlign()&&(l=e.globalOpts.panWithinDisplay,e.globalOpts.panWithinDisplay=!0),this.mkSection(t,a),this.display.blendMode)for(i=0;i<e.images.length;i++)(r=e.images[i])!==this&&r.display===this.display&&r.blend.active&&(r.wcsim===this||this.wcsim===r||r.wcsim&&r.wcsim===this.wcsim)&&(r.params.wcsalign||this.params.wcsalign)&&(o=e.pix2pix(this,r,{x:t,y:a}),r.mkSection(o.x,o.y));for(s in this.wcsAlign()&&(e.globalOpts.panWithinDisplay=l),this.displayImage("rgb"),this.layers)this.layers.hasOwnProperty(s)&&this.layers[s].show&&this.layers[s].opts.panzoom&&this.refreshShapes(s);return e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan"),this}},e.Image.prototype.getZoom=function(){return this.rgb.sect.zoom},e.Image.prototype.parseZoom=function(e){var t;switch(t=this.rgb.sect.zoom,typeof e){case"string":switch(e.charAt(0)){case"*":case"x":case"X":e=t*parseFloat(e.slice(1));break;case"/":e=t/parseFloat(e.slice(1));break;case"I":case"i":e=2*t;break;case"O":case"o":e=t/2;break;case"T":case"t":e=Math.min(this.display.width/this.raw.width,this.display.height/this.raw.height),e=Math.round(1e6*(e+1e-7))/1e6;break;default:e=parseFloat(e)}break;case"number":break;default:return}return e},e.Image.prototype.setZoom=function(t){var a,i,s,r,n;if(!(0<=$.inArray("zoom",this.params.disable))){if((a=this.parseZoom(t))||e.error("invalid input for setZoom: "+t),this.wcsAlign()&&(n=e.globalOpts.panWithinDisplay,e.globalOpts.panWithinDisplay=!0),this.mkSection(a),this.display.blendMode)for(t=0;t<e.images.length;t++)(s=e.images[t])!==this&&s.display===this.display&&s.blend.active&&(s.wcsim===this||this.wcsim===s||s.wcsim&&s.wcsim===this.wcsim)&&(s.params.wcsalign||this.params.wcsalign)&&(r=e.pix2pix(this,s,this.getPan()),s.mkSection(r.x,r.y,a));for(i in this.wcsAlign()&&(e.globalOpts.panWithinDisplay=n),this.displayImage("rgb"),this.layers)this.layers.hasOwnProperty(i)&&this.layers[i].show&&this.layers[i].opts.panzoom&&this.refreshShapes(i);return e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom"),this}},e.Image.prototype.alignPanZoom=function(t,a){var i,s,r;if(t)return"string"==typeof t&&((i=e.getImage(t))?t=i:e.error("unknown image for alignPanZoom: "+t)),r=this.raw.wcsinfo||{cdelt1:1},s=t.raw.wcsinfo||{cdelt1:1},i=t.getPan(),this.setPan(e.pix2pix(t,this,{x:i.ox,y:i.oy})),this.setZoom((t.rgb.sect.zoom||1)*r.cdelt1/s.cdelt1),this},e.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom()),this.binning.obin=this.binning.bin,this.rgb.sect.ozoom=this.rgb.sect.zoom},e.Image.prototype.imageToLogicalPos=function(e,t){var a,i,s,r,n,o=e.x;s=e.y;var l="image";switch(t=t||this.params.lcs||"image"){case"physical":this.lcs.physical&&(l=t,a=this.lcs.physical.reverse,i=this.lcs.physical.rrot,r=this.lcs.physical.cx,n=this.lcs.physical.cy);break;case"detector":this.lcs.detector&&(l=t,a=this.lcs.detector.reverse,i=this.lcs.detector.rrot,r=this.lcs.detector.cx,n=this.lcs.detector.cy);break;case"amplifier":this.lcs.amplifier&&(l=t,a=this.lcs.amplifier.reverse,i=this.lcs.amplifier.rrot,r=this.lcs.amplifier.cx,n=this.lcs.amplifier.cy)}return a&&(o=e.x*a[0][0]+e.y*a[1][0]+a[2][0],s=e.x*a[0][1]+e.y*a[1][1]+a[2][1],i&&(a=r+(o-r)*i[0][0]+(s-n)*i[1][0]+i[2][0],s=n+(o-r)*i[0][1]+(s-n)*i[1][1]+i[2][1],o=a),"table"===this.imtab&&(i=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(o=o-i+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(s=s-i+this.raw.header.TABMIN2))),{x:o,y:s,sys:l}},e.Image.prototype.logicalToImagePos=function(e,t){var a,i,s,r,n,o={x:e.x,y:e.y};switch(s=this.raw.header.CRPIX1||1,r=this.raw.header.CRPIX2||1,t=t||this.params.lcs||"image"){case"ophysical":this.lcs.ophysical?(a=this.lcs.ophysical.forward,i=this.lcs.ophysical.frot):this.lcs.physical&&(a=this.lcs.physical.forward,i=this.lcs.physical.frot);break;case"physical":this.lcs.physical&&(a=this.lcs.physical.forward,i=this.lcs.physical.frot);break;case"detector":this.lcs.detector&&(a=this.lcs.detector.forward,i=this.lcs.detector.frot);break;case"amplifier":this.lcs.amplifier&&(a=this.lcs.amplifier.forward,i=this.lcs.amplifier.frot)}return a&&("table"===this.imtab&&(n=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(e.x=e.x-this.raw.header.TABMIN1+n),void 0!==this.raw.header.TABMIN2&&(e.y=e.y-this.raw.header.TABMIN2+n)),o.x=e.x*a[0][0]+e.y*a[1][0]+a[2][0],o.y=e.x*a[0][1]+e.y*a[1][1]+a[2][1],i&&(a=s+(o.x-s)*i[0][0]+(o.y-r)*i[1][0]+i[2][0],i=r+(o.x-s)*i[0][1]+(o.y-r)*i[1][1]+i[2][1],o.x=a,o.y=i)),o},e.Image.prototype.displayToImagePos=function(e){var t=this.rgb.sect;return{x:(e.x-this.ix+.5)/t.zoom+t.x0+.5,y:(this.rgb.img.height-(e.y-this.iy+.5))/t.zoom+t.y0+.5}},e.Image.prototype.imageToDisplayPos=function(e){var t=this.rgb.sect;return{x:(e.x-.5-t.x0)*t.zoom+this.ix-.5,y:(t.y0-(e.y-.5))*t.zoom+this.rgb.img.height+this.iy-.5}},e.Image.prototype.logicalToDisplayPos=function(e,t,a){return this.imageToDisplayPos(this.logicalToImagePos(e,t,a))},e.Image.prototype.displayToLogicalPos=function(e){return this.imageToLogicalPos(this.displayToImagePos(e))},e.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys},e.Image.prototype.setWCSSys=function(t){if(!(0<=$.inArray("wcs",this.params.disable)))return"image"===t?(this.params.wcssys="image",this.params.wcsunits="pixels",e.wcsunits.image="pixels"):"physical"===t?(this.params.wcssys="physical",this.params.wcsunits="pixels",e.globalOpts.wcsUnits.physical="pixels"):this.raw.wcs&&0<this.raw.wcs&&("native"===t&&(t=this.params.wcssys0),t=e.wcssys(this.raw.wcs,t))&&(this.params.wcssys=t.trim(),this.setWCSUnits(t=e.globalOpts.wcsUnits[this.params.wcssys]||"sexagesimal")),e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys"),this},e.Image.prototype.initWCS=function(t){var a,i,s,r=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;for(i in t=t||this.raw.header,this.freeWCS(),this.raw.altwcs={},this.raw.altwcs[a="default"]={},this.raw.altwcs[a].header=t,t)t.hasOwnProperty(i)&&(s=i.match(r))&&s.length&&(this.raw.altwcs[a=s[2]]||(this.raw.altwcs[a]={},this.raw.altwcs[a].header=$.extend({},t)),"RADESYS"===s[1]&&(s[1]="RADECSYS"),this.raw.altwcs[a].header[s[1]]=t[s[0]]);for(i in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(i)&&(t=e.raw2FITS(this.raw.altwcs[i].header),this.raw.altwcs[i].wcs=e.initwcs(t),0<this.raw.altwcs[i].wcs))try{this.raw.altwcs[i].wcsinfo=JSON.parse(e.wcsinfo(this.raw.altwcs[i].wcs))}catch(n){}return this.setWCS("default"),this},e.Image.prototype.freeWCS=function(t){var a;if((t=t||this.raw).altwcs)for(a in t.altwcs)t.altwcs.hasOwnProperty(a)&&0<t.altwcs[a].wcs&&(e.freewcs(t.altwcs[a].wcs),t.altwcs[a].wcs=null)},e.Image.prototype.getWCS=function(){var e,t;for(e in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(e)&&this.raw.wcs===this.raw.altwcs[e].wcs)return(t=$.extend(!0,{},this.raw.altwcs[e].wcsinfo)).version=e,t.wcsname=this.raw.altwcs[e].header.WCSNAME,t;return null},e.Image.prototype.setWCS=function(t){var a;if(t=t||"default",!this.raw||!this.raw.altwcs)return this;for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)&&(t===a||t===this.raw.altwcs[a].header.WCSNAME))return 0>=this.raw.altwcs[a].wcs&&e.error("invalid WCS for version: %s",t),this.raw.wcs=this.raw.altwcs[a].wcs,this.raw.wcsinfo=this.raw.altwcs[a].wcsinfo,t=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:"native"!==this.params.wcssys?this.params.wcssys.trim():this.params.lcs,this.setWCSSys(t),this.params.wcssys0||(this.params.wcssys0=t),this.setWCSUnits(this.params.wcsunits),this;e.error("could not find WCS version: "+t)},e.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"},e.Image.prototype.setWCSUnits=function(t){if(!(0<=$.inArray("wcs",this.params.disable)))return"pixels"===t?(this.params.wcssys="physical",this.params.wcsunits="pixels",e.globalOpts.wcsUnits[this.params.wcssys]="pixels"):this.raw.wcs&&0<this.raw.wcs&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys||this.setWCSSys(this.raw.wcs,e.imageOpts.wcssys),(t=e.wcsunits(this.raw.wcs,t))&&(this.params.wcsunits=t.trim(),e.globalOpts.wcsUnits[this.params.wcssys]=this.params.wcsunits)),e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits"),this},e.Image.prototype.notifyHelper=function(){var t,a=this,i=new RegExp("^"+e.ANON+"[0-9]*");if(e.helper.connected&&!this.file.match(i)){switch(e.helper.type){case"get":case"post":e.helper.pageid||e.helper.send("pageid",null,function(t){t&&t.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(e.helper.pageid=t,e.helper.js9helper="js9helper")})}e.helper.send("image",{image:this.file},function(i){var s;"object"==typeof i?(s=i.stdout,i.stderr&&1<e.DEBUG&&e.log(i.stderr)):s=i,s&&(i=s.trim().match(/(?:[^\s\[]+|\[[^\]]*\])+/g),a&&"?"!==(i=i[1])&&(e.globalOpts.dataDir?(s=i.lastIndexOf("/")+1,a.fitsFile=e.globalOpts.dataDir+"/"+i.slice(s)):(a.fitsFile=i,0>a.fitsFile.indexOf("/")&&(t=a.file.match(/.*\//))&&t.length&&(i=new RegExp("^"+e.INSTALLDIR),t=t[0].replace(i,""),a.fitsFile=t+a.fitsFile),e.globalOpts.prependJS9Dir&&(a.fitsFile&&!a.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==a.fitsFile.charAt(0)&&(a.fitsFile="${JS9_DIR}/"+a.fitsFile),a.parentFile&&!a.parentFile.match(/^\${JS9_DIR}/)&&"/"!==a.parentFile.charAt(0)&&(a.parentFile="${JS9_DIR}/"+a.parentFile))),1<e.DEBUG&&e.log("JS9 fitsFile: %s %s",a.file,a.fitsFile)),a&&a.fitsFile&&(a.fitsFile=e.cleanPath(a.fitsFile)),a&&a.parentFile&&(a.parentFile=e.cleanPath(a.parentFile)),a.queried||(a.queryHelper("all"),a.queried=!0))})}return this},e.Image.prototype.queryHelper=function(t){var a=this;return t=t||"all",!e.helper.connected||"all"!==t&&"getAnalysis"!==t||this.analysisPackages||e.helper.send("getAnalysis",{fits:this.fitsFile},function(t){if(t)try{a.analysisPackages=JSON.parse(t)}catch(i){e.log("can't get analysis",i)}}),this},e.Image.prototype.expandMacro=function(t,a){var i,s=this;if(t)return t.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(t,r,n){var o;n=function(e,t){var a=e.params.wcssys;if(t)switch(t){case"wcs":"physical"!==a&&"image"!==a||(e.params.wcssys=e.params.wcssys0);break;case"physical":case"image":e.params.wcssys=t}return a};var l=function(e,t){var a;return"table"===e.imtab?e.raw.hdu.table.filter&&!t.match(e.raw.hdu.table.filter)&&(t=t.match(/\]\[/)?t.slice(0,-1)+"&&"+e.raw.hdu.table.filter+"]":t+"["+e.raw.hdu.table.filter+"]"):"image"===e.imtab&&(a=e.file.match(/\[.*\]/))&&(t=t.match(/\[.*\]/)?t.replace(/\[.*\]/,a):t+a),t},c=r.split("(");switch(c[1]&&(c[1]=c[1].replace(/\)$/,"")),c[0]){case"id":o=s.display.divjq.attr("id");break;case"image":case"png":o=s.id;break;case"filename":s.parentFile&&"this"!==c[1]?s.raw&&s.raw.filter?((o=s.parentFile).match(/\[.*\]/)||(o+="[EVENTS]"),o+="["+s.raw.filter+"]"):o=l(s,s.parentFile):s.fitsFile?o=l(s,s.fitsFile):e.error("no FITS file for "+s.id);break;case"fits":s.fitsFile||e.error("no FITS file for "+s.id),o=l(s,s.fitsFile);break;case"parent":s.parentFile||e.error("no parent FITS file for "+s.id),o=s.parentFile;break;case"ext":s.fitsFile?null===(o=s.fitsFile.match(/\[.*\]/))&&(o=""):e.error("no FITS file for "+s.id);break;case"imcenter":o=s.displayToLogicalPos({x:s.display.width/2,y:s.display.height/2}),o=sprintf("%s,%s",o.x,o.y);break;case"wcscenter":o=s.displayToImagePos({x:s.display.width/2,y:s.display.height/2}),o=e.pix2wcs(s.raw.wcs,o.x,o.y).replace(/\s+/g,",");break;case"sregions":t=n(s,c[1]),o=s.listRegions("source",{mode:0}).replace(/\s+/g,""),t&&(s.params.wcssys=t);break;case"bregions":t=n(s,c[1]),o=s.listRegions("background",{mode:0}).replace(/\s+/g,""),t&&(s.params.wcssys=t);break;case"regions":t=n(s,c[1]),o=s.listRegions("all",{mode:0}).replace(/\s+/g,""),t&&(s.params.wcssys=t);break;default:if(a)for(i=a.length,n=0;n<i;n++)if(a[n].name===r){o=a[n].value;break}void 0===o&&(o=t)}return o})},e.Image.prototype.lookupAnalysis=function(e){var t,a,i,s=null;if(this.analysisPackages){for(a=0;a<this.analysisPackages.length&&!s;a++)for(i=this.analysisPackages[a],t=0;t<i.length&&(!(s=i[t]).xclass||s.xclass+":"+s.name!==e);t++)s=null;if(s)return s;for(a=0;a<this.analysisPackages.length&&!s;a++)for(i=this.analysisPackages[a],t=0;t<i.length&&(s=i[t]).name!==e;t++)s=null}return s},e.Image.prototype.runAnalysis=function(t,a,i){var s,r=this,n={},o=function(t,a){switch(e.helper||e.error(t,a),e.helper.type){case"nodejs":case"socket.io":e.helper.socket&&"polling"===e.helper.socket.io.engine.transport.name?window.setTimeout(function(){e.error(t,a)},0):e.error(t,a);break;default:e.error(t,a)}};if("string"==typeof a)try{a=JSON.parse(a)}catch(l){e.error("can't parse analysis opts: "+a,l)}if(i=i||e.globalOpts.analysisFunc,e.helper.connected&&this.analysisPackages){if(s=this.lookupAnalysis(t)){if(s.action&&(n.cmd=this.expandMacro(s.action,a)),s.keys)for(n.keys={},t=0;t<s.keys.length;t++)n.keys[s.keys[t]]=this.expandMacro("$"+s.keys[t],a);switch(n.id=this.expandMacro("$id"),n.image=this.file,n.fits=this.fitsFile,n.rtype=s.rtype,e.helper.type){case"nodejs":case"socket.io":a=s.xclass?s.xclass+":"+s.name:s.name;break;default:a="runAnalysis"}return e.waiting(!0,this.display),e.helper.send(a,n,function(t){var a,l;if(e.waiting(!1),(a="object"==typeof t?t:0<=t.search(e.analOpts.epattern)?{stderr:t}:{stdout:t}).errcode=a.errcode||0,i)i.call(r,a.stdout,a.stderr,a.errcode,s);else{if(a.stderr){if(!(0<=(t=a.stderr).search(/WARNING:/i)&&0>t.search(/ERROR:/i)))return void o(t,e.analOpts.epattern);e.log(t)}else if(a.errcode){if(t=sprintf("ERROR: running %s [%s]",s.name,a.errcode),!a.stdout)return void o(t,e.analOpts.epattern);e.log(t)}switch(s.rtype){case"text":case void 0:r.displayAnalysis("text",a.stdout,{divid:e.globalOpts.analysisDiv});break;case"plot":r.displayAnalysis("plot",a.stdout,{divid:e.globalOpts.analysisDiv});break;case"alert":a.stdout&&alert(a.stdout);break;case"fits":case"png":(l=a.stdout.split(/\s+/))&&l[0]&&("/"!==(t=e.cleanPath(l[0])).charAt(0)&&(t=e.InstallDir(t)),a={proxyFile:t},l[1]&&(l=e.cleanPath(l[1]),a.parentFile=l),a.fits2fits=!1,e.Load(t,a,{display:r.display}));break;case"regions":(l=a.stdout.split(/\s+/))&&l[0]&&(t=e.cleanPath(l[0]),e.fetchURL(null,t,n={responseType:"text"},function(e,t){r.addShapes("regions",e,t)}));break;case"catalog":(l=a.stdout.split(/\s+/))&&l[0]&&(t=e.cleanPath(l[0]),e.fetchURL(null,t,n={responseType:"text"},function(e,t){r.loadCatalog(null,e,t)}));break;case"none":break;default:e.error("unknown analysis result type: "+s.rtype)}}}),this}e.error("could not find analysis task: "+t)}},e.Image.prototype.displayAnalysis=function(t,a,i){var s,r,n,o,l,c,p,d,h,g={x:"linear",y:"linear"};d=e.lightOpts[e.LIGHTWIN];var u=function(e){return 0===e?e:Math.log(e)},m=function(e){return 0===e?e:Math.exp(e)},f=function(e,t){var a,i,s;if(!e.text)return null;if(i=e.x||0,"%Y"===e.y.toUpperCase()){for(a=1;a<t.length-1;a++)if(t[a][0]>i){s=Math.max(t[a-1][1],t[a][1],t[a+1][1]);break}}else s=e.y;return{x:i,y:s}},y=function(t,a,i){var s,r,n,o=i.data,l=i.annotations.color||e.plotOpts.annotateColor;for(t.find(".plotAnnotation").remove(),s=0;s<i.annotations.data.length;s++)n=f(r=i.annotations.data[s],o),0>(n=a.pointOffset({x:n.x,y:n.y})).left||n.left>t.width()||(r=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",n.left,n.top+-25,l,"&darr;"+r.text),t.append(r))};if("string"==typeof i)try{i=JSON.parse(i)}catch(b){e.error("can't parse display opts: "+i,b)}switch(s=(i=i||{}).winformat,i.divid&&0<$("#"+i.divid).length&&(c=$("#"+i.divid)),l=i.title||"",this&&!l&&(l="AnalysisResults: "+(i=(i=this.fitsFile||this.id||"").split("/").reverse()[0])+sprintf(e.IDFMT,this.display.id)),i="Analysis_"+e.uniqueID(),t){case"text":a="<div class='JS9Analysis'></div><pre class='JS9AnalysisText'>"+(a||"")+"</pre></div>",c?c.html(a):r=e.lightWin(i,"inline",a,l,s=s||d.textWin);break;case"plot":if("string"==typeof a)try{n=JSON.parse(a)}catch(b){e.error("can't plot return data: "+a,b)}else"object"==typeof a&&(n=a);if(!n)return;if(a=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",i,i),c?c.html(a):r=e.lightWin(i,"inline",a,l,s=s||d.plotWin),o=$("#"+i+" #"+i+"Plot"),c&&(o.css("width",c.css("width")),o.css("height",c.css("height")),o.css("margin",0)),n.data){switch(e.globalOpts.plotLibrary){case"plotly":for(h=function(e,t,a,i){var s;switch(a){case"x":s={xaxis:{type:i,autorange:!0}};break;case"y":s={yaxis:{type:i,autorange:!0}}}Plotly.restyle(e.attr("id"),s)},d=$.extend(!0,{},e.plotOpts,n.opts),n.label&&(d.title=n.label),a={x:[],y:[],type:"scatter"},3<=n.data[0].length&&(a.error_y={type:"data",array:[],visible:!0},n.points&&n.points.yerr&&n.points.yerr.color&&(a.error_y.color=n.points.yerr.color)),s=0;s<n.data.length;s++)a.x.push(n.data[s][0]),a.y.push(n.data[s][1]),a.error_y&&a.error_y.array&&a.error_y.array.push(n.data[s][2]);e.plotOpts.annotate&&n.annotations&&(d.annotations=function(t){var a,i,s,r=t.data,n=t.annotations.color||e.plotOpts.annotateColor,o=[];for(a=0;a<t.annotations.data.length;a++)(s=f(i=t.annotations.data[a],r))&&o.push(i={x:s.x,y:s.y,xref:"x",yref:"y",text:i.text,arrowcolor:n,font:{color:n},showarrow:!0,arrowhead:2,ax:0,ay:-30});return o}(n)),"log"===d.xscale&&(d.xaxis=d.xaxis||{},d.xaxis.type="log",d.xaxis.autorange=!0,g.x="log"),"log"===d.yscale&&(d.yaxis=d.yaxis||{},d.yaxis.type="log",d.yaxis.autorange=!0,g.y="log");try{Plotly.newPlot(o.attr("id"),[a],d)}catch(b){e.error("can't plot data (plotly)",b)}break;default:h=function(e,t,a,i){switch(a){case"x":a=t.getAxes().xaxis;break;case"y":a=t.getAxes().yaxis}switch(i){case"linear":a.options.transform=null,a.options.inverseTransform=null;break;case"log":a.options.transform=u,a.options.inverseTransform=m}g[a]=i,t.setupGrid(),t.draw()},d=$.extend(!0,{},e.plotOpts,n.opts),e.plotOpts.annotate&&n.annotations&&(d.zoomStack.func=function(e,t){y(o,e,n)}),n.color=n.color||d.color,"log"===n.xscale&&(d.xaxis=d.xaxis||{},d.xaxis.transform=u,d.xaxis.inverseTransform=m,g.x="log"),"log"===n.yscale&&(d.yaxis=d.yaxis||{},d.yaxis.transform=u,d.yaxis.inverseTransform=m,g.y="log");try{p=$.plot(o,[n],d)}catch(b){e.error("can't plot data (flot)",b)}e.plotOpts.annotate&&n.annotations&&y(o,p,n)}o.css("outline","none"),o.attr("tabindex",0),o.on("keypress",function(e){if(e=String.fromCharCode(e.which||e.keyCode),"linear"===g[e])g[e]="log";else{if("log"!==g[e])return;g[e]="linear"}h(o,p,e,g[e])})}break;case"params":case"regions":case"textline":c?e.allinone?c.html(a):$.ajax({url:a,cache:!1,dataType:"text",success:function(e){c.html(e)}}):r=e.lightWin(i,r=e.allinone?"inline":"ajax",a,l,s="params"===t?s||d.paramWin:"regions"===t?"small"===e.globalOpts.regionConfigSize?s||d.regWin0:s||d.regWin:s||d.dpathWin)}return r},e.Image.prototype.loadAuxFile=function(t,a){var i,s,r,n,o=this,l=e.auxFiles.length,c=[],p=function(){if(o.aux[s.name]=s,e.Image.prototype.mkOffScreenCanvas.call(n),e.Image.prototype.mkRawDataFromPNG.call(n),a)try{e.xeqByName(a,window,o,s)}catch(t){e.error("in aux mask onload callback",t)}e.DEBUG&&e.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",n.type,n.file,n.raw.width,n.raw.height,n.raw.dmin,n.raw.dmax)},d=function(t){if(o.aux[s.name]=s,s.regions=t,a)try{e.xeqByName(a,window,o,s)}catch(i){e.error("in aux region onload callback",i)}},h=function(t){if(o.aux[s.name]=s,s.text=t,a)try{e.xeqByName(a,window,o,s)}catch(i){e.error("in aux text onload callback",i)}},g=function(t,a,i){e.log(sprintf("could not load auxiliary file: %s [%s]",s.url,a))};if(t&&l){for(i=0;i<l;i++)(s=e.auxFiles[i]).image&&!s.regex&&(s.regex=new RegExp(s.image));for(r=t.split(":"),i=0;i<l;i++)if(r[0]===(s=e.auxFiles[i]).name&&this.id.match(s.regex)&&(1===r.length||r[1]===s.type))switch(s.type){case"mask":if(s.im){if(this.aux[s.name]=s,a)try{e.xeqByName(a,window,this,s)}catch(u){e.error("in aux mask callback",u)}}else c.push(s);break;case"regions":if(s.layer){if(this.aux[s.name]=s,a)try{e.xeqByName(a,window,this,s)}catch(u){e.error("in aux regions callback",u)}}else c.push(s);break;case"text":if(s.text){if(this.aux[s.name]=s,a)try{e.xeqByName(a,window,this,s)}catch(u){e.error("in aux text callback",u)}}else c.push(s)}for(i=0;i<c.length;i++)switch(s=c[i],s.type){case"mask":s.im=Object.create(e.Image),(n=s.im).type="aux",n.file=s.url,n.id=n.file.split("/").reverse()[0],n.params={},n.params.scalemin=Number.NaN,n.params.scalemax=Number.NaN,n.raws=[],n.png={},n.png.image=new Image,$(n.png.image).on("load",p).on("error",g),n.png.image.src=e.InstallDir(s.url);break;case"regions":s.layer=this.display.newShapeLayer(t,e.Regions.opts),r=e.InstallDir(s.url),$.ajax({url:r,cache:!1,dataType:"json",mimeType:"application/json",success:d,error:g});break;case"text":r=e.InstallDir(s.url),$.ajax({url:r,cache:!1,dataType:"text",success:h,error:g})}}},e.Image.prototype.saveFITS=function(t){var a;return window.hasOwnProperty("saveAs")?(t=t?t.replace(/\.fz$/i,"").replace(/(png|jpg|jpeg)$/i,"fits"):"js9.fits",a=this.toArray({notab:!0,twoaxes:!0}),a=new Blob([a],{type:"application/octet-binary"}),saveAs(a,t)):e.error("no saveAs function available to save FITS file"),t},e.Image.prototype.saveIMG=function(t,a,i){var s,r,n,o,l,c;if(window.hasOwnProperty("saveAs")){if("number"==typeof i)c=i,i=null;else if("string"==typeof i){if(e.isNumber(i))c=parseFloat(i),i=null;else try{i=JSON.parse(i)}catch(p){i=null}i&&(c=i.quality)}if(t=t||"js9.png",a=a||"image/png",i=i||{},o=this.display.width,l=this.display.height,(r=document.createElement("canvas")).setAttribute("width",o),r.setAttribute("height",l),n=r.getContext("2d"),"image"===i.source?n.putImageData(this.rgb.img,0,0):n.drawImage(this.display.canvas,0,0),!1!==i.layers)for(s in this.layers)this.layers.hasOwnProperty(s)&&"main"===this.layers[s].dlayer.dtype&&this.layers[s].show&&n.drawImage(i=this.layers[s].dlayer.canvasjq[0],0,0,o,l);e.notNull(c)&&(0>c||1<c)&&(c=.95),r.toBlob(function(e){saveAs(e,t)},a,c)}else e.error("no saveAs function available for saving image");return t},e.Image.prototype.savePNG=function(e,t){return(e=e||"js9.png").match(/\.png$/)||(e+=".png"),this.saveIMG(e,"image/png",t)},e.Image.prototype.saveJPEG=function(e,t){return(e=e||"js9.jpg").match(/\.jpg$/)||e.match(/\.jpeg$/)||(e+=".jpg"),this.saveIMG(e,"image/jpeg",t)},e.Image.prototype.updateValpos=function(t,a){var i,s,r,n,o,l,c,p,d,h;i=null;var g=e.floatPrecision(this.params.scalemin,this.params.scalemax);if(r=function(e,t){var a,i="";for(t=t||3,0>e&&(e=Math.abs(e),i="-"),a=""+e;a.length<t;)a="0"+a;return i+a},this.params.valpos){if(void 0===a&&(a=!0),this.valpos)return a&&this.display.displayMessage("info",this.valpos,e.globalOpts.valposTarget),this.valpos;switch(l={x:t.x,y:t.y,sys:"image"},c="image"===this.params.wcssys?l:this.imageToLogicalPos(t),i=this.raw.data[Math.floor(t.y-.5)*this.raw.width+Math.floor(t.x-.5)],this.raw.bitpix){case 8:case 16:case-16:case 32:o=r(i);break;case-32:case-64:o=e.floatFormattedString(i,g,3);break;default:o=r(i)}s=(r=o)+"&nbsp;&nbsp;&nbsp;&nbsp;"+(n=c.x.toFixed(3)+" "+c.y.toFixed(3)+" ("+c.sys+")"),i={ix:l.x,iy:l.y,ipos:l.x.toFixed(2)+"\t\t "+l.y.toFixed(2),isys:"image",px:c.x,py:c.y,ppos:c.x.toFixed(2)+"\t\t "+c.y.toFixed(2),psys:c.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:i,val3:o,id:this.id,file:this.file,object:this.object},(this.telescope||this.instrument)&&(i.object+="  (",this.telescope&&(i.object+=this.telescope,this.instrument&&(i.object+=", ")),this.instrument&&(i.object+=this.instrument),i.object+=")"),0<this.raw.wcs&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys&&(s=r+"&nbsp;&nbsp;&nbsp;&nbsp;"+(s=(l=e.pix2wcs(this.raw.wcs,t.x,t.y).trim().split(/\s+/))[0]+" "+l[1]+" ("+(l[2]||"wcs")+")")+"&nbsp;&nbsp;&nbsp;&nbsp;"+n,i.ra=l[0],i.dec=l[1],i.wcspos=l[0]+"\t "+l[1],i.wcssys=l[2],this.raw.wcsinfo&&(l=Math.abs(this.raw.wcsinfo.cdelt1),p=Math.abs(this.raw.wcsinfo.cdelt2),c=1/60,1<=l||1<=p?o="deg":l>=c||p>=c?(o="'",l*=60,p*=60):(o='"',l*=3600,p*=3600),h=this.binning.bin,c=(((d=this.rgb.sect).x1-d.x0)*l).toFixed(0),p=((d.y1-d.y0)*p).toFixed(0),i.wcsfov=c+o+" x "+p+o,c=e.floatFormattedString(l*h/d.zoom,g,3),i.wcspix=c+o+" / pixel",i.wcsfovpix=i.wcsfov+"  ("+i.wcspix+")",l=e.pix2wcs(this.raw.wcs,(d.x1+d.x0)/2,(d.y1+d.y0)/2).trim().split(/\s+/),i.racen=l[0],i.deccen=l[1],i.wcscen=l[0]+"\t "+l[1])),i.vstrsmall=r+"&nbsp;&nbsp;&nbsp;&nbsp;"+n,i.vstr=s,i.vstrmedium=s,i.vstrlarge=s+"&nbsp;&nbsp;&nbsp;&nbsp;"+this.file,a&&this.display.displayMessage("info",i,e.globalOpts.valposTarget)}return i},e.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos,this.params.valpos||this.display.clearMessage()},e.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}},e.Image.prototype.setColormap=function(t,a,i){if(!(0<=$.inArray("colormap",this.params.disable)&&this.cmapObj)){switch(arguments.length){case 1:case 3:switch(t){case"rgb":e.globalOpts.rgb.active=!e.globalOpts.rgb.active;break;case"invert":this.params.invert=!this.params.invert;break;case"reset":this.params.invert=e.imageOpts.invert,this.params.contrast=e.imageOpts.contrast,this.params.bias=e.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case"red":this===e.globalOpts.rgb.rim&&(e.globalOpts.rgb.rim=null);break;case"green":this===e.globalOpts.rgb.gim&&(e.globalOpts.rgb.gim=null);break;case"blue":this===e.globalOpts.rgb.bim&&(e.globalOpts.rgb.bim=null)}switch(this.cmapObj=e.lookupColormap(t),this.params.colormap=this.cmapObj.name,t){case"red":e.globalOpts.rgb.rim=this;break;case"green":e.globalOpts.rgb.gim=this;break;case"blue":e.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(a)||(this.params.contrast=a),isNaN(i)||(this.params.bias=i));break;case 2:isNaN(t)||(this.params.contrast=t),isNaN(a)||(this.params.bias=a)}return this.displayImage("colors"),this.xeqstash&&this.xeqstash.filterRGBImage&&delete this.xeqstash.filterRGBImage,e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap"),this}},e.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}},e.Image.prototype.setScale=function(t,a,i){var s=this,r=function(t){0<=e.scales.indexOf(t)?s.params.scale=t:"dataminmax"===t?(s.params.scaleclipping="dataminmax",s.params.scalemin=s.raw.dmin,s.params.scalemax=s.raw.dmax):"zscale"===t?(void 0!==s.params.z1&&void 0!==s.params.z2||s.zscale(!1),s.params.scaleclipping="zscale",s.params.scalemin=s.params.z1,s.params.scalemax=s.params.z2):"zmax"===t?(void 0===s.params.z1&&s.zscale(!1),s.params.scaleclipping="zmax",s.params.scalemin=s.params.z1,s.params.scalemax=s.raw.dmax):"user"===t?s.params.scaleclipping="user":e.error("unknown scale: "+t)};if(!(0<=$.inArray("scale",this.params.disable))){if(arguments.length){switch(arguments.length){case 1:r(t);break;case 2:this.params.scalemin=parseFloat(t),this.params.scalemax=parseFloat(a),this.params.scaleclipping="user";break;default:r(t),"zscale"!==t&&"zmax"!==t&&(this.params.scalemin=parseFloat(a),this.params.scalemax=parseFloat(i),this.params.scaleclipping="user")}this.displayImage("colors")}return e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale"),this}},e.Image.prototype.getParam=function(e){return e?"all"===e?this.params:this.params[e]:null},e.Image.prototype.setParam=function(e,t){var a,i;if(!e)return null;if("all"===e&&"object"==typeof t)return $.extend(!0,this.params,t),(t.colormap||t.contrast||t.bias)&&(i=this.getColormap(),t.colormap=t.colormap||i.colormap,t.contrast=t.contrast||i.contrast,t.bias=t.bias||i.bias,this.setColormap(t.colormap,t.contrast,t.bias)),(t.scale||t.scalemin||t.scalemax)&&(i=this.getScale(),t.scale=t.scale||i.scale,t.scalemin=t.scalemin||i.scalemin,t.scalemax=t.scalemax||i.scalemax,this.setScale(t.scale,t.scalemin,t.scalemax)),t.invert&&(this.params.invert=t.invert,this.displayImage("colors")),t.zoom&&this.setZoom(t.zoom),t.wcssys&&this.setWCSSys(t.wcssys),t.wcsunits&&this.setWCSUnits(t.wcsunits),this.params;if("disable"===e){for($.isArray(t)||(t=[t]),a=0;a<t.length;a++)0>(i=$.inArray(t[a],this.params.disable))&&this.params.disable.push(t[a]);return this.params.disable}if("enable"===e){for($.isArray(t)||(t=[t]),a=0;a<t.length;a++)0<=(i=$.inArray(t[a],this.params.disable))&&this.params.disable.splice(i,1);return this.params.disable}switch(a=this.params[e],this.params[e]=t,e){case"colormap":this.setColormap(t);break;case"invert":this.displayImage("colors");break;case"contrast":i=this.getColormap(),this.setColormap(i.colormap,t,i.bias);break;case"bias":i=this.getColormap(),this.setColormap(i.colormap,i.contrast,t);break;case"scale":this.setScale(t);break;case"scalemin":i=this.getScale(),this.setScale("user",t,i.scalemax);break;case"scalemax":i=this.getScale(),this.setScale("user",i.scalemin,t);break;case"scaleclipping":i=this.getScale(),this.setScale(t,i.scalemin,i.scalemax);break;case"wcssys":this.setWCSSys(t);break;case"wcsunits":this.setWCSUnits(t);break;case"zoom":this.setZoom(t)}return a},e.Image.prototype.dataminmax=function(e,t){var a,i,s=isNaN(this.params.scalemin)||void 0===this.params.scalemin,r=isNaN(this.params.scalemax)||void 0===this.params.scalemax;if("dataminmax"===this.params.scaleclipping&&(this.raw.dmin!==this.params.scalemin&&void 0!==this.raw.dmin||(s=!0),this.raw.dmax!==this.params.scalemax&&void 0!==this.raw.dmax||(r=!0)),void 0!==e&&void 0!==t)this.raw.dmin=e,this.raw.dmax=t;else if(this.raw.dmin=Number.MAX_VALUE,this.raw.dmax=Number.MIN_VALUE,0<this.raw.bitpix)if(void 0!==this.raw.header.BLANK)for(i=this.raw.header.BLANK,a=0;a<this.raw.data.length;a++)this.raw.data[a]!==i&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));else for(a=0;a<this.raw.data.length;a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);else for(a=0;a<this.raw.data.length;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));return s&&(this.params.scalemin=this.raw.dmin),r&&(this.params.scalemax=this.raw.dmax),this},e.Image.prototype.zscale=function(t){var a,i,s;if(!e.zscale||!this.raw||!this.raw.data)return this;i=(a=this.raw.data).length*a.BYTES_PER_ELEMENT;try{s=e.vmalloc(i)}catch(r){e.error("image too large for zscale malloc: "+i,r)}try{e.vmemcpy(new Uint8Array(a.buffer),s)}catch(r){e.error("can't copy image to zscale heap: "+i,r)}return a=e.zscale(s,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline),e.vfree(s),s=a.trim().split(/\s+/),this.params.z1=parseFloat(s[0]),this.params.z2=parseFloat(s[1]),"zmax"===t?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):t&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2),this},e.Image.prototype.countsInRegions=function(t){var a,i,s,r,n,o=this,l="field",c="";for(r=function(t,a,i){var s,r;if(s=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/,!t)return i;if("string"==typeof t){if(!(a=o.expandMacro(t)))return i;if(a.match(s))return a}for((s=o.getShapes("regions",t))&&s.length||e.error("no regions found: "+t),a="",t=0;t<s.length;t++)r=s[t],o.params.wcssys?(a||(a=r.wcssys||""),a+=sprintf("; %s",r.wcsstr)):(a||(a=r.imsys||""),a+=sprintf("; %s",r.imstr));return a||i},this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||e.error("no virtual file available for regcnts: "+this.id),a=0;a<arguments.length;a++)if("string"==typeof(i=arguments[a])&&"{"===i.charAt(0))try{arguments[a]=JSON.parse(i)}catch(p){e.error("can't parse json arg in regcnts: "+i,p)}switch(arguments.length){case 0:break;case 1:"object"==typeof arguments[0]?n=arguments[0]:l=r(arguments[0],"$sregions","field");break;case 2:l=r(arguments[0],"$sregions","field"),"object"==typeof arguments[1]?n=arguments[1]:c=r(arguments[1],"$bregions","");break;default:l=r(arguments[0],"$sregions","field"),c=r(arguments[1],"$bregions",""),n=arguments[2]}return(n=n||{}).reduce=n.reduce||e.globalOpts.reduceRegcnts,n.dim=n.dim||Math.max(e.globalOpts.image.xdim,e.globalOpts.image.ydim),i=n.cmdswitches||"",a=this.raw.hdu.fits.vfile,(r=this.file.match(/\[.*\]/))&&(a+=r),"table"===this.imtab?(r=this.raw.hdu.table.filter)&&!a.match(r)&&(a=a.match(/\]\[/)?a.slice(0,-1)+"&&"+r+"]":a+"["+r+"]"):3===this.raw.header.NAXIS&&0>i.search(/(^| )-c/)&&(i+=sprintf(" -c %s",this.raw.hdu.slice||1)),n.reduce&&!this.parentFile&&(r=this.fileDimensions(),1<(r=Math.floor(Math.max(r.xdim,r.ydim)/n.dim+.5))&&("table"===this.imtab?i+=sprintf(" -b %s",r):(s=sprintf("bin%s_%s",r,a.split("/").reverse()[0]),r=sprintf("0@0,0@0,%s",r),e.imsection(a,s,r,""),a=s))),e.waiting(!0,this.display),i=e.regcnts(a,l,c,i),e.waiting(!1),s&&e.vunlink(s),(i.match(/^ERROR/)||i.match(/FITSIO status/))&&e.error(i),n.lightwin&&this.displayAnalysis("text",i,{divid:e.globalOpts.analysisDiv}),i},e.Image.prototype.radialProfile=function(t){var a,i,s,r,n,o;for(n=[],o={cmdswitches:"-j -r"},a=0;a<arguments.length;a++)"object"==typeof arguments[a]?(i=$.extend(!0,{},arguments[a],o),n.push(i),r=i):n.push(arguments[a]);i||n.push(o),r=r||{},a=e.Image.prototype.countsInRegions.apply(this,n);try{s=JSON.parse(a)}catch(l){e.error("can't parse regcnts JSON",l)}for(s.columnUnits.radii||e.error("no radii available for radial profile"),a=s.columnUnits.radii,i=s.columnUnits.surfBrightness,n=r.color||"green",o=r.errorcolor||"red",r=e.isNull(r.errorbars)||r.errorbars?"y":"n",r={color:sprintf("%s",n),label:sprintf("surface brightness(%s) vs. radius(%s)",i,a),points:{errorbars:sprintf("%s",r),yerr:{show:"true",color:sprintf("%s",o)}},data:[]},a=0;a<s.backgroundSubtractedResults.length;a++)("undefined"===(i=s.backgroundSubtractedResults[a]).radius2||"NA"===i.radius2||i.radius1>i.radius2)&&e.error("radial profile source region must be an annulus"),r.data.push(i=[(i.radius1+i.radius2)/2,i.surfBrightness,i.surfError]);return this.displayAnalysis("plot",r,{divid:e.globalOpts.analysisDiv})},e.Image.prototype.plot3d=function(t,a,i){var s,r,n,o,l,c,p=[];for(this.raw.header&&3===this.raw.header.NAXIS||e.error("plot3d requires a data cube with 3 dimensions"),(i=$.extend(!0,{},i,e.globalOpts.plot3d)).cube=i.cube||"*:*:all",n=i.cube.split(":"),s=0;s<n.length;s++)if("all"===n[s]){l=s+1;break}l||e.error("plot3d requires specification of cube's third index"),i.cmdswitches=sprintf("-j -c %s",i.cube),n=i.mode||"avg",i.areaunits?i.areaunits.match(/^p/)?(i.areaunits="pixels",i.cmdswitches+=" -p"):i.areaunits.match(/^a/)?i.areaunits="arcsec":(i.areaunits="pixels",i.cmdswitches+=" -p"):(i.areaunits="pixels",i.cmdswitches+=" -p"),s=i.color||"green",t=this.countsInRegions(t,a,i);try{o=JSON.parse(t)}catch(d){e.error("can't parse regcnts results: "+t,d)}for(t=(t=this.raw.header["CTYPE"+String(l)])?sprintf("%s",t.toLowerCase()):"slice",a="avg"===n?"pixels"===i.areaunits?"counts/pixel**2":"counts/arcsec**2":sprintf("summed counts"),a={color:sprintf("%s",s),label:sprintf("%s vs %s ",a,t),data:[]},c=this.raw.header["CRVAL"+String(l)]||0,l=this.raw.header["CDELT"+String(l)]||1,s=0;s<o.source.cubeSlices;s++){for(t="backgroundSubtractedResults"+String(s+1),r=p[s]=0;r<o[t].length;r++)p[s]="avg"===n?p[s]+o[t][r].surfBrightness:p[s]+o[t][r].netCounts;a.data.push(t=[s*l+c,p[s]])}return this.displayAnalysis("plot",a,{divid:i.divid||e.globalOpts.analysisDiv})},e.Image.prototype.rawDataLayer=function(t,a){var i,s,r,n,o,l;if(!arguments.length)return this.raw.id;if("string"==typeof t){if("function"!=typeof a){for(r=t,i=0;i<this.raws.length;i++)if(r===(n=this.raws[i]).id){if("remove"===a){if(r===e.RAWID0&&e.error("can't remove primary (raw0) data layer"),n.hdu&&n.hdu.fits&&1>=(s=e.lookupVfile(n.hdu.fits.vfile)).length&&e.cleanupFITSFile(n,!0),this.raw=this.raws[0],n.current0&&n.current0.id)for(s=0;s<this.raws.length;s++)if(n.current0.id===this.raws[s].id){this.raw=this.raws[s];break}for(s=0;s<e.images.length;s++)if((n=e.images[s]).xeqstash)for(o in n.xeqstash)n.xeqstash.hasOwnProperty(o)&&n.xeqstash[o].id===r&&delete n.xeqstash[o];this.raws.splice(i,1)}else this.raw=n;return this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX),this.imtab=this.raw.imtab||this.imtab,this.dataminmax(),this.mkSection(),this.initWCS(),this.initLCS(),this.displayImage("all"),this.refreshLayers(),e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer"),!0}return!1}t={rawid:t}}if("function"!=typeof a)return!1;if("string"==typeof t)try{t=JSON.parse(t)}catch(c){e.error("can't parse rawData opts: "+t,c)}if(o=(t=t||{}).rawid||e.RAWIDX,void 0===t.oraw&&(t.oraw="current0"),"current"===t.oraw)r=this.raw;else if("current0"===t.oraw)r=this.raw.id===o?this.raw.current0:this.raw;else for(i=0;i<this.raws.length;i++)if(t.oraw===(n=this.raws[i]).id){r=n;break}for(r||(r=this.raws[0]),n=-1,i=0;i<this.raws.length;i++)if(o===this.raws[i].id){s=this.raws[i],n=i;break}if(0>n||t.alwaysCopy){if((s=$.extend(!0,{},r)).current0=r,t.bitpix){switch(t.bitpix){case 8:s.data=new Uint8Array(r.height*r.width);break;case 16:s.data=new Int16Array(r.height*r.width);break;case-16:s.data=new Uint16Array(r.height*r.width);break;case 32:s.data=new Int32Array(r.height*r.width);break;case-32:s.data=new Float32Array(r.height*r.width);break;case-64:s.data=new Float64Array(r.height*r.width)}for(l=s.width*s.height,i=0;i<l;i++)s.data[i]=r.data[i];s.bitpix=t.bitpix}else switch(r.bitpix){case 8:s.data=new Uint8Array(r.data);break;case 16:s.data=new Int16Array(r.data);break;case-16:s.data=new Uint16Array(r.data);break;case 32:s.data=new Int32Array(r.data);break;case-32:s.data=new Float32Array(r.data);break;case-64:s.data=new Float64Array(r.data)}s.id=o,s.from=t.from||s.from||"func"}return a.call(this,r,s,t)&&(0<=n?this.raws[n]=s:this.raws.push(s),this.raw=s,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==t.dataminmax&&this.dataminmax(),this.displayImage("all",t)),!0},e.Image.prototype.gaussBlurData=function(t){var a={};if(void 0===t&&e.error("missing sigma value for gaussBlurData"),this.params.sigma=t,"string"==typeof a)try{a=JSON.parse(a)}catch(i){e.error("can't parse gaussBlur opts: "+a,i)}return(a=a||{}).bitpix=-64===this.raw.bitpix?-64:-32,a.oraw="current0",a.alwaysCopy=!0,a.rawid=a.rawid||"gaussBlur",a.sigma=t,this.xeqStashSave("gaussBlurData",Array.prototype.slice.call(arguments),a.rawid),this.rawDataLayer(a,function(a,i){var s;switch(i.bitpix){case-32:s=new Float32Array(i.data);break;case-64:s=new Float64Array(i.data);break;default:e.error("invalid temp bitpix for gaussBlur: "+i.bitpix)}return gaussBlur(s,i.data,i.width,i.height,t),!0}),this},e.Image.prototype.imarithData=function(t,a,i){var s;if(!arguments.length)return"add sub mul div min max reset".split(" ");if("string"==typeof i)try{i=JSON.parse(i)}catch(r){e.error("can't parse imarith opts: "+i,r)}if((i=i||{}).rawid=i.rawid||"imarith","reset"!==t&&"remove"!==t){switch(void 0!==t&&void 0!==a||e.error("missing arg(s) for image arithmetic"),this.xeqStashSave("imarithData",Array.prototype.slice.call(arguments),i.rawid),t){case"add":case"sub":case"mul":case"div":case"min":case"max":i.op=t;break;default:e.error("invalid operator for image arithmetic: "+t)}if("object"==typeof a?(this.raw.width===a.raw.width&&this.raw.height===a.raw.height||e.error("images must be the same size for image arithmetic"),i.argtype="image",i.argval=a):e.isNumber(a)?(i.argtype="value",i.argval=a):((s=e.lookupImage(a))||e.error("imarith arg1 must be an image or a constant: "+a),i.argval=s,i.argtype="image"),"div"===i.op&&"value"===i.argtype&&0===i.argval&&e.error("imarith can't divide by zero (nor can anyone else)"),!i.bitpix)switch(i.argtype){case"image":i.bitpix=0<this.raw.bitpix&&0<i.argval.raw.bitpix?Math.max(this.raw.bitpix,i.argval.raw.bitpix):0>this.raw.bitpix&&0>i.argval.raw.bitpix?Math.min(this.raw.bitpix,i.argval.raw.bitpix):0>this.raw.bitpix&&0<i.argval.raw.bitpix?this.raw.bitpix:i.argval.raw.bitpix;break;case"value":i.bitpix=-64===this.raw.bitpix?-64:-32}return i.alwaysCopy=!0,i.oraw="current",this.rawDataLayer(i,function(t,a,i){switch(i.argtype){case"image":switch(t=i.argval.raw.data,i.op){case"add":for(i=0;i<a.data.length;i++)a.data[i]+=t[i];break;case"sub":for(i=0;i<a.data.length;i++)a.data[i]-=t[i];break;case"mul":for(i=0;i<a.data.length;i++)a.data[i]*=t[i];break;case"div":for(i=0;i<a.data.length;i++)a.data[i]=0===t[i]?0:a.data[i]/t[i];break;case"min":for(i=0;i<a.data.length;i++)a.data[i]=Math.min(a.data[i],t[i]);break;case"max":for(i=0;i<a.data.length;i++)a.data[i]=Math.max(a.data[i],t[i]);break;default:e.error("unknown operation for imarith: "+i.op)}break;case"value":switch(t=i.argval,i.op){case"add":for(i=0;i<a.data.length;i++)a.data[i]+=t;break;case"sub":for(i=0;i<a.data.length;i++)a.data[i]-=t;break;case"mul":for(i=0;i<a.data.length;i++)a.data[i]*=t;break;case"div":for(i=0;i<a.data.length;i++)a.data[i]=0===t?0:a.data[i]/t;break;case"min":for(i=0;i<a.data.length;i++)a.data[i]=Math.min(a.data[i],t);break;case"max":for(i=0;i<a.data.length;i++)a.data[i]=Math.max(a.data[i],t);break;default:e.error("unknown op for imarith: "+i.op)}break;default:e.error("unknown argument type for imarith: "+i.argtype)}return!0}),this}this.rawDataLayer(i.rawid,"remove")},e.Image.prototype.shiftData=function(t,a,i){if(void 0!==t&&void 0!==a||e.error("missing translation value(s) for shiftData"),"string"==typeof i)try{i=JSON.parse(i)}catch(s){e.error("can't parse shift opts: "+i,s)}return(i=i||{}).rawid=i.rawid||"shift",i.x=t,i.y=a,this.xeqStashSave("shiftData",Array.prototype.slice.call(arguments),i.rawid),this.rawDataLayer(i,function(e,t,a){var i,s,r,n,o=e.data.BYTES_PER_ELEMENT;if(void 0===t.xoff&&(t.xoff=0),void 0===t.yoff&&(t.yoff=0),t.xoff+=a.x,t.yoff+=a.y,!a.fill||"clear"===a.fill)if(0<t.bitpix?t.header.BLANK=n=a.blank||t.header.BLANK||0:n=NaN,"function"==typeof t.data.fill)t.data.fill(n);else for(a=0;a<t.data.length;a++)t.data[a]=n;for(a=0;a<e.height;a++)if(!(0>(r=a+t.yoff)||r>=e.height)){if(n=e.width,0>(s=(i=0)+t.xoff)&&(i-=s,n+=s,s=0),s+n>e.width&&(n-=s+n-e.width),0>=n)return!1;i=(a*e.width+i)*o,i=new Uint8Array(e.data.buffer,i,n*o),s=(r*e.width+s)*o,(n=new Uint8Array(t.data.buffer,s,n*o)).set(i)}return!0}),this},e.Image.prototype.rotateData=function(t,a){var i,s,r,n,o,l,c=0,p=0;if(this.raws&&this.raws[0]||e.error("no raw data for reprojection"),(i=this.raws[0]).header&&i.wcsinfo||e.error("no WCS info available for reprojection"),"string"==typeof a)try{a=JSON.parse(a)}catch(d){e.error("can't parse rotate opts: "+a,d)}if((a=a||{}).stash="rotateData",a.rawid="rotate",a.oraw=e.RAWID0,!0!==a.resetSection&&(a.resetSection=!1),s=i.header,r=$.extend(!0,{},s),i.width&&i.height&&(r.NAXIS1=i.width,r.NAXIS2=i.height),i.wcsinfo&&(c=i.wcsinfo.cdelt1||0,p=i.wcsinfo.cdelt2||0),"string"==typeof t)switch(t.toLowerCase()){case"northisup":case"northup":t=0,0<c&&(c=-c),0>p&&(p=-p)}return o=-(n=t)*Math.PI/180,l=Math.sin(o),o=Math.cos(o),e.isNull(s.CD1_1)?(r.CROTA2=n,r.CDELT1=c,r.CDELT2=p):(r.CD1_1=c*o,r.CD1_2=-p*l,r.CD2_1=c*l,r.CD2_2=p*o),i.wcsinfo&&(r.ptype=i.wcsinfo.ptype),this.xeqStashSave("rotateData",Array.prototype.slice.call(arguments),a.rawid),this.reprojectData(r,a)},e.Image.prototype.reproject=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m,f,y,b,S,v={},w=!1;b=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/,h=/TAN|SIN|ZEA|STG|ARC/;var x=function(t,a){var i;return a?(i=$.extend(!0,{},t),e.isNull(i.CRVAL1)&&!e.isNull(a.crval1)&&(i.CRVAL1=a.crval1),e.isNull(i.CRVAL2)&&!e.isNull(a.crval2)&&(i.CRVAL2=a.crval2),e.isNull(i.CRPIX1)&&!e.isNull(a.crpix1)&&(i.CRPIX1=a.crpix1),e.isNull(i.CRPIX2)&&!e.isNull(a.crpix2)&&(i.CRPIX2=a.crpix2),e.isNull(i.CDELT1)&&!e.isNull(a.cdelt1)&&(i.CDELT1=a.cdelt1),e.isNull(i.CDELT2)&&!e.isNull(a.cdelt2)&&(i.CDELT2=a.cdelt2),e.isNull(i.CROTA2)&&!e.isNull(a.crot)&&(i.CROTA2=a.crot),i):t};if(e.reproject&&t&&this!==t){for(o in this.raws&&this.raws[0]||e.error("no raw data for reprojection"),(g=this.raws[0]).header&&g.wcsinfo||e.error("no WCS info available for reprojection"),a=a||{},n=$.extend(!0,{},g.header))n.hasOwnProperty(o)&&b.test(o)&&delete n[o];if("object"==typeof t){for(o in t.raw&&t.raw.header?l=t.raw.header:t.BITPIX&&t.NAXIS1&&t.NAXIS2?l=t:e.error("invalid wcs object input to reproject()"),l)l.hasOwnProperty(o)&&b.test(o)&&(v[o]=l[o]);if(!(n=$.extend(!0,{},v,n)).NAXIS||!n.NAXIS1||!n.NAXIS2)return;o=e.raw2FITS(n,{addcr:!0}),v="wcs_"+e.uniqueID()+".txt",e.vfile(v,o),S=(o=e.globalOpts.reproj.xdim||e.globalOpts.image.xdim)*(b=e.globalOpts.reproj.ydim||e.globalOpts.image.ydim)*32,(n.NAXIS1*n.NAXIS2*Math.abs(n.BITPIX)>S||g.header.NAXIS1*g.header.NAXIS2*Math.abs(g.header.BITPIX)>S)&&e.error("the max reproject size is "+o+" * "+b+" * 4 bytes/pixel. You can use the Bin/Filter/Section plugin to extract a section, then save it as FITS and reproject the smaller image.")}else v=t;try{h.test(g.wcsinfo.ptype)||(c=x(g.header,g.wcsinfo),r="owcs_"+e.uniqueID()+".txt",e.vfile(r,e.raw2FITS(c,{addcr:!0})),i="awcs_"+e.uniqueID()+".txt",d=e.tanhdr(r,i,""),1<e.DEBUG&&e.log("tanhdr (input): %s %s -> %s",r,i,d),e.vunlink(r),0<=d.search(/\[struct stat="OK"/)&&(a.cmdswitches=a.cmdswitches||"",a.cmdswitches+=" -i "+i)),(t.raw&&!h.test(t.raw.wcsinfo.ptype)||t.ptype&&!h.test(t.ptype))&&(c=x(l,t.raw.wcsinfo),r="owcs_"+e.uniqueID()+".txt",e.vfile(r,e.raw2FITS(c,{addcr:!0})),s="awcs_"+e.uniqueID()+".txt",d=e.tanhdr(r,s,""),1<e.DEBUG&&e.log("tanhdr (reproj): %s %s -> %s",r,s,d),e.vunlink(r),0<=d.search(/\[struct stat="OK"/)&&(e.vunlink(v),v=s))}catch(J){}for(g.hdu&&g.hdu.fits.vfile?(s=g.hdu.fits.vfile,g.hdu.fits.extname?s+=sprintf("[%s]",g.hdu.fits.extname):g.hdu.fits.extnum&&0<g.hdu.fits.extnum&&(s+=sprintf("[%s]",g.hdu.fits.extnum))):(p=this.toArray(),s=this.id.replace(/\.png$/,"_png.fits"),e.vfile(s,p)),r=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,"").replace(/\.gz$/i,""),r="reproj_"+e.uniqueID()+"_"+r,c=a.rawid||"reproject",l=0;l<this.raws.length&&((h=this.raws[l]).id!==c||!e.cleanupFITSFile(h,!0));l++);g.hdu&&"table"===g.hdu.imtab&&g.hdu.table&&!s.match(/\[bin /)&&(s.match(/\[EVENTS\]/)||(s+="[EVENTS]"),h=g.hdu.table,g=Math.floor(h.xcen-h.xdim/2+1),l=Math.floor(h.xcen+h.xdim/2),c=Math.floor(h.ycen-h.ydim/2+1),h=Math.floor(h.ycen+h.ydim/2),s+=sprintf("[bin X=%s:%s,Y=%s:%s]",g,l,c,h));try{0<=(u=r.lastIndexOf("."))&&(m=r.substring(0,u)+"_area"+r.substring(u)),y=a.cmdswitches||"",d=e.reproject(s,r,v,y+=" -a 0 "+e.globalOpts.reprojSwitches),1<e.DEBUG&&e.log("reproject: %s %s %s [%s] -> %s",s,r,v,y,d),e.vunlink(m),e.vunlink(v),i&&e.vunlink(i),p&&e.vunlink(s),0>d.search(/\[struct stat="OK"/)&&(w=!0,(f=d.match(/msg="(.*)"/))&&f[1]?e.error(f[1]+" (from mProjectPP)"):e.error(d))}catch(J){if(w)return;e.vunlink(m),e.vunlink(v),d?e.error(d):e.error("WCS reproject failed",J)}return r}},e.Image.prototype.reprojectData=function(t,a){var i,s,r=this;if(t&&e.reproject&&("string"==typeof t&&((i=e.getImage(t))?t=i:e.error("unknown WCS for reproject: "+t)),this!==t)){if("string"==typeof(a=a||{}))try{a=JSON.parse(a)}catch(n){e.error("can't parse reproject opts: "+a,n)}return a.rawid||this.xeqStashSave("reprojectData",Array.prototype.slice.call(arguments),"reproject"),a.stash||(a.stash="reprojectData"),e.waiting(!0,this.display),window.setTimeout(function(){var i,n;if(n=function(e){r.xeqPlugins("image","onreprojectdata"),(i=i||{}).refreshRegions=!0,!1!==a.resetSection&&(i.resetSection=!0),r.refreshImage(e,i),r.xeqStashCall(r.xeqstash,[a.stash,"reprojectData"])},n=(a=a||{}).reprojHandler||n,s=r.reproject(t,a)){(i=$.extend(!0,{},e.fits.options,a)).rawid=i.rawid||"reproject",t.raw&&t.raw.header&&(i.wcsim=t);try{e.handleFITSFile(s,i,n)}catch(o){e.error("can't process reprojected FITS file",o)}}},e.SPINOUT),this}},e.Image.prototype.filterRGBImage=function(t){var a,i=[],s=Array.prototype.slice.call(arguments);if(!t){for(a in e.ImageFilters)e.ImageFilters.hasOwnProperty(a)&&i.push(a);return i}if("reset"===t||e.ImageFilters[t]||e.error("JS9 image filter '"+t+"' not available"),"reset"===t)return this.setColormap("reset"),this;this.xeqStashSave("filterRGBImage",Array.prototype.slice.call(arguments)),s.shift(),s.unshift(this.display.context,this.rgb.img);try{e.ImageFilters[t].apply(null,s)}catch(r){e.error("JS9 image filter '"+t+"' failed",r)}return this.displayImage("display"),e.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage"),this},e.Image.prototype.moveToDisplay=function(t){var a,i,s,r=0,n=this.display;if(i=e.lookupDisplay(t),!t||!i)return e.error("could not find display: "+t),null;for(a in this.display.clearMessage(),this.display.context.clear(),this.xeqPlugins("image","onimageclear"),n.layers)n.layers.hasOwnProperty(a)&&("main"!==n.layers[a].dtype||i.layers[a]||i.newShapeLayer(a,n.layers[a].opts));if(i.image)for(a in i.layers)i.layers.hasOwnProperty(a)&&"main"===i.layers[a].dtype&&i.image.showShapeLayer(a,!1,{local:!0});for(a in this.layers)this.layers.hasOwnProperty(a)&&(t=this.layers[a],(s=i.layers[a])?(this.showShapeLayer(a,!1,{local:!0}),t.dlayer=s,t.divjq=s.divjq,t.canvasjq=s.canvasjq,t.canvas=s.canvas):delete this.layers[a]);for(a in this.display=i,this.display.image=this,this.mkSection(),this.displayImage("all"),this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0,{local:!0});for(this.refreshLayers(),n.image=null,a=0;a<e.images.length;a++)if(n===(i=e.images[a]).display){i.display.image=null,i.displayImage("all"),i.refreshLayers(),r++;break}return!r&&n.winid&&n.winid.close&&(0<=(a=$.inArray(n,e.displays))&&e.displays.splice(a,1),n.winid.close()),this},e.Image.prototype.saveSession=function(t,a){var i,s,r,n,o,l,c,p,d,h,g=function(){var e={};for(c in e.file=this.file,e.dwidth=this.display.width,e.dheight=this.display.height,e.params=$.extend(!0,{},this.params),e.tmp={},"active"===this.tmp.gridStatus&&(e.tmp.gridStatus="active"),d=this.imageToLogicalPos({x:this.rgb.sect.xcen,y:this.rgb.sect.ycen}),(h=this.maybePhysicalToImage(d))&&(d=h),e.sect={},e.sect.xcen=d.x,e.sect.ycen=d.y,e.sect.xdim=this.raw.width,e.sect.ydim=this.raw.height,e.sect.zoom=this.rgb.sect.zoom,e.layers=[],this.layers)this.layers.hasOwnProperty(c)&&"main"===(o=(n=this.layers[c]).dlayer).dtype&&"crosshair"!==c&&"grid"!==c&&((l={}).name=c,l.json=o.canvas.toJSON(o.el),l.dopts=$.extend(!0,{},o.opts),n.catalog&&(l.catalog=n.catalog),n.starbase&&(l.starbase=JSON.stringify(n.starbase)),e.layers.push(l));return e.blend=this.blend,e.xeqstash=this.xeqstash,this.wcsim&&this.wcsim.id&&(e.wcsim=this.wcsim.id),e.params.display&&delete e.params.display,e.params.crosshair=!1,e};if(window.hasOwnProperty("saveAs")||e.error("no saveAs function available to save session"),(t=t||"js9.ses").match(/\.ses$/)||(t+=".ses"),"string"==typeof a)try{a=JSON.parse(a)}catch(u){e.error("can't parse session opts: "+a,u)}if(a=a||{},e.waiting(!0,this.display),s={images:[]},"display"===a.mode)for(i=0;i<e.images.length;i++)(p=e.images[i]).display.id===this.display.id&&s.images.push(g.call(p));else s.images.push(g.call(this));for(s.display={blendMode:this.display.blendMode},s.globals=$.extend(!0,{},e.globalOpts),delete s.globals.rgb,s.cmaps=[],i=0;i<e.colormaps.length;i++)"user"===e.colormaps[i].source&&s.cmaps.push(e.colormaps[i]);try{r=JSON.stringify(s,null,4)}catch(u){e.error("can't create json file for save session",u)}return i=new Blob([r],{type:"application/json"}),saveAs(i,t),e.waiting(!1),t},e.Image.prototype.xeqStashSave=function(t,a,i,s){var r,n;for(s=s||"image",this.xeqstash=this.xeqstash||{},r=0;r<a.length;r++)"object"==typeof a[r]&&(a[r]instanceof e.Image?a[r]=a[r].id:a[r]instanceof e.Display&&(a[r]=a[r].id));for(r=0;r<this.xeqstash.length;r++)if((n=this.xeqstash[r]).func===t&&n.context===s)return n.args=a,this;return this.xeqstash[t]={args:a,id:i,context:s},this},e.Image.prototype.xeqStashCall=function(t,a){var i,s;for(i in t=t||this.xeqstash)if(t.hasOwnProperty(i)&&!(0<=$.inArray(i,a))){(s=t[i]).context=s.context||"image";try{switch(s.context){case"image":this[i].apply(this,s.args);break;case"display":this.display[i].apply(this.display,s.args);break;default:this[i].apply(this,s.args)}}catch(r){e.error("error executing stash: "+i,r,!1)}}},e.Image.prototype.xeqPlugins=function(t,a,i){var s,r,n,o,l,c=function(e,t){var a="JS9:"+e;$(document).trigger(a,t)};if(t&&a&&e.globalOpts.xeqPlugins){for(s in o=this.display.pluginInstances)if(o.hasOwnProperty(s)&&(n=(r=o[s]).plugin.opts,r.isActive(a)&&"function"==typeof n[a])){switch(this.callingPlugin=a,t){case"image":try{n[a].call(r,this),c(a,{im:this})}catch(p){r.errLog(a,p)}break;case"region":case"shape":try{n[a].call(r,this,i),c(a,{im:this,xreg:i})}catch(p){r.errLog(a,p)}break;case"keypress":l=i.originalEvent||i;try{n[a].call(r,this,this.ipos,l),c(a,{im:this,ipos:this.ipos,evt:l})}catch(p){r.errLog(a,p)}break;case"mouse":if(!this.clickInRegion||n[a+"_inRegion"]){l=i.originalEvent||i;try{n[a].call(r,this,this.ipos,l),c(a,{im:this,ipos:this.ipos,evt:l})}catch(p){r.errLog(a,p)}}}delete this.callingPlugin}return this}},e.Image.prototype.uploadFITSFile=function(){var t,a,i=this,s=function(t){delete i.tmp.upload,window.setTimeout(function(){e.progress(!1)},1e3),t.stderr?e.error(t.stderr):t.stdout&&(i.fitsFile=t.stdout.trim(),i.proxyFile=i.fitsFile,e.globalOpts.prependJS9Dir&&!i.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==i.fitsFile.charAt(0)&&(i.fitsFile="${JS9_DIR}/"+i.fitsFile),i.queryHelper("all"))};if(e.worker&&("nodejs"===e.helper.type||"socket.io"===e.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile)return this.tmp.upload&&e.error("only one upload allowed at a time"),t=this.raw.hdu.fits.vfile,e.helper.send("quotacheck",null,function(r){(r.stderr||r.errcode)&&e.error(r.stderr||"from quotacheck: "+r.errcode),a=e.vread(t,"binary"),e.worker.socketio(function(){i.tmp.upload=!0,e.progress(!0,i.display),e.worker.postMessage("uploadFITS",[t,a],s,[a.buffer])})}),this},e.Image.prototype.removeProxyFile=function(t){var a,i,s=this;if("boolean"==typeof t)i=t;else if("string"==typeof t){if(t.match(/^\//))return;if(a=new RegExp("^"+e.INSTALLDIR),(a=t.replace(a,"")).match(/\.\./))return;a=t}else{if(!this.proxyFile)return;a=this.proxyFile}a&&e.Send("removeproxy",{cmd:"js9Xeq removeproxy "+a},function(e){i&&e&&"OK"===e.stdout.trim()&&(s.proxyFile=null,s.fitsFile=null,s.analysisPackages=null,s.queryHelper("all"))})},e.Image.prototype.starbaseToShapes=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m,f,y,b,S;h=e.globalOpts.catalogs.ras,i=e.globalOpts.catalogs.decs;var v=[],w=e.globalOpts.catalogs,x=function(t,a,i){return(t=e.wcs2pix(t.raw.wcs,a,i).trim().split(/ +/))&&t.length?{x:parseFloat(t[0]),y:parseFloat(t[1])}:null};if(s=function(e,t,a,i){var s,r;if(void 0!==i)r=i;else{for(r=-1,s=0;s<a.length;s++){for(i=0;i<t.length;i++)if(a[s].toLowerCase()===t[i].toLowerCase()){r=e[t[i]];break}if(0<=r)break}if(0>r)for(b=a[0],S=new RegExp("^"+b,"i"),i=0;i<t.length;i++)if(t[i].match(S)){r=e[t[i]];break}if(0>r)for(b=a[0],S=new RegExp(".*"+b+".*","i"),i=0;i<t.length;i++)if(t[i].match(S)){r=e[t[i]];break}}return r},t&&t.data&&t.headline){switch(l=t.data,p=t.delims,0>(h=s(t,c=t.headline,h,(a=a||{}).xcol))&&e.error("can't find an RA column (see Preferences:catalogs)"),0>(g=s(t,c,i,a.ycol))&&e.error("can't find a Dec column (see Preferences:catalogs)"),n=a.shape||w.shape||"circle"){case"box":d=function(e,t,i){return{width:a.width||w.width||7,height:a.height||w.height||7}};break;case"circle":d=function(e,t,i){return{radius:a.radius||w.radius||3.5}};break;case"ellipse":d=function(e,t,i){return{r1:a.r1||w.r1||3.5,r2:a.r2||w.r2||3.5}};break;default:d=function(e,t,i){return{width:a.width||7,height:a.height||7}}}for(f=this.getWCSSys(),this.setWCSSys(y=a.wcssys?a.wcssys:w.wcssys?w.wcssys:"ICRS"),s=i=0;i<l.length;i++)if(u=l[i][h],m=l[i][g],"\0"!==p[h]&&0<=":h ".indexOf(p[h])&&"galactic"!==y&&"ecliptic"!==y&&(u*=15),r=x(this,u,m)){if(o=d.call(this,l[i][1],l[i][1]),o={id:i.toString(),shape:n,x:r.x,y:r.y,width:o.width,height:o.height,radius:o.radius,r1:o.r1,r2:o.r2,angle:0,data:{ra:u,dec:m}},!1!==a.save&&!1!==e.globalOpts.catalogs.save)for(r=0;r<=c.length;r++)c[r]&&(o.data[c[r]]=l[i][r]);a.color&&(o.color=a.color),v[s++]=o}return this.setWCSSys(f),v}},e.Image.prototype.loadCatalog=function(t,a,i){var s,r,n=$.extend(!0,{},e.Catalogs.opts);if(s=e.globalOpts.catalogs,1===arguments.length&&"string"!=typeof t&&(a=t,t=null),2===arguments.length&&"string"!=typeof t&&(i=a,a=t,t=null),a){if(s.tooltip&&(n.tooltip=s.tooltip),"string"==typeof i)try{i=JSON.parse(i)}catch(o){e.error("can't parse catalog opts: "+i,o)}(i=i||{}).color=i.color||s.color||"#00FF00",i.wcssys=i.wcssys||s.wcssys,i.updateWCS=!0,s={convFuncs:{def:function(t){var a={};return a.val=e.saostrtod(t),a.delim=String.fromCharCode(e.saodtype()),"\0"!==a.delim&&0<=" \t-.:hdmsr'\"".indexOf(a.delim)||e.isNumber(t)?a:(a.val=t,a)}},units:i.units||s.units,skip:i.skip||s.skip};try{r=new e.Starbase(a,s)}catch(o){e.error("could not parse catalog. Is it in tab-separated column format?")}return r&&r.data&&r.data.length||e.error("no objects found in catalog"),(s=this.starbaseToShapes(r,i)).length?(t=t||"catalog_"+e.uniqueID(),this.display.newShapeLayer(t,n),this.removeShapes(t),this.layers[t].catalog=a,this.layers[t].starbase=r,this.addShapes(t,s,i)):e.error("no catalog objects found"),this}},e.Image.prototype.saveCatalog=function(t,a){var i,s;return i=a||this.activeShapeLayer(),this.layers[i]&&this.layers[i].catalog||e.error(i&&"undefined"!==i?"no catalog available: "+i:"no active catalog available"),s=new Blob([this.layers[i].catalog],{type:"text/plain;charset=utf-8"}),(t=t||i+".cat").match(/\.cat$/)||(t+=".cat"),window.hasOwnProperty("saveAs")?saveAs(s,t):e.error("no saveAs function available to save catalog"),t},e.Image.prototype.wcs2wcs=function(t,a,i,s){var r,n,o;return r=this.getWCSSys(),n=this.getWCSUnits(),t=t||r,a=a||r,"string"==typeof i&&(":"===(o=e.strtoscaled(i)).dtype&&"galactic"!==t&&"ecliptic"!==t&&(o.dval*=15),i=o.dval),"string"==typeof s&&(s=(o=e.strtoscaled(s)).dval),o=this.setWCSSys(t).getWCSSys(),"native"!==t&&o!==t&&e.error("unknown or invalid wcs: "+t),i=e.wcs2pix(this.raw.wcs,i,s).trim().split(/ +/),t=parseFloat(i[0]),i=parseFloat(i[1]),this.setWCSSys(a),this.setWCSUnits("degrees"),t=e.pix2wcs(this.raw.wcs,t,i).trim(),this.setWCSUnits(n),r!==a&&this.setWCSSys(r),t},e.Image.prototype.wcs2imlen=function(t){var a,i=1;if(t){switch(t=e.strtoscaled(t),void 0!==(a=this.raw.wcsinfo||{cdelt1:1,cdelt2:1}).cdelt1?i=a.cdelt1:void 0!==a.cdelt2&&(i=a.cdelt2),this.params.wcssys){case"image":break;case"physical":this.lcs&&this.lcs.physical&&(t.dval*=this.lcs.physical.forward[0][0]);break;default:t.dtype&&"."!==t.dtype&&"\0"!==t.dtype&&(t.dval=Math.abs(t.dval/i))}return t.dval}},e.Colormap=function(t,a,i,s){var r,n;if(t){switch(this.name=t,arguments.length){case 2:this.type="lut",this.colors=a;break;case 4:this.type="sao",this.vertices=[a,i,s];break;default:e.error("colormap requires a colormap name and 1 or 3 array args")}for(this.source=e.inited?"user":"core",r=0;r<e.colormaps.length;r++)if(e.colormaps[r].name===this.name){e.colormaps[r]=this,n=!0;break}n||e.colormaps.push(this),1<e.DEBUG&&e.log("JS9 colormap:  %s",this.name)}},e.Colormap.prototype.mkColorCell=function(t){var a,i,s,r=e.COLORSIZE,n=[0,0,0];switch(this.type){case"sao":for(i=t/r,t=0;3>t;t++){for(a=(s=this.vertices[t]).length,r=0;r<a&&!(s[r][0]>i);r++);r=0===r?s[0][1]:r===a?s[a-1][1]:(a=(s[r][1]-s[r-1][1])/(s[r][0]-s[r-1][0]))?a*(i-s[r-1][0])+s[r-1][1]:s[r][1],n[t]=255*r}break;case"lut":i=this.colors.length,0>(t=Math.floor(t*i/r))?(n[0]=255*this.colors[0][0],n[1]=255*this.colors[0][1],n[2]=255*this.colors[0][2]):t<i?(n[0]=255*this.colors[t][0],n[1]=255*this.colors[t][1],n[2]=255*this.colors[t][2]):(n[0]=255*this.colors[i-1][0],n[1]=255*this.colors[i-1][1],n[2]=255*this.colors[i-1][2]);break;default:e.error("unknown colormap type")}return n},e.Display=function(t){var a=this;this.divjq=t instanceof jQuery?t:"object"==typeof t?$(t):$("#"+t),this.divjq.attr("id")||this.divjq.attr("id",e.DEFID),this.id=this.divjq.attr("id"),this.tmp={},this.divjq.addClass("JS9"),this.width=this.divjq.attr("data-width"),this.width||(this.width=e.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=e.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.width0=this.width,this.height0=this.height,this.canvas=document.createElement("canvas"),this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",e.ZINDEX),this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",e.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq),e.allinone||(this.iconjq=$("<div>").addClass("JS9Logo").css("display","none").css("z-index",e.ZINDEX+1).appendTo(this.divjq),this.iconimgjs=$("<img>").addClass("JS9Logo").attr("src",e.InstallDir("images/js9logo.png")).attr("alt","js9").attr("title","js9").appendTo(this.iconjq),e.globalOpts.logoDisplay&&this.iconjq.css("display","block")),e.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),e.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+e.RESIZEFUDGE).css("height",this.height+e.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var t=a.divjq.width(),i=a.divjq.height();e.bugs.webkit_resize&&(t-=e.RESIZEFUDGE,i-=e.RESIZEFUDGE),a.resize(t,i)})),this.context=this.canvas.getContext("2d"),e.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1),this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq),this.image=null,this.pluginInstances={},this.layers={},this.initMessages(),this.blendMode=!1,this.mouseActions=e.globalOpts.mouseActions.slice(0),this.touchActions=e.globalOpts.touchActions.slice(0),this.mousetouchZoom=e.globalOpts.mousetouchZoom,this.divjq.on("mouseenter",this,function(t){return e.mouseEnterCB(t)}),this.divjq.on("mouseover",this,function(t){return e.mouseOverCB(t)}),this.divjq.on("mousedown touchstart",this,function(t){return e.mouseDownCB(t)}),this.divjq.on("mousemove touchmove",this,function(t){return e.mouseMoveCB(t)}),this.divjq.on("mouseup touchend",this,function(t){return e.mouseUpCB(t)}),this.divjq.on("mouseout",this,function(t){return e.mouseOutCB(t)}),this.divjq.on("keypress",this,function(t){return e.keyPressCB(t)}),this.divjq.on("keydown",this,function(t){return e.keyDownCB(t)}),this.divjq.on("keyup",this,function(t){return e.keyUpCB(t)}),this.divjq.on("wheel",this,function(t){return e.wheelCB(t)}),this.divjq.on("dragenter",this,function(t){return e.dragenterCB(this.id,t)}),this.divjq.on("dragover",this,function(t){return e.dragoverCB(this.id,t)}),this.divjq.on("dragexit",this,function(t){return e.dragexitCB(this.id,t)}),this.divjq.on("drop",this,function(t){return e.dragdropCB(this.id,t)}),this.divjq.on("contextmenu",this,function(){return!1}),this.addFileDialog("Load",e.globalOpts.imageTemplates),this.addFileDialog("RefreshImage",e.globalOpts.imageTemplates),this.addFileDialog("LoadRegions",e.globalOpts.regionTemplates),this.addFileDialog("LoadSession",e.globalOpts.sessionTemplates),this.addFileDialog("LoadColormap",e.globalOpts.colormapTemplates),this.addFileDialog("LoadCatalog",e.globalOpts.catalogTemplates),e.displays.push(this),e.DEBUG&&e.log("JS9 display:  %s",this.id)},e.Display.prototype.addFileDialog=function(t,a){var i,s,r=this;t&&e.publics[t]&&(s="openLocal"+t+"-"+r.id,i=$("<div>").css("visibility","hidden").css("position","relative").css("top",-50).css("left",-50).appendTo(r.divjq),i=$("<input>").attr("type","file").attr("id",s).attr("multiple",!0).appendTo(i),a&&i.attr("accept",a),i.on("change",function(){var a;for(this.files.length&&e.waiting(!0,r),a=0;a<this.files.length;a++)e.publics[t](this.files[a],{display:r.id});return this.value=null,!1}))},e.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",e.MESSZINDEX).appendTo(this.divjq),this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer),this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer),this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer),this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(t,a){this.oicb=e.globalOpts.internalContrastBias,e.globalOpts.internalContrastBias=!1},stop:function(t,a){e.globalOpts.internalContrastBias=this.oicb}})}catch(t){}return this},e.Display.prototype.displayPlugin=function(t){var a,i,s,r,n,o,l=this;if("string"==typeof t)for(a=0;a<e.plugins.length;a++)if((r=e.plugins[a]).name===t){t=r;break}switch("object"==typeof t&&t.name||e.error("unknown plugin type for displayPlugin"),o=this.pluginInstances[t.name],e.globalOpts.winType){case"light":if(i=e.lightOpts[e.LIGHTWIN],o&&o.status){if("inactive"===o.status){if(o.winHandle&&(o.winHandle.show(),o.status="active",t.opts.onplugindisplay))try{t.opts.onplugindisplay.call(o,this.image)}catch(c){e.log("onplugindisplayCB: %s [%s]\n%s",t.name,c.message,e.strace(c))}}else if("active"===o.status&&o.winHandle&&(o.winHandle.hide(),o.status="inactive",t.opts.onpluginclose))try{t.opts.onpluginclose.call(o,l.image)}catch(c){e.log("onplugincloseCB: %s [%s]\n%s",t.name,c.message,e.strace(c))}}else if(n=t.name.replace(/\s/g,"_"),a=this.id+"_"+n+"_lightDiv",r=this.id+"_"+n+"_outerDiv",n=this.id+"_"+n+"_innerDiv",o||(s=$("<div>").attr("id",r).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(t.name).attr("id",n).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(s)),s=t.opts.winDims[0]||e.WIDTH,i=sprintf(i.format,s,t.opts.winDims[1]||e.HEIGHT,t.opts.winResize?"1":"0"),s=t.opts.toolbarHTML&&0<=t.opts.toolbarHTML.search(/\$title/)?"":t.opts.winTitle||"",s+=sprintf(e.IDFMT,this.id),r=e.lightWin(a,"div",r,s,i),a=$("#"+a+" #"+n),(o=e.instantiatePlugin(a,t,r)).winHandle.onclose=function(){if(o.winHandle.hide(),o.status="inactive",t.opts.onpluginclose)try{t.opts.onpluginclose.call(o,l.image)}catch(c){e.log("onplugincloseCB: %s [%s]\n%s",t.name,c.message,e.strace(c))}return!1},o.status="active",t.opts.onplugindisplay)try{t.opts.onplugindisplay.call(o,this.image)}catch(c){e.log("onplugindisplayCB: %s [%s]\n%s",t.name,c.message,e.strace(c))}break;case"new":e.error("external window support for plugins not yet implemented")}},e.Display.prototype.resize=function(t,a,i){var s,r,n,o,l,c=function(e){e.left+=o,e.top+=l,e.setCoords()};if(e.globalOpts.resize||e.error("display resize not enabled"),!t&&!a)return{width:this.width,height:this.height};if("full"===t){if(i=a,window.innerWidth&&(t=window.innerWidth),window.innerHeight)for(a=window.innerHeight,s=0;s<e.globalOpts.centerDivs.length;s++)this.pluginInstances[r=e.globalOpts.centerDivs[s]]&&(a-=this.pluginInstances[r].divjq.height())}else"image"===t?(this.image||e.error("can't resize display to 'image' without an image"),i=a,t=this.image.raw.width,a=this.image.raw.height):"reset"===t&&(i=a,t=this.width0||t,a=this.height0||a);if(t=Math.floor(t),a=a?Math.floor(a):t,(10>t||10>a)&&e.error("invalid dimension(s) passed to display resize"),t===this.width&&a===this.height)return this;for(n in i=i||{},o=((s=t)-this.width)/2,l=((t=a)-this.height)/2,this.width=s,this.height=t,this.divjq.css("width",s),this.divjq.css("height",t),this.canvasjq.attr("width",s),this.canvasjq.attr("height",t),e.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,s),this.oheight=Math.min(this.oheight,t)),0<=$.inArray("JS9Menubar",e.globalOpts.resizeDivs)&&(e.isNull(i.resizeMenubar)||i.resizeMenubar)&&(a=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",s),0<=$.inArray("JS9Toolbar",e.globalOpts.resizeDivs)&&(e.isNull(i.resizeToolbar)||i.resizeToolbar)&&(a=this.pluginInstances.JS9Toolbar)&&(a.divjq.attr("data-width",String(s)+"px"),e.Toolbar.init.call(a)),0<=$.inArray("JS9Colorbar",e.globalOpts.resizeDivs)&&(e.isNull(i.resizeColorbar)||i.resizeColorbar)&&(a=this.pluginInstances.JS9Colorbar)&&(a.divjq.attr("data-width",String(s)+"px"),e.Colorbar.init.call(a)),this.layers)this.layers.hasOwnProperty(n)&&"main"===(a=this.layers[n]).dtype&&(a.divjq.css("width",s),a.divjq.css("height",t),a.canvasjq.attr("width",s),a.canvasjq.attr("height",t),a.canvas.setWidth(s),a.canvas.setHeight(t),a.canvas.calcOffset());for(s=0;s<e.images.length;s++)if((t=e.images[s]).mkSection(),t.display&&this===t.display&&(t.resize?(t.resize.left+=o,t.resize.top+=l):t.resize={left:o,top:l},t===t.display.image))for(n in t.layers)t.layers.hasOwnProperty(n)&&("main"!==(a=t.layers[n]).dlayer.type||a.json||(a.canvas.getObjects().forEach(c),a.canvas.renderAll()));return e.bugs.webkit_resize&&this.divjq.css("width",this.width+e.RESIZEFUDGE).css("height",this.height+e.RESIZEFUDGE),!this.image||!e.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",i),this.image.refreshLayers()),i.center&&this.center(),this},e.Display.prototype.inResize=function(t){return!!(e.globalOpts.resizeHandle&&t.x+e.RESIZEDIST>=this.divjq.width()&&t.y+e.RESIZEDIST>=this.divjq.height())},e.Display.prototype.center=function(){var t,a,i,s;i=(o=this.divjq).offset().top;var r=o.height(),n=$(window).height();s=o.offset().left;var o=o.width(),l=$(window).width();for(t=0;t<e.globalOpts.centerDivs.length;t++)this.pluginInstances[a=e.globalOpts.centerDivs[t]]&&(r+=(a=this.pluginInstances[a].divjq).height(),i=Math.min(a.offset().top,i));return i=r<n?i-(n/2-r/2):i,s=o<l?s-(l/2-o/2):s,$("html, body").animate({scrollTop:i,scrollLeft:s},250),this},e.Display.prototype.gather=function(t){var a,i;if("string"==typeof t)try{t=JSON.parse(t)}catch(s){e.error("can't parse gather opts: "+t,s)}for(a=(t=t||{}).images||e.images,t=0;t<a.length;t++)(i="number"==typeof a[t]?e.images[a[t]]:a[t])&&i.display!==this&&i.moveToDisplay(this);e.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")},e.Display.prototype.separate=function(t){var a,i,s,r,n,o,l,c,p,d,h,g,u,m,f,y=this,b=0,S={},v=0,w=0,x=1,J=/_sep[0-9][0-9]*/,k=e.globalOpts.separate,C=e.bugs.webkit_resize?e.RESIZEFUDGE:0,I=function(t,a){switch(t||e.error("can't init seapration ops: no from id"),r=a.leftMargin||k.leftMargin||0,n=a.topMargin||k.topMargin||0,s=a.layout||e.globalOpts.separate.layout||"auto"){case"auto":case"horizontal":w=1,v=0;break;case"vertical":w=0,v=1;break;default:w=1,v=0}o=43,l=0,c=$("#"+t),0<(p=$("#"+t+"Menubar")).length&&(p.isactive="visible"===p.closest(".JS9PluginContainer").css("visibility")),0<(d=$("#"+t+"Toolbar")).length&&(d.isactive="visible"===d.closest(".JS9PluginContainer").css("visibility")),0<(h=$("#"+t+"Colorbar")).length&&(h.isactive="visible"===h.closest(".JS9PluginContainer").css("visibility")),0<c.length&&(g=c.width(),u=c.height(),m=c.offset().top-$(window).scrollTop(),f=c.offset().left-$(document).scrollLeft(),p.isactive&&(u+=p.height(),m-=p.height()),d.isactive&&(u+=d.height(),m-=d.height()),h.isactive&&(u+=h.height(),m-=h.height(),m+=7))},M=function(e,t){var a,i;return e&&(0<c.length&&(a="",p.isactive&&(a+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",t,c.width())),d.isactive&&(a+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",t,c.width())),a+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",t,c.width()-C,c.height()-C),h.isactive&&(a+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",t,c.width()))),"auto"===s&&f+g*(w+.5)>window.innerWidth&&(v++,w=0),i=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",g,u,m+(u+n+o)*v,f+(g+r+l)*w),"auto"===s||"horizontal"===s?w++:"vertical"===s&&v++),{id:t,html:a,winopts:i}},T=function(s){var r,n;r=b++,s.length>r?(r="number"==typeof s[r]?e.images[s[r]]:s[r])&&r.display===y?(r.displayImage("all"),void 0===a?(I(a=r.display.id,t),T(s)):(i="string"==typeof t.idbase?n=t.idbase+x++:a.replace(J,"")+"_sep"+e.uniqueID(),S[i]=r,$("#dhtmlwindowholder").arrive("#"+i,{onceOnly:!0},function(){n=$(this).attr("id"),window.setTimeout(function(){S[n].moveToDisplay(n),T(s)},0)}),r=M(a,i),n&&(r.id=n),e.LoadWindow(null,{id:r.id},"light",r.html,r.winopts))):T(s):e.globalOpts.extendedPlugins&&y.image&&y.image.xeqPlugins("image","onseparatedisplay")};if("string"==typeof t)try{t=JSON.parse(t)}catch(A){e.error("can't parse separate opts: "+t,A)}T((t=t||{}).images||e.images)},e.Display.prototype.nextImage=function(t){var a,i,s;if(t=t||1,this.image){for(s=this.image.pos,a=0;a<e.images.length&&this.image!==e.images[a];a++);for(i=a+t;i!==a&&(i>=e.images.length&&(i=0),0>i&&(i=e.images.length-1),e.images[i].display!==this);i+=t);return a!==i&&((t=e.images[i]).displayImage("all"),t.refreshLayers(),t.display.clearMessage(),s&&(s=t.displayToImagePos(s),t.valpos=null,t.valpos=t.updateValpos(s,!0))),this}},e.Display.prototype.loadSession=function(t,a){var i,s,r=this,n={},o=function(t){var a,i,o,l,c,p=function(){var a=this.canvas.getObjects();a&&void 0!==a.length&&(t.layers[this.layerName].nshape=a.length+1),e.Fabric.updateChildren(this,null,"objects"),t.refreshLayers()};if((c=n[t.file]||{}).blend&&(t.blend=$.extend(!0,{},c.blend)),c.tmp&&(t.tmp=$.extend(!0,{},c.tmp)),c.wcsim&&(t.wcsim=e.lookupImage(c.wcsim)),c.layers&&c.layers.length)for(a=0;a<c.layers.length;a++)if(l=(o=c.layers[a]).name,!(0<=$.inArray("regions",t.params.disable)&&"regions"===l)&&"crosshair"!==l&&"grid"!==l&&(i=r.newShapeLayer(l,o.dopts),t.addShapes(l,[]),i.canvas.loadFromJSON(o.json,p.bind(i)),o.catalog&&(t.layers[l].catalog=o.catalog),o.starbase))try{t.layers[l].starbase=JSON.parse(o.starbase)}catch(d){}t.tmp&&"active"===t.tmp.gridStatus&&t.displayCoordGrid(!0),e.notNull(s)&&0==--s&&e.images.sort(function(e,t){var a=0,i=0;return n[e.file]&&(a=n[e.file].i),n[t.file]&&(i=n[t.file].i),a-i}),c.xeqstash&&t.xeqStashCall(c.xeqstash),e.globalOpts.extendedPlugins&&e.images[0].xeqPlugins("image","onsessionload")},l=function(t){t.file||e.error("session does not contain a filename"),delete(i=$.extend(!0,{},t)).params.display,i.params.crosshair=!1,i.params.onload=o,t=i.file,i.sect&&(i.params.xcen=i.sect.xcen,i.params.ycen=i.sect.ycen,i.params.xdim=i.sect.xdim,i.params.ydim=i.sect.ydim,i.params.zoom=i.sect.zoom,delete i.sect),window.isElectron&&e.desktopOpts.sessionPath&&a.sessionPath&&"/"!==i.file.charAt(0)&&!i.file.match(e.URLEXP)&&(t=e.fixPath(a.sessionPath+i.file)),n[t]=i,e.Load(t,i.params,{display:r.id})},c=function(t){var a,i;if(t.globalOpts&&($.extend(!0,e.globalOpts,t.globalOpts),delete t.globalOpts),t.cmaps)for(a=0;a<t.cmaps.length;a++)e.AddColormap(t.cmaps[a]);if(t.images)for(s=t.images.length,a=0;a<t.images.length;a++)t.images[a].i=a,l(t.images[a]);else l(t);if(t.display)for(i in t.display)if(t.display.hasOwnProperty(i))switch(i){case"blendMode":e.BlendDisplay(t.display[i],{display:r});break;default:r[i]=t.display[i]}};return a=a||{},e.waiting(!0,this),"object"==typeof t?c(t):$.ajax({url:t,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(e){c(e)},error:function(a,i,s){e.error("could not load session: "+t,s)}}),this},e.Display.prototype.displayMessage=function(e,t,a){},e.Display.prototype.clearMessage=function(e){},e.Display.prototype.createMosaic=function(t,a){var i,s,r,n,o=this,l=function(){var t;for(t=0;t<n.length;t++)e.vunlink(n[t])},c=function(t,a){var i;0>a.search(/\[struct stat="OK"/)&&(e.waiting(!1),l(),(i=a.match(/msg="(.*)"/))&&i[1]?e.error(i[1]+" (from "+t+")"):e.error(a||"unknown "+t+" failure"))},p=function(t,a){var i;a=a||{},i=$.extend(!0,{},a),!1!==a.waiting&&e.waiting(!0,o),i.display=o.id,e.checkNew(new e.Image(t,i)),e.waiting(!1)},d=function(){var t;(a.verbose||1<e.DEBUG)&&(t=sprintf.apply(null,arguments),e.log(t))};if((a=a||{}).reduce=a.reduce||e.globalOpts.reduceMosaic,a.dim=a.dim||Math.max(e.globalOpts.image.xdim,e.globalOpts.image.ydim),t)if("string"==typeof t)if("current"===t)t=this.image?[this.image]:[];else if("all"===t)for(t=[],i=0;i<e.images.length;i++)e.images[i].display.id===o.id&&t.push(e.images[i]);else t=[t];else $.isArray(t)||e.error("unknown input type for createMosaic()");else t=this.image?[this.image]:[];for(t.length||e.error("no images specified for createMosaic()"),i=0;i<t.length;i++)"string"==typeof t[i]&&((s=e.lookupImage(t[i]))?t[i]=s:e.error("unknown image for mosaic: "+t[i])),(s=t[i]).raw.hdu&&s.raw.hdu.fits&&s.raw.hdu.fits.vfile||e.error("no virtual file available for mosaic: "+s.id);return e.waiting(!0,o),window.setTimeout(function(){var s,o,h,g,u,m,f,y,b,S,v,w=e.uniqueID();for(o=(v=function(e){return"mosaic_"+w+"_"+e})("in.lst"),u=v("in.tbl"),g=v("in.hdr"),h=v("bin.lst"),f=v("bin.tbl"),y=v("out.lst"),b=v("out.tbl"),S=v("out.hdr"),s=(v=t[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits")).replace(/\.fits$/,"_area.fits"),n=[o,u,g,h,f,y,b,S,s],s=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|"),i=0;i<t.length;i++)s+=sprintf("%s\n",t[i].raw.hdu.fits.vfile);if(e.vfile(o,s),o=e.imgtbl(o,".",u,"-C"),c("mImgtbl",o),e.vsize(u)||e.error("no image data found with which to construct a mosaic"),o=e.makehdr(u,g,""),c("mMakeHdr",o),"js9"===a.reduce){for(s=e.vread(g).split("\n"),i=g=0;i<s.length;i++)switch(o=s[i].split("="),o[0].trim()){case"NAXIS1":g=Math.max(g,parseFloat(o[1].trim()));break;case"NAXIS2":g=Math.max(g,parseFloat(o[1].trim()))}for(r=Math.max(1,Math.floor(g/a.dim+.5)),s=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|"),(u=(u=e.vread(u)).trim().split("\n")).splice(0,3),i=0;i<u.length;i++)g=(o=u[i].trim().split(/\s+/))[o.length-2],o=o[o.length-1],g&&o&&(m=sprintf("%s[%s]",o,g),g=sprintf("bin_%s_%s",g,o.split("/").reverse()[0].replace(/\.(g|f)z$/,"")),n.push(g),o=sprintf("0@0,0@0,%s",r),d("bin %s [%s]",m,r),e.imsection(m,g,o,""),s+=sprintf("%s\n",g));e.vfile(h,s),o=e.imgtbl(h,".",f,"-C"),c("mImgtbl",o),e.vsize(f)||e.error("no image data found to construct a mosaic"),o=e.makehdr(f,S,""),c("mMakeHdr",o),u=e.vread(f)}else o=e.shrinkhdr(a.dim,g,S),c("mShrinkHdr",o),u=e.vread(u);for((u=u.trim().split("\n")).splice(0,3),s=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|"),i=0;i<u.length;i++)g=(o=u[i].trim().split(/\s+/))[o.length-2],o=o[o.length-1],g&&o&&(h="-a 1","shrink"===a.reduce&&(h+=sprintf(" -h %s",g)),h+=" "+e.globalOpts.reprojSwitches,f=sprintf("reproj_%s_%s",g,o.split("/").reverse()[0].replace(/\.(g|f)z$/,"")),s+=sprintf("%s\n",f),n.push(f),n.push(f.replace(/\.fits$/i,"_area.fits")),d("reproject: %s [%s] -> %s",o,g,f),o=e.reproject(o,f,S,h),c("mProjectPP",o));e.vfile(y,s),o=e.imgtbl(y,".",b,""),c("mImgtbl",o),e.vsize(b)||e.error("no FITS files were added to output table for mosaic"),d("create mosaic: %s",v),o=e.madd(b,S,v,""),c("mAdd",o),l(),(y=$.extend(!0,{},e.fits.options,a)).image={xdim:0,ydim:0},y.file=v,e.fits.handleFITSFile(v,y,p)},e.SPINOUT),this},e.Command=function(t){for(var a in t)t.hasOwnProperty(a)&&(this[a]=t[a]);t.name||e.error("command has no name"),t.get||t.set||e.error("command requires get and/or set routine"),e.commands.push(this),1<e.DEBUG&&e.log("JS9 command:  %s",this.name)},e.Command.prototype.getDisplayInfo=function(e){return e&&e.id&&(this.display=e,this.image=e.image),this},e.Command.prototype.getWhich=function(e){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(e):0===e.length?"get":"set"},e.Helper=function(){"file:"===e.globalOpts.helperProtocol&&(e.globalOpts.helperProtocol="http:"),document.domain&&"localhost"!==document.domain||(e.globalOpts.htimeout=e.globalOpts.lhtimeout),e.globalOpts.helperProtocol+="//",this.helper=this.connected=!1,this.type=e.allinone&&!e.globalOpts.allinoneHelper?"none":e.globalOpts.helperType||"sock.io",this.pageid=null,this.connect()},e.Helper.prototype.connectinfo=function(){var t;return null===e.helper.connected?"notConfigured":e.helper.connected?(t=sprintf("connected %s %s",e.helper.type,e.helper.url),e.helper.pageid&&(t+="<p>"+e.helper.pageid),t):sprintf("notConnected %s",e.helper.type)},e.Helper.prototype.connect=function(t){var a=e.globalOpts.ehretries,i=e.globalOpts.ehtimeout,s=this,r=function(t,a,i){s.connected=!1,s.helper=!1,s.ready=!0,$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"}),i&&"timeout"!==i||(i="or connection refused"),i===(a=a||"timeout")&&(a=""),"error"===i&&(i="is the helper running?"),e.globalOpts.requireHelper?e.error("helper connect error: "+a+" "+i):e.DEBUG&&e.log(sprintf("JS9 helper connect error: %s (%s)",a,i))},n=function(t){$.ajax({url:t,dataType:"script",timeout:e.globalOpts.htimeout,success:function(){var t={reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:1e4,reconnectionAttempts:100,timeout:e.globalOpts.htimeout};"undefined"==typeof io?r(0,"socket io object is undefined",null):(s.socket=io.connect(s.url,t),s.socket.on("connect",function(){var t,a;for(s.connected=!0,s.helper=!0,a=[],t=0;t<e.displays.length;t++)a.push(e.displays[t].id);s.socket.emit("initialize",{displays:a,pageid:s.pageid},function(t){s.pageid=t.pageid,s.js9helper=t.js9helper,e.globalOpts.dataPathModify=t.dataPathModify,s.ready=!0,$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"}),e.DEBUG&&e.log("JS9 helper: connect: "+s.type)}),$(document).trigger("JS9:connected",{type:"socket.io",status:"OK"})}),s.socket.on("connect_error",function(){s.connected=!1,s.helper=!1,1<e.DEBUG&&e.log("JS9 helper: connect error")}),s.socket.on("connect_timeout",function(){s.connected=!1,s.helper=!1,1<e.DEBUG&&e.log("JS9 helper: connect timeout")}),s.socket.on("disconnect",function(t){s.connected=!1,s.helper=!1,1<e.DEBUG&&e.log("JS9 helper: disconnect: "+t),"io server disconnect"===t&&(1<e.DEBUG&&e.log("JS9 helper: manual reconnect"),s.socket.connect())}),s.socket.on("reconnect",function(){s.connected=!0,s.helper=!0,1<e.DEBUG&&e.log("JS9 helper: reconnect")}),s.socket.on("msg",e.msgHandler))},error:function(e,t,a){r(0,t,a)}})},o=function(e,t,a){$.ajax({url:e,dataType:"jsonp",success:function(){n(t)},error:function(){0<--a?window.setTimeout(function(){o(e,t,a)},i):r()}})};if(t&&(this.type=t),this.socket){try{this.socket.disconnect()}catch(l){e.log("warning: can't disconnect from socket")}this.socket=null}switch(this.url=e.globalOpts.helperURL?0<=e.globalOpts.helperURL.search(/:\/\//)?e.globalOpts.helperURL:e.globalOpts.helperProtocol+e.globalOpts.helperURL:document.domain?location.origin?location.origin:e.globalOpts.helperProtocol+document.domain:e.globalOpts.helperProtocol+"localhost",this.baseurl=this.url,this.type){case"none":this.connected=null,this.ready=!0,$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case"get":case"post":e.globalOpts.helperCGI||e.error("cgi script name missing for helper"),this.url+="/"+e.globalOpts.helperCGI,this.helper=this.connected=!0,e.DEBUG&&e.log("JS9 helper: connect: "+this.type),this.ready=!0,$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case"sock.io":case"nodejs":e.globalOpts.helperPort||e.error("port missing for helper"),this.url=this.url.replace(/:[0-9][0-9]*$/,"")+":"+e.globalOpts.helperPort,this.sockurl=this.url+"/socket.io/socket.io.js",window.isElectron?(this.aliveurl=this.url+"/alive",o(this.aliveurl,this.sockurl,a)):n(this.sockurl);break;default:e.error("unknown helper type: "+this.type)}},e.Helper.prototype.send=function(t,a,i){if(!this.connected)return null;if(a&&"object"==typeof a){try{a.cookie=document.cookie}catch(s){delete a.cookie}e.globalOpts.dataPath&&!a.dataPath&&(a.dataPath=e.globalOpts.dataPath+":.")}else a={dataPath:"."};switch(e.TOROOT&&(a.dataPath+=":"+e.TOROOT),this.type){case"get":case"post":a.key=t,e.helper.pageid&&(a.pageid=e.helper.pageid),e.DEBUG&&e.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(a),this.url),$.ajax({url:this.url,type:this.type.toUpperCase(),data:a,dataType:"text",success:function(t){"string"==typeof t&&0<=t.search(e.analOpts.epattern)&&e.log(t),i&&i(t)},error:function(t,a,i){e.DEBUG&&e.log("JS9 helper: "+this.type+" failure: "+a+" "+i)}});break;case"sock.io":case"nodejs":e.helper.socket.emit(t,a,i)}return this},e.WebWorker=function(t){this.worker=new Worker(t),this.worker.onmessage=e.WebWorker.prototype.msgHandler.bind(this),this.handlers=[]},e.WebWorker.prototype.msgHandler=function(t){var a,i=t.data;switch(i.cmd){case"progress":e.progress(i.result.value,i.result.max);break;case"initsocketio":for(this.sockinit=!0,t=0;t<this.handlers.length;t++)if((a=this.handlers[t]).id===i.id){a.func(i.result),this.handlers.splice(t,1);break}break;case"uploadFITS":for(t=0;t<this.handlers.length;t++)if((a=this.handlers[t]).id===i.id){a.func(i.result),this.handlers.splice(t,1);break}break;case"connect_error":case"connect_timeout":1<e.DEBUG&&e.log("JS9 worker socketio: "+i.cmd);break;case"disconnect":e.waiting(!1),i.result?e.worker.postMessage("initsocketio",[e.helper.url,e.helper.pageid],function(){e.error(i.result)}):1<e.DEBUG&&e.log("JS9 worker socketio: disconnect");break;case"error":e.error(i.result||"in web worker")}},e.WebWorker.prototype.postMessage=function(t,a,i,s){var r=t+e.uniqueID(),n={id:r,cmd:t,args:a};i&&this.handlers.push({id:r,cmd:t,args:a=a||[],func:i}),s?this.worker.postMessage(n,s):this.worker.postMessage(n)},e.WebWorker.prototype.socketio=function(t){var a=e.helper;e.worker.sockinit?t&&t():e.worker.postMessage("initsocketio",[a.url,a.pageid],function(a){"OK"===a?t&&t():e.error("can't init  socket.io for JS9 worker: "+a)})},e.WebWorker.prototype.terminate=function(){this.worker.terminate()},fabric.major_version=parseFloat(fabric.version.split(".")[0]),fabric.minor_version=parseFloat(fabric.version.split(".")[1]),e.Fabric={},e.Fabric.elements="cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(" "),e.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1},e.Fabric.rescaleStrokeWidth=function(t,a){t=t||1,t*=(this.scaleX+this.scaleY)/2,!a&&this.params&&(a=this.params.sw1),a&&("group"===this.type?this.forEachObject(function(i){e.Fabric.rescaleStrokeWidth.call(i,t,a)}):this.set("strokeWidth",a/t))},e.Fabric.rescaleEvenly=function(){var e;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case"annulus":case"circle":this.scaleX!==(e=this.params.lastscale||1)?this.scaleY=this.scaleX:this.scaleY!==e&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}},fabric.Object.prototype.rescaleBorder=e.Fabric.rescaleStrokeWidth,fabric.Object.prototype.rescaleEvenly=e.Fabric.rescaleEvenly,e.Fabric.newShapeLayer=function(t,a,i){var s,r,n=function(t,a){if(t.params.sel=null,t.display.image&&(t.display.image.layer=null),a)switch(a.type){case"polyline":case"polygon":e.Fabric.removePolygonAnchors(t,a),t.canvas.renderAll()}},o=function(a,i){if(a.params.sel&&i.params&&a.params.sel!==i&&n(a,a.params.sel),i){switch(i.type){case"polyline":case"polygon":e.Fabric.addPolygonAnchors(a,i),a.canvas.renderAll()}i.polyparams?a.params.sel=i.polyparams.polygon:i.params&&(a.params.sel=i)}a.display.image&&(a.display.image.layer=t)};if(this&&t)return this.layers[t]?this.layers[t]:(this.layers[t]={},(r=this.layers[t]).layerName=t,r.params=[],r.params.sel=null,r.params.sellayer=null,i?r.dtype="other":(r.dtype="main",i=this.divjq),s=i.attr("id")+"-"+t.replace(/\s+/,"_")+"-shapeLayer",r.display=this,r.opts=$.extend(!0,{},a),r.opts.canvas=r.opts.canvas||{},void 0===r.opts.canvas.selection&&(r.opts.canvas.selection=!0),r.el=e.Fabric.elements,r.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(i),r.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",s).attr("width",i.css("width")).attr("height",i.css("height")).appendTo(r.divjq),e.bugs.webkit_resize&&"main"===r.dtype&&r.canvasjq.attr("width",this.width).attr("height",this.height),r.canvas=new fabric.Canvas(r.canvasjq[0]),r.canvas.renderOnAddRemove=!1,r.canvas.preserveObjectStacking=!0,r.opts.movable?(r.opts.lockMovementX=!1,r.opts.lockMovementY=!1,r.opts.selectable=!0,r.opts.evented=!0):!1===r.opts.movable&&(r.opts.lockMovementX=!0,r.opts.lockMovementY=!0,r.opts.selectable=!1,r.opts.evented=!1),void 0===r.opts.changeable&&void 0!==r.opts.fixinplace&&(r.opts.changeable=!r.opts.fixinplace),r.opts.changeable?(r.opts.hasControls=!0,r.opts.hasRotatingPoint=!0,r.opts.hasBorders=!0,r.opts.lockMovementX=!1,r.opts.lockMovementY=!1,r.opts.lockRotation=!1,r.opts.lockScalingX=!1,r.opts.lockScalingY=!1,r.opts.lockUniScaling=!1,r.opts.selectable=!0,r.opts.evented=!0,r.opts.usekeyboard=!0):!1===r.opts.changeable&&(r.opts.hasControls=!1,r.opts.hasRotatingPoint=!1,r.opts.hasBorders=!1,r.opts.lockMovementX=!0,r.opts.lockMovementY=!0,r.opts.lockRotation=!0,r.opts.lockScalingX=!0,r.opts.lockScalingY=!0,r.opts.lockUniScaling=!0,r.opts.selectable=!1,r.opts.evented=!1,r.opts.usekeyboard=!1),r.opts.selectable&&(r.opts.canvas.selection=!0),r.opts.onmousedown||r.opts.onmouseup||r.opts.onmousemove||r.opts.tooltip||r.opts.onmouseover||r.opts.onmouseout?(r.opts.evented=!0,r.canvas.on("mouse:down",r.opts.onmousedown?function(a){r.display.image&&a.target?("main"===r.dtype&&(r.display.image.clickInRegion=!0,r.display.image.clickInLayer=t),r.opts.onmousedown.call(this,r.display.image,a.target.pub,a.e,a.target)):(this._selection=this.selection)&&(this.selection=e.specialKey(a.e))}:function(t){(this._selection=this.selection)&&(this.selection=e.specialKey(t.e))}),r.canvas.on("mouse:up",r.opts.onmouseup?function(e){r.display.image&&e.target&&r.opts.onmouseup.call(this,r.display.image,e.target.pub,e.e,e.target),this.selection=this._selection||this.selection}:function(){this.selection=this._selection||this.selection}),r.opts.onmousemove&&r.canvas.on("mouse:move",function(e){r.display.image&&e.target&&r.opts.onmousemove.call(this,r.display.image,e.target.pub,e.e,e.target)}),r.opts.onmouseover&&r.canvas.on("mouse:over",function(e){r.display.image&&e.target&&r.opts.onmouseover.call(this,r.display.image,e.target.pub,e.e,e.target)}),r.opts.onmouseout&&r.canvas.on("mouse:out",function(e){r.display.image&&e.target&&r.opts.onmouseout.call(this,r.display.image,e.target.pub,e.e,e.target)}),r.opts.tooltip&&(r.canvas.on("mouse:over",function(t){r.display.image&&t.target&&e.tooltip(t.target.left+t.target.width+2,t.target.top+t.target.height+2,r.opts.tooltip,r.display.image,t.target.pub,t.e,t.target)}),r.canvas.on("mouse:out",function(t){r.display.image&&t.target&&e.tooltip(t.target.left,t.target.top,null,r.display.image,t.target.pub,t.e,t.target)}))):(r.canvas.on("mouse:down",function(t){(this._selection=this.selection)&&(this.selection=e.specialKey(t.e))}),r.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection})),"function"==typeof r.opts.ongroupcreate&&(r.opts.canvas.selection=!0,r.opts.selectable=!0,r.canvas.on("selection:created",function(e){var t=[],a=[];r.display.image&&e.target&&"group"===e.target.type&&(e.target.forEachObject(function(e){e.pub&&(a.push(e),t.push(e.pub))}),r.opts.ongroupcreate.call(this,r.display.image,t,e.e,a))})),r.canvas.on("object:modified",function(t){var a,i,s,n,o=[];if(t.target&&(e.Fabric.updateChildren(r,a=t.target,"deltas"),r.opts.sortOverlapping&&(a.setCoords(),r.canvas.forEachObject(function(e){e!==a&&a.intersectsWithObject(e)&&(1===fabric.major_version?(s=e.getWidth(),n=e.getHeight()):(s=e.getScaledWidth(),n=e.getScaledHeight()),o.push({obj:e,siz:s*n}))}),o.length)))for(1===fabric.major_version?(s=a.getWidth(),n=a.getHeight()):(s=a.getScaledWidth(),n=a.getScaledHeight()),o.push({obj:a,siz:s*n}),o.sort(function(e,t){return e.siz<t.siz?-1:e.siz>t.siz?1:0}),i=o.length,t=0;t<i;t++)try{o[t].obj.sendToBack()}catch(l){}}),r.canvas.on("object:scaling",function(t){t.target&&((t=t.target).rescaleEvenly(),t.rescaleBorder(),e.Fabric.updateChildren(r,t,"scaling"))}),r.canvas.on("object:moving",function(t){t.target&&e.Fabric.updateChildren(r,t.target,"moving")}),r.canvas.on("object:rotating",function(t){t.target&&e.Fabric.updateChildren(r,t.target,"rotating")}),1===fabric.major_version?r.canvas.on("object:selected",function(e){e.target&&o(r,e.target)}):(r.canvas.on("selection:created",function(e){e.target&&o(r,e.target)}),r.canvas.on("selection:updated",function(t){var a=r.canvas.getActiveObject();if("activeSelection"===a.type){var i,s,n,l=r.canvas.getActiveObjects(t);for(t=0;t<l.length;t++)if((s=l[t]).params){if(s.params.parent&&s.params.parent.obj&&(i=s.params.parent.obj,0>$.inArray(i,l)&&a.addWithUpdate(i)),s.params.children)for(i=0;i<s.params.children.length;i++)n=s.params.children[i].obj,0>$.inArray(n,l)&&a.addWithUpdate(n);switch(s.type){case"polyline":case"polygon":e.Fabric.removePolygonAnchors(r,s)}}r.canvas.renderAll()}else o(r,a)})),r.canvas.on("before:selection:cleared",function(e){e.target&&n(r,e.target)}),r.divjq.closest(e.lightOpts[e.LIGHTWIN].drag).length&&(fabric.isTouchSupported?r.divjq.on("touchstart",function(){r.canvas.calcOffset()}):r.divjq.on("mouseenter",function(){r.canvas.calcOffset()})),r)},e.Fabric.showShapeLayer=function(t,a,i){var s,r,n,o,l=this,c=0;if(r=this.getShapeLayer(t)){if(i=i||{},o=r.canvas,n=this.display.layers[t],a){for(s in i.local||(r.show=!0),r.json&&r.show&&o.loadFromJSON(r.json,function(){var a,i,s;for(a in e.Fabric.updateChildren(r.dlayer,null,"objects"),l.resize&&(o.getObjects().forEach(function(e){e.left+=l.resize.left,e.top+=l.resize.top,e.setCoords()}),o.calcOffset()),l.layers[t].opts.panzoom?(l.binning.obin=l.binning.bin,l.rgb.sect.ozoom=l.rgb.sect.zoom,l.refreshShapes(t)):o.renderAll(),o.selection=r.opts.canvas.selection,r.zindex=Math.abs(r.zindex),n.divjq.css("z-index",r.zindex),l.layers)l.layers.hasOwnProperty(a)&&t!==a&&l.layers[a].show&&(i=l.display.layers[a]).divjq.css("z-index")<r.zindex&&(s=i.canvas.getActiveObject())&&(e.Fabric.removePolygonAnchors(i,s),i.canvas.discardActiveObject())}),this.layers)this.layers.hasOwnProperty(s)&&this.layers[s].json&&c++;c||(this.resize=null),this.xeqPlugins("shape","onshapelayershow",t)}else{if(r.show){for(c=(a=o.getObjects()).length;c--;)(s=a[c]).params&&(s.params.winid&&(s.params.winid.close(),s.params.winid=null),s.params.anchors&&e.Fabric.removePolygonAnchors(r.dlayer,s));a=o.toJSON(r.dlayer.el),r.json=JSON.stringify(a),o.selection=!1,n&&(r.zindex=-Math.abs(r.zindex),n.divjq.css("z-index",r.zindex)),o.clear()}i.local||(r.show=!1),this.xeqPlugins("shape","onshapelayerhide",t)}return this}},e.Fabric.displayShapeLayers=function(){var e;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(e in this.display.image.layers)this.display.image.layers.hasOwnProperty(e)&&this.display.image.showShapeLayer(e,!1,{local:!0});if(this.layers)for(e in this.layers)this.layers.hasOwnProperty(e)&&this.showShapeLayer(e,!0,{local:!0})}},e.Fabric.toggleShapeLayers=function(){var e,t;if(this.toggleLayers){for(e in this.layers)this.layers.hasOwnProperty(e)&&(t=this.layers[e])&&this.toggleLayers[e]&&this.showShapeLayer(e,!0);delete this.toggleLayers}else for(e in this.toggleLayers={},this.layers)this.layers.hasOwnProperty(e)&&"crosshair"!==e&&(t=this.layers[e])&&t.show&&"main"===t.dlayer.dtype&&(this.toggleLayers[e]=!0,this.showShapeLayer(e,!1))},e.Fabric.getShapeLayer=function(e,t){var a,i;if(!e)return null;if(!(i=this.layers[e])){if(!(a=this.display.layers[e]))return null;this.layers[e]={},(i=this.layers[e]).show=!0,i.nshape=0,i.dlayer=a,i.opts=i.dlayer.opts,i.canvas=i.dlayer.canvas,i.canvas.calcOffset()}return i},e.Fabric.activeShapeLayer=function(e){var t,a,i,s;if(e)if($.isArray(e)){for(t=0,a=this.zlayer-1;t<e.length;t++)"main"===(s=this.layers[e[t]]).dlayer.dtype&&(s.zindex=a--,s.show?i||(i=e[t]):s.zindex=-s.zindex,s.dlayer.divjq.css("z-index",s.zindex));e=i}else{if((s=this.layers[e])&&s.show){for(t in i=s.zindex,s.zindex=this.zlayer-1,s.dlayer.divjq.css("z-index",s.zindex),this.layers)this.layers.hasOwnProperty(t)&&(a=this.layers[t])!==s&&a.zindex===s.zindex&&"main"===a.dlayer.dtype&&(a.zindex=i,a.dlayer.divjq.css("z-index",a.zindex));this.xeqPlugins("shape","onshapelayeractive",e)}e=this}else{for(t in this.layers)this.layers.hasOwnProperty(t)&&"main"===(a=this.layers[t]).dlayer.dtype&&(void 0===s||a.zindex>s)&&(s=a.zindex,i=t);e=i}return e},e.Fabric._parseShapeOptions=function(t,a,i){var s,r,n,o,l,c,p={},d={};if(o="main"===this.display.layers[t].dtype?this.rgb.sect.zoom:1,a.remove)return{remove:a.remove};if(d.tags=[],delete a.parent,delete a.id,a.tags)if("string"==typeof a.tags)for(r=a.tags.toLowerCase().split(","),t=0;t<r.length;t++)d.tags[t]=r[t].trim();else if($.isArray(a.tags))for(t=0;t<a.tags.length;t++)d.tags[t]=a.tags[t].trim();switch(void 0!==a.angle&&(p.angle=-a.angle),void 0!==a.x&&void 0!==a.y&&(r=this.imageToDisplayPos(a),p.left=r.x,p.top=r.y),void 0!==a.px&&void 0!==a.py&&(r=this.logicalToDisplayPos({x:a.px,y:a.py}),p.left=r.x,p.top=r.y),"string"==typeof a.wcs&&(r=a.wcs.trim().split(/ +/),a.ra=r[0],a.dec=r[1],3<=r.length&&(a.wcssys=r[2])),void 0!==a.ra&&void 0!==a.dec&&0<this.raw.wcs&&(a.wcssys?(n=this.getWCSSys(),s=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(a.wcssys)):a._wcssys&&(n=this.getWCSSys(),s=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(a._wcssys),delete a._wcssys),"string"==typeof a.ra&&(a.ra=e.saostrtod(a.ra),":"===String.fromCharCode(e.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(a.ra*=15)),"string"==typeof a.dec&&(a.dec=e.saostrtod(a.dec)),r=e.wcs2pix(this.raw.wcs,a.ra,a.dec).trim().split(/ +/),n&&(this.setWCSSys(n),e.globalOpts.xeqPlugins=s),r=this.imageToDisplayPos({x:parseFloat(r[0]),y:parseFloat(r[1])}),p.left=r.x,p.top=r.y),void 0!==a.left&&(p.left=a.left),void 0!==a.top&&(p.top=a.top),void 0===p.left&&!0!==a.noLeftTop&&(p.left=i&&void 0!==i.left?i.left:this.display.canvasjq.attr("width")/2-1),void 0===p.top&&!0!==a.noLeftTop&&(p.top=i&&void 0!==i.top?i.top:this.display.canvasjq.attr("height")/2-1+1),a.dx&&(p.left+=a.dx),a.dy&&(p.top-=a.dy),a.shape){case"annulus":if(d.radii=[],void 0!==a.radii){if("string"==typeof a.radii)for(d.radii=a.radii.replace(/ /g,"").split(","),s=t=0;t<d.radii.length;t++)""!==d.radii[t]&&(a.sizeScale&&(d.radii[t]*=a.sizeScale),d.radii[s++]=this.wcs2imlen(d.radii[t]));else if(d.radii=a.radii,a.sizeScale)for(t=0;t<d.radii.length;t++)d.radii[t]*=a.sizeScale}else for(a.ireg&&e.SCALEIREG&&(e.notNull(a.iradius)&&(a.iradius/=o),e.notNull(a.oradius)&&(a.oradius/=o)),a.sizeScale&&(e.notNull(a.iradius)&&(a.iradius*=a.sizeScale),e.notNull(a.oradius)&&(a.oradius*=a.sizeScale)),o=(a.oradius-a.iradius)/a.nannuli,n=a.nannuli+1,t=0;t<n;t++)s=a.iradius+o*t,a.sizeScale&&(s*=a.sizeScale),d.radii.push(s);break;case"box":a.ireg&&e.SCALEIREG&&(e.notNull(a.width)&&(a.width/=o),e.notNull(a.height)&&(a.height/=o)),a.sizeScale&&(e.notNull(a.width)&&(a.width*=a.sizeScale),e.notNull(a.height)&&(a.height*=a.sizeScale));break;case"circle":a.ireg&&e.SCALEIREG&&e.notNull(a.radius)&&(a.radius/=o),a.sizeScale&&e.notNull(a.radius)&&(a.radius*=a.sizeScale);break;case"ellipse":a.ireg&&e.SCALEIREG&&(e.notNull(a.r1)&&(a.r1/=o),e.notNull(a.r2)&&(a.r2/=o)),a.sizeScale&&(e.notNull(a.r1)&&(a.r1*=a.sizeScale),e.notNull(a.r2)&&(a.r2*=a.sizeScale));break;case"point":switch(a.ptshape){case"box":a.width=2*a.ptsize,a.height=2*a.ptsize;break;case"circle":a.radius=a.ptsize;break;case"ellipse":a.rx=a.ptsize,a.ry=a.ptsize/2}a.lockRotation=!0,a.lockScalingX=!0,a.lockScalingY=!0,a.lockUniScaling=!0,a.hasControls=!1,a.hasRotatingPoint=!1,a.hasBorders=!0;break;case"line":case"polygon":if(void 0!==a.wcspts&&0<this.raw.wcs){for(a.pts=[],a.wcssys&&(n=this.getWCSSys(),s=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(a.wcssys)),t=0;t<a.wcspts.length;t++)r=e.wcs2pix(this.raw.wcs,a.wcspts[t].ra,a.wcspts[t].dec).trim().split(/ +/),a.pts.push({x:parseFloat(r[0]),y:parseFloat(r[1])});n&&(this.setWCSSys(n),e.globalOpts.xeqPlugins=s)}if(a.pts&&a.pts.length){if("string"==typeof a.pts){if(n=(r=a.pts.replace(/ /g,"").split(",")).length,"string"==typeof r[0])for(t=0;t<n;t++)r[t]=parseFloat(r[t]);for(a.pts=[],s=t=0;t<n;t+=2,s++)a.pts[s]={x:r[t],y:r[t+1]}}for(n=a.pts.length,t=0;t<n;t++)a.pts[t]=this.imageToDisplayPos(a.pts[t]);for(a.left&&a.top?s={x:a.left,y:a.top}:(s=e.centerPolygon(a.pts),p.left=s.x,p.top=s.y),a.points=[],t=0;t<n;t++)a.points.push(r={x:(a.pts[t].x-s.x)/o,y:(a.pts[t].y-s.y)/o})}else i&&i.points&&i.points.length||("polygon"===a.shape&&a.polypoints?a.points=a.polypoints:"line"===a.shape&&a.linepoints&&(a.points=a.linepoints));if(a.ireg&&e.SCALEIREG)for(n=a.points.length,t=0;t<n;t++)a.points[t].x/=o,a.points[t].y/=o}for(l in a)if(a.hasOwnProperty(l))switch(l){case"tags":case"x":case"y":case"px":case"py":case"dx":case"dy":case"ra":case"dec":case"pts":case"left":case"top":case"angle":case"radii":case"ireg":break;case"type":case"originX":case"originY":case"width":case"height":case"scaleX":case"scaleY":case"flipX":case"flipY":case"opacity":case"cornerSize":case"transparentCorners":case"hoverCursor":case"padding":case"borderColor":case"cornerColor":case"centeredScaling":case"centeredRotation":case"fill":case"fillRule":case"backgroundColor":case"stroke":case"strokeWidth":case"strokeDashArray":case"strokeLineCap":case"strokeLineJoin":case"strokeMiterLimit":case"shadow":case"borderOpacityWhenMoving":case"borderScaleFactor":case"borderDashArray":case"transformMatrix":case"minScaleLimit":case"selectable":case"evented":case"visible":case"hasControls":case"hasBorders":case"hasRotatingPoint":case"rotatingPointOffset":case"perPixelTargetFind":case"includeDefaultValues":case"clipTo":case"lockMovementX":case"lockMovementY":case"lockRotation":case"lockScalingX":case"lockScalingY":case"lockUniScaling":case"send":case"radius":case"rx":case"ry":case"points":case"selectionLineWidth":case"fontFamily":case"fontSize":case"fontStyle":case"fontWeight":case"text":case"textDecoration":case"textAlign":case"lineHeight":case"textBackgroundColor":case"textOpts":p[l]=a[l];break;case"shape":c=a[l];break;default:d[l]=a[l]}if(!(a=d.color||p.stroke)){var h,g;for(h in a=d.tags,l=(l=d.tagcolors)||{})if(l.hasOwnProperty(h)&&(t=h.split("_"),0===$(a).not(t).length&&0===$(t).not(a).length)){g=l[h];break}if(!g)for(h in l)if(l.hasOwnProperty(h)&&(t=h.split("_"),0===$(a).not(t).length)){g=l[h];break}if(!g)for(h in l)if(l.hasOwnProperty(h)&&(t=h.split("_"),0===$(t).not(a).length)){g=l[h];break}a=g=g||i&&i.get("stroke")||l.defcolor||e.globalOpts.defcolor||"#000000"}return p.stroke=a,p.selectColor=p.stroke,!0!==e.globalOpts.controlsMatchRegion&&"corner"!==e.globalOpts.controlsMatchRegion||(p.cornerColor=p.stroke),!0!==e.globalOpts.controlsMatchRegion&&"border"!==e.globalOpts.controlsMatchRegion||(p.borderColor=p.stroke),void 0===d.changeable&&void 0!==d.fixinplace&&(d.changeable=!d.fixinplace),void 0!==d.changeable&&(p.lockMovementX=i=!d.changeable,p.lockMovementY=i,p.lockRotation=i,p.lockScalingX=i,p.lockScalingY=i,p.hasControls=!i,p.hasRotatingPoint=!i,p.hasBorders=!i),void 0!==d.movable&&(p.lockMovementX=i=!d.movable,p.lockMovementY=i),void 0!==d.resizable&&(p.hasControls=i=d.resizable,p.hasBorders=i),void 0!==d.rotatable&&(i=!d.rotatable,void 0===p.lockRotation&&(p.lockRotation=i,p.hasRotatingPoint=!i)),{shape:c,opts:p,params:d}},e.Fabric._exportShapeOptions=function(e){return"object"!=typeof e?[]:Object.keys(e).filter(function(t){switch(t){case"top":case"left":case"width":case"height":case"radius":case"rx":case"ry":case"angle":case"panzoom":case"iradius":case"oradius":case"nannuli":case"aradius1":case"aradius2":case"configURL":case"sortOverlapping":case"tagcolors":case"pts":case"ptshape":case"ptsize":case"linepoints":case"polypoints":case"responseType":case"display":case"tags":case"r1":case"r2":case"x":case"y":case"dx":case"dy":case"px":case"py":case"shape":case"parent":case"rtn":case"_wcssys":case"file":return!1;case"text":return"text"!==e.shape;default:return!0}})},e.Fabric._handleChildText=function(t,a,i){var s,r,n;if("regions"===t)if(i=i||{},"text"===a.params.shape||!i.text||a.params.children&&a.params.children.length){if(a.params.children&&(i.text||i.textOpts))for(s=0;s<a.params.children.length;s++)n=a.params.children[s].obj,r=$.extend(!0,{},i.textOpts||{}),i.text&&(r.text=i.text),this.changeShapes(t,n.params.id,r)}else r=a.height*a.scaleX/2-12,r=1e-6>Math.abs(a.angle)?{x:a.left,y:a.top-r}:e.rotatePoint({x:a.left,y:a.top-r},a.angle,{x:a.left,y:a.top}),r={x:(n=this.displayToImagePos(r)).x,y:n.y,angle:-a.angle,color:a.stroke,text:i.text,parent:"TBD",rtn:"object"},i.textOpts&&(r=$.extend(!0,{},r,i.textOpts)),(s=e.Fabric.addShapes.call(this,t,"text",r)).params.parent={id:a.params.id,obj:a,dleft:a.left-s.left,dtop:a.top-s.top,lastscalex:a.scaleX,lastscaley:a.scaleY,lastangle:a.angle,textheight:12},e.Fabric._updateShape.call(this,t,s,null,"child",s.params),void 0!==i.strokeWidth&&(s.params.parent.strokeWidth=i.strokeWidth),n.x===r.x&&n.y===r.y||(s.params.parent.moved=!0),i.textOpts&&void 0!==i.textOpts.ra&&void 0!==i.textOpts.dec&&(s.params.hasTextOpts=!0),a.params.children.push({id:s.params.id,obj:s})},e.Fabric.addShapes=function(t,a,i){var s,r,n,o,l,c,p,d,h,g=[],u=[],m={};if(!(0<=$.inArray("regions",this.params.disable)&&"regions"===t)){if("string"==typeof i)try{i=JSON.parse(i)}catch(f){e.error("can't parse shape opts: "+i,f)}if(i=i||{},this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:t,shape:a,opts:i});else if((c=this.getShapeLayer(t))&&c.show){if(p=c.canvas,d="main"===this.display.layers[t].dtype?this.rgb.sect.zoom:1,"string"==typeof a)a="string"==typeof(s=this.parseRegions(a,i))?[{shape:s}]:s;else if(!$.isArray(a)){if("object"!=typeof a)return;a=[a]}if(!p.size()){if("main"===this.display.layers[t].dtype)switch(t){case e.Crosshair.LAYERNAME:case e.Grid.LAYERNAME:c.zindex=1;break;default:c.zindex=this.zlayer++}else c.zindex=e.SHAPEZINDEX;(n=this.display.layers[t]).divjq.css("z-index",c.zindex),this.xeqPlugins("shape","onshapelayercreate",t)}for(o=$.extend(!0,{},e.Fabric.opts,c.opts,i),n=0;n<a.length;n++)if(l=$.extend(!0,{},o,a[n]),(r=e.Fabric._parseShapeOptions.call(this,t,l)).remove&&(!0!==r.remove&&"true"!==r.remove||(r.remove="all"),!1!==r.remove&&"false"!==r.remove))this.removeShapes(t,r.remove);else if(r.shape){switch(l=r.opts,void 0===(m=r.params).id&&(m.id=++c.nshape),m.exports=e.Fabric._exportShapeOptions.call(this,i).concat(e.Fabric._exportShapeOptions.call(this,a[n])),m.parent=null,m.children=[],l.stroke&&(l.color=l.stroke,l.stroke=e.colorToHex(l.stroke)),r.shape){case"annulus":if(m.shape="annulus",r=l.top,h=l.left,l.top=0,l.left=0,m.radii)for(s=0;s<m.radii.length;s++)l.radius=m.radii[s],g.push(new fabric.Circle(l));l.top=r,l.left=h,l.width=2*l.radius,l.height=2*l.radius,s=new fabric.Group(g,l);break;case"box":m.shape="box",s=new fabric.Rect(l);break;case"circle":m.shape="circle",s=new fabric.Circle(l);break;case"ellipse":m.shape="ellipse",l.rx=m.r1,l.ry=m.r2,s=new fabric.Ellipse(l);break;case"point":switch(m.shape="point",m.ptshape){case"box":s=new fabric.Rect(l);break;case"circle":s=new fabric.Circle(l);break;case"ellipse":s=new fabric.Ellipse(l);break;default:s=new fabric.Rect(l)}break;case"line":m.shape="line",s=new fabric.Polyline(l.points,l);break;case"polygon":m.shape="polygon",s=new fabric.Polygon(l.points,l,!0);break;case"text":m.shape="text",m.text=l.text||"Double-click to add text here",l.fill=l.stroke,l.strokeWidth=0,s=new fabric.Text(m.text,l);break;default:e.error("unknown shape: "+r.shape)}if(p.add(s),m.layerName=t,m.sw1=Math.max(1,Math.floor(s.strokeWidth+.5)),m.listonchange=!1,s.params=m,c.opts.panzoom)switch(m.shape){case"point":case"text":break;default:s.scale(d)}if(s.rescaleBorder(),e.Fabric._handleChildText.call(this,t,s,l),"TBD"!==i.parent&&e.Fabric._updateShape.call(this,t,s,null,"add",m),i.onaddshapes&&s.pub)try{e.xeqByName(i.onaddshapes,this,this,s.pub)}catch(f){e.error("in onaddshapes callback",f,!1)}u.push(s)}return(void 0===m.redraw||m.redraw)&&p.renderAll(),"object"===i.rtn?s:"objs"===i.rtn?u:m.id}}},e.Fabric.selectShapes=function(t,a,i){var s,r,n,o,l,c;if(!this.layers||!t||!this.layers[t])return null;switch("string"==typeof(a=a||"all")&&/^[1-9]\d*$/.test(a)&&(a=parseInt(a,10)),n=this.layers[t].canvas,r=1===fabric.major_version?n.getActiveGroup():(t=n.getActiveObject())&&"activeSelection"===t.type?t:null,t={group:null},typeof a){case"object":a.params&&(r&&r.contains(a)&&(t.group=r),i.call(this,a,t));break;case"number":for(o=(n=n.getObjects()).length;o--;)(l=n[o]).params&&a===l.params.id&&(t.group=r&&r.contains(l)?r:null,i.call(this,l,t));break;case"string":if("selected"===a)if(1===fabric.major_version){if(n.getActiveObject())(a=n.getActiveObject()).params&&(t.group=null,i.call(this,a,t));else if(r)for(t.group=r,o=(n=r.getObjects()).length;o--;)(l=n[o]).params&&!l.params.parent&&i.call(this,l,t)}else for(t.group=r,o=(n=n.getActiveObjects()).length;o--;)(l=n[o]).params&&!l.params.parent&&i.call(this,l,t);else for(o=(n=n.getObjects()).length;o--;)if((l=n[o]).params&&("child"===a||!l.params.parent)&&("child"!==a||l.params.parent))if(s=l.stroke.toLowerCase(),t.group=r&&r.contains(l)?r:null,"all"===a)i.call(this,l,t);else if(a.toLowerCase()===s||e.colorToHex(a).toLowerCase()===s)i.call(this,l,t);else if(a===l.params.shape)i.call(this,l,t);else if(a===l.params.file)i.call(this,l,t);else if("child"===a&&l.params.parent)i.call(this,l,t);else if("parent"===a&&l.params.children&&l.params.children.length)i.call(this,l,t);else if(l.params.tags)for(s=0;s<l.params.tags.length;s++)c=l.params.tags[s],a.match(/^\/.*\/$/)&&c.match(new RegExp(a.slice(1,-1)))?i.call(this,l,t):a===c&&i.call(this,l,t)}return this},e.Fabric.updateShapes=function(t,a,i,s){var r=this;return this.selectShapes(t,a,function(a,n){e.Fabric._updateShape.call(r,t,a,n,i,s)}),this},e.Fabric._updateShape=function(t,a,i,s,r){var n,o,l,c,p,d,h,g,u,m,f,y={},b=this.layers[t];for(d=function(e){return e.toFixed(2)},i=i||{},r=r||{},l="main"===this.display.layers[t].dtype?this.rgb.sect.zoom:1,y.mode=s=s||"update",y.id=a.params.id,y.shape=a.params.shape,y.layer=t,y.color=a.color||a.stroke,y.tags=a.params.tags,y.parent=a.params.parent?a.params.parent.obj.params.id:null,h=a.getCenterPoint(),i.group&&(o=i.group.getCenterPoint(),h={x:h.x+o.x,y:h.y+o.y},i.group.angle&&(h=e.rotatePoint(h,i.group.angle,o))),h=this.displayToImagePos(h),y.x=h.x,y.y=h.y,y.lcs=this.imageToLogicalPos(h),"image"===this.params.wcssys?(y.imsys="image",c=y.x,p=y.y,m=1):(y.imsys=y.lcs.sys,c=y.lcs.x,p=y.lcs.y,m=this.lcs.physical.reverse[0][0]),y.angle=-a.angle,i.group&&(y.angle-=i.group.angle),f=y.angle,this.raw.wcsinfo&&this.raw.wcsinfo.crot&&(y.angle-=this.raw.wcsinfo.crot);0>y.angle;)y.angle+=360;for(;360<y.angle;)y.angle-=360;switch(o=a.scaleX/l,l=a.scaleY/l,i.group&&(o*=i.group.scaleX,l*=i.group.scaleY),y.shape){case"annulus":for(y.shape="annulus",y.radii=[],"image"!==y.imsys&&(y.lcs.radii=[]),y.imstr="annulus("+d(c)+", "+d(p)+", ",u="annulus "+y.x+" "+y.y+" ",l=(f=a.getObjects()).length,i=0;i<l;i++)y.imstr+=d(g=(c=f[i].radius*o)*m),u+=y.x+" "+y.y+" "+(y.x+c)+" "+y.y+" ",y.imstr=i===l-1?y.imstr+")":y.imstr+", ",y.radii.push(c),"image"!==y.imsys&&y.lcs.radii.push(g);break;case"box":y.shape="box",y.width=a.width*o,y.height=a.height*l,g=y.width*m,u=y.height*m,"image"!==y.imsys&&(y.lcs.width=g,y.lcs.height=u),y.imstr="box("+d(c)+", "+d(p)+", "+d(g)+", "+d(u)+", "+y.angle.toFixed(4)+")",u="box "+y.x+" "+y.y+" "+y.x+" "+y.y+" "+(y.x+y.width)+" "+y.y+" "+y.x+" "+y.y+" "+y.x+" "+(y.y+y.height)+" "+y.angle*Math.PI/180;break;case"circle":y.radius=a.radius*o,g=y.radius*m,"image"!==y.imsys&&(y.lcs.radius=g),y.imstr="circle("+d(c)+", "+d(p)+", "+d(g)+")",u="circle "+y.x+" "+y.y+" "+y.x+" "+y.y+" "+(y.x+y.radius)+" "+y.y;break;case"ellipse":y.r1=a.width*o/2,y.r2=a.height*l/2,g=y.r1*m,u=y.r2*m,"image"!==y.imsys&&(y.lcs.r1=g,y.lcs.r2=u),y.imstr="ellipse("+d(c)+", "+d(p)+", "+d(g)+", "+d(u)+", "+y.angle.toFixed(4)+")",u="ellipse "+y.x+" "+y.y+" "+y.x+" "+y.y+" "+(y.x+y.r1)+" "+y.y+" "+y.x+" "+y.y+" "+y.x+" "+(y.y+y.r2)+" "+y.angle*Math.PI/180;break;case"point":y.width=a.width*o,y.height=a.height*l,g=y.width*m,u=y.height*m,"image"!==y.imsys&&(y.lcs.width=g,y.lcs.height=u),y.imstr="point("+d(c)+", "+d(p)+")",u="point "+y.x+" "+y.y;break;case"line":case"polygon":for(y.imstr=y.shape+"(",u=y.shape+" ",y.pts=[],"image"!==y.imsys&&(y.lcs.pts=[]),i=0;i<a.points.length;i++)0<i&&(y.imstr+=", ",u+=" "),m=e.rotatePoint(m={x:y.x+a.points[i].x*o,y:y.y-a.points[i].y*l},f,{x:y.x,y:y.y}),"image"===this.params.wcssys?y.imstr+=d(m.x)+", "+d(m.y):(c=this.imageToLogicalPos(m),y.imstr+=d(c.x)+", "+d(c.y),y.lcs.pts.push({x:c.x,y:c.y})),u+=m.x+" "+m.y,y.pts.push(m),"line"===y.shape&&(0===i?g=0:(c=y.pts[i-1],g+=Math.sqrt((m.x-c.x)*(m.x-c.x)+(m.y-c.y)*(m.y-c.y))));"line"===y.shape&&e.notNull(g)?y.imstr+=') {"size":'+d(g)+',"units":"pixels"}':y.imstr+=")",y.angle=0;break;case"text":y.imstr="text("+d(c)+", "+d(p)+', "'+a.text+'", '+y.angle.toFixed(4)+")",u="text "+y.x+" "+y.y+' "'+a.text+'" '+y.angle*Math.PI/180,y.text=a.text}if(this.raw.wcs&&0<this.raw.wcs&&(n=e.pix2wcs(this.raw.wcs,h.x,h.y).trim().split(/\s+/),y.rastr=n[0],y.decstr=n[1],y.wcssys=n[2],":"===(d=e.strtoscaled(n[0])).dtype&&"galactic"!==n[2]&&"ecliptic"!==n[2]&&(d.dval*=15),h=e.strtoscaled(n[1]),y.ra=d.dval,y.dec=h.dval,!1!==r.updateWCS&&(r.updateWCS||b.opts.updateWCS))){for(y.wcsstr=e.reg2wcs(this.raw.wcs,u).replace(/;$/,""),n=y.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(","),i=0;i<n.length;i++)n[i]=n[i].trim();switch(y.wcsposstr=[n[0],n[1]],y.shape){case"annulus":y.wcssizestr=[n[n.length-1]];break;case"box":y.wcssizestr=[n[2],n[3]];break;case"circle":y.wcssizestr=[n[2]];break;case"ellipse":y.wcssizestr=[n[2],n[3]];break;case"line":case"polygon":for(y.wcspts=[],i=0;i<n.length;i+=2)":"===(d=e.strtoscaled(n[i])).dtype&&"galactic"!==y.wcssys&&"ecliptic"!==y.wcssys&&(d.dval*=15),h=e.strtoscaled(n[i+1]),y.wcspts.push({ra:d.dval,dec:h.dval})}}if(y.data=a.params.data,a.set("pub",y),a.params.winid&&($(a.params.winid).is(":visible")?e.Regions.initConfigForm.call(this,a):a.params.winid=null),r.nocb)return y;if(!a.params.parent&&"child"!==s&&"move"!==s&&"mouseout"!==s){if(this.params.xeqonchange&&b.show&&b.opts.onchange)try{this.params.xeqonchange=!1,e.xeqByName(b.opts.onchange,window,this,y)}catch(S){e.log("error in onchange: %s [%s]\n%s",this.id,S.message,e.strace(S))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+t+"change",y)}if("regions"===t&&e.globalOpts.regionsToClipboard){switch(s){case"add":case"select":case"update":i=y.parent||y.id;break;default:i=null}if(e.notNull(i)){try{n=this.listRegions(i,{mode:1})}catch(S){n=null}n&&(e.clipboard=n)}}return y},e.Fabric.removeShapes=function(t,a,i){var s=[],r=this;if(i=this.getShapeLayer(t)){for(i=i.canvas,"regions"===t&&e.globalOpts.unremoveReg&&(this.regstack.push(this.listRegions(a,{mode:1},t)),this.regstack.length>e.globalOpts.unremoveReg&&(this.regstack=this.regstack.slice(0,e.globalOpts.unremoveReg))),this.selectShapes(t,a,function(a,i){var n,o;if(!1!==a.params.removable){if(e.Fabric._updateShape.call(r,t,a,i,"remove"),a.params.winid&&a.params.winid.close(),a.params.parent)for(n=(o=a.params.parent.obj).params.children.length-1;0<=n;n--)if(a===o.params.children[n].obj){o.params.children.splice(n,1);break}for(n=0;n<a.params.children.length;n++)s.push(o=a.params.children[n].obj);s.push(a)}}),a=0;a<s.length;a++)i.remove(s[a]);return 1===fabric.major_version?i.getActiveGroup()&&i.discardActiveGroup():i.discardActiveObject(),i.renderAll(),this}},e.Fabric.getShapes=function(t,a,i){var s=[],r={};if("string"==typeof i)try{i=JSON.parse(i)}catch(n){e.error("can't parse getShapes opts: "+i,n)}return i=i||{},"regions"===t&&"text"===i.format?this.listRegions(a,{mode:i.mode||1}):(this.selectShapes(t,a,function(e){r=e.pub||{},e.params.parent&&!i.includeChildren||(i.includeObj&&(r.obj=e),s.push(r))}),s)},e.Fabric.changeShapes=function(t,a,i){var s,r,n,o,l,c,p,d,h,g,u,m,f=[],y=this;if((l=this.getShapeLayer(t))&&i){if("string"==typeof i)try{i=JSON.parse(i)}catch(b){e.error("can't parse shape opts: "+i,b)}return u="main"===this.display.layers[t].dtype?this.rgb.sect.zoom:1,p=(c=l.canvas).getActiveObject(),this.selectShapes(t,a,function(a,b){if(i.radii&&(a.params.radii=[]),o=$.extend(!0,{},a.params,i),(n=e.Fabric._parseShapeOptions.call(this,t,o,a)).remove&&(!0!==n.remove&&"true"!==n.remove||(n.remove="all"),!1!==n.remove&&"false"!==n.remove))this.removeShapes(t,n.remove||"all");else{if(n.opts.send)switch(n.opts.send){case"front":c.sendToFront(p),c.discardActiveObject();break;case"back":c.sendToBack(p),c.discardActiveObject()}switch(m=e.Fabric._exportShapeOptions.call(this,i).filter(function(e){return!a.params.exports.hasOwnProperty(e)}),n.params.exports=a.params.exports.concat(m),n.opts.stroke&&(n.opts.color=n.opts.stroke,n.opts.stroke=e.colorToHex(n.opts.stroke)),a.params.shape){case"text":n.opts.stroke&&(n.opts.fill=n.opts.stroke),n.opts.strokeWidth=0}switch(a.set(n.opts),a.params=$.extend(!1,{},a.params,n.params),i.strokeWidth&&(a.params.sw1=i.strokeWidth),a.params.shape){case"annulus":if(i.radii&&i.radii.length){for(h=a.get("stroke"),a.forEachObject(function(e){f.push(e)}),d=f.length,s=0;s<d;s++)a.remove(f[s]),c.remove(f[s]);for(d=a.params.radii.length,s=g=0;s<d;s++)r=new fabric.Circle({radius:a.params.radii[s],stroke:h}),g=Math.max(g,a.params.radii[s]),a.add(r);a.scaleX=u,a.scaleY=u,a.width=2*g,a.height=2*g,p===a&&c.setActiveObject(a)}break;case"box":i.width&&(a.scaleX=u),i.height&&(a.scaleY=u);break;case"circle":i.radius&&(a.scaleX=u,a.scaleY=u);break;case"ellipse":i.r1&&(a.rx=a.params.r1,a.scaleX=u,a.width=2*a.rx),i.r2&&(a.ry=a.params.r2,a.scaleY=u,a.height=2*a.ry);break;case"line":case"polygon":(i.points&&i.points.length||i.pts&&i.pts.length)&&(a.scaleX=u,a.scaleY=u),p===a&&(e.Fabric.removePolygonAnchors(l.dlayer,a),e.Fabric.addPolygonAnchors(l.dlayer,a)),e.resetPolygonCenter(a);break;case"text":i.text&&(a.params.text=i.text)}if(a.rescaleBorder(),e.Fabric.updateChildren(l.dlayer,a,"moving"),e.Fabric.updateChildren(l.dlayer,a,"scaling"),e.Fabric.updateChildren(l.dlayer,a,"rotating"),e.Fabric.updateChildren(l.dlayer,a,"deltas"),a.setCoords(),e.Fabric._handleChildText.call(y,t,a,i),e.Fabric._updateShape.call(y,t,a,b,"update"),i.onchangeshapes&&a.pub)try{e.xeqByName(i.onchangeshapes,this,this,a.pub)}catch(S){e.error("in onchangeshapes callback",S,!1)}}}),(void 0===i.redraw||i.redraw)&&c.renderAll(),this}},e.Fabric.refreshShapes=function(t){var a,i,s,r,n,o,l,c,p=!1,d=this,h=this.raw.wcs;if(c=this.getShapeLayer(t))return"main"===this.display.layers[t].dtype&&(p=!0),p?(r=this.binning.obin/this.rgb.sect.ozoom*(s=this.rgb.sect.zoom)/(i=this.binning.bin),n=this.binning.obin/this.rgb.sect.ozoom*s/i):(i=1,n=r=s=this.rgb.sect.zoom),i=c.canvas,1===fabric.major_version?i.getActiveGroup()&&i.discardActiveGroup():i.discardActiveObject(),a=i.getActiveObject(),this.selectShapes(t,"all",function(t){var i,s,g,u;if(0<h&&t.pub.ra&&t.pub.dec?("string"==typeof t.pub.ra&&(t.pub.ra=e.saostrtod(t.pub.ra),":"===String.fromCharCode(e.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(t.pub.ra*=15)),"string"==typeof t.pub.dec&&(t.pub.dec=e.saostrtod(t.pub.dec)),s=e.wcs2pix(h,t.pub.ra,t.pub.dec).trim().split(/ +/),s=this.imageToDisplayPos({x:parseFloat(s[0]),y:parseFloat(s[1])})):s=d.logicalToDisplayPos(t.pub.lcs),t.set("left",s.x),t.set("top",s.y),("box"===t.params.shape||"ellipse"===t.params.shape||"text"===t.params.shape&&!t.params.parent)&&t.set("angle",d.raw.wcsinfo&&d.raw.wcsinfo.crot?-(t.pub.angle+d.raw.wcsinfo.crot):-t.pub.angle),!1!==t.params.zoomable)switch(t.params.shape){case"point":case"text":break;default:if(o=r,l=n,p&&(o*=t.scaleX,l*=t.scaleY),t.scaleX=o,t.scaleY=l,t.rescaleBorder(),t.points)if(g=t.getCenterPoint(),0<h&&t.pub.wcspts)for(u=t.pub.wcspts,i=0;i<u.length;i++)s=e.wcs2pix(h,u[i].ra,u[i].dec).trim().split(/ +/),s=this.imageToDisplayPos({x:parseFloat(s[0]),y:parseFloat(s[1])}),t.angle&&(s=e.rotatePoint(s,-t.angle,g)),t.points[i]={x:(s.x-g.x)/t.scaleX,y:(s.y-g.y)/t.scaleY};else if(t.pub.lcs.pts)for(u=t.pub.lcs.pts,i=0;i<u.length;i++)s=d.logicalToDisplayPos(t.pub.lcs.pts[i]),t.angle&&(s=e.rotatePoint(s,-t.angle,g)),t.points[i]={x:(s.x-g.x)/t.scaleX,y:(s.y-g.y)/t.scaleY}}switch(t.setCoords(),t.type){case"polyline":case"polygon":a===t&&(e.Fabric.removePolygonAnchors(c.dlayer,t),e.Fabric.addPolygonAnchors(c.dlayer,t))}e.Fabric.updateChildren(c.dlayer,t,"moving"),e.Fabric.updateChildren(c.dlayer,t,"scaling"),e.Fabric.updateChildren(c.dlayer,t,"rotating")}),i&&i.renderAll(),this},e.Fabric.addPolygonPoint=function(t,a,i){var s,r,n,o,l,c,p,d,h,g,u,m,f,y,b=Number.MAX_VALUE;if(a&&a.points){for(i=e.eventToDisplayPos(i),c=a.getCenterPoint().x,l=a.getCenterPoint().y,c=(i.x-c)/a.get("scaleX"),u=(i.y-l)/a.get("scaleY"),l=-a.get("angle")*Math.PI/180;l>2*Math.PI;)l-=2*Math.PI;for(i=Math.cos(l)*c-Math.sin(l)*u,u=Math.sin(l)*c+Math.cos(l)*u,c=a.points,l=0;l<c.length;l++)p=(o=c[l]).x<(r=c[(l+1)%c.length]).x?o.x:r.x,d=o.y<r.y?o.y:r.y,h=o.x>r.x?o.x:r.x,g=o.y>r.y?o.y:r.y,s=o.x-r.x,o=o.y-r.y,0!==(n=Math.sqrt(s*s+o*o))&&(s/=n,o/=n),(s=r.x+s*(n=(n=i-r.x)*s+(u-r.y)*o))<p?s=p:s>h&&(s=h),(r=r.y+o*n)<d?r=d:r>g&&(r=g),(p=(s-i)*(s-i)+(r-u)*(r-u))<b&&(b=p,m=s,f=r,y=l===c.length?0:l);if(t=this.getShapeLayer(t),e.Fabric.removePolygonAnchors(t.dlayer,a),c.splice(y+1,0,{x:m,y:f}),1===fabric.major_version)t.canvas.setActiveObject(a);else{switch(a.type){case"polyline":case"polygon":e.Fabric.addPolygonAnchors(t.dlayer,a),t.dlayer.canvas.renderAll()}a.polyparams?t.dlayer.params.sel=a.polyparams.polygon:a.params&&(t.dlayer.params.sel=a)}}},e.Fabric.removePolygonPoint=function(t,a){var i,s,r,n;a&&a.polyparams&&(r=(s=a.polyparams.polygon).points,"polygon"===s.type&&3>=r.length||"polyline"===s.type&&2>=r.length||(n=a.polyparams.point,delete a.polyparams.point,i=this.getShapeLayer(t),e.Fabric.removePolygonAnchors(i.dlayer,s),r.splice(n,1),e.resetPolygonCenter(s),i.canvas.setActiveObject(s)))},e.Fabric.addPolygonAnchors=function(t,a){var i,s,r={},n=t.canvas,o=function(){var a=this.polyparams.polygon,i=this.polyparams.point,s=a.get("points"),o=t.display.image;void 0!==i&&!1!==a.params.changeable&&(a.angle?r=e.rotatePoint({x:this.left,y:this.top},-a.angle,{x:a.left,y:a.top}):(r.x=this.left,r.y=this.top),s[i].x=(r.x-a.left)/a.scaleX,s[i].y=(r.y-a.top)/a.scaleY,e.resetPolygonCenter(a),e.Fabric._updateShape.call(o,a.params.layerName,a,null,"update"),o&&(o.params.listonchange||a.params.listonchange)&&o.listRegions(a,{mode:2}),n.renderAll())},l=function(t){var a,i={};for(a=0;a<t.params.anchors.length;a++)i.x=t.left+t.points[a].x*t.scaleX,i.y=t.top+t.points[a].y*t.scaleY,t.angle&&(i=e.rotatePoint(i,t.angle,{x:t.left,y:t.top})),t.params.anchors[a].set({left:i.x,top:i.y,angle:t.angle}),t.params.anchors[a].setCoords();t._calcDimensions(!0),n.renderAll()};if(!a.params.anchors&&!1!==a.params.changeable){for(a.params.anchors=[],i=0;i<a.points.length;i++)r.x=a.left+a.points[i].x*a.scaleX,r.y=a.top+a.points[i].y*a.scaleY,a.angle&&(r=e.rotatePoint(r,a.angle,a.getCenterPoint())),(s=new fabric.Rect({left:r.x,top:r.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:a.get("stroke"),hoverCursor:"pointer",width:e.Fabric.opts.cornerSize+2,height:e.Fabric.opts.cornerSize+2,padding:2})).on("moving",o),s.polyparams={},s.polyparams.polygon=a,s.polyparams.point=i,a.params.anchors[i]=s,n.add(s);a.on("moving",function(){l(a)}),a.on("rotating",function(){l(a)}),a.on("scaling",function(){l(a)}),a.setCoords()}},e.Fabric.removePolygonAnchors=function(e,t){var a,i=e.canvas;if(t&&t.params&&t.params.anchors&&!1!==t.params.changeable){for(a=0;a<t.params.anchors.length;a++)i.remove(t.params.anchors[a]);delete t.params.anchors}},e.Fabric.updateChildren=function(t,a,i){var s,r,n,o,l,c;if("regions"===t.layerName)if("objects"===i)n={},t.canvas.getObjects().forEach(function(e){e.params&&(e.params.parent||e.params.children.length)&&(n[e.params.id]=e)}),t.canvas.getObjects().forEach(function(e){if(e.params)for(e.params.parent&&(e.params.parent.obj=n[e.params.parent.id]),s=0;s<e.params.children.length;s++)e.params.children[s].obj=n[e.params.children[s].id]});else if(a&&a.params)if("deltas"===i)a.params.parent&&((r=a.params.parent).dleft=r.obj.left-a.left,r.dtop=r.obj.top-a.top,r.moved=!0);else for(s=0;s<a.params.children.length;s++){switch(r=(o=a.params.children[s].obj).params.parent,i){case"moving":o.left=a.left-r.dleft,o.top=a.top-r.dtop;break;case"rotating":for(;0>a.angle;)a.angle+=360;for(;360<a.angle;)a.angle-=360;for(c=e.rotatePoint({x:o.left,y:o.top},l=a.angle-r.lastangle,{x:a.left,y:a.top}),o.left=c.x,o.top=c.y,r.dleft=a.left-o.left,r.dtop=a.top-o.top,o.angle+=l;0>o.angle;)o.angle+=360;for(;360<o.angle;)o.angle-=360;r.lastangle=a.angle;break;case"scaling":r.dleft*=a.scaleX/r.lastscalex,r.dtop=a.scaleY/r.lastscaley*(r.dtop-r.textheight)+r.textheight,r.lastscalex=a.scaleX,r.lastscaley=a.scaleY,r.moved=!0,o.left=a.left-r.dleft,o.top=a.top-r.dtop}o.setCoords(),t.display.image&&t.display.image.updateShapes(t.layerName,o,"child")}},e.resetPolygonCenter=function(t){var a,i,s,r;if(r={},1===fabric.major_version?(t._calcDimensions(),i=(t.minX+t.width/2)*t.scaleX,a=(t.minY+t.height/2)*t.scaleY):(i=((a=t._calcDimensions()).left+a.width/2)*t.scaleX,a=(a.top+a.height/2)*t.scaleY),t.angle?r=e.rotatePoint({x:t.left+i,y:t.top+a},t.angle,{x:t.left,y:t.top}):(r.x=t.left+i,r.y=t.top+a),1<fabric.major_version||5<=fabric.minor_version)for(i/=t.scaleX,s=a/t.scaleY,a=0;a<t.points.length;a++)t.points[a].x-=i,t.points[a].y-=s;t.left=r.x,t.top=r.y,1<fabric.major_version&&(r=t._calcDimensions(),t.width=r.width,t.height=r.height,t.pathOffset={x:r.left+t.width/2,y:r.top+t.height/2}),t.setCoords()},e.Fabric.print=function(t){var a,i,s,r,n,o,l=0,c=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));if("string"==typeof t)try{t=JSON.parse(t)}catch(p){e.error("can't parse print opts: "+t,p)}for(i in t=t||{},r=this.display.canvas.toDataURL("image/png"),a="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>",n=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,l),a+=sprintf("%s<img src='%s'></div>",n,r),this.layers)this.layers.hasOwnProperty(i)&&"main"===(r=this.layers[i]).dlayer.dtype&&r.show&&(a+=sprintf("%s%s</div>",n,r.dlayer.canvas.toSVG()));(void 0===t.colorbar||t.colorbar)&&(t=this.display.pluginInstances.JS9Colorbar)&&t.isActive()&&(l+=2,r=t.colorbarjq[0].toDataURL("image/png"),l+=this.display.height,n=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,l),a+=sprintf("%s<img src='%s'></div>",n,r),t.textjq&&t.textjq[0]&&(r=t.textjq[0].toDataURL("image/png"),l+=t.colorbarjq.height()+1,n=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,l),a+=sprintf("%s<img style='width:%spx;'src='%s'></div>",n,this.display.width,r))),a+="</body></html>",window.isElectron&&(o="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data; window.setTimeout(function(){window.print()}, 250);},false)<\/script><p>waiting for image ...</body></html>"),(s=window.open(o,this.id,c))?s.document?(s.document.open(),s.document.write(a),s.document.close()):s.postMessage?window.setTimeout(function(){s.postMessage(a,"*")},250):e.error("no method available for drawing image into print window"):e.error("could not create print window (check your pop-up blockers)")},e.Fabric.initGraphics=function(){var t;for(t in e.Display.prototype.newShapeLayer=e.Fabric.newShapeLayer,e.Image.prototype.addShapes=e.Fabric.addShapes,e.Image.prototype.selectShapes=e.Fabric.selectShapes,e.Image.prototype.updateShapes=e.Fabric.updateShapes,e.Image.prototype.updateShape=e.Fabric._updateShape,e.Image.prototype.getShapes=e.Fabric.getShapes,e.Image.prototype.changeShapes=e.Fabric.changeShapes,e.Image.prototype.removeShapes=e.Fabric.removeShapes,e.Image.prototype.refreshShapes=e.Fabric.refreshShapes,e.Image.prototype.getShapeLayer=e.Fabric.getShapeLayer,e.Image.prototype.showShapeLayer=e.Fabric.showShapeLayer,e.Image.prototype.activeShapeLayer=e.Fabric.activeShapeLayer,e.Image.prototype.displayShapeLayers=e.Fabric.displayShapeLayers,e.Image.prototype.toggleShapeLayers=e.Fabric.toggleShapeLayers,e.Image.prototype.print=e.Fabric.print,e.Fabric.opts)e.Fabric.opts.hasOwnProperty(t)&&(fabric.Object.prototype[t]=e.Fabric.opts[t])},e.Fabric.initGraphics(),e.MouseTouch={},e.MouseTouch.CLASS="JS9",e.MouseTouch.NAME="MouseTouch",e.MouseTouch.WIDTH=512,e.MouseTouch.HEIGHT=220,e.MouseTouch.BASE=e.MouseTouch.CLASS+e.MouseTouch.NAME,e.MouseTouch.mouseText=[],e.MouseTouch.mouseText[0]="move mouse, no buttons pressed:",e.MouseTouch.mouseText[1]="move mouse, primary button pressed:",e.MouseTouch.mouseText[2]="move mouse, secondary button pressed:",e.MouseTouch.touchText=[],e.MouseTouch.touchText[0]="touch move, with one finger:",e.MouseTouch.touchText[1]="touch move, with two fingers:",e.MouseTouch.touchText[2]="touch move, with three fingers:",e.MouseTouch.textHTML="<div style='float: left'>%s</div>",e.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>",e.MouseTouch.actionid=function(e,t){return(e+"_"+t).replace(/[^A-Za-z0-9_]/g,"_")},e.MouseTouch.addText=function(t,a){var i;return i=sprintf(e.MouseTouch.textHTML,a),$("<div>").addClass(e.MouseTouch.BASE+"Text").html(i).appendTo(t)},e.MouseTouch.addAction=function(t,a,i){return a=e.MouseTouch.actionid(a,i),i=sprintf(e.MouseTouch.actionHTML,i),$("<div>").addClass(e.MouseTouch.BASE+"Action").attr("id",a).html(i).appendTo(t)},e.MouseTouch.isPinch=function(t,a){var i,s,r,n,o=e.globalOpts.pinchWait,l=e.globalOpts.pinchThresh;if(!t)return-1;if(!(s=t.display).mousetouchZoom||2!==t.pos.touches.length)return-1;switch(s.ispinch){case-1:case 1:return s.ispinch}if(i=Math.sqrt((t.pos.touches[0].x-t.pos.touches[1].x)*(t.pos.touches[0].x-t.pos.touches[1].x)+(t.pos.touches[0].y-t.pos.touches[1].y)*(t.pos.touches[0].y-t.pos.touches[1].y)),s.dist0||(s.dist0=i),s.deltas.push(Math.floor(i-s.dist0)),s.deltas.length>=o){for(i=1,n=r=0;i<o;i++)s.deltas[i]>s.deltas[i-1]?r++:s.deltas[i]<s.deltas[i-1]&&n++;return s.ispinch=r>=l||n>=l?1:-1,s.lastzoom=0,s.ispinch}return 0},e.MouseTouch.Actions={},e.MouseTouch.Actions["display value/position"]=function(t,a,i){!e.specialKey(i)&&e.globalOpts.internalValPos&&t&&a&&0<a.x&&0<a.y&&a.x<t.raw.width&&a.y<t.raw.height&&(t.valpos=t.updateValpos(a,!0))},e.MouseTouch.Actions["change contrast/bias"]=function(t,a,i){var s=t.display;e.globalOpts.internalContrastBias&&t&&a&&!(t.pos0&&t.pos&&Math.abs(t.pos0.x-t.pos.x)<e.NOMOVE&&Math.abs(t.pos0.y-t.pos.y)<e.NOMOVE||t.clickInRegion||e.specialKey(i)||t.rgbFile)&&(i=e.eventToDisplayPos(i,t.posOffset),a=Math.floor(i.x+.5),i=Math.floor(i.y+.5),e.globalOpts.containContrastBias&&(0>a||0>i||a>=s.canvas.width||i>=s.canvas.height)||(t.params.bias=a/s.canvas.width,t.params.contrast=i/s.canvas.height*10,e.bugs.firefox_linux?window.setTimeout(function(){t.displayImage("scaled",{blendMode:!1})},0):t.displayImage("scaled",{blendMode:!1}),t.xeqstash&&t.xeqstash.filterRGBImage&&delete t.xeqstash.filterRGBImage,e.globalOpts.extendedPlugins&&t.xeqPlugins("image","onchangecontrastbias")))},e.MouseTouch.Actions["change contrast/bias"].stop=function(e,t,a){e.display.blendMode&&e.displayImage("rgb")},e.MouseTouch.Actions["wheel zoom"]=function(t,a){var i;t&&t.display.mousetouchZoom&&(i=0<a.originalEvent.deltaY?Math.min(e.MAXZOOM,t.getZoom()+e.ADDZOOM):Math.max(e.MINZOOM,t.getZoom()-e.ADDZOOM),i=Math.round(100*(i+1e-5))/100,t.setZoom(i))},e.MouseTouch.Actions["pan the image"]=function(e,t,a){var i;e&&(t=(e.pos0.x-e.pos.x)/(i=e.rgb.sect).zoom,a=(e.pos0.y-e.pos.y)/i.zoom,1<=Math.abs(t)||1<=Math.abs(a))&&(e.setPan(i.xcen+t,i.ycen-a),e.pos0=e.pos)},e.MouseTouch.Actions.pinch=function(t,a,i){t&&(i=(a=t.display).zoom0*Math.sqrt((t.pos.touches[0].x-t.pos.touches[1].x)*(t.pos.touches[0].x-t.pos.touches[1].x)+(t.pos.touches[0].y-t.pos.touches[1].y)*(t.pos.touches[0].y-t.pos.touches[1].y))/a.dist0,(i=Math.max(e.MINZOOM,Math.min(e.MAXZOOM,Math.round(100*(i+1e-5))/100)))!==a.lastzoom&&t.setZoom(i),a.lastzoom=i)},e.MouseTouch.Actions.start=function(t,a,i){t&&((a=t.display).ispinch=0,a.dist0=0,a.zoom0=t.rgb.sect.zoom,a.deltas=[]),a=e.MouseTouch.getAction(t,i),e.MouseTouch.Actions[a]&&e.MouseTouch.Actions[a].start&&e.MouseTouch.Actions[a].start(t,t.ipos,i)},e.MouseTouch.Actions.stop=function(t,a,i){a=e.MouseTouch.getAction(t,i),e.MouseTouch.Actions[a]&&e.MouseTouch.Actions[a].stop&&e.MouseTouch.Actions[a].stop(t,t.ipos,i)},e.MouseTouch.getAction=function(t,a){var i,s;if(!t)return i;switch(s=t.display,t.clickState){case 0:i=s.mouseActions[0];break;case 1:i=s.mouseActions[1];break;case 2:i=s.mouseActions[2];break;case-1:i=s.touchActions[0];break;case-2:switch(e.MouseTouch.isPinch(t,a)){case-1:i=s.touchActions[1];break;case 1:i="pinch"}break;case-3:i=s.touchActions[2]}return i},e.MouseTouch.action=function(t,a,i){(i=i||e.MouseTouch.getAction(t,a))&&e.MouseTouch.Actions[i]&&e.MouseTouch.Actions[i](t,t.ipos,a)},e.MouseTouch.mousetouchzoom=function(t,a){var i=e.lookupDisplay(t);i&&(i.mousetouchZoom=a.checked)},e.MouseTouch.init=function(){var t,a,i=this;if(this.divjq.html(""),this.divjq.addClass("JS9PluginScrolling"),this.mousetouchContainer=$("<div>").addClass(e.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq),a=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",e.MouseTouch.BASE+"Header"),this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(e.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(a).appendTo(this.mousetouchContainer),this.mousetouchTextContainer=$("<span style='float: left'>").addClass(e.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer),this.mousetouchActionContainer=$("<span style='float: left'>").addClass(e.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer),e.TOUCHSUPPORTED){for(this.mousetouchTouchTextContainer=$("<div>").addClass(e.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer),t=0;t<e.MouseTouch.touchText.length;t++)e.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,e.MouseTouch.touchText[t]);for(t=e.MouseTouch.touchText.length;t<this.display.touchActions.length;t++)e.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");for(this.mousetouchTouchContainer=$("<div>").addClass(e.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer),t=0;t<this.display.touchActions.length;t++)e.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",a=this.display.touchActions[t]);this.mousetouchTouchContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index(),s=i.display.touchActions.splice(this.oidx,1)[0];i.display.touchActions.splice(a,0,s)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){for(this.mousetouchMouseTextContainer=$("<div>").addClass(e.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer),t=0;3>t;t++)e.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,e.MouseTouch.mouseText[t]);for(t=3;t<this.display.mouseActions.length;t++)e.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");for(this.mousetouchMouseContainer=$("<div>").addClass(e.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer),t=0;t<this.display.mouseActions.length;t++)e.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",a=this.display.mouseActions[t]);this.mousetouchMouseContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index(),s=i.display.mouseActions.splice(this.oidx,1)[0];i.display.mouseActions.splice(a,0,s)}})}a=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",e.MouseTouch.BASE+"Footer",this.display.id),this.mousetouchFootContainer=$("<span style='float: left'>").addClass(e.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(a).appendTo(this.mousetouchContainer),this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)},e.Regions={},e.Regions.CLASS="JS9",e.Regions.NAME="Regions",e.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",sortOverlapping:!0,title:"Region Configuration",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(t,a,i,s){var r;!e.specialKey(i)&&s.params&&(a=(new Date).getTime(),s.params.lasttime&&a-s.params.lasttime<e.DBLCLICK&&(r=!0),s.params.lasttime=a),r?s.params.winid||!1===s.params.changeable||e.Regions.displayConfigForm.call(t,s):e.specialKey(i)&&("polygon"===s.type||"polyline"===s.type?(e.Fabric.addPolygonPoint.call(t,s.params.layerName,s,i),e.Fabric._updateShape.call(t,s.params.layerName,s,null,"update")):s.polyparams&&s.polyparams.polygon&&(e.Fabric.removePolygonPoint.call(t,(i=s.polyparams.polygon).params.layerName,s),e.Fabric._updateShape.call(t,i.params.layerName,i,null,"update")))},onmouseup:function(){var e,t=[];for(this.getActiveObject()&&t.push(this.getActiveObject()),1===fabric.major_version?this.getActiveGroup()&&(t=this.getActiveGroup().getObjects()):t.push(this.getActiveObjects()),e=0;e<t.length;e++)t[e].polyparams&&this.setActiveObject(t[e].polyparams.polygon)},onchange:null},e.Regions.init=function(t){var a;return e.Image.prototype.parseRegions=e.Regions.parseRegions,e.Image.prototype.saveRegions=e.Regions.saveRegions,e.Image.prototype.listRegions=e.Regions.listRegions,e.Image.prototype.copyRegions=e.Regions.copyRegions,e.Image.prototype.editRegionTags=e.Regions.editRegionTags,e.Image.prototype.toggleRegionTags=e.Regions.toggleRegionTags,e.Image.prototype.unremoveRegions=e.Regions.unremoveRegions,(a=this.display.newShapeLayer(t||"regions",e.Regions.opts)).canvas.on("mouse:up",function(){var e,t,i=[];if(a.display.image)for(t=a.display.image,1===fabric.major_version?(this.getActiveObject()&&i.push(this.getActiveObject()),this.getActiveGroup()&&(i=this.getActiveGroup().getObjects())):i.push(this.getActiveObjects()),e=0;e<i.length;e++)if(i[e].params){t.params.listonchange?t.listRegions("all"===t.params.whichonchange?"all":"selected",{mode:2}):i[e].params.listonchange&&t.listRegions("selected",{mode:2});break}}),this},e.Regions.displayConfigForm=function(t){var a,i=this,s=e.Regions.opts.title;t&&($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){t.pub&&e.Regions.initConfigForm.call(i,t)}),a=e.allinone?e.allinone.regionsConfigHTML:e.InstallDir(e.Regions.opts.configURL),t.params.winid=i.displayAnalysis("regions",a,{title:s}))},e.Regions.initConfigForm=function(t){var a,i,s,r,n,o,l,c,p,d,h=this;d=(p=t.params).winid;var g="#"+$(d).attr("id")+" #regionsConfigForm ",u=function(e){if(void 0!==e)return"number"==typeof e&&0!=e%1&&(e=Math.round(1e4*(e+1e-5))/1e4),String(e)},m=function(e){return(e||"").replace(/\n/g,"\\n")};switch(i=$(g).data("wcssys"),$(g+"."+t.pub.shape).each(function(){$(this).removeClass("nodisplay")}),$(g+".val").each(function(){switch(r="",s=$(this).attr("name")){case"x":case"y":void 0!==t.pub.lcs&&void 0!==t.pub.lcs[s]?r=u(t.pub.lcs[s]):void 0!==t.pub[s]&&(r=u(t.pub[s]));break;case"radii":t.pub.radii&&(r="image"!==h.params.wcssys&&"physical"!==h.params.wcssys&&t.pub.wcsstr?t.pub.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):t.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));break;case"pts":t.pub.pts?t.pub.pts.forEach(function(e){r&&(r+=", "),r+=sprintf("%s, %s",e.x.toFixed(2),e.y.toFixed(2))}):t.pub.imstr&&(r=t.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;case"fontFamily":t.getFontFamily&&(r=t.getFontFamily());break;case"fontSize":t.getFontSize&&(r=t.getFontSize());break;case"fontStyle":t.getFontStyle&&(r=t.getFontStyle());break;case"fontWeight":t.getFontWeight&&(r=t.getFontWeight());break;case"strokeWidth":r=t.params.sw1;break;case"strokeDashes":t.strokeDashArray?(r=t.strokeDashArray.join(" ")).match(/NaN/)&&(r=""):r="";break;case"regstr":r="image"!==h.params.wcssys&&"physical"!==h.params.wcssys&&t.pub.wcsstr?t.pub.wcssys+"; "+t.pub.wcsstr:t.pub.imsys+"; "+t.pub.imstr;break;case"xpos":switch(h.params.wcssys){case"image":r=sprintf("%.1f",t.pub.x);break;case"physical":r=t.pub.lcs?sprintf("%.1f",t.pub.lcs.x):sprintf("%.1f",t.pub.x);break;default:r=void 0!==t.pub.ra?sprintf("%.6f",t.pub.ra):sprintf("%.1f",t.pub.x)}l=r;break;case"ypos":switch(h.params.wcssys){case"image":r=sprintf("%.1f",t.pub.y);break;case"physical":r=t.pub.lcs?sprintf("%.1f",t.pub.lcs.y):sprintf("%.1f",t.pub.y);break;default:r=void 0!==t.pub.dec?sprintf("%.6f",t.pub.dec):sprintf("%.1f",t.pub.y)}c=r;break;case"radius":case"oradius":case"length":case"width":case"r1":switch(h.params.wcssys){case"image":void 0!==t.pub[s]&&(r=u(t.pub[s]));break;case"physical":void 0!==t.pub.lcs[s]&&(r=u(t.pub.lcs[s]));break;default:r=u(t.pub.wcssizestr?t.pub.wcssizestr[0]:t.pub[s])}break;case"height":case"r2":switch(h.params.wcssys){case"image":void 0!==t.pub[s]&&(r=u(t.pub[s]));break;case"physical":void 0!==t.pub.lcs[s]&&(r=u(t.pub.lcs[s]));break;default:r=u(t.pub.wcssizestr?t.pub.wcssizestr[1]:t.pub[s])}break;case"wcssys":if(!(n=$(g).find("[name='"+s+"']")).find("option").length)for(a=0;a<e.wcssyss.length;a++)n.append("<option>"+(o=e.wcssyss[a])+"</option>");n.find("option").each(function(e,t){h.params.wcssys===t.value&&(r=t.value)});break;case"altwcssys":if(!(n=$(g).find("[name='"+s+"']")).find("option").length)for(a=0;a<e.wcssyss.length;a++)"image"!==(o=e.wcssyss[a])&&"physical"!==o&&n.append("<option>"+o+"</option>");(r=$(g).data("wcssys"))||n.find("option").each(function(e,t){h.params.wcssys===t.value&&(r=t.value)});break;case"wcsunits":t.pub.wcsunits&&(r=t.pub.wcsunits);break;case"childtext":0<t.params.children.length&&(r=m(t.params.children[0].obj.text));break;case"text":void 0!==t.pub[s]&&(r=m(u(t.pub[s])));break;case"id":r=t.pub.id;break;default:void 0!==t.pub[s]&&(r=u(t.pub[s]))}$(this).val(r)}),(!this.raw.wcs||0>this.raw.wcs)&&$(g).find("[name='wcssys']").hide(),"image"===this.params.wcssys||"physical"===this.params.wcssys||!this.raw.wcs||0>this.raw.wcs?$(g).find("[name='altwcssys']").hide():($(g).find("[name='altwcssys']").show(),i&&h.params.wcssys!==i&&(i=h.wcs2wcs(null,i,l,c).split(/\s+/),$(g).find("[name='xpos']").val(i[0]),$(g).find("[name='ypos']").val(i[1]))),"text"!==t.type&&($(g+".childtext").removeClass("nodisplay"),$(g+"[name='childtext']").prop("readonly",0<p.children.length)),void 0===p.listonchange&&(p.listonchange=!1),p.listonchange?$(g+"[name='listonchange']").prop("checked",!0):$(g+"[name='listonchange']").prop("checked",!1),void 0===p.changeable&&void 0!==p.fixinplace&&(p.changeable=!p.fixinplace),void 0===p.changeable&&(p.changeable=!0),p.changeable?$(g+"[name='changeable']").prop("checked",!0):$(g+"[name='changeable']").prop("checked",!1),$(g).find("input:text[readonly]").css("border-color","A5A5A5").css("background","#E9E9E9"),t.pub.shape){case"box":case"ellipse":$(g+".angle").removeClass("nodisplay");break;case"text":$(g+".textangle").removeClass("nodisplay")}$(g).data("im",this),$(g).data("shape",t),$(g).data("winid",d),$(g).data("tooltipInit")||($(g).data("tooltipInit",!0),e.BROWSER[3]?(p="touchstart",d="touchend"):(p="mouseover",d="mouseout"),$(".col_R").on(p,function(){var t;t=$(this).find("input").data("tooltip");var a=$(this).closest(".dhtmlwindow").find(".drag-handle");t&&a.length&&(t=e.Regions.opts.title+": "+t,$(a)[0].childNodes[0].nodeValue=t)}),$(".col_R").on(d,function(){var t=$(this).closest(".dhtmlwindow").find(".drag-handle");t.length&&($(t)[0].childNodes[0].nodeValue=e.Regions.opts.title)}))},e.Regions.processConfigForm=function(t,a,i,s){var r,n,o,l,c=s.length,p=1,d={},h=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},g=function(e){if(void 0!==e)return"number"==typeof e&&0!=e%1&&(e=Math.round(1e4*(e+1e-5))/1e4),String(e)},u=function(e,t){return void 0!==e&&g(e)!==g(t)},m=function(t,a,i){return"remove"===a?"selected"===i:"childtext"===a?!(0<t.params.children.length)&&""!==i:"strokeDashes"===a?JSON.stringify(t.strokeDashArray)!==JSON.stringify(i):("tags"===a||""!==i)&&("misc"===a&&""!==i||("angle"===a?t.angle!==-parseFloat(i):"ix"===a?u(t.pub.x,e.saostrtod(i)):"iy"===a?u(t.pub.y,e.saostrtod(i)):"px"===a?u(t.pub.lcs.x,e.saostrtod(i)):"py"===a?u(t.pub.lcs.y,e.saostrtod(i)):"ra"===a?u(e.saostrtod(t.pub.wcsposstr[0]),e.saostrtod(i)):"dec"===a?u(e.saostrtod(t.pub.wcsposstr[1]),e.saostrtod(i)):void 0!==t.pub.lcs[a]?!!u(t.pub.lcs[a],i):!!(u(t.pub[a],i)||u(t.params[a],i)||u(t[a],i))))},f=function(t){return"true"===t||"false"!==t&&(e.isNumber(t)?parseFloat(t):t)},y=function(e){var t=String.fromCharCode(13,10);return(e||"").replace(/\\n/g,t)};for(this.lcs&&this.lcs.physical&&(p=this.lcs.physical.forward[0][0]||1),r=0;r<c;r++){if(o=s[r].value,"xpos"===(n=s[r].name)||"ypos"===n)switch(this.params.wcssys){case"image":n="i"+n.charAt(0);break;case"physical":n="p"+n.charAt(0);break;default:n=this.raw.wcs&&0<this.raw.wcs?"xpos"===n?"ra":"dec":"xpos"===n?"ix":"iy"}switch(n){case"text":"text"===a.type&&m(a,n,o)&&(d[n]=y(f(o)));break;case"strokeDashes":m(a,n,o=o.trim().split(/\s+/))&&(d.strokeDashArray=0===o.length?[]:o.map(function(e){return parseInt(e,10)}));break;case"childtext":"text"!==a.type&&m(a,n,o)&&(d.text=y(f(o)));break;case"ix":m(a,n,o)&&(d.x=f(o),void 0===d.y&&(d.y=a.pub.y));break;case"iy":m(a,n,o)&&(d.y=f(o),void 0===d.x&&(d.x=a.pub.x));break;case"px":m(a,n,o)&&(d.px=f(o),void 0===d.py&&(d.py=a.pub.lcs.y));break;case"py":m(a,n,o)&&(d.py=f(o),void 0===d.px&&(d.px=a.pub.lcs.x));break;case"ra":m(a,n,o)&&(d.ra=o,void 0===d.dec&&(d.dec=a.pub.wcsposstr[1]));break;case"dec":m(a,n,o)&&(d.dec=o,void 0===d.ra&&(d.ra=a.pub.wcsposstr[0]));break;case"wcssys":break;case"radius":case"length":case"width":case"r1":switch(this.params.wcssys){case"image":m(a,n,o)&&(d[n]=f(o));break;case"physical":m(a,n,o)&&(d[n]=f(o)*p);break;default:o="."===(o=e.strtoscaled(o)).dtype?o.dval:Math.abs(o.dval/h.cdelt1),m(a,n=n.replace("wcs",""),o)&&(d[n]=f(o))}break;case"height":case"r2":switch(this.params.wcssys){case"image":m(a,n,o)&&(d[n]=f(o));break;case"physical":m(a,n,o)&&(d[n]=f(o)*p);break;default:o="."===(o=e.strtoscaled(o)).dtype?o.dval:Math.abs(o.dval/h.cdelt2),m(a,n=n.replace("wcs",""),o)&&(d[n]=f(o))}break;case"remove":m(a,n,o)&&(d[n]=a.pub.id);break;case"misc":if(o.trim())try{l=JSON.parse(o),$.extend(d,l)}catch(b){e.error("invalid json: "+o)}break;default:m(a,n,o)&&(d[n]=f(o))}}d.ra&&d.dec&&(t=$(t).data("wcssys"))&&this.params.wcssys!==t&&(t=this.wcs2wcs(t,null,d.ra,d.dec).split(/\s+/),d.ra=t[0],d.dec=t[1]),this.changeShapes(a.pub.layer,a,d),e.Regions.initConfigForm.call(this,a,i)},e.Regions.pasteFromClipboard=function(t){var a,i,s,r,n=0,o=0;if(this){if((a=e.CopyFromClipboard().trim())||e.error(e.CLIPBOARDERROR),a.match(/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/)){if(s=e.globalOpts.regionsToClipboard,e.globalOpts.regionsToClipboard=!1,r=this.addShapes("regions",a,{rtn:"objs"}),t){for(i=r.length,t=0;t<i;t++)n+=r[t].pub.x,o+=r[t].pub.y;for(n/=i,o/=i,t=0;t<i;t++)this.changeShapes("regions",r[t].pub.id,{x:r[t].pub.x-n+this.ipos.x,y:r[t].pub.y-o+this.ipos.y})}e.globalOpts.regionsToClipboard=s}else e.error(e.CLIPBOARDERROR2);return a}},e.Regions.listRegions=function(t,a,i){var s,r,n,o,l,c,p="",d="none",h=!1,g=[];n={};var u=function(e,t){var a,i,s,r={},n=e.params,o=n.children,l=n.exports;for(a=0;a<l.length;a++)if(("text"!==(s=l[a])||"text"===e.type)&&"textOpts"!==s){if("strokeDashArray"===s&&(""===(i=e.strokeDashArray.join(""))||i.match(/NaN/)))continue;"data"===s&&"object"==typeof n.data&&!1===n.data.doexport||("strokeWidth"===s&&n.sw1?r[s]=n.sw1:void 0!==e[s]?r[s]=e[s]:void 0!==n[s]?r[s]=n[s]:t&&void 0!==t[s]&&(r[s]=t[s]))}return 0<o.length&&o[0].obj.text&&(r.text=(a=o[0].obj).text,r.textOpts=u(a),e.angle!==a.angle?(r.textOpts.angle=-a.angle,("circle"===e.params.shape||"annulus"===e.params.shape)&&(a.params.hasTextOpts=!0)):0!==a.angle?"circle"!==e.params.shape&&"annulus"!==e.params.shape||(r.textOpts.angle=-a.angle,a.params.hasTextOpts=!0):0!==e.angle||0===e.pub.angle||"circle"!==e.params.shape&&"annulus"!==e.params.shape||(r.textOpts.angle=e.pub.angle,a.params.hasTextOpts=!0),(a.params.parent.moved||a.params.hasTextOpts)&&(a.pub.ra&&a.pub.dec?(r.textOpts.ra=a.pub.ra,r.textOpts.dec=a.pub.dec):a.pub.lcs?(r.textOpts.px=a.pub.lcs.x,r.textOpts.py=a.pub.lcs.y):(r.textOpts.x=a.pub.x,r.textOpts.y=a.pub.y)),r.textOpts.color===e.stroke&&delete r.textOpts.color,r.textOpts.text&&delete r.textOpts.text,Object.keys(r.textOpts).length||delete r.textOpts),r};if("string"==typeof a)try{a=JSON.parse(a)}catch(m){e.error("can't parse listRegions opts: "+a,m)}if(void 0===(a=(a=a||{}).mode)&&(a=3),void 0===i&&(i="regions"),s=(c=this.getShapes(i,t,{includeObj:!0})).length,a)for(t=0;t<s;t++)if((o=(i=c[t]).tags.join(","))&&"source,include"!==o&&"include,source"!==o){h=!0;break}for(r in e.Regions.opts.tagcolors)e.Regions.opts.tagcolors.hasOwnProperty(r)&&g.push(e.Regions.opts.tagcolors[r]);for(t=0;t<s;t++)n=(i=c[t]).obj,r=0<=(o=i.tags.join(",")).indexOf("exclude")?"-":"",n=u(n,i),i.color&&-1===g.indexOf(i.color)&&(n.color=i.color),h&&(l=" # "+o),i.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==d&&("none"!==d&&(p+="; "),p+=this.params.wcssys,d="wcs"),p+="; "+r+i.wcsstr):i.imstr&&(d!==i.imsys&&("none"!==d&&(p+="; "),p+=i.imsys,d=i.imsys),p+="; "+r+i.imstr),1==a%2&&0<Object.keys(n).length&&(p+=" "+JSON.stringify(n)),l&&(p+=l);return 1<a&&this.display.displayMessage("regions",p),p},e.Regions.copyRegions=function(t,a){var i,s,r=[];if("object"==typeof t)r.push(t);else if("all"===t)for(i=0;i<e.images.length;i++)this!==e.images[i]&&r.push(e.images[i]);else(i=e.lookupImage(t))&&r.push(i);if(r.length){for(a||(s=this.listRegions("selected",{mode:1})),s||(s=this.listRegions(a,{mode:1})),i=0;i<r.length;i++)r[i].addShapes("regions",s);return this}},e.Regions.parseRegions=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m,f=[],y=/^(annulus|box|circle|ellipse|line|polygon|point|text)$/,b=/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/,S=/^(image|physical)$/,v=/[dr:]/,w=/\(\s*([^)]+?)\s*\)/,x=/(\{.*\})/,J=/\s*,\s*/,k=/#(?![a-zA-Z0-9]{6}['"])/,C=function(e){return"0"!==e&&"false"!==e},I=function(e){var t,a,i,s={opts:{},args:[],isregion:0};if(s.cmd=0<=e.indexOf("(")?e.split("(")[0].trim().toLowerCase():0<=e.indexOf("{")?e.split("{")[0].trim().toLowerCase():0<=e.indexOf("#")?e.split("#")[0].trim().toLowerCase():e.trim().toLowerCase(),s.cmd&&(s.isregion=0<=s.cmd.search(y)),t=e.trim().split(k),(a=x.exec(t[0]))&&a[0])try{s.opts=JSON.parse(a[0].trim())}catch(r){s.opts={}}return s.comment=t[1],s.comment&&void 0!==(i=function(e){for(var t,a,i,s={},r=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,n={color:function(e){return{color:e}},dash:function(e){if(e)return{strokeDashArray:[3,1]}},dashlist:function(e){var t;if(e){for(t=e.split(" "),e=0;e<t.length;e++)t[e]=parseFloat(t[e]);return{strokeDashArray:t}}},delete:function(e){return{removable:C(e)}},edit:function(e){return{selectable:C(e)}},fixed:function(e){return{zoomable:!C(e)}},font:function(e){var t={},a=(e=e.split(" ")).length;return 1<=a&&(t.fontFamily=e[0]),2<=a&&(t.fontSize=parseFloat(e[1])),3<=a&&(t.fontStyle=e[2]),4<=a&&(t.fontWeight=e[3]),t},highlite:function(e){return{hasControls:C(e),hasBorders:C(e),hasRotatingPoint:C(e)}},move:function(e){return{movable:C(e)}},rotate:function(e){return{rotatable:C(e)}},resize:function(e){return{resizable:C(e)}},changeable:function(e){return{changeable:C(e)}},select:function(e){return{selectable:C(e)}},text:function(e){return{text:e}},tag:function(e){return{tags:e}},width:function(e){return{strokeWidth:parseFloat(e)}}};null!==(t=r.exec(e));)if(a=t[1],t=t[2].replace(/^['"{]|['"}]$/g,""),n.hasOwnProperty(a)&&"function"==typeof n[a])for(i in a=n[a](t))a.hasOwnProperty(i)&&("tags"===i&&s.hasOwnProperty(i)?s[i]+=","+a[i]:s[i]=a[i]);else s[a]=t;return(e=e.replace(r,""))&&(s._comment=e.trim()),s}(s.comment.trim().toLowerCase()))._comment&&(s.comment=i._comment,delete i._comment),i&&(s.opts=$.extend({},i,s.opts)),(a=w.exec(e))&&a[1]&&(s.args=a[1].split(J)),s.isregion&&0===s.cmd.indexOf("-")&&(s.cmd=s.cmd.slice(1),s.comment=s.comment?s.comment+",exclude":"exclude"),s},M=function(t,a){var i,s;return s=e.strtoscaled(t),i=e.strtoscaled(a),!s.dtype.match(v)&&!i.dtype.match(v)||c.match(S)||(g=!0,d=c),h||g?(":"===s.dtype&&"galactic"!==d&&"ecliptic"!==d&&(s.dval*=15),"r"===s.dtype&&(s.dval=180*s.dval/Math.PI),"r"===i.dtype&&(i.dval=180*i.dval/Math.PI),i=e.wcs2pix(this.raw.wcs,s.dval,i.dval).split(/ +/),s=parseFloat(i[0]),i=parseFloat(i[1])):"physical"===d?(s=(i=this.logicalToImagePos({x:s.dval,y:i.dval})).x,i=i.y):(s=s.dval,i=i.dval),[s,i]},T=function(t,a){var i=e.strtoscaled(t),s=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};return i.dtype.match(v)&&!c.match(S)&&(g=!0,d=c),h||g?("r"===i.dtype&&(i.dval=180*i.dval/Math.PI),i.dval=Math.abs(i.dval/s["cdelt"+a])):"physical"===d&&this.lcs&&this.lcs.physical&&(i.dval*=this.lcs.physical.forward[0][0]),i.dval},A=function(t){t=e.strtoscaled(t);var a=this.raw.wcsinfo||{crot:0};return a.crot&&(t.dval+=a.crot),t.dval};if(!(t=t.trim()).match(/(\(|\{|#|;|\n)/))return t;for(c=this.getWCSSys(),p=this.getWCSUnits(),h="image"!=(d="physical")&&"physical"!==d,n=t.split(/\n|;/),i=0;i<n.length;i++)if("#"!==n[i].trim().substr(0,1))if(g=!1,m=(l=I(n[i])).args.length,l.isregion){switch((o=$.extend(!0,{},l.opts)).shape=l.cmd,2<=m&&(u=M.call(this,l.args[0],l.args[1]),o.x=u[0],o.y=u[1]),o.textOpts&&void 0!==o.textOpts.ra&&void 0!==o.textOpts.dec&&(o.textOpts._wcssys=d),l.cmd){case"annulus":for(o.radii=[],s=2;s<m;s++)o.radii.push(T.call(this,l.args[s],1));break;case"box":3<=m&&(o.width=T.call(this,l.args[2],1)),4<=m&&(o.height=T.call(this,l.args[3],2)),5<=m&&(o.angle=A.call(this,l.args[4]));break;case"circle":3<=m&&(o.radius=T.call(this,l.args[2],1));break;case"ellipse":3<=m&&(o.r1=T.call(this,l.args[2],1)),4<=m&&(o.r2=T.call(this,l.args[3],2)),5<=m&&(o.angle=A.call(this,l.args[4]));break;case"line":case"polygon":for(o.pts=[],r=s=0;s<m;s+=2,r++)u=M.call(this,l.args[s],l.args[s+1]),o.pts[r]={x:u[0],y:u[1]};delete o.x,delete o.y;break;case"text":3<=m&&(o.text=l.args[2].replace(/^['"]/,"").replace(/["']$/,"")),4<=m&&(o.angle=A.call(this,l.args[3]))}l.comment&&(o.tags=l.comment),f.push(o)}else l.cmd.match(b)?(s=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(l.cmd),e.globalOpts.xeqPlugins=s,d=this.getWCSSys(),h="image"!==d&&"physical"!==d):"remove"!==l.cmd&&"delete"!==l.cmd||f.push({remove:!0});return s=e.globalOpts.xeqPlugins,e.globalOpts.xeqPlugins=!1,this.setWCSSys(c),this.setWCSUnits(p),e.globalOpts.xeqPlugins=s,f},e.Regions.saveRegions=function(t,a,i){var s,r,n,o,l,c,p;if(t&&(c=t.match(/\.([^.]*)$/))&&2<=c.length&&("reg"===c[1]||"svg"===c[1])&&(o=c[1]),"object"==typeof i)l=i,i=null;else if("string"==typeof i){try{l=JSON.parse(i)}catch(d){l=null}l&&(i=null)}switch(l&&(e.notNull(l.layer)&&(i=l.layer),e.notNull(l.type)&&(o=l.type)),o=o||"reg",this.layers[i=i||"regions"]||e.error("can't find layer for saveRegions: "+i),o){case"svg":try{e.globalOpts.svgBorder&&(p=this.addShapes(i,"box",{left:this.rgb.img.width/2,top:this.rgb.img.height/2,width:this.rgb.img.width,height:this.rgb.img.height,color:"black",strokeWidth:1,tags:"SVGBorder"})),n=this.layers[i].dlayer.canvas.toSVG(),e.globalOpts.svgBorder&&this.removeShapes(i,p)}catch(d){e.error("can't convert layer to SVG: "+i)}break;default:try{s=sprintf("# Region file format: JS9 version 1.0"),r=this.listRegions(a,{mode:1},i),n=sprintf("%s\n%s\n",s,r.replace(/; */g,"\n"))}catch(d){e.error("can't convert layer to region: "+i)}}return a=new Blob([n],{type:"text/plain;charset=utf-8"}),t||(t=i&&"regions"!==i?"js9_"+i+"."+o:"js9."+o),window.hasOwnProperty("saveAs")?saveAs(a,t):e.error("no saveAs function available to save region file"),t},e.Regions.editRegionTags=function(e,t,a){var i,s,r,n,o=[];if((r=this.getShapes("regions",e)).length){for(i=0;i<r.length;i++)for(n=r[i].tags,o.push(t),s=0;s<n.length;s++)n[s]!==a&&o.push(n[s]);this.changeShapes("regions",e,{tags:o})}},e.Regions.toggleRegionTags=function(e,t,a){var i,s,r,n,o;if((r=this.getShapes("regions",e)).length){for(i=0;i<r.length;i++)for(n=r[i].tags,o="",s=0;s<n.length;s++){if(n[s]===t){o=n[s]=a;break}if(n[s]===a){o=n[s]=t;break}}o&&this.changeShapes("regions",e,{tags:n})}},e.Regions.unremoveRegions=function(){var e=this.regstack.pop();return e?this.addShapes("regions",e):null},e.Catalogs={},e.Catalogs.CLASS="JS9",e.Catalogs.NAME="Catalogs",e.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1},e.Crosshair={},e.Crosshair.CLASS="JS9",e.Crosshair.NAME="Crosshair",e.Crosshair.LAYERNAME="crosshair",e.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,arrowSize:20,strokeWidth:1,color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}},e.Crosshair.display=function(t,a,i){var s,r,n,o,l,c,p,d=e.Crosshair.LAYERNAME;if(i=!!/iPad|iPhone|iPod/.test(navigator.platform)||i.shiftKey,(t.tmp.arrowCrosshair||i&&t&&!t.tmp.shiftKey&&t.crosshair&&t.params.crosshair)&&(t.tmp.arrowCrosshair&&!t.params.crosshair?(i=a.x-(n=e.Crosshair.opts.arrowSize/t.rgb.sect.zoom),c=a.x+n,r=a.y-n,p=a.y+n):(i=0,c=t.raw.width,r=0,p=t.raw.height),t.changeShapes(d,t.crosshair.h,c={pts:[{x:i,y:a.y},{x:c,y:a.y}],redraw:!1}),t.changeShapes(d,t.crosshair.v,i={pts:[{x:a.x,y:r},{x:a.x,y:p}],redraw:!0}),t.crosshair.visible=!0,e.globalOpts.wcsCrosshair&&t&&t.raw.wcs&&0<t.raw.wcs))for(r=e.pix2wcs(t.raw.wcs,a.x,a.y).trim().split(/\s+/),o=e.saostrtod(r[0]),":"===String.fromCharCode(e.saodtype())&&"galactic"!==t.params.wcssys&&"ecliptic"!==t.params.wcssys&&(o*=15),l=e.saostrtod(r[1]),a=0;a<e.displays.length;a++)if((n=e.displays[a].image)&&n!==t&&n.crosshair&&n.params.crosshair&&0<n.raw.wcs){c=n.raw.width,p=n.raw.height;try{s=e.wcs2pix(n.raw.wcs,o,l)}catch(h){s=null}s&&(r=s.trim().split(/\s+/),i=parseFloat(r[0]),r=parseFloat(r[1]),0<i&&i<c&&0<r&&r<p&&(n.changeShapes(d,n.crosshair.h,c={pts:[{x:0,y:r},{x:c,y:r}],redraw:!1}),n.changeShapes(d,n.crosshair.v,i={pts:[{x:i,y:0},{x:i,y:p}],redraw:!0}),n.crosshair.visible=!0))}},e.Crosshair.hide=function(t,a,i){a=e.Crosshair.LAYERNAME,i=e.Crosshair.opts.hiddenPts,(t&&t.crosshair&&t.crosshair.visible||t.tmp.arrowCrosshairVisible)&&(t.changeShapes(a,t.crosshair.h,i),t.changeShapes(a,t.crosshair.v,i),t.crosshair.visible=!1,delete t.tmp.arrowCrosshairVisible)},e.Crosshair.create=function(t){var a=e.Crosshair.opts.hiddenPts,i=e.Crosshair.LAYERNAME;t&&!t.crosshair&&(t.crosshair={},t.crosshair.h=t.addShapes(i,"line",a),t.crosshair.v=t.addShapes(i,"line",a),t.crosshair.visible=!1)},e.Crosshair.keyaction=function(e,t,a){e&&a&&a.shiftKey&&(e.tmp.shiftKey=!0)},e.Crosshair.keyup=function(e,t,a){e&&e.tmp.shiftKey&&a&&!a.shiftKey&&delete e.tmp.shiftKey},e.Crosshair.init=function(){var t,a=e.Crosshair.LAYERNAME;for(t=0;t<e.displays.length;t++)e.displays[t].layers.crosshair||e.displays[t].newShapeLayer(a,e.Crosshair.opts);return this},e.Image.prototype.toggleCrosshair=function(){this.params.crosshair=!this.params.crosshair,this.params.crosshair||e.Crosshair.hide(this)},e.Image.prototype.toggleWCSCrosshair=function(){e.globalOpts.wcsCrosshair=!e.globalOpts.wcsCrosshair},e.Grid={},e.Grid.CLASS="JS9",e.Grid.NAME="Grid",e.Grid.LAYERNAME="grid",e.Grid.opts={movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6},e.Grid.limits=function(e,t,a,i){return e=1<(e=a-t)?10:.1<e?100:.01<e?1e3:.001<e?1e4:1e-4<e?1e5:1e6,{lo:t=Math.floor(t*e)/e,hi:a=Math.ceil(a*e)/e,inc:Math.ceil((a-t)/i*e)/e}},e.Grid.getLabel=function(t,a,i){var s,r,n=!1;switch(t.wcsunits){case"sexagesimal":if("ra"===i&&"galactic"!==t.wcssys&&"ecliptic"!==t.wcssys&&(a/=15),r=(a=e.saodtostr(a,":",t.sexaPrec)).split(":"),t.last[i])for(a="",s=0;s<r.length;s++)a&&(a+=":"),(n||r[s]!==t.last[i][s])&&(a+=r[s],n=!0);t.last[i]=$.extend({},r);break;default:a=a.toFixed(t.degPrec)}return 0>(t=(a=a.replace(/0+$/,"")).indexOf("."))?a+=".0":t===a.length-1&&(a+="0"),a.replace(/:\.0/,":0.0")},e.Grid.display=function(t,a){var i,s,r,n,o,l,c,p,d,h,g,u,m,f,y,b,S,v,w,x,J,k;g=this.display;var C=this.raw;if(f=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}],e.isNull(t))switch(this.tmp.gridStatus){case"inactive":case void 0:return!1;case"active":case"processing":default:return!0}if(this.removeShapes(e.Grid.LAYERNAME),!1===t||!this.raw.wcs||0>=this.raw.wcs)this.tmp.gridStatus="inactive";else{if("string"==typeof(a=a||{}))try{a=JSON.parse(a)}catch(I){e.error("can't parse displayCoordGrid JSON",I)}for(this.tmp.gridStatus="processing",(v=$.extend(!0,{},e.Grid.opts,a)).wcsunits=this.getWCSUnits(),v.wcssys=this.getWCSSys(),v.last={},e.wcsunits(this.raw.wcs,"degrees"),"image"===v.cover?(n=[Math.max(1,Math.floor(C.width/g.width)),Math.max(1,Math.floor(C.height/g.height))],h=[{x:0,y:0},{x:C.width-1,y:C.height-1}]):(n=v.reduceDims?C.width<C.height?[C.width/C.height,1]:C.height<C.width?[1,C.height/C.width]:[1,1]:[1,1],h=[],u=this.displayToImagePos(s={x:this.ix+v.margin,y:this.iy-v.margin}),h[0]={x:u.x,y:u.y},u=this.displayToImagePos(s={x:g.width-this.ix-v.margin,y:g.height-this.iy-v.margin}),h[1]={x:u.x,y:u.y}),i=e.pix2wcs(C.wcs,h[0].x,h[0].y).trim().split(/\s+/),f[0].ra=e.saostrtod(i[0]),f[0].dec=e.saostrtod(i[1]),i=e.pix2wcs(C.wcs,h[0].x,h[1].y).trim().split(/\s+/),f[1].ra=e.saostrtod(i[0]),f[1].dec=e.saostrtod(i[1]),i=e.pix2wcs(C.wcs,h[1].x,h[0].y).trim().split(/\s+/),f[2].ra=e.saostrtod(i[0]),f[2].dec=e.saostrtod(i[1]),i=e.pix2wcs(C.wcs,h[1].x,h[1].y).trim().split(/\s+/),f[3].ra=e.saostrtod(i[0]),f[3].dec=e.saostrtod(i[1]),h=f[0].ra,u=f[0].dec,g=f[0].ra,m=f[0].dec,i=1;4>i;i++)h=Math.min(h,f[i].ra),u=Math.min(u,f[i].dec),g=Math.max(g,f[i].ra),m=Math.max(m,f[i].dec);for(h=(i=e.Grid.limits.call(this,v,h,g,v.raLines*n[0])).lo,g=i.hi,f=i.inc,u=(i=e.Grid.limits.call(this,v,u,m,v.decLines*n[1])).lo,m=i.hi,y=i.inc,e.wcsunits(this.raw.wcs,v.wcsunits),w=g-(S=(b=Math.abs(this.raw.wcsinfo.cdelt1))*e.Grid.opts.stride),k=m-(J=(x=Math.abs(this.raw.wcsinfo.cdelt2))*e.Grid.opts.stride),i="image;",p=h;p<=g;p+=f){for(r="line(",c=x,s=l=0,d=u;d<=m;d+=c)(o=e.wcs2pix(C.wcs,p,d).trim().split(/ +/))&&o.length&&(n=parseFloat(o[0]),o=parseFloat(o[1]),n>=-v.margin&&n<=C.width+v.margin&&o>=-v.margin&&o<=C.height+v.margin?(r+=String(n+1+","+o+"1, "),s++,0===l?(l=1,d<k&&(c=J)):1===l&&d>k&&(l=2,c=x)):1===l&&(l=2,d-=c,c=x));1<s&&(i+=r.replace(/,\s+$/,") "),i+=sprintf(' {"color": "%s"};',v.lineColor))}for(d=u;d<=m;d+=y){for(r="line(",c=b,s=l=0,p=h;p<=g;p+=c)(o=e.wcs2pix(C.wcs,p,d).trim().split(/ +/))&&o.length&&(n=parseFloat(o[0]),o=parseFloat(o[1]),n>=-v.margin&&n<=C.width+v.margin&&o>=-v.margin&&o<=C.height+v.margin?(r+=String(n+1+","+o+"1, "),s++,0===l?(l=1,p<w&&(c=S)):1===l&&p>w&&(l=2,c=b)):1===l&&(l=2,p-=c,c=b));1<s&&(i+=r.replace(/,\s+$/,") "),i+=sprintf(' {"color": "%s"};',v.lineColor))}for(l=v.labelDecOffx/this.rgb.sect.zoom,c=v.labelDecOffy/this.rgb.sect.zoom,b=0,p=S=h,r=0;p<=g;p+=f){for(d=u;d<=m;d+=y)(o=e.wcs2pix(C.wcs,p,d).trim().split(/ +/))&&o.length&&(n=parseFloat(o[0]),o=parseFloat(o[1]),(s=this.imageToDisplayPos({x:n,y:o})).x>this.ix+v.labelMargin&&s.x<this.rgb.img.width+this.ix-v.labelMargin&&s.y>this.iy+v.labelMargin&&s.y<this.rgb.img.height+this.iy-v.labelMargin&&(b>=v.decSkip?(i+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',n+l,o+c,e.Grid.getLabel.call(this,v,d,"dec"),v.decAngle,v.labelColor,v.labelFontFamily,v.labelFontSize,v.labelFontStyle,v.labelFontWeight),r++):(p!==S&&b++,S=p)));if(r)break}for(l=v.labelRAOffx/this.rgb.sect.zoom,c=v.labelRAOffy/this.rgb.sect.zoom,b=0,d=S=u,r=0;d<=m;d+=y){for(p=h;p<=g;p+=f)(o=e.wcs2pix(C.wcs,p,d).trim().split(/ +/))&&o.length&&(n=parseFloat(o[0]),o=parseFloat(o[1]),(s=this.imageToDisplayPos({x:n,y:o})).x>this.ix+v.labelMargin&&s.x<this.rgb.img.width+this.ix-v.labelMargin&&s.y>this.iy+v.labelMargin&&s.y<this.rgb.img.height+this.iy-v.labelMargin&&(b>=v.raSkip?(i+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',n+l,o+c,e.Grid.getLabel.call(this,v,p,"ra"),v.raAngle,v.labelColor,v.labelFontFamily,v.labelFontSize,v.labelFontStyle,v.labelFontWeight),r++):(d!==S&&b++,S=d)));if(r)break}this.addShapes(e.Grid.LAYERNAME,i,v),this.tmp.gridStatus="active"}},e.Grid.toggle=function(e){if(e)switch(e.tmp.gridStatus){case void 0:case null:case"inactive":e.displayCoordGrid(!0);break;case"active":e.displayCoordGrid(!1)}},e.Grid.regrid=function(e){e&&"active"===e.tmp.gridStatus&&"complete"===e.status.load&&e.displayCoordGrid(!0)},e.Grid.init=function(t){t=$.extend(!0,{},e.Catalogs.opts,e.Grid.opts,t),this.display.newShapeLayer(e.Grid.LAYERNAME,t).canvas.on("mouse:up",function(){return!1})},e.Image.prototype.displayCoordGrid=e.Grid.display,e.Dysel={},e.Dysel.CLASS="JS9",e.Dysel.NAME="Dysel",e.Dysel.display=null,e.Dysel.plugins=[],e.Dysel.init=function(e){},e.Dysel.unhighlightSelection=function(){e.bugs.webkit_resize?$(".JS9").find(".JS9Image").removeClass("JS9Highlight"):$(".JS9").removeClass("JS9Highlight")},e.Dysel.highlightSelection=function(t){t&&e.Dysel.retrievePlugins().length&&1!==e.displays.length&&(e.Dysel.unhighlightSelection(),t=t.display,e.bugs.webkit_resize?$(t.divjq).find(".JS9Image").addClass("JS9Highlight"):$(t.divjq).addClass("JS9Highlight"))},e.Dysel.addPlugins=function(t){e.Dysel.plugins.push(t)},e.Dysel.retrievePlugins=function(){return e.Dysel.plugins},e.Dysel.getDisplay=function(t){return e.Dysel.retrievePlugins().length?"previous"===t?e.Dysel.odisplay:e.Dysel.display:null},e.Dysel.getDisplayOr=function(t){return"previous"===t?e.Dysel.getDisplay(t):e.Dysel.getDisplay()||t},e.Dysel.select=function(t){t&&e.Dysel.retrievePlugins().length&&(e.Dysel.odisplay=e.Dysel.display,e.Dysel.display=t,t.image&&(e.Dysel.highlightSelection(t.image),t.image.xeqPlugins("image","ondynamicselect",null)))},e.Dysel.imageload=function(t){t&&e.Dysel.select(t.display)},e.Dysel.imageclose=function(t){var a,i;if(t&&(i=e.Dysel.getDisplay())&&i.image===t){for(i=a=0;a<e.images.length;a++)t.display===e.images[a].display&&i++;if(1>=i)for(a=0;a<e.displays.length;a++)if(t.display!==(i=e.displays[a])&&i.image){e.Dysel.select(e.displays[a]);break}}},e.getDynamicDisplayOr=e.Dysel.getDisplayOr,Math.log10=Math.log10||function(e){return Math.log(e)/Math.LN10},"function"!=typeof Object.create&&(Object.create=function(e){var t=function(){};return t.prototype=e,new t}),Math.asinh=Math.asinh||function(e){return-1/0===e?e:Math.log(e+Math.sqrt(e*e+1))},Math.sinh=Math.sinh||function(e){return(Math.exp(e)-Math.exp(-e))/2},e.jupyterFocus=function(e,t){window.hasOwnProperty("Jupyter")&&(e instanceof jQuery?e:$(e)).find(t||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))})},e.getImageID=function(t,a,i){var s,r,n=0,o=1,l=e.images.length,c=/.*<([0-9][0-9]*)>$/,p=/<[0-9][0-9]*>/;for(t=t.replace(p,""),s=0;s<l;s++)(r=e.images[s]).display.id===a&&r!==i&&t===r.id0.replace(p,"")&&(r.id&&0<=r.id.search(c)&&(r=r.id.replace(c,"$1"),o=Math.max(o,parseInt(r,10))),n++);return n?t+"<"+String(o+1)+">":t},e.uniqueID=function(){var e=1;return function(){return e++}}(),e.waiting=function(t,a){var i,s;switch(t){case!0:window.hasOwnProperty("Spinner")&&"spinner"===e.globalOpts.waitType?(a&&("object"==typeof a?i=a.divjq[0]:"string"==typeof a&&(s=e.lookupDisplay(a))&&(i=s.divjq[0])),i||(i=$("body").get(0)),e.spinner||(e.spinner={},s={color:e.globalOpts.spinColor,opacity:e.globalOpts.spinOpacity},e.spinner.spinner=new Spinner(s)),e.spinner.spinner.spin(i)):$("body").addClass("waiting");break;case!1:window.hasOwnProperty("Spinner")&&"spinner"===e.globalOpts.waitType?e.spinner&&e.spinner.spinner.stop():$("body").removeClass("waiting")}},e.progress=function(t,a){if("boolean"==typeof t||"string"==typeof t)switch(t){case!0:case"indeterminate":a&&(e.progress.display=a,e.progress.display.displayMessage("progress",t));break;case!1:case"":e.progress.display&&(e.progress.display.clearMessage("progress"),delete e.progress.display)}else"number"==typeof t&&e.progress.display&&e.progress.display.displayMessage("progress",[t,a])},e.msgHandler=function(t,a){var i,s,r,n=[],o=t.cmd,l=t.id,c=e.globalOpts.alerts,p=e.globalOpts.quietReturn?"":"OK";if(a&&(e.globalOpts.alerts=!1),e.publics[o]){if($.isArray(t.args)||(t.args=[t.args]),n=$.extend(!0,[],t.args),l)if(0<n.length){if("string"==typeof(i=n[n.length-1]))try{s=JSON.parse(i)}catch(d){s=null}else"object"==typeof i&&(s=i);s&&"object"==typeof s&&s.hasOwnProperty("display")&&1===Object.keys(s).length?"string"==typeof i&&(n.pop(),n.push(s)):n.push({display:l})}else n.push({display:l});"RunAnalysis"===o&&a&&(1===n.length&&n.push(null),n.push(a),a=null);try{r=e.publics[o].apply(null,n)}catch(d){r=sprintf("ERROR: %s",d.message)}return a&&(e.globalOpts.alerts=c,(r instanceof e.Display||r instanceof e.Image)&&(r=r.id),a(r)),r}if(o&&"#"!==o){if(s=e.lookupCommand(o),i=e.lookupDisplay(l),s&&i)switch(s.getDisplayInfo(i),t.args?n=$.extend(!0,[],t.args):t.paramlist&&(n=t.paramlist.split(/ +/)),s.getWhich(n)){case"get":try{r=s.get(n)||""}catch(d){r="ERROR: "+d.message}break;case"set":try{r=s.set(n)||p}catch(d){r="ERROR: "+d.message}break;default:r=sprintf("ERROR: unknown cmd type for '%s'",o)}else s||(r=sprintf("ERROR: unknown cmd '%s'",o)),i||(r=sprintf("ERROR: unknown display (%s)",l));return a&&(e.globalOpts.alerts=c,(r instanceof e.Display||r instanceof e.Image)&&(r=r.id),a(r)),r}a&&a(""),a&&(e.globalOpts.alerts=c)},e.lightWin=function(t,a,i,s,r){var n;switch(e.LIGHTWIN){case"dhtml":n=dhtmlwindow.open(t,a,i,s,r),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+t+" "+e.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+t+" ."+e.lightOpts.dhtml.dragBar).doubletap(function(){n.close()},null,400),$("#"+t+" ."+e.lightOpts.dhtml.dragBar).on("touchend",this,function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<e.lightOpts.nclick&&(e.lightOpts.nclick=0):2<=e.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),e.lightOpts.nclick=-1):0<=e.lightOpts.nclick&&e.lightOpts.nclick++})}return n},e.checkNew=function(t){t||e.error("internal failure in a JS9 constructor")},e.specialKey=function(e){return e.metaKey||e.ctrlKey},e.strace=function(t){var a="";return 1<e.DEBUG&&(a=t.stack||t.stacktrace||""),a},e.floatToString=function(t){return sprintf("%g",parseFloat(t.toFixed(e.globalOpts.floatPrecision)))},e.floatPrecision=function(e,t){var a,i;return(a=Math.floor(Math.log10(Math.abs(e))))!==(i=Math.floor(Math.log10(Math.abs(t))))?a>i?a:i:1},e.floatFormattedString=function(e,t,a){var i="";return void 0===e?i:(-2>t?(t="%."+String(2+a)+"e",i=sprintf(t,e)):0>t?i=e.toFixed(Math.abs(t)+3+a):2>t?(t="%."+String(t+a)+"f",i=sprintf(t,e)):5>t?i=e.toFixed(0+a):(t="%."+String(2+a)+"e",i=sprintf(t,e)),i)},e.centerPolygon=function(e){var t,a,i,s,r,n;if(e&&e.length){for(a=e.length,t=0;t<a;t++)(void 0===i||e[t].x<i)&&(i=e[t].x),(void 0===s||e[t].x>s)&&(s=e[t].x),(void 0===r||e[t].y<r)&&(r=e[t].y),(void 0===n||e[t].y>n)&&(n=e[t].y);return{x:(i+s)/2,y:(r+n)/2}}},e.centroidPolygon=function(e){var t,a,i=0,s=0;if(e&&e.length){for(a=e.length,t=0;t<a;t++)i+=e[t].x,s+=e[t].y;return{x:i/a,y:s/a}}},e.lookupImage=function(t,a){var i,s,r,n=e.images.length;if(!t)return null;for(i=0;i<n;i++)if((t===(s=e.images[i])||t===s.id||t===s.id0||t===s.id0.replace(/\[.*\]$/,"")||t===s.file||t===s.file.replace(/\[.*\]$/,"")||t===s.file0||t===e.TOROOT+s.file||s.fitsFile&&t===s.fitsFile)&&0<$("#"+s.display.id).length&&(r=s.display.id,!a||"string"==typeof a&&a===r||"object"==typeof a&&a.id===r))return s;return null},e.lookupDisplay=function(t,a){var i,s=new RegExp(sprintf("[-_]?(%s)$",e.PLUGINS));if(void 0===a&&(a=!0),t&&0>t.toString().search(e.SUPERMENU)){for(i=0;i<e.displays.length;i++)if(t===e.displays[i]||t===e.displays[i].id||t===e.displays[i].oid)return e.displays[i];if("string"==typeof t)for(t=t.replace(s,""),i=0;i<e.displays.length;i++)if(t===e.displays[i]||t===e.displays[i].id||t===e.displays[i].oid)return e.displays[i];if(!a)return null;e.error("can't find JS9 display with id: "+t)}return e.displays[0]},e.getImage=function(t){var a;return!(a=e.lookupImage(t))&&(t=e.lookupDisplay(t))&&(a=t.image),a},e.lookupVfile=function(t){var a,i,s,r,n=[];if(!t)return n;for(a=0;a<e.images.length;a++)for(s=e.images[a],i=0;i<s.raws.length;i++)(r=s.raws[i]).hdu&&r.hdu.fits&&t===r.hdu.fits.vfile&&n.push({im:s,raw:r,idx:i});return n},e.loadScript=function(e,t,a){var i=document.getElementsByTagName("head")[0],s=document.createElement("script");s.type="text/javascript",t&&(s.onload=t),a&&(s.onerror=a),s.src=e,i.appendChild(s)},e.fetchURL=function(t,a,i,s){var r,n=new XMLHttpRequest;i=i||{},t||a||e.error("invalid url specification for fetchURL"),a||(t=/([^\\\/]+)$/.exec(a=t)[1]),t||(t=/([^\\\/]+)$/.exec(a)[1]),r=(r=i.allowCache||a.match(/\?/)?a:a+"?r="+Math.random()).replace(/^\${JS9_DIR}\//,e.INSTALLDIR),n.open("GET",r,!0),n.responseType=i.responseType?i.responseType:"blob",e.globalOpts.xtimeout&&(n.timeout=e.globalOpts.xtimeout),n.onload=function(){var r;4===this.readyState&&(200===this.status||0===this.status?"blob"===n.responseType?((r=new Blob([this.response])).name=t.match("://")?t.split("/").reverse()[0].replace(/\?.*$/,""):t,"uc"===r.name&&(r.name="google_"+e.uniqueID()+".fits"),s?s(r,i):e.Load(r,i)):i.display?s(this.response,i,{display:i.display}):s(this.response,i):e.error(404===this.status?"could not find "+a:sprintf("can't load: %s %s (%s)  ",a,n.statusText,n.status)))},n.onerror=function(){e.error(sprintf("cannot load: %s %s .. please check the url/pathname",a,n.statusText))},n.ontimeout=function(){e.error("timeout awaiting response from server: "+a)};try{n.send()}catch(o){e.error("request to load "+a+" failed",o)}},e.fitsLibrary=function(t){var a;if(!t)return e.fits.name;switch(a=t.toLowerCase()){case"fitsy":e.fits=Fitsy,e.fits.datahandler(e.NewFitsImage),e.fits.options=e.userOpts.fits||e.fits.options||{};break;case"astroem":case"cfitsio":e.fits=Astroem,e.fits.options=e.fits.options||{},e.fits.options.handler=e.NewFitsImage,e.fits.options.error=e.error,e.userOpts.fits?(e.fits.options.extlist=e.userOpts.fits.extlist,e.fits.options.table={xdim:e.userOpts.fits.xdim,ydim:e.userOpts.fits.ydim,bin:e.userOpts.fits.bin||1},e.fits.options.image={xdim:e.userOpts.fits.ixdim||e.userOpts.fits.xmax,ydim:e.userOpts.fits.iydim||e.userOpts.fits.ymax,bin:e.userOpts.fits.ibin||1}):(e.fits.options.extlist=e.globalOpts.extlist,e.fits.options.table={bin:e.globalOpts.table.bin||1},e.notNull(e.globalOpts.table.xdim)?e.fits.options.table.xdim=e.globalOpts.table.xdim:e.notNull(e.globalOpts.dims)&&(e.fits.options.table.xdim=e.globalOpts.dims[0]),e.notNull(e.globalOpts.table.ydim)?e.fits.options.table.ydim=e.globalOpts.table.ydim:e.notNull(e.globalOpts.dims)&&(e.fits.options.table.ydim=e.globalOpts.dims[1]),e.fits.options.image={bin:e.globalOpts.image.bin||1},e.notNull(e.globalOpts.image.xdim)?e.fits.options.image.xdim=e.globalOpts.image.xdim:e.notNull(e.globalOpts.xmax)&&(e.fits.options.image.xdim=e.globalOpts.xmax),e.notNull(e.globalOpts.image.ydim)?e.fits.options.image.ydim=e.globalOpts.image.ydim:e.notNull(e.globalOpts.ymax)&&(e.fits.options.image.ydim=e.globalOpts.ymax)),e.fits.maxFITSMemory&&e.globalOpts.maxMemory&&e.fits.maxFITSMemory(e.globalOpts.maxMemory);break;default:e.error("unknown fits library: "+t)}return e.fits.ready=!0,e.fits.name=a,e.fits.options.error=e.error,e.fits.options.waiting=e.waiting,a},e.handleFITSFile=function(t,a,i){e.fits.handleFITSFile?e.fits.handleFITSFile(t,a,i):e.error("no FITS module available to process FITS file")},e.cleanupFITSFile=function(t,a){return!!(e.fits.cleanupFITSFile&&t&&t.hdu&&t.hdu.fits)&&(e.fits.cleanupFITSFile(t.hdu.fits,a),!0)},e.handleImageFile=function(t,a,i){var s=new FileReader;a=$.extend(!0,{},e.fits.options,a),i=i||e.Load,s.onload=function(e){var s,r,n,o=new Image;o.onload=function(){var e,l,c=0;l=(e=document.createElement("canvas")).getContext("2d");var p=o.height,d=o.width;for(e.width=d,e.height=p,l.drawImage(o,0,0),s=l.getImageData(0,0,d,p).data,r=new Float32Array(p*d),l=0;l<p;l++)for(e=0;e<d;e++)r[(p-l)*d+e]=.299*s[c]+.587*s[c+1]+.114*s[c+2],c+=4;for((n={head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:d,NAXIS2:p},filename:t.name,filedata:r,naxis:2,axis:[0,d,p],bitpix:-32,bin:1,data:r}).dmin=Number.MAX_VALUE,n.dmax=Number.MIN_VALUE,c=0;c<p*d;c++)isNaN(n.data[c])||(n.dmin=Math.min(n.dmin,n.data[c]),n.dmax=Math.max(n.dmax,n.data[c]));i(n,a)},o.src=e.target.result},s.readAsDataURL(t)},e.getFITSImage=function(t,a,i,s){e.fits.getFITSImage?e.fits.getFITSImage(t,a,i,s):e.error("no FITS module available to process FITS image")},e.fits2RepFile=function(t,a,i,s,r){var n,o,l,c,p,d={},h="fits2"+s;if(!0===(n=i[h]||void 0===i[h]&&e.globalOpts[h])?n="always":!1===n&&(n="never"),n.match(/never/i))return!1;if(!e.helper.connected||"nodejs"!==e.helper.type&&"socket.io"!==e.helper.type)return"always"===n&&e.globalOpts.requireFits2Fits&&e.error("can't run fits2fits without connected JS9 helper"),!1;if(!e.helper.js9helper){if(!e.globalOpts.requireFits2Fits)return!1;e.error("js9helper not found for fits2fits processing")}switch(h){case"fits2png":break;case"fits2fits":if(!e.globalOpts.workDir)return e.globalOpts.requireFits2Fits&&e.error("can't run fits2fits without a workdir"),!1;for(s=i.xdim||e.fits.options.image.xdim||e.fits.options.table.xdim,o=i.ydim||e.fits.options.image.ydim||e.fits.options.table.ydim,c="a"===(c=i.binMode||e.globalOpts.binMode)?"a":"","string"==typeof(l=i.bin||e.fits.options.image.bin||e.fits.options.table.bin)&&(l.match(/[as]$/)&&(c=l.slice(-1)),l=parseInt(l,10)),l=Math.max(1,l||1),d.sect=void 0!==i.xcen&&void 0!==i.ycen?sprintf("%s@%s,%s@%s,%s%s",s,i.xcen,o,i.ycen,l,c):sprintf("%s,%s,%s%s",s,o,l,c),s=n.toLowerCase().split(/[>,]/),n=0;n<s.length;n++)switch(s[n]){case"size":s[n+1]&&(e.isNumber(s[n+1])&&(d.maxsize=1e6*parseFloat(s[n+1])),n++)}break;default:e.error("unknown FITS representation type: "+s)}return d.fits=e.cleanPath(a),d.parent=!0,e.waiting(!0,t),e.helper.send(h,d,function(a){var s,n;if((a="object"==typeof a?a:0<=a.search(e.analOpts.epattern)?{stderr:a}:{stdout:a}).stderr&&e.error(a.stderr,e.analOpts.epattern),a.stdout)switch(h){case"fits2png":"png"===(s=(a=a.stdout.replace(/\n*$/,"").split("\n").pop()).split(".").pop().toLowerCase())?(i.source="fits2png",e.checkNew(new e.Image(a,i,r))):e.error("fits2png conversion failed: "+a);break;case"fits2fits":if(a.stdout.match(/^ERROR:/)&&(e.globalOpts.requireFits2Fits?e.error(a.stdout):a.stdout=d.fits),n=a.stdout.split(/\n/),(a=e.cleanPath(n[0]))===d.fits)s=$.extend(!0,{},i);else{if("/"!==a.charAt(0)&&(a=e.InstallDir(a)),delete(s=$.extend(!0,{},i)).xcen,delete s.ycen,delete s.bin,void 0!==s.xdim&&(s.xdim=0),void 0!==s.ydim&&(s.ydim=0),s.source="fits2fits",s.proxyFile=a,n[1]){try{p=JSON.parse(n[1])}catch(o){}p&&(s.extname=p.extname,s.extnum=p.extnum,s.hdus=p.hdus,s.parent=p)}n[2]&&(n=e.cleanPath(n[2]),s.parentFile=n,s.extname?(s.parentFile=s.parentFile.replace(/\[.*\]/,""),s.parentFile+=sprintf("[%s]",s.extname)):s.extnum&&0<s.extnum&&(s.parentFile=s.parentFile.replace(/\[.*\]/,""),s.parentFile.file+=sprintf("[%s]",s.extnum))),r&&(s.onload=r)}s.fits2fits=!1,e.Load(a,s,{display:t})}}),!0},e.lookupColormap=function(t,a){var i;if(void 0===a&&(a=!0),t||(t=e.imageOpts.colormap),t)for(i=0;i<e.colormaps.length;i++)if(e.colormaps[i].name===t)return e.colormaps[i];if(!a)return null;e.error("unknown colormap '"+t+"'")},e.lookupCommand=function(t){var a,i;if(t)for(i=t.toLowerCase(),a=0;a<e.commands.length;a++)if((t=e.commands[a]).name===i||t.alias===i||t.alias2===i)return t;return null},e.error=function(t,a,i){var s,r,n="",o="",l=!0;if(e.waiting(!1),"string"==typeof a?(r=t.match(a))?r[1]?t=r[1]:r[0]&&(t=r[0]):l=!1:"object"==typeof a&&(s=a),3>arguments.length&&(i=!0),l&&(s&&s.message?t+=sprintf(" (%s)",s.message):t&&(s=Error(t)),(r=e.strace(s))&&(o="\n\nStacktrace:\n"+r),e.globalOpts.alerts&&(t&&"string"==typeof t&&0>t.search(/ERROR/)&&(n="JS9 ERROR: "),alert(n+(t+o))),i))throw s},e.eventToCharStr=function(t){var a,i,s={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},r={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},n={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};return a="number"==typeof t?t:t.which||t.keyCode,i=String(a),r.hasOwnProperty(i)&&(a=r[i]),a=!t.shiftKey&&65<=a&&90>=a?String.fromCharCode(a+32):!t.shiftKey&&s.hasOwnProperty(a)?s[a]:t.shiftKey&&n.hasOwnProperty(a)?n[a]:String.fromCharCode(a),e.specialKey(t)&&(a="M-"+a),a},e.eventToDisplayPos=function(e,t){var a,i,s,r,n;if(e||(e=window.event),e.target?i=e.target:e.srcElement&&(i=e.srcElement),3===i.nodeType&&(i=i.parentNode),t=t||$(i).offset(),e.originalEvent?e.originalEvent.touches&&e.originalEvent.touches.length?(a=(n=e.originalEvent.touches)[0].pageX,s=n[0].pageY):e.originalEvent.changedTouches&&e.originalEvent.changedTouches.length?(a=(n=e.originalEvent.changedTouches)[0].pageX,s=n[0].pageY):(a=e.pageX,s=e.pageY):(a=e.pageX,s=e.pageY),i=t.left+1,r=t.top+1,s={x:Math.floor(a-i),y:Math.floor(s-r)},n&&n.length)for(s.touches=[{x:s.x,y:s.y}],a=1;a<n.length;a++)s.touches[a]={x:Math.floor(n[a].pageX-i),y:Math.floor(n[a].pageY-r)};return s},e.pix2pix=function(t,a,i){var s,r,n;return t&&a&&t.raw.wcs&&a.raw.wcs?(s=e.pix2wcs(t.raw.wcs,n=i.x,i=i.y).trim().split(/\s+/),r=e.saostrtod(s[0]),":"===String.fromCharCode(e.saodtype())&&"galactic"!==t.params.wcssys&&"ecliptic"!==t.params.wcssys&&(r*=15),t=e.saostrtod(s[1]),s=e.wcs2pix(a.raw.wcs,r,t).trim().split(/\s+/),a=parseFloat(s[0]),t=parseFloat(s[1]),.5>Math.abs(a-n)&&(a=n),.5>Math.abs(t-i)&&(t=i),{x:a,y:t}):i},e.rotatePoint=function(e,t,a){var i;return a=a||{x:0,y:0},t=Math.PI*t/180,i=Math.cos(t),t=Math.sin(t),{x:i*(e.x-a.x)-t*(e.y-a.y)+a.x,y:t*(e.x-a.x)+i*(e.y-a.y)+a.y}},e.invertMatrix3=function(e){var t,a,i=0,s=0,r=[[0,0,0],[0,0,0],[0,0,0]],n=e[0][0]*e[1][1];for(t=0;3>t;t++)for(a=0;2>a;a++)if(void 0===e[t][a]||isNaN(e[t][a]))return null;return 0<=n?i+=n:s+=n,0<=(n=-e[0][1]*e[1][0])?i+=n:s+=n,0===(t=i+s)||1e-15>Math.abs(t/(i-s))?null:(r[0][0]=e[1][1]*(t=1/t),r[1][0]=-e[1][0]*t,r[0][1]=-e[0][1]*t,r[1][1]=e[0][0]*t,r[2][0]=-(e[2][0]*r[0][0]+e[2][1]*r[1][0]),r[2][1]=-(e[2][0]*r[0][1]+e[2][1]*r[1][1]),r)},e.log=function(){if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(e){Function.prototype.bind.call(console.log,console).apply(console,arguments)}},e.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},e.notNull=function(e){return null!=e},e.isNull=function(e){return null==e},e.cardpars=function(t){var a;return"HISTORY"===(a=t.slice(0,8).trim())||"COMMENT"===a?[a,t.slice(9).trim()]:"="===t[8]?("T"===(t=t.slice(10).replace(/\'/g," ").replace(/ \/.*/,"").trim())?t=!0:"F"===t?t=!1:e.isNumber(t)&&(t=parseFloat(t)),[a,t]):void 0},e.raw2FITS=function(t,a){var i,s,r,n,o,l=!1,c="",p={};if(r=function(e,t,a,i){var s,r=e;return"XTENSION"!==t||a?(s=new RegExp(t+" *= *(-?[-+]?[0-9]*.?[0-9]*([eE][-+]?[0-9]+)?) *"),e?(e=e.replace(s,"$1"),e=parseFloat(e)):e=void 0,e!==a&&(r=sprintf("%-8s= %20s / %-47s",t,a,i||""))):r=sprintf("%s  = %20s / %-47s","SIMPLE","T","file does conform to FITS standard"),p[t]=!0,r},!t)return c;if("boolean"==typeof(a=a||{})&&(a={addcr:a}),t.card||t.cardstr){for(o=t.header||{},s=t.card?t.card.length:t.ncard,i=0;i<s;i++)if(n=t.card?t.card[i].slice(0,80):t.cardstr.slice(80*i,80*(i+1)),!a.notab||!n.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)){if(n.match(/^XTENSION/)&&0===i&&a.simple)c+=r(n,"XTENSION");else if(n.match(/^BITPIX /)&&t.bitpix)c+=r(n,"BITPIX",t.bitpix,"bits/pixel");else if(n.match(/^NAXIS1 /)&&t.width)c+=r(n,"NAXIS1",t.width,"x image dim");else if(n.match(/^NAXIS2 /)&&t.height)c+=r(n,"NAXIS2",t.height,"y image dim");else if(n.match(/^CRPIX1 /)&&e.notNull(o.CRPIX1))c+=r(n,"CRPIX1",o.CRPIX1,"ref point");else if(n.match(/^CRPIX2 /)&&e.notNull(o.CRPIX2))c+=r(n,"CRPIX2",o.CRPIX2,"ref point");else if(n.match(/^CDELT1 /)&&e.notNull(o.CDELT1))c+=r(n,"CDELT1",o.CDELT1,"deg/pixel");else if(n.match(/^CDELT2 /)&&e.notNull(o.CDELT2))c+=r(n,"CDELT2",o.CDELT2,"deg/pixel");else if(n.match(/^CD1_1 /)&&e.notNull(o.CD1_1))c+=r(n,"CD1_1",o.CD1_1,"WCS matrix value");else if(n.match(/^CD1_2 /)&&e.notNull(o.CD1_2))c+=r(n,"CD1_2",o.CD1_2,"WCS matrix value");else if(n.match(/^CD2_1 /)&&e.notNull(o.CD2_1))c+=r(n,"CD2_1",o.CD2_1,"WCS matrix value");else if(n.match(/^CD2_2 /)&&e.notNull(o.CD2_2))c+=r(n,"CD2_2",o.CD2_2,"WCS matrix value");else if(n.match(/^LTV1 /)&&e.notNull(o.LTV1))c+=r(n,"LTV1",o.LTV1,"IRAF ref. point");else if(n.match(/^LTV2 /)&&e.notNull(o.LTV2))c+=r(n,"LTV2",o.LTV2,"IRAF ref. point");else if(n.match(/^LTM1_1 /)&&e.notNull(o.LTM1_1))c+=r(n,"LTM1_1",o.LTM1_1,"IRAF matrix value");else if(n.match(/^LTM1_2 /)&&e.notNull(o.LTM1_2))c+=r(n,"LTM1_2",o.LTM1_2,"IRAF matrix value");else if(n.match(/^LTM2_1 /)&&e.notNull(o.LTM2_1))c+=r(n,"LTM2_1",o.LTM2_1,"IRAF matrix value");else if(n.match(/^LTM2_2 /)&&e.notNull(o.LTM2_2))c+=r(n,"LTM2_2",o.LTM2_2,"IRAF matrix value");else if(a.twoaxes&&n.match(/^NAXIS /))c+=r(n,"NAXIS",2,"number of data axes");else{if(a.twoaxes&&n.match(/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/))continue;if(a.twoaxes&&n.match(/^(DATASUM|CHECKSUM)/))continue;"END "===n.substring(0,4)?(e.notNull(o.LTV1)&&!p.LTV1&&(c+=r(null,"LTV1",o.LTV1,"IRAF ref. point"),a.addcr&&(c+="\n")),e.notNull(o.LTV2)&&!p.LTV2&&(c+=r(null,"LTV2",o.LTV2,"IRAF ref. point"),a.addcr&&(c+="\n")),e.notNull(o.LTM1_1)&&!p.LTM1_1&&(c+=r(null,"LTM1_1",o.LTM1_1,"IRAF matrix value"),a.addcr&&(c+="\n")),e.notNull(o.LTM1_2)&&!p.LTM1_2&&(c+=r(null,"LTM1_2",o.LTM1_2,"IRAF matrix value"),a.addcr&&(c+="\n")),e.notNull(o.LTM2_1)&&!p.LTM2_1&&(c+=r(null,"LTM2_1",o.LTM2_1,"IRAF matrix value"),a.addcr&&(c+="\n")),e.notNull(o.LTM2_2)&&!p.LTM2_2&&(c+=r(null,"LTM2_2",o.LTM2_2,"IRAF matrix value"),a.addcr&&(c+="\n")),c+=n,l=!0):c+=n}a.addcr&&(c+="\n")}}else if(t.header||t.BITPIX)for(n in void 0===(r=t.header?t.header:t).SIMPLE&&void 0===r.simple||(!0===(i=void 0!==r.SIMPLE?r.SIMPLE:r.simple)?i="T":!1===i&&(i="F"),c+=sprintf("%-8s= %20s / %-47s","SIMPLE",i,"conforms to FITS standard"),a.addcr&&(c+="\n")),void 0===r.BITPIX&&void 0===r.bitpix||(i=void 0!==r.BITPIX?r.BITPIX:r.bitpix,c+=sprintf("%-8s= %20s / %-47s","BITPIX",i,"bits/pixel"),a.addcr&&(c+="\n")),r)if(r.hasOwnProperty(n)&&"js9Protocol"!==n&&"js9Endian"!==n&&"SIMPLE"!==n&&"simple"!==n&&"BITPIX"!==n&&"bitpix"!==n){if("END"===n&&(l=!0),n.match(/HISTORY__[0-9]+/))c+=sprintf("HISTORY %-72s",r[n]);else if(n.match(/COMMENT__[0-9]+/))c+=sprintf("COMMENT %-72s",r[n]);else{if(!0===(i=r[n])?i="T":!1===i?i="F":""===i?i="' '":e.isNumber(i)||"'"===i.charAt(0)||(i="'"+i+"'"),0<(o=80-(s=sprintf("%-8s= %20s",n,i)).length))for(i=0;i<o;i++)s+=" ";c+=s}a.addcr&&(c+="\n")}return l||(c+=sprintf("%-8s%-72s","END"," "),a.addcr&&(c+="\n")),c},e.hdus2Str=function(e){var t,a,i,s="";if(!e)return s;for(t=0;t<e.length;t++){switch(a=(i=e[t]).name?i.name:0===t?"Primary":"N/A",s+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",i.hdu,a,i.type),i.type){case"image":if(s+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",i.bitpix,i.naxis),i.naxes.length){for(s+="&#09;<b>axes</b>: [",a=0;a<i.naxes.length;a++)s+=sprintf("%d",i.naxes[a]),a!==i.naxes.length-1&&(s+=", ");s+="]"}break;case"table":case"ascii":for(a="&#09;",9>=i.rows&&(a+="&#09;"),s+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",i.rows,a),a=0;a<i.cols.length;a++)s+=sprintf("%s",i.cols[a].name),a!==i.cols.length-1&&(s+=", ");s+="]"}s+="\n\n"}return s},CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(e){e&&(this.save(),this.setTransform(1,0,0,1,0,0)),this.clearRect(0,0,this.canvas.width,this.canvas.height),e&&this.restore()},e.tooltip=function(t,a,i,s,r,n){var o;o=function(t){return t.replace(/\$([a-zA-Z0-9_.\/]+)/g,function(t,a,i){switch((a=a.split("."))[0]){case"im":i=s;break;case"xreg":i=r;break;case"evt":i=n;break;default:return t}for(t=1;t<a.length;t++)i=e.isNumber(i=i[a[t]])?i.toFixed(6):i;return void 0===i&&(i=""),i})},i?(i=o(i),s.display.tooltip.html(i),o=s.display.tooltip.width(),i=s.display.tooltip.height(),t=Math.max(2,Math.min(t,s.display.width-(o+10))),a=Math.max(2,Math.min(a,s.display.height-(i+10))),s.display.tooltip.css({left:t,top:a,display:"inline-block"})):s.display.tooltip.html("").css({left:-9999,display:"none"})},e.xeqByName=function(t,a){var i,s,r,n;switch(s=Array.prototype.slice.call(arguments,2),i=typeof t){case"function":return t.apply(a,s);case"string":for(n=(r=t.split(".")).pop(),i=0;i<r.length;i++)a=a[r[i]];return a[n].apply(a,s);default:e.error("unknown function type: "+i)}},e.varByName=function(t,a){var i,s,r;for(a=a||e,r=(s=t.split(".")).pop(),i=0;i<s.length;i++)if(!(a=a[s[i]]))return null;return a[r]},e.mergePrefs=function(t){var a,i,s;for(s in t)if(t.hasOwnProperty(s)&&e.hasOwnProperty(s)&&((i=typeof e[s])==(a=typeof t[s])||"string"===a))switch(i){case"object":$.isArray(t[s])?e[s]=t[s]:$.extend(e[s],t[s]);break;case"number":case"string":e[s]=t[s]}},e.loadPrefs=function(t,a){$.ajax({url:t,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(t){e.mergePrefs(t)},error:function(i,s,r){a&&(e.CHROMEFILEWARNING&&"Chrome"===e.BROWSER[0]&&""===document.domain&&r&&r.message&&r.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),e.CHROMEFILEWARNING=!1):e.log("JS9 prefs file not available: %s",t))}})},e.isTypedArray=function(e){return e=Object.prototype.toString.call(e),{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(e)},e.Starbase=function(e,t){var a,i,s,r,n,o=0;if(n=function(e){var t;for(t=0;t<e.length;t++)if(null===e[t].match(/^-+$/))return 0;return t},i=function(e){return e},this.head={},this.convFuncs=[],this.data=[],this.delims=[],e){if(t=t||{},r=e.replace(/\s+$/,"").split("\n"),t.skip&&(s=t.skip.split(""))&&s.length)for(;o<r.length&&(s[0]===r[o][0]||"\n"===s[1]&&""===r[o]);o++);if(void 0!==r[o]&&void 0!==r[o+1]){for(this.headline=r[o++].trim().split(/ *\t */),t.units&&(this.unitline=r[o++].trim().split(/ *\t */)),this.dashline=r[o++].trim().split(/ *\t */),a=n(this.dashline);0===a||a!==this.headline.length;)t.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=r[o++].trim().split(/ *\t */),a=n(this.dashline);for(a=0;a<this.headline.length;a++)this.headline[a]=this.headline[a].replace(/\./g,"_"),this.convFuncs[a]=t.convFuncs&&t.convFuncs[this.headline[a]]?t.convFuncs[this.headline[a]]:t.convFuncs&&t.convFuncs.def?t.convFuncs.def:i;for(i=0;o<r.length&&(!s||!s.length||s[0]!==r[o][0]&&("\n"!==s[1]||""!==r[o]));o++,i++)for(this.data[i]=r[o].split("\t"),a=0;a<this.data[i].length;a++)n=this.convFuncs[a](this.data[i][a]),this.data[i][a]=n.val,this.delims[a]=n.delim||null;for(a=0;a<this.headline.length;a++)this[this.headline[a]]=a}}},e.colorToHex=function(e){var t,a;return e?void 0!==(t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",deeppink2:"#ee1289",deeppink3:"#cd1076",deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",deepskyblue3:"#009acd",deepskyblue4:"#00688b",dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",lemonchiffon4:"#8b8970",lightblue1:"#bfefff",lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",paleturquoise3:"#96cdcd",paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",seagreen4:"#2e8b57",skyblue1:"#87ceff",skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",violetred2:"#ee3a8c",violetred3:"#cd3278",violetred4:"#8b2252",webgray:"#808080",webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",blue3:"#0000cd",blue4:"#00008b",brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",cyan1:"#00ffff",cyan2:"#00eeee",cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",gray2:"#050505",gray20:"#333333",gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",gray47:"#787878",gray48:"#7a7a7a",gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",gray74:"#bdbdbd",gray75:"#bfbfbf",gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",green3:"#00cd00",green4:"#008b00",grey:"#bebebe",grey0:"#000000",grey1:"#030303",grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",grey32:"#525252",grey33:"#545454",grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",grey6:"#0f0f0f",grey60:"#999999",grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",grey87:"#dedede",grey88:"#e0e0e0",grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",magenta4:"#8b008b",maroon1:"#ff34b3",maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",salmon2:"#ee8262",salmon3:"#cd7054",salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",turquoise3:"#00c5cd",turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"})[a=e.toLowerCase()]?t[a]:(t=e.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",t[1],t[2],t[3]):e:""},e.strtoscaled=function(t){t=e.saostrtod(t);var a=String.fromCharCode(e.saodtype());switch(a){case'"':t/=3600;break;case"'":t/=60;break;case"r":t*=180/Math.PI}return{dval:t,dtype:a}},e.cleanPath=function(e){return e?e.trim().replace(/\/\.\//,"/").replace(/^\.\//,""):""},e.fixPath=function(t,a){return a=a||{},window.isElectron&&window.currentDir&&e.desktopOpts.currentPath&&!1!==a.fixpath&&"/"!==t.charAt(0)&&!t.match(e.URLEXP)&&(t=window.currentDir+"/"+t),t},e.dirname=function(e){return e&&-1!==e.indexOf("/")?e.match(/.*\//)[0]:""},e.mouseDownCB=function(t){var a=t.data,i=a.image;if(i){if(t.target&&(i.posOffset=$(t.target).offset()),i.pos0=e.eventToDisplayPos(t,i.posOffset),i.pos=i.pos0,i.ipos0=i.displayToImagePos(i.pos),i.ipos=i.ipos0,a.resizing=a.inResize(i.pos),!a.resizing){if(t.preventDefault(),e.hasOwnProperty("MouseTouch")&&e.MouseTouch.action(i,t,"start"),i.clickInRegion&&"regions"===i.clickInLayer)return void i.display.clearMessage("regions");e.specialKey(t)||i.xeqPlugins("mouse","onmousedown",t)}switch(i.clickState=t.which,t.which){case 3:i.clickState=2}t.originalEvent&&t.originalEvent.touches&&t.originalEvent.touches.length&&(i.clickState=-t.originalEvent.touches.length),$(document).on("mousemove."+a.id,a,function(t){return e.mouseMoveCB(t)}),$(document).on("mouseup."+a.id,a,function(t){return e.mouseUpCB(t)})}},e.mouseUpCB=function(t){var a,i,s=t.data;if(a=s.image)for(a.pos=e.eventToDisplayPos(t,a.posOffset),a.ipos=a.displayToImagePos(a.pos),i=Math.abs(a.pos0.x-a.pos.x)<e.NOMOVE&&Math.abs(a.pos0.y-a.pos.y)<e.NOMOVE,s.inResize(a.pos)||t.preventDefault(),e.hasOwnProperty("MouseTouch")&&e.MouseTouch.action(a,t,"stop"),a.clickInRegion&&a.clickInLayer&&a.updateShapes(a.clickInLayer,"selected",i?"select":"update"),e.specialKey(t)||(a.xeqPlugins("mouse","onmouseup",t),i&&(a.xeqPlugins("mouse","onclick",t),e.hasOwnProperty("Menubar"))&&e.Menubar.onclick(a.display),"click"===e.globalOpts.dynamicSelect&&e.Dysel.getDisplayOr(s)!==s&&e.Dysel.select(s)),a.clickInRegion=!1,a.clickInLayer=null,a.clickState=0,a.posOffset=null,s.resizing&&(s.resizing=!1,e.bugs.webkit_resize&&(t=parseInt(s.divjq.css("width"),10),i=parseInt(s.divjq.css("height"),10),t<s.owidth&&s.divjq.css("width",s.owidth+e.RESIZEFUDGE),i<s.oheight&&s.divjq.css("height",s.oheight+e.RESIZEFUDGE)),e.globalOpts.resizeRedisplay||(a.displayImage("all"),a.refreshLayers())),$(document).off("mouseup."+s.id),$(document).off("mousemove."+s.id),a=0;a<e.displays.length;a++)(t=e.displays[a])!==s&&t.image&&t.image.clickState&&t.divjq.trigger("mouseup");else e.hasOwnProperty("Menubar")&&e.Menubar.onclick(t.data)},e.mouseMoveCB=function(t){var a,i=(a=t.data).image;!i||e.specialKey(t)||(i.pos=e.eventToDisplayPos(t,i.posOffset),i.ipos=i.displayToImagePos(i.pos),i.pos0||(i.pos0=i.pos),i.ipos0||(i.ipos0=i.ipos),a.resizing)||(t.preventDefault(),i.valpos=null,i.clickInRegion&&"regions"===i.clickInLayer&&(a=i.display.layers.regions.params.sel)&&((i.params.listonchange||a.params.listonchange||e.globalOpts.intensivePlugins)&&i.updateShape("regions",a,null,"move"),(i.params.listonchange||a.params.listonchange)&&i.listRegions("selected",{mode:2}),e.globalOpts.intensivePlugins&&i.xeqPlugins("region","onregionsmove",a.pub)),e.hasOwnProperty("MouseTouch")&&e.MouseTouch.action(i,t),e.hasOwnProperty("Crosshair")&&i.tmp.arrowCrosshairVisible&&!i.params.crosshair&&e.Crosshair.hide(i,i.ipos,t),i.valpos||(i.valpos=i.updateValpos(i.ipos,!1)),e.specialKey(t)||i.xeqPlugins("mouse","onmousemove",t))},e.mouseEnterCB=function(t){var a=t.data,i=a.image;t.preventDefault(),i&&(e.specialKey(t)||"move"===e.globalOpts.dynamicSelect&&e.Dysel.getDisplayOr(a)!==a&&e.Dysel.select(a))},e.mouseOverCB=function(t){var a=t.data.image,i=$(document).scrollLeft(),s=$(document).scrollTop();t.preventDefault(),a&&(a.display.displayConjq.focus(),window.scrollTo(i,s),e.specialKey(t)||(a.pos=e.eventToDisplayPos(t),a.ipos=a.displayToImagePos(a.pos),e.specialKey(t)||a.xeqPlugins("mouse","onmouseover",t)))},e.mouseOutCB=function(t){var a=t.data.image;t.preventDefault(),a&&(a.display.displayConjq.blur(),a.clickInRegion&&a.clickInLayer&&a.updateShapes(a.clickInLayer,"selected","mouseout"),e.specialKey(t)||(a.pos=e.eventToDisplayPos(t),a.ipos=a.displayToImagePos(a.pos),e.specialKey(t)||a.xeqPlugins("mouse","onmouseout",t)))},e.wheelCB=function(t){var a=t.data,i=a.image;a.mousetouchZoom&&i&&e.hasOwnProperty("MouseTouch")&&e.MouseTouch.Actions["wheel zoom"]&&(e.MouseTouch.Actions["wheel zoom"](i,t),t.preventDefault())},e.keyPressCB=function(e){var t=e.data.image;e.preventDefault(),t&&t.xeqPlugins("keypress","onkeypress",e)},e.keyDownCB=function(t){var a=t.data.image;t.preventDefault(),e.hasOwnProperty("Keyboard")&&e.Keyboard.action(a,a?a.ipos:{x:null,y:null},t),a&&a.xeqPlugins("keypress","onkeydown",t)},e.keyUpCB=function(e){var t=e.data.image;t&&t.xeqPlugins("keypress","onkeyup",e)},e.dragenterCB=function(e,t){t.stopPropagation(),t.preventDefault()},e.dragoverCB=function(e,t){t.stopPropagation(),t.preventDefault()},e.dragexitCB=function(e,t){t.stopPropagation(),t.preventDefault()},e.dragdropCB=function(t,a){var i,s,r,n,o;a.originalEvent&&(a=a.originalEvent),a.stopPropagation(),a.preventDefault(),(r=$.extend(!0,{},e.fits.options)).display=r.display||t,r.extlist=r.extlist||e.globalOpts.extlist,n=a.target.files||a.dataTransfer.files,o=e.lookupDisplay(r.display),n.length?window.setTimeout(function(){var t,a;for(i=0;i<n.length;i++)(a=(t=n[i]).path||t.name||"").match(/\.reg$/)?e.LoadRegions(t,{display:r.display}):a.match(/\.cat$/)?e.LoadCatalog(null,t,{display:r.display}):a.match(/\.ses$/)?e.LoadSession(t,{display:r.display}):a.match(/\.js9ses$/)?e.LoadSession(t,{display:r.display}):a.match(/\.cmap$/)?e.LoadColormap(t):(e.waiting(!0,o),r.refresh=e.globalOpts.refreshDragDrop,e.Load(t,r,{display:r.display}))},e.SPINOUT):(s=a.dataTransfer.getData("text")).match(e.URLEXP)&&e.globalOpts.loadProxy&&e.LoadProxy(s,{display:r.display})},e.RegisterPlugin=function(t,a,i,s){var r,n;t&&a&&i&&(r=t+a,s?(s.viewMenuItem&&(s.menuItem=s.viewMenuItem),s.menuItem&&!s.menu&&(s.menu="view"),s.menu&&(s.menu=s.menu.toLowerCase())):s=[],e.PLUGINS&&(e.PLUGINS+="|"),e.PLUGINS+=r.replace(/JS9/,""),e.PLUGINS+="|",e.PLUGINS+=a,e.plugins.push({xclass:t,xname:a,name:r,opts:s,func:i,instances:[]}),s.help&&((i=s.help.match(/^.*[\\\/]/))[0]&&(n="plugins/"+i[0].replace(/[\\\/]+$/,"")),i=s.help.replace(/^.*[\\\/]/,""),e.helpOpts[a]={type:n,url:i,heading:t,title:s=s.menuItem?s.menuItem:r}),e.inited&&e.instantiatePlugins())},e.instantiatePlugin=function(t,a,i,s){var r,n,o,l,c="visible";if("string"==typeof a){for(r=0;r<e.plugins.length;r++)if((n=e.plugins[r]).name===a){a=n;break}"string"==typeof a&&e.error("unknown plugin: "+a)}if((n=Object.create(a.func.prototype)).name=a.name,n.isActive=function(e){if("active"!==this.status||e&&!this.plugin.opts.hasOwnProperty(e))return!1;switch(this.winType){case"virtual":return!0;default:return this.divjq.is(":visible")}},n.errLog=function(t,a){e.log("error in %s: %s [%s]\n%s",t,this.name,a.message,e.strace(a))},t){for(o=t instanceof jQuery?t:"object"==typeof t?$(t):$("#"+t),r=0;r<a.instances.length;r++)if(o.is(a.instances[r].odivjq))return a.instances[r]}else o=$("div");if(t?i?(n.id=o.attr("id")||a.name,n.winType="light",n.winHandle=i,n.odivjq=o,n.divjq=o,n.outerdivjq=n.divjq.closest(e.lightOpts[e.LIGHTWIN].top)):(n.id=o.attr("id")||a.name,n.winType="div",0<=$.inArray(n.name,e.globalOpts.hiddenPluginDivs)&&(c="hidden"),o.wrap(sprintf("<div class='JS9PluginContainer' style='visibility: %s'>",c)),n.odivjq=o,n.divjq=o,n.divjq.addClass(a.xclass+"Plugin").addClass("JS9Plugin"),n.odivjq.attr("id")||n.odivjq.attr("id",n.id),n.outerdivjq=n.divjq.closest(".JS9PluginContainer"),!1!==o.data("toolbarseparate")&&(a.opts.toolbarSeparate||o.data("toolbarseparate"))&&(i="<div class='"+e.lightOpts[e.LIGHTWIN].dragBar+"'>",$(i).insertBefore(n.divjq))):(n.id=a.name,n.winType="virtual"),n.plugin=a,n.el=t,n.status="active",a.instances.push(n),"virtual"===n.winType)for(r=0;r<e.displays.length;r++)e.displays[r].pluginInstances[a.name]||(n.div=null,n.display=e.displays[r],a.func.apply(n,s),e.displays[r].pluginInstances[a.name]=n);else if(n.div=n.divjq[0],n.outerdiv=n.outerdivjq[0],!a.opts.winDims||n.divjq.width()&&n.divjq.height()||(n.divjq.css("width",a.opts.winDims[0]),n.divjq.css("height",a.opts.winDims[1])),"*"===(t=n.divjq.data("js9id")||n.id)?a.opts.dynamicSelect?(n.display=e.displays[0],n.isDynamic=!0,e.Dysel.addPlugins(a.name),l="*"):e.error(a.name+" is not a dynamically selectable plugin"):(n.display=e.lookupDisplay(t),l=n.display.id),(o=o.data("toolbarhtml")||a.opts.toolbarHTML)&&(o=e.Image.prototype.expandMacro.call(null,o,[{name:"title",value:a.opts.winTitle||""}]),0===(t=n.divjq.closest(e.lightOpts[e.LIGHTWIN].drag)).length&&(t=n.divjq),$("<div class='JS9PluginToolbar-"+n.winType+"'>").css("z-index",e.BTNZINDEX).html(o).data("displayid",l).insertAfter(t)),n.display.pluginInstances[a.name]=n,a.func.apply(n,s),"*"===l)for(r=0;r<e.displays.length;r++)e.displays[r].pluginInstances[a.name]?n.display=e.displays[r]:e.displays[r].pluginInstances[a.name]=n;return n},e.instantiatePlugins=function(){var t,a=function(t){var a,i,s;for($("div."+t.name).each(function(){e.instantiatePlugin($(this),t,null,t.opts.divArgs)}),t.opts.menuItem||!t.opts.winDims||t.opts.winDims[0]||t.opts.winDims[1]||e.instantiatePlugin(null,t,null,t.opts.divArgs),a=0;a<t.instances.length;a++)if((s=t.instances[a]).isDynamic)for(i=0;i<e.displays.length;i++)e.displays[i].pluginInstances[t.name]||(e.displays[i].pluginInstances[t.name]=s)};for(t=0;t<e.plugins.length;t++)a(e.plugins[t])},e.initEmscripten=function(){var t;if(!window.hasOwnProperty("Astroem"))if(t={responseType:"arraybuffer",allowCache:!0},e.globalOpts.useWasm&&"object"==typeof WebAssembly&&("file:"!==location.protocol||e.globalOpts.allowFileWasm))e.globalOpts.astroemWasm=e.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),e.fetchURL(e.globalOpts.astroemWasm,null,t,function(t){Module.wasmBinary=t,e.globalOpts.astroemURL=e.InstallDir("astroemw.js");try{e.loadScript(e.globalOpts.astroemURL)}catch(a){e.error("can't find "+e.globalOpts.astroemURL)}});else{e.globalOpts.astroemURL=e.InstallDir("astroem.js");try{e.loadScript(e.globalOpts.astroemURL)}catch(a){e.error("can't find "+e.globalOpts.astroemURL)}}},e.initFITS=function(){window.hasOwnProperty("Astroem")?(e.vmalloc=Astroem.vmalloc,e.vfree=Astroem.vfree,e.vheap=Astroem.vheap,e.vmemcpy=Astroem.vmemcpy,e.vfile=Astroem.vfile,e.vread=Astroem.vread,e.vunlink=Astroem.vunlink,e.vsize=Astroem.vsize,e.vmount=Astroem.vmount,e.arrfile=Astroem.arrfile,e.listhdu=Astroem.listhdu,e.initwcs=Astroem.initwcs,e.freewcs=Astroem.freewcs,e.wcsinfo=Astroem.wcsinfo,e.wcssys=Astroem.wcssys,e.wcsunits=Astroem.wcsunits,e.pix2wcs=Astroem.pix2wcs,e.wcs2pix=Astroem.wcs2pix,e.reg2wcs=Astroem.reg2wcs,e.saostrtod=Astroem.saostrtod,e.saodtostr=Astroem.saodtostr,e.saodtype=Astroem.saodtype,e.zscale=Astroem.zscale,e.tanhdr=Astroem.tanhdr,e.reproject=Astroem.reproject,e.madd=Astroem.madd,e.imgtbl=Astroem.imgtbl,e.makehdr=Astroem.makehdr,e.shrinkhdr=Astroem.shrinkhdr,e.imsection=Astroem.imsection,e.regcnts=Astroem.regcnts,e.fitsLibrary("cfitsio")):window.hasOwnProperty("Fitsy")&&e.fitsLibrary("fitsy")},e.initColormaps=function(){e.hasOwnProperty("Colormap")&&(e.checkNew(new e.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),e.checkNew(new e.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),e.checkNew(new e.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]])),e.checkNew(new e.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),e.checkNew(new e.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),e.checkNew(new e.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),e.checkNew(new e.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),e.checkNew(new e.Colormap("magma",[[.001462,466e-6,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]])),e.checkNew(new e.Colormap("inferno",[[.001462,466e-6,.013866],[.002267,.00127,.01857],[.003299,.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]])),e.checkNew(new e.Colormap("plasma",[[.050383,.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,859e-6,.656133],[.405503,678e-6,.656977],[.41158,577e-6,.65773],[.417642,564e-6,.65839],[.423689,646e-6,.658956],[.429719,831e-6,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]])),e.checkNew(new e.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),e.checkNew(new e.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),e.checkNew(new e.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),e.checkNew(new e.Colormap("a",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),e.checkNew(new e.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),e.checkNew(new e.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),e.checkNew(new e.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],[.065,.625],[.25,.25],[1,1]])),e.checkNew(new e.Colormap("hsv",function(){var e,t,a,i,s,r,n,o=[],l=0;for(e=0;200>e;e++,l++){for(a=360*(t=1-e/199)+270,i=Math.abs(Math.sin(3.1416*t)),t=Math.pow(1-t,1/3);360<=a;)a-=360;switch(s=(a/=60)-(n=Math.floor(a)),a=t*(1-i),r=t*(1-i*s),i=t*(1-i*(1-s)),o[l]=[],n){case 0:o[l].push(t),o[l].push(i),o[l].push(a);break;case 1:o[l].push(r),o[l].push(t),o[l].push(a);break;case 2:o[l].push(a),o[l].push(t),o[l].push(i);break;case 3:o[l].push(a),o[l].push(r),o[l].push(t);break;case 4:o[l].push(i),o[l].push(a),o[l].push(t);break;case 5:o[l].push(t),o[l].push(a),o[l].push(r)}}return o}())),e.checkNew(new e.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),e.checkNew(new e.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]])),e.checkNew(new e.Colormap("staircase",function(){var e,t,a=[],i=0;for(e=1;5>=e;e++,i++)t=e/5,a[i]=[],a[i].push(.3*t),a[i].push(.3*t),a[i].push(t);for(e=1;5>=e;e++,i++)t=e/5,a[i]=[],a[i].push(.3*t),a[i].push(t),a[i].push(.3*t);for(e=1;5>=e;e++,i++)t=e/5,a[i]=[],a[i].push(t),a[i].push(.3*t),a[i].push(.3*t);return a}())),e.checkNew(new e.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))},e.initCommands=function(){e.hasOwnProperty("Command")&&(e.checkNew(new e.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var e,t,a,i,s="",r=this.image;if(r&&r.analysisPackages)for(t=0;t<r.analysisPackages.length;t++){for(i=r.analysisPackages[t],e=0;e<i.length;e++)a=i[e],s&&(s+=", "),s+=sprintf("%s (%s)",a.title,a.xclass?a.xclass+":"+a.name:a.name);t<r.analysisPackages.length-1&&(s+="\n")}return s},set:function(t){var a,i=this.image;i&&((a=i.lookupAnalysis(t[0]))?a.purl?(t=i.displayAnalysis("params",e.InstallDir(a.purl),{title:a.title+": "+i.fitsFile}),$(t).data("dispid",i.display.id).data("aname",a.name)):i.runAnalysis(a.name):e.error("unknown analysis command '"+t[0]+"'"))}})),e.checkNew(new e.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var e;if(e=this.image)return e=e.getColormap(),sprintf("%s %s %s",e.colormap,e.contrast,e.bias)},set:function(e){var t=this.image;t&&t.setColormap.apply(t,e)}})),e.checkNew(new e.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var t,a="";for(t=0;t<e.colormaps.length;t++)a&&(a+=", "),a+=e.colormaps[t].name;return a}})),e.checkNew(new e.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var e,t=this.image;return t&&(e=t.displayCoordGrid()),e?"true":"false"},set:function(e){var t,a=this.image;a&&(t=!!e[0].match(/true/i),a.displayCoordGrid(t,e[1]))}})),e.checkNew(new e.Command({name:"help",help:"get list of available commmands",get:function(){var t,a,i;for(i="<table>",t=0;t<e.commands.length;t++)i+="<tr><td>"+(a=e.commands[t]).name+"</td><td>"+a.help,a.alias&&(i+=" ("+a.alias,a.alias2&&(i+=", "+a.alias2),i+=")"),i+="</td></tr>";return i+"</table>"}})),e.checkNew(new e.Command({name:"helper",help:"get/set helper connection",get:function(){return e.helper.connectinfo()},set:function(t){e.helper.connect(t[0].trim())}})),e.checkNew(new e.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var e=this.image;if(e)return e.file},set:function(t){var a,i;for(a=0;a<e.images.length;a++)if(0<=(i=e.images[a]).file.search(t[0])&&i.display===this.display){i.displayImage("display");break}}})),e.checkNew(new e.Command({name:"images",help:"get list of currently loaded images",get:function(){var t,a,i="";for(t=0;t<e.images.length;t++)(a=e.images[t]).display===this.display&&(i&&(i+=", "),i+=a.file);return i}})),e.checkNew(new e.Command({name:"load",help:"load image(s)",set:function(t){var a,i,s,r=t.length;for(a=0;a<r;a++){if(s=null,(i=a+1)<r&&0===t[i].indexOf("{"))try{s=JSON.parse(t[i])}catch(n){s=null}s?(e.Load(t[a],s,{display:this.display.id}),a++):e.Load(t[a],{display:this.display.id})}}})),e.checkNew(new e.Command({name:"pan",help:"set/get pan location for current image",get:function(){var e;if(e=this.image)return e=e.getPan(),sprintf("%s %s",e.x,e.y)},set:function(e){var t=this.image;t&&t.setPan.apply(t,e)}})),e.checkNew(new e.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(t){var a=this.image;if(a)return(t=e.Pix2WCS(parseFloat(t[0]),parseFloat(t[1]),{display:a})).str}})),e.checkNew(new e.Command({name:"print",help:"print image window",get:function(){var e=this.image;e&&e.print()}})),e.checkNew(new e.Command({name:"refresh",help:"refresh current image using specified file (def: use last file)",set:function(t){var a,i,s,r=t.length;if(a=this.image,0===r)e.Load(a.file,s={refresh:a},{display:this.display.id});else for(a=0;a<r;a++){if(s=null,(i=a+1)<r&&0===t[i].indexOf("{"))try{s=JSON.parse(t[i])}catch(n){s=null}s?(s.refresh=!0,e.Load(t[a],s,{display:this.display.id}),a++):e.Load(t[a],s={refresh:!0},{display:this.display.id})}}})),e.checkNew(new e.Command({name:"regcnts",help:"counts in regions for current image",get:function(){var e=this.image;e&&e.countsInRegions("$sregions","$bregions",{lightwin:!0})},set:function(e){var t=this.image;if(t)return t.countsInRegions.apply(t,e)}})),e.checkNew(new e.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var e=this.image;if(e)return e.listRegions("all",{mode:0})||""},set:function(e){var t=this.image;t&&("delete"===e[0]||"remove"===e[0]?(e=e.slice(1).join(" "),t.removeShapes("regions",e)):(e=e.join(" "),t.addShapes("regions",e)))}})),e.checkNew(new e.Command({name:"resize",help:"get/set display size for current image",get:function(){var e;if(e=this.image)return e=e.display,sprintf("%s %s",e.width,e.height)},set:function(e){var t,a;(t=this.image)&&e.length&&(t=t.display,a=parseInt(e[0],10),e=1<e.length?parseInt(e[1],10):a,t.resize(a,e))}})),e.checkNew(new e.Command({name:"scale",help:"set/get scaling for current image",get:function(){var e;if(e=this.image)return e=e.getScale(),sprintf("%s %s %s",e.scale,e.scalemin,e.scalemax)},set:function(e){var t=this.image;t&&t.setScale.apply(t,e)}})),e.checkNew(new e.Command({name:"scales",help:"get list of available scales",get:function(){return e.scales.join(", ")}})),e.checkNew(new e.Command({name:"section",help:"display section of current image",set:function(t){var a,i=this.image;if(1===t.length&&"full"===t[0])i.displaySection("full");else{t=t.join(" ");try{a=JSON.parse(t)}catch(s){e.error("invalid JSON section")}i.displaySection(a)}}})),e.checkNew(new e.Command({name:"status",help:"get status for specified (or current) image",get:function(t){var a,i,s,r="";for(a=0;a<e.images.length;a++)if(0<=(i=e.images[a]).file.search(t[0])){s=i;break}if(s?a=1:(a=0,s=this.image),s){if(a>t.length)return s.status.load;for(;a<t.length;a++)switch(i=t[a].toLowerCase().trim(),i){case"load":r&&(r+="\n"),r+=s.status.load}}return r}})),e.checkNew(new e.Command({name:"url",help:"display a url",set:function(t){e.DisplayHelp(t[0])}})),e.checkNew(new e.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var e=this.image;if(e)return e.getWCSSys()},set:function(e){var t=this.image;t&&t.setWCSSys(e[0])}})),e.checkNew(new e.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var e=this.image;if(e)return e.getWCSUnits()},set:function(e){var t=this.image;t&&t.setWCSUnits(e[0])}})),e.checkNew(new e.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return e.wcssyss.join(", ")}})),e.checkNew(new e.Command({name:"wcsunits",help:"get list of available wcs units",get:function(){return e.wcsunitss.join(", ")}})),e.checkNew(new e.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(t){var a=this.image;if(a)return(t=e.WCS2Pix(parseFloat(t[0]),parseFloat(t[1]),{display:a})).str}})),e.checkNew(new e.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var e=this.image;if(e)return e.getZoom()},set:function(e){var t=this.image;t&&t.setZoom(e[0])}})))},e.initAnalysis=function(){$(document).on("keyup keypress",".js9AnalysisForm",function(e){var t=$(this);if(13===(e.which||e.keyCode))return e.preventDefault(),(e=$(this).data("enterfunc"))&&t.find("[name='"+e+"']").click(),!1})},e.init=function(){var t;if(window.HTMLCanvasElement&&JSON||e.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge."),window.hasOwnProperty("JS9Prefs")&&"object"==typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(e.INSTALLDIR=JS9Prefs.globalOpts.installDir),!e.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(){var t=$(this).attr("href");t&&"js9.css"===t.split("/").reverse()[0]&&(e.INSTALLDIR=t.replace(/js9\.css$/,""))})}catch(a){e.INSTALLDIR=""}e.INSTALLDIR&&(e.INSTALLDIR=e.cleanPath(e.INSTALLDIR))}if(e.INSTALLDIR&&"/"!==e.INSTALLDIR.slice(-1)&&(e.INSTALLDIR+="/"),e.TOROOT=e.INSTALLDIR.replace(/([^\/.])+/g,".."),window.hasOwnProperty("JS9Inline")&&"object"==typeof JS9Inline&&(e.inline=$.extend(!0,{},JS9Inline)),"dhtml"===e.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=e.inline?[e.inline["images/min.gif"],e.inline["images/close.gif"],e.inline["images/restore.gif"],e.inline["images/resize.gif"]]:e.allinone?[e.allinone.min,e.allinone.close,e.allinone.restore,e.allinone.resize]:[e.InstallDir("images/min.gif"),e.InstallDir("images/close.gif"),e.InstallDir("images/restore.gif"),e.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){e.jupyterFocus($(this).parent())})),e.globalOpts.plotLibrary=e.globalOpts.plotLibrary||"flot","plotly"!==e.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(e.globalOpts.plotLibrary="flot"),window.hasOwnProperty("JS9Prefs")&&"object"==typeof JS9Prefs?e.mergePrefs(JS9Prefs):e.PREFSFILE&&(e.loadPrefs(e.InstallDir(e.PREFSFILE),1),e.loadPrefs(e.PREFSFILE,0)),e.hasOwnProperty("Regions")&&$.extend(!0,e.Regions.opts,e.regionOpts),delete e.regionOpts,e.hasOwnProperty("Catalogs")&&$.extend(!0,e.Catalogs.opts,e.catalogOpts),delete e.catalogOpts,e.hasOwnProperty("Crosshair")&&$.extend(!0,e.Crosshair.opts,e.crosshairOpts),delete e.crosshairOpts,e.hasOwnProperty("Grid")&&$.extend(!0,e.Grid.opts,e.gridOpts),delete e.gridOpts,e.hasOwnProperty("Module")&&$.extend(!0,Module,e.emscriptenOpts),delete e.emscriptenOpts,e.globalOpts.resize||(e.globalOpts.resizeHandle=!1),void 0!==e.analOpts.prependJS9Dir&&(e.globalOpts.prependJS9Dir=e.analOpts.prependJS9Dir,delete e.analOpts.prependJS9Dir),void 0!==e.analOpts.dataDir&&(e.globalOpts.dataDir=e.analOpts.dataDir,delete e.analOpts.dataDir),e.BROWSER[3]&&(e.globalOpts.resizeHandle=!1),window.hasOwnProperty("localStorage")){try{t=localStorage.getItem("globals")}catch(a){t=null}if(t){try{e.userOpts.displays=JSON.parse(t)}catch(a){}e.userOpts.displays&&$.extend(!0,e.globalOpts,e.userOpts.displays)}try{t=localStorage.getItem("images")}catch(a){t=null}if(t){try{e.userOpts.images=JSON.parse(t)}catch(a){}e.userOpts.images&&$.extend(!0,e.imageOpts,e.userOpts.images)}try{t=localStorage.getItem("fits")}catch(a){t=null}if(t)try{e.userOpts.fits=JSON.parse(t)}catch(a){}try{t=localStorage.getItem("regions")}catch(a){t=null}if(t){try{e.userOpts.regions=JSON.parse(t)}catch(a){}e.userOpts.regions&&$.extend(!0,e.Regions.opts,e.userOpts.regions)}try{t=localStorage.getItem("grid")}catch(a){t=null}if(t){try{e.userOpts.images=JSON.parse(t)}catch(a){}e.userOpts.images&&$.extend(!0,e.Grid.opts,e.userOpts.images)}try{t=localStorage.getItem("catalog")}catch(a){t=null}if(t){try{e.userOpts.images=JSON.parse(t)}catch(a){}e.userOpts.images&&$.extend(!0,e.Catalogs.Opts,e.userOpts.images)}}if(e.DEBUG=e.DEBUG||e.globalOpts.debug||0,$("div.JS9").each(function(){e.checkNew(new e.Display($(this)))}),window.Worker&&!e.allinone)try{e.worker=new e.WebWorker(e.InstallDir(e.WORKERFILE))}catch(a){}e.allinone?e.initFITS():e.initEmscripten(),e.helper=new e.Helper,window.addEventListener("message",function(t){var a,i=t.data;if("null"===(t=t.origin||t.originalEvent.origin)&&(t="unknown"),e.globalOpts.postMessage){if("string"==typeof i)try{a=JSON.parse(i)}catch(s){e.error("can't parse msg: "+i,s)}else"object"==typeof i?a=i:e.error("invalid msg from postMessage");e.msgHandler(a,function(e,t,i,s){s=s||{},parent.postMessage({cmd:a.cmd,res:{name:s.name,rtype:s.rtype,rdata:e,stdout:e,stderr:t,errcode:i}},"*")})}else e.DEBUG&&(t=sprintf("JS9 ignoring postMessage, origin: %s",t),t="string"==typeof i?t+sprintf(" data: %s",i):"object"==typeof i?t+sprintf(" obj: %s",JSON.stringify(Object.keys(i))):t+sprintf(" typeof: %s",typeof i),e.log(t))},!1),window.hasOwnProperty("ImageFilters")&&(e.ImageFilters=ImageFilters),e.initColormaps(),e.initCommands(),e.initAnalysis(),e.RegisterPlugin(e.MouseTouch.CLASS,e.MouseTouch.NAME,e.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:e.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[e.MouseTouch.WIDTH,e.MouseTouch.HEIGHT]}),e.RegisterPlugin(e.Regions.CLASS,e.Regions.NAME,e.Regions.init,{divArgs:["regions"],winDims:[0,0]}),e.RegisterPlugin(e.Crosshair.CLASS,e.Crosshair.NAME,e.Crosshair.init,{onmousemove:e.Crosshair.display,onkeyboardaction:e.Crosshair.keyaction,onkeyup:e.Crosshair.keyup,onimageload:e.Crosshair.create,winDims:[0,0]}),e.RegisterPlugin(e.Grid.CLASS,e.Grid.NAME,e.Grid.init,{onsetpan:e.Grid.regrid,onsetzoom:e.Grid.regrid,onsetwcssys:e.Grid.regrid,onsetwcsunits:e.Grid.regrid,onimageload:e.Grid.regrid,onupdateprefs:e.Grid.regrid,winDims:[0,0]}),e.RegisterPlugin(e.Dysel.CLASS,e.Dysel.NAME,e.Dysel.init,{onimageload:e.Dysel.imageload,onimageclose:e.Dysel.imageclose,winDims:[0,0]}),e.instantiatePlugins(),e.plugins.sort(function(e,t){var a=e.opts.menuItem,i=t.opts.menuItem;return a?!i||a<i?-1:a>i?1:0:1}),$(document).scrollTop(0),e.inited=!0,$(document).trigger("JS9:init")},e.parsePublicArgs=function(e){var t=null,a=(e=Array.prototype.slice.call(e))[e.length-1];return a&&"object"==typeof a&&a.hasOwnProperty("display")&&1===Object.keys(a).length&&(t=a.display,e.pop()),{argv:e,display:t}},e.mkPublic=function(t,a){"string"==typeof a?e.Image.prototype[a]?(e[t]=function(){var t;t=e.parsePublicArgs(arguments);var i=e.getImage(t.display);if(i)return(t=i[a].apply(i,t.argv))===i||t===i.display?e.globalOpts.quietReturn?"":"OK":t},e.publics[t]=e[t]):e.error("unknown image function for mkPublic: "+a):"function"==typeof a?(e[t]=a,e.publics[t]=e[t]):e.error("unsupported type for mkPublic: "+typeof a)},e.mkPublic("CloseImage","closeImage"),e.mkPublic("DisplayImage","displayImage"),e.mkPublic("DisplayExtension","displayExtension"),e.mkPublic("DisplaySlice","displaySlice"),e.mkPublic("DisplaySection","displaySection"),e.mkPublic("BlendImage","blendImage"),e.mkPublic("GetColormap","getColormap"),e.mkPublic("SetColormap","setColormap"),e.mkPublic("GetZoom","getZoom"),e.mkPublic("SetZoom","setZoom"),e.mkPublic("GetPan","getPan"),e.mkPublic("SetPan","setPan"),e.mkPublic("AlignPanZoom","alignPanZoom"),e.mkPublic("GetScale","getScale"),e.mkPublic("SetScale","setScale"),e.mkPublic("GetParam","getParam"),e.mkPublic("SetParam","setParam"),e.mkPublic("GetValPos","updateValpos"),e.mkPublic("ImageToDisplayPos","imageToDisplayPos"),e.mkPublic("DisplayToImagePos","displayToImagePos"),e.mkPublic("ImageToLogicalPos","imageToLogicalPos"),e.mkPublic("LogicalToImagePos","logicalToImagePos"),e.mkPublic("GetWCSUnits","getWCSUnits"),e.mkPublic("SetWCSUnits","setWCSUnits"),e.mkPublic("GetWCS","getWCS"),e.mkPublic("SetWCS","setWCS"),e.mkPublic("GetWCSSys","getWCSSys"),e.mkPublic("SetWCSSys","setWCSSys"),e.mkPublic("ShowShapeLayer","showShapeLayer"),e.mkPublic("ActiveShapeLayer","activeShapeLayer"),e.mkPublic("ToggleShapeLayers","toggleShapeLayers"),e.mkPublic("AddShapes","addShapes"),e.mkPublic("RemoveShapes","removeShapes"),e.mkPublic("GetShapes","getShapes"),e.mkPublic("ChangeShapes","changeShapes"),e.mkPublic("DisplayCoordGrid","displayCoordGrid"),e.mkPublic("Print","print"),e.mkPublic("SavePNG","savePNG"),e.mkPublic("SaveJPEG","saveJPEG"),e.mkPublic("SaveFITS","saveFITS"),e.mkPublic("UploadFITSFile","uploadFITSFile"),e.mkPublic("CountsInRegions","countsInRegions"),e.mkPublic("RadialProfile","radialProfile"),e.mkPublic("Plot3D","plot3d"),e.mkPublic("RunAnalysis","runAnalysis"),e.mkPublic("RawDataLayer","rawDataLayer"),e.mkPublic("GaussBlurData","gaussBlurData"),e.mkPublic("ImarithData","imarithData"),e.mkPublic("RotateData","rotateData"),e.mkPublic("ReprojectData","reprojectData"),e.mkPublic("ShiftData","shiftData"),e.mkPublic("FilterRGBImage","filterRGBImage"),e.mkPublic("MoveToDisplay","moveToDisplay"),e.mkPublic("LookupImage",function(t){var a=e.parsePublicArgs(arguments);return e.lookupImage(a.argv[0],a.display)}),e.mkPublic("LookupDisplay",function(t,a){var i=e.parsePublicArgs(arguments);return e.lookupDisplay(i.argv[0]||i.display,i.argv[1])}),e.mkPublic("RenameDisplay",function(t,a){var i;switch((i=e.parsePublicArgs(arguments)).argv.length){case 0:return;case 1:a=i.display,t=i.argv[0];break;default:a=i.argv[0],t=i.argv[1]}(i=e.lookupDisplay(a))&&i.id&&(a=i.id,i.oid||(i.oid=a),i.id=t,e.helper.send("renameDisplay",{odisplay:a,ndisplay:i.id}))}),e.mkPublic("CloseDisplay",function(t){var a,i;for(a=e.parsePublicArgs(arguments),t=e.lookupDisplay(a.argv[0]||a.display),a=e.images.length-1;0<=a;a--)(i=e.images[a]).display===t&&i.closeImage()}),e.mkPublic("AddColormap",function(t,a,i,s,r){var n,o;n=e.parsePublicArgs(arguments);var l=function(t,a){var i,s;for("object"!=typeof t&&e.error("invalid colormap object for JS9.AddColormap()"),$.isArray(t)||(t=[t]),i=0;i<t.length;i++)(s=t[i]).name||e.error("missing name for colormap in JS9.AddColormap()"),s.vertices?e.AddColormap(s.name,s.vertices[0],s.vertices[1],s.vertices[2],a):s.colors?e.AddColormap(s.name,s.colors,a):e.error("unknown colormap type for JS9.AddColormap()")};if(a=n.argv[1],i=n.argv[2],s=n.argv[3],r=n.argv[4],(t=n.argv[0])instanceof Blob)(n=new FileReader).onload=function(t){try{o=JSON.parse(t.target.result)}catch(i){e.error("can't parse json colormap",i)}l(o,a)},n.readAsText(t);else if("object"==typeof t)l(t,a);else switch(n.argv.length){case 1:try{o=JSON.parse(t)}catch(c){e.error("can't parse JSON colormap",c)}l(o);break;case 2:case 3:if("string"==typeof a)try{a=JSON.parse(a)}catch(c){e.error("can't parse JSON colormap",c)}e.checkNew(new e.Colormap(t,a)),2===n.argv.length?e.globalOpts.topColormaps.push(t):"object"==typeof i&&!1===i.toplevel||e.globalOpts.topColormaps.push(t);break;case 4:case 5:if("string"==typeof a)try{a=JSON.parse(a)}catch(c){e.error("can't parse JSON colormap",c)}if("string"==typeof i)try{i=JSON.parse(i)}catch(c){e.error("can't parse JSON colormap",c)}if("string"==typeof s)try{s=JSON.parse(s)}catch(c){e.error("can't parse JSON colormap",c)}e.checkNew(new e.Colormap(t,a,i,s)),4===n.argv.length?e.globalOpts.topColormaps.push(t):r&&"object"==typeof r&&!1===r.toplevel||e.globalOpts.topColormaps.push(t);break;default:e.error("AddColormap() requires a colormap name and 1 or 3 args")}}),e.mkPublic("LoadColormap",function(t,a){(t=e.parsePublicArgs(arguments).argv[0])||e.error("JS9.LoadColormap: no file specified for colormap load"),"object"==typeof t?e.AddColormap(t,a):"string"==typeof t?(t=e.fixPath(t),e.fetchURL(null,t,null,function(t){e.AddColormap(t,a)})):e.error("unknown file type for LoadColormap: "+typeof t)}),e.mkPublic("SetRGBMode",function(t,a){var i,s,r=["red","green","blue"],n=["rid","gid","bid"],o=e.parsePublicArgs(arguments);if(void 0===(t=o.argv[0])&&(t=!e.globalOpts.rgb.active),a=o.argv[1])for(i=0;3>i;i++)"string"==typeof(s=a[n[i]])&&(s=e.LookupImage(s)),s&&s.setColormap(r[i]);return"true"===t?t=!0:"false"===t&&(t=!1),e.globalOpts.rgb.active=!!t,e.DisplayImage({display:o.display}),e.globalOpts.rgb.active}),e.mkPublic("GetRGBMode",function(){return{active:e.globalOpts.rgb.active,rid:e.globalOpts.rgb.rim?e.globalOpts.rgb.rim.id:null,gid:e.globalOpts.rgb.gim?e.globalOpts.rgb.gim.id:null,bid:e.globalOpts.rgb.bim?e.globalOpts.rgb.bim.id:null}}),e.mkPublic("SetValPos",function(t){var a=null,i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s&&(a=s.params.valpos,s.params.valpos=t=i.argv[0]),a}),e.mkPublic("SetImageInherit",function(t){var a=null,i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s&&(a=s.params.inherit,s.params.inherit=t=i.argv[0]),a}),e.mkPublic("GetImageInherit",function(){var t=null,a=e.parsePublicArgs(arguments);return(a=e.getImage(a.display))&&(t=a.params.inherit),t}),e.mkPublic("Load",function(t,a){var i,s,r,n,o;if(s="fits",a=(r=e.parsePublicArgs(arguments)).argv[1],t=r.argv[0]){if(r=r.display?r.display:0<e.displays.length?e.displays[0].id:e.DEFID,"object"==typeof a)a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(l){a={}}else a={};if(a.display=a.display||r,a.onload?n=a.onload:e.imageOpts.onload&&(a.onload=n=e.imageOpts.onload),t instanceof Blob){if(t.path||t.name)if(a.filename=t.path||t.name,r="object"==typeof a.refresh?a.refresh:e.lookupImage(a.filename,a.display)){if(e.isNull(a.refresh)&&(a.refresh=e.globalOpts.reloadRefresh),!a.refresh)return r.displayImage("display",a),r.refreshLayers(),r.display.clearMessage(),void e.waiting(!1);a.refresh=r}else delete a.refresh;else delete a.refresh;if(a.filename||(a.filename=e.ANON+e.uniqueID()),t.type&&-1!==t.type.indexOf("image/"))switch(t.type){case"image/fits":break;default:s="img"}else a.filename.split(".").pop().match(/(png|jpg|jpeg)/i)&&(s="img");switch(s){case"fits":o=$.extend(!0,{},e.fits.options,a);try{e.handleFITSFile(t,o,e.NewFitsImage)}catch(l){e.error("can't process FITS file",l)}break;case"img":try{e.handleImageFile(t,a,e.Load)}catch(l){e.error("can't process IMG file",l)}}}else if("object"==typeof t)e.checkNew(new e.Image(t,a,n));else if("string"!=typeof t&&e.error("unknown file type for Load: "+typeof t),"U0lNUExFICA9"===t.slice(0,12)&&(t=window.atob(t)),"SIMPLE  ="===t.slice(0,9)){for(n=[],i=0;i<t.length;i++)n[i]=t.charCodeAt(i);i=new Blob([new Uint8Array(n)]),a.filename||(a.filename=e.ANON+e.uniqueID()),i.name=a.filename,o=$.extend(!0,{},e.fits.options,a);try{e.handleFITSFile(i,o,e.NewFitsImage)}catch(l){e.error("can't process FITS file",l)}}else e.isNull(a.refresh)&&(a.refresh=e.globalOpts.reloadRefresh),a.refresh?"object"==typeof a.refresh?r=a.refresh:(s=t.split("/").reverse()[0],(r=e.lookupImage(s,a.display))&&(a.refresh=r)):(s=t.split("/").reverse()[0],r=e.lookupImage(s,a.display)),r&&!a.refresh?(r.displayImage("all",a),r.display.clearMessage(),e.waiting(!1)):"png"===(s=(t=e.cleanPath(t)).split(".").pop().toLowerCase())?e.globalOpts.pngisfits?e.checkNew(new e.Image(t,a,n)):(t=e.fixPath(t,a),e.fetchURL(null,t,a,e.NewFitsImage)):e.fits2RepFile(a.display,t,a,"fits")||e.fits2RepFile(a.display,t,a,"png",n)||(a.display&&(i=e.lookupDisplay(a.display)),e.waiting(!0,i),r&&a.refresh&&e.cleanupFITSFile(r.raw,!0),i=(t=e.fixPath(t,a)).replace(/\[.*\]/,""),e.localMount&&0<=e.vsize(e.localMount+"/"+t)&&0<=$.inArray("."+s,e.globalOpts.localTemplates.split(","))?((o=$.extend(!0,{},e.fits.options,a)).file=t,o.vfile=e.localMount+"/"+t,window.setTimeout(function(){try{e.handleFITSFile(t,o,e.NewFitsImage)}catch(l){e.error("can't process FITS file",l)}},0)):e.fetchURL(t,i,a))}else e.error("JS9.Load: no file specified for image load")}),e.mkPublic("LoadWindow",function(t,a,i,s,r){var n,o,l,c,p,d,h,g,u,m,f,y,b,S,v,w=e.lightOpts[e.LIGHTWIN];p=e.parsePublicArgs(arguments);var x=function(t){0<=(t=$.inArray(t,e.displays))&&e.displays.splice(t,1)};if(d=function(t,a,i){var s,r;return(a=a||{}).clone&&(r=e.lookupDisplay(a.clone,!1)),i&&(b=i.match(/(.*width=)([0-9]+)(px,height=)([0-9]+)(px.*)/,"$1@@H@@$3"),S=parseInt(b[2],10),v=parseInt(b[4],10)),s=sprintf("<hr class='hline0'>"),!r||0<$("#"+a.clone+"Menubar").length&&!r.pluginInstances.JS9Menubar.isDynamic?s+=sprintf("<div class='JS9Menubar' id='%sMenubar'></div>",t):i&&(v-=40),s+=sprintf("<div class='JS9' id='%s'></div>",t),!r||0<$("#"+a.clone+"Colorbar").length&&!r.pluginInstances.JS9Colorbar.isDynamic?(n=r&&r.pluginInstances.JS9Colorbar?sprintf("data-showTicks='%s'",r.pluginInstances.JS9Colorbar.showTicks):"",s+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' %s></div></div>",t,n),r&&r.pluginInstances.JS9Colorbar&&!r.pluginInstances.JS9Colorbar.showTicks&&(v-=15)):i&&(v-=44),i?(e.Dysel.retrievePlugins().length&&(S+=2,v+=2),{html:s,winopts:b[1]+String(S)+b[3]+String(v)+b[5]}):s},t=p.argv[0],i=p.argv[2],s=p.argv[3],r=p.argv[4],"object"==typeof(a=p.argv[1]))a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(J){a={}}else a={};switch(p=((i=i||"light")||"")+"win",i){case"light":return a.id?(o=a.id,delete a.id):o=p+e.uniqueID(),c="d"+o,s?r=r||w.imageWin:(s=(h=d(o,a,w.imageWin)).html,r=r||h.winopts),h=sprintf("JS9 Display"+e.IDFMT,o),(g=e.lightWin(c,"inline",s,h,r)).onclose=function(){var t,a,i=[];for(t=0;t<e.images.length;t++)(a=e.images[t]).display.id===o&&i.push(a);if(!i.length)return x(l),!0;if("move"===e.globalOpts.lightWinClose){if(e.isNull(e.globalOpts.lightWinMoveTo)||e.globalOpts.lightWinMoveTo===o)u=0;else for(u=t=0;t<e.displays.length;t++)if(e.displays[t].id===e.globalOpts.lightWinMoveTo){u++;break}u||(e.globalOpts.lightWinClose="ask",delete e.globalOpts.lightWinMoveTo)}switch(e.globalOpts.lightWinClose){case"close":for(x(l),t=0;t<i.length;t++)try{i[t].closeImage()}catch(s){}return!0;case"move":for(x(l),t=0;t<i.length;t++)try{i[t].moveToDisplay(e.globalOpts.lightWinMoveTo)}catch(s){}return!0;default:return m="lightCloseID"+e.uniqueID(),e.allinone?(f="inline",y=e.allinone.lightCloseHTML):(f="ajax",y=e.InstallDir(e.lightOpts.lcloseURL)),$("#dhtmlwindowholder").arrive("#lightWinCloseForm",{onceOnly:!0},function(){var t,a;for(a=$("#lightWinCloseForm").find("#lightWinCloseSel"),t=0;t<e.displays.length;t++)e.displays[t].id!==o&&a.append($("<option>",{value:e.displays[t].id,text:e.displays[t].id}))}),c=e.lightWin(m,f,y,"Closing a light window",w.lcloseWin),$(c).data("dispid",o),$(c).data("winid",g),!1}},(l=new e.Display(o)).winid=g,e.helper.send("addDisplay",{display:o}),e.instantiatePlugins(),a.display=o,t&&e.Load(t,a),o;case"new":if(a.id?(o=a.id,delete a.id):o=p+e.uniqueID(),r=r||sprintf("width=%s, height=%s",e.globalOpts.newWindowWidth,e.globalOpts.newWindowHeight),(p=(p=document.getElementsByTagName("head")[0].innerHTML).replace(/src=['"].*astroemw?\.js['"]/,"")).match(/src=["'].*js9\.js/)||p.match(/src=["'].*js9\.min\.js/)||(p+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script")),d=s||d(o,a),s=sprintf("<html><head>%s</head><body",p),t&&(s+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",t,JSON.stringify(a))),s+=sprintf(">%s</body></html>\n",d),window.isElectron&&(h="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data<\/script><p></body></html>"),h=window.open(h,o,r))return h.document?(h.document.open(),h.document.write(s),h.document.close()):e.error(h.postMessage?"LoadWindow('new') is disabled on the Desktop for security reasons":"no method available for drawing image into window"),o;e.error("could not create window (check your pop-up blockers)")}}),e.mkPublic("LoadProxy",function(t,a){var i,s,r=e.parsePublicArgs(arguments);if(t=r.argv[0],a=r.argv[1],e.globalOpts.loadProxy||e.error("proxy load not available for this server"),e.globalOpts.workDir||e.error("proxy load requires a temp workDir this server"),t||e.error("no url specified for proxy load"),(t=t.trim()).match(/dropbox\.com/)?t=(t=t.replace("www.dropbox.com","dl.dropboxusercontent.com")).replace("?dl=0","")+"?raw=1":t.match(/drive\.google\.com/)&&(t=t.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1")),r.display&&(s=e.lookupDisplay(r.display)),"object"==typeof a)a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(n){a={}}else a={};e.waiting(!0,s),e.Send("loadproxy",{cmd:"js9Xeq loadproxy "+t},function(s){(s="object"==typeof s?s:0<=s.search(e.analOpts.epattern)?{stderr:s}:{stdout:s}).errcode=s.errcode||0,s.stderr?e.error(s.stderr):s.stdout?(void 0===a.fits2png&&(a.fits2png=!1),i=e.cleanPath(s.stdout),a.proxyFile=i,"/"!==i.charAt(0)&&(i=e.InstallDir(i)),a.fixpath=!1,a.proxyURL=t,e.Load(i,a,{display:r.display})):e.error("internal error: no return from load proxy command")})}),e.mkPublic("Preload",function(t){var a,i,s,r,n="",o=null,l=null,c=e.globalOpts.alerts,p=arguments.length;a=e.parsePublicArgs(arguments);var d=e.URLEXP,h=/\.ses$/,g=/\.cmap$/;switch(t=a.argv[0],e.globalOpts.loadProxy&&e.helper.baseurl&&(s=new RegExp("^"+e.helper.baseurl)),a.display&&(l={display:a.display},--p),p){case 0:a=(null===e.helper.connected||e.helper.connected)&&e.fits.name&&0<e.preloads.length?2:3;break;case 1:a="boolean"==typeof t?t&&0<e.preloads.length?2:3:(null===e.helper.connected||e.helper.connected)&&e.fits.name?1:0;break;default:a=(null===e.helper.connected||e.helper.connected)&&e.fits.name?1:0}switch(a){case 0:for(a=0;a<p;a++)if((i=a+1)<p&&"object"==typeof arguments[i])o=$.extend(!0,{},arguments[i]),e.preloads.push([arguments[a],o,l]),a++;else if(i<p&&0===arguments[i].indexOf("{")){try{o=JSON.parse(arguments[i])}catch(u){o=null}e.preloads.push([arguments[a],o,l]),a++}else e.preloads.push([arguments[a],null,l]);break;case 1:for(e.globalOpts.alerts=!1,a=0;a<p;a++)if(r=s&&arguments[a].match(d)&&!arguments[a].match(s)?e.LoadProxy:arguments[a].match(h)?e.LoadSession:arguments[a].match(g)?e.LoadColormap:e.Load,(i=a+1)<p&&"object"==typeof arguments[i]){r!==e.Load&&r!==e.LoadProxy||(e.preloadwaiting[e.cleanPath(arguments[a])]=!0);try{l?r(arguments[a],arguments[i],l):r(arguments[a],arguments[i])}catch(u){n=n+" "+arguments[a]}a++}else if(i<p&&0===arguments[i].indexOf("{")){try{o=JSON.parse(arguments[i])}catch(u){o=null}r!==e.Load&&r!==e.LoadProxy||(e.preloadwaiting[e.cleanPath(arguments[a])]=!0);try{l?r(arguments[a],o,l):r(arguments[a],o)}catch(u){n=n+" "+arguments[a]}a++}else{r!==e.Load&&r!==e.LoadProxy||(e.preloadwaiting[e.cleanPath(arguments[a])]=!0);try{l?r(arguments[a],null,l):r(arguments[a],null)}catch(u){n=n+" "+arguments[a]}}e.globalOpts.alerts=c,n&&e.error("could not preload image(s): "+n);break;case 2:for(e.globalOpts.alerts=!1,a=0;a<e.preloads.length;a++){(r=s&&e.preloads[a][0].match(d)&&!e.preloads[a][0].match(s)?e.LoadProxy:e.preloads[a][0].match(h)?e.LoadSession:e.preloads[a][0].match(g)?e.LoadColormap:e.Load)!==e.Load&&r!==e.LoadProxy||(e.preloadwaiting[e.cleanPath(e.preloads[a][0])]=!0);try{e.preloads[a][2]?r(e.preloads[a][0],e.preloads[a][1],e.preloads[a][2]):r(e.preloads[a][0],e.preloads[a][1])}catch(u){n=n+" "+e.preloads[a][0]}}e.globalOpts.alerts=c,n&&e.error("could not preload image(s): "+n),e.preloads=[]}}),e.mkPublic("RefreshImage",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);if(t=i.argv[0],a=i.argv[1]||{},s)if(a.id=s.id,t instanceof Blob){a.rawid&&a.rawid!==s.raw.id||e.cleanupFITSFile(s.raw,!0);try{e.handleFITSFile(t,e.fits.options,function(e){s.refreshImage(e,a)})}catch(r){e.error("can't refresh FITS file",r)}}else s.refreshImage(t,a);else t instanceof Blob&&e.Load.apply(null,arguments)}),e.mkPublic("GetLoadStatus",function(t){var a,i,s=e.parsePublicArgs(arguments),r=e.getImage(s.display);return r?((t=s.argv[0])&&"object"==typeof t&&t.hasOwnProperty("id")&&(t=t.id),"string"==typeof t&&(i=t.split("/").reverse()[0]),r.file0&&(a=r.file0.split("/").reverse()[0],i&&!i.match(/\[.*\]/)&&(a=a.replace(/\[.*\]/,""))),!t||r.id0===t||r.file0===t||a&&i&&a===i?r.status.load:"other"):"none"}),e.mkPublic("CopyToClipboard",function(t,a){var i,s;e.clipboard=t,(s=document.createElement("textarea")).style.position="fixed",s.style.top=0,s.style.left=0,s.style.width="2em",s.style.height="2em",s.style.padding=0,s.style.border="none",s.style.outline="none",s.style.boxShadow="none",s.style.background="transparent",s.value=t,document.body.appendChild(s),s.select();try{document.execCommand("copy")?i="OK":(i="MANUAL",e.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",t):window.prompt("copy to clipboard: Ctrl+C",t))}catch(r){i="ERROR"}return document.body.removeChild(s),a&&a.display&&(a.display.divjq.trigger("mouseout"),a.display.divjq.trigger("mouseenter")),i}),e.mkPublic("CopyFromClipboard",function(){return e.clipboard||""}),e.mkPublic("OpenFileMenu",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.display))&&$("#openLocalLoad-"+t.id).click()}),e.mkPublic("OpenRegionsMenu",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.display))&&$("#openLocalLoadRegions-"+t.id).click()}),e.mkPublic("OpenSessionMenu",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.display))&&$("#openLocalLoadSession-"+t.id).click()}),e.mkPublic("OpenCatalogsMenu",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.display))&&$("#openLocalLoadCatalog-"+t.id).click()}),e.mkPublic("OpenColormapMenu",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.display))&&$("#openLocalLoadColormap-"+t.id).click()}),e.mkPublic("SaveColormap",function(){var t,a,i,s=(a=e.parsePublicArgs(arguments)).argv[0],r=a.argv[1],n=function(e){var t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(a){}return t},o=function(t){var a,i,s=[];for(a=0;a<t.length;a++)(i=e.lookupColormap(t[a]))&&(delete(i=$.extend(!0,{},i)).type,s.push(i));return 1===s.length?s[0]:s};return window.hasOwnProperty("saveAs")?(a=e.getImage(a.display))&&(s=n(s),r=n(r),s?"string"==typeof s?(t=s,"string"==typeof r?i=o([r]):$.isArray(r)?i=o(r):delete(i=$.extend(!0,{},a.cmapObj)).type):$.isArray(s)&&(t="js9.cmap",i=o(s)):(t="js9.cmap",delete(i=$.extend(!0,{},a.cmapObj)).type),i=JSON.stringify(i),i=new Blob([i],{type:"text/plain"}),saveAs(i,t)):e.error("no saveAs function available to save colormap"),t}),e.mkPublic("NewFitsImage",function(t,a){var i,s,r;t=(s=e.parsePublicArgs(arguments)).argv[0],a=s.argv[1]||{},s=e.lookupDisplay(s.display||a.display||e.DEFID),a.refresh?("object"==typeof a.refresh?r=a.refresh:s&&s.image&&(r=s.image),r?(a.onload&&(a.onrefresh=a.onload,delete a.onload),r.refreshImage(t,a)):(a.onload&&(i=a.onload),e.checkNew(new e.Image(t,a,i)))):(a.onload&&(i=a.onload),e.checkNew(new e.Image(t,a,i)))}),e.mkPublic("GetImage",function(t){return t&&"string"!=typeof t&&(t=e.parsePublicArgs(arguments).display),e.getImage(t)}),e.mkPublic("GetImageData",function(t){var a=e.parsePublicArgs(arguments),i=e.getImage(a.display);return i?i.getImageData(t=a.argv[0]):null}),e.mkPublic("GetDisplayData",function(t){var a,i,s,r=[];for(i=(a=e.parsePublicArgs(arguments)).display||e.displays[0].id,t=a.argv[0],a=0;a<e.images.length;a++)(s=e.images[a]).display.id===i&&r.push(s.getImageData(t));return r}),e.mkPublic("GetFITSHeader",function(t){var a="",i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s&&s.raw&&(a=e.raw2FITS(s.raw,{addcr:t=i.argv[0]})),a}),e.mkPublic("BlendDisplay",function(t){var a,i,s=[],r=(a=e.parsePublicArgs(arguments)).display||e.DEFID;if(i=e.lookupDisplay(r),t=a.argv[0],i||e.error("no JS9 display found: "+r),void 0===t||"mode"===t)return i.blendMode;if("list"===t){for(a=0;a<e.images.length;a++)(i=e.images[a]).display.id===r&&i.blend.active&&s.push(i.id);return s}return"true"===t?t=!0:"false"===t&&(t=!1),i.blendMode=!!t,i.image&&(i.image.xeqPlugins("image","ondisplayblend"),i.image.displayImage()),i.blendMode}),e.mkPublic("LoadAuxFile",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);s?s.loadAuxFile(t=i.argv[0],a=i.argv[1]):e.error("could not find image for aux file: "+t)}),e.mkPublic("SubmitAnalysis",function(t,a,i){var s,r,n;s=e.lightOpts[e.LIGHTWIN];var o=e.parsePublicArgs(arguments);if(t=o.argv[0],i=o.argv[2],(a=o.argv[1])?s=e.lookupDisplay(o.display).id:(a=(s=$(t).closest(s.top)).data("aname"),s=s.data("dispid")),a?s&&(r=e.getImage(s)):n="internal error: could not find analysis task name",r){s=$(t).closest("form");try{o=(o=s.serializeArray()).concat($("#"+s.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get())}catch(l){o=null}r.runAnalysis(a,o,i)}else n="internal error: could not find image";return n&&e.error(n),!1}),e.mkPublic("Send",function(t,a,i){e.helper.connected?e.helper.send(t,a,i):e.error("no JS9 helper available")}),e.mkPublic("EventToDisplayPos",function(t){return e.eventToDisplayPos(t)}),e.mkPublic("PixToWCS",function(t,a){var i,s,r=1;s=e.parsePublicArgs(arguments);var n=e.getImage(s.display);if(n&&("object"==typeof(i=s.argv[0])&&e.notNull(i.x)&&e.notNull(i.y)?(t=i.x,a=i.y):(t=s.argv[0],a=s.argv[1]),e.isNumber(t)&&e.isNumber(a)||e.error("invalid input for PixToWCS"),0<n.raw.wcs))return s=(i=e.pix2wcs(n.raw.wcs,t,a).trim()).split(/ +/),"sexagesimal"===n.params.wcsunits&&"galactic"!==n.params.wcssys&&"ecliptic"!==n.params.wcssys&&(r=15),{ra:e.saostrtod(s[0])*r,dec:e.saostrtod(s[1]),sys:s[2],str:i}}),e.Pix2WCS=e.PixToWCS,e.mkPublic("WCSToPix",function(t,a){var i,s,r;return i=e.parsePublicArgs(arguments),(r=e.getImage(i.display))&&("object"==typeof(s=i.argv[0])&&e.notNull(s.ra)&&e.notNull(s.dec)?(t=s.ra,a=s.dec):(t=i.argv[0],a=i.argv[1]),e.isNumber(t)&&e.isNumber(a)||e.error("invalid input for WCSToPix"),0<r.raw.wcs)?(i=e.wcs2pix(r.raw.wcs,t,a).trim().split(/ +/),{x:s=parseFloat(i[0]),y:r=parseFloat(i[1]),str:i=sprintf("%f %f",s,r)}):null}),e.WCS2Pix=e.WCSToPix,e.mkPublic("NewShapeLayer",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s?s.display.newShapeLayer(t=i.argv[0],a=i.argv[1]):null}),e.mkPublic("AddRegions",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s?(a=i.argv[1],(t=i.argv[0])||e.error("no region specified for AddRegions"),s.addShapes("regions",t,a)):null}),e.mkPublic("RemoveRegions",function(t){var a=e.parsePublicArgs(arguments),i=e.getImage(a.display);return i?(i.removeShapes("regions",t=a.argv[0]),i.display.clearMessage("regions"),e.globalOpts.quietReturn?"":"OK"):null}),e.mkPublic("CopyRegions",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s?(s.copyRegions(t=i.argv[0],a=i.argv[1]),e.globalOpts.quietReturn?"":"OK"):null}),e.mkPublic("GetRegions",function(t){var a=e.parsePublicArgs(arguments),i=e.getImage(a.display);return i?(a.argv.unshift("regions"),i.getShapes.apply(i,a.argv)):null}),e.mkPublic("ChangeRegions",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);return s&&((t=i.argv[0])||e.error("no region specified for GetRegions"),s.changeShapes("regions",t,a=i.argv[1])),null}),e.mkPublic("SaveRegions",function(t,a,i){var s,r,n,o;return s=(o=e.parsePublicArgs(arguments)).argv[0],r=o.argv[1],n=o.argv[2],(o=e.getImage(o.display))?o.saveRegions(s,r,n):null}),e.mkPublic("EditRegionTags",function(t,a,i){var s=e.parsePublicArgs(arguments),r=e.getImage(s.display);return r?r.editRegionTags(t=s.argv[0],a=s.argv[1],i=s.argv[2]):null}),e.mkPublic("ToggleRegionTags",function(t,a,i){var s=e.parsePublicArgs(arguments),r=e.getImage(s.display);return r?r.toggleRegionTags(t=s.argv[0],a=s.argv[1],i=s.argv[2]):null}),e.mkPublic("UnremoveRegions",function(){var t;return t=e.parsePublicArgs(arguments),(t=e.getImage(t.display))?t.unremoveRegions():null}),e.mkPublic("LoadRegions",function(t,a){var i;i=e.parsePublicArgs(arguments);var s=e.getImage(i.display),r=function(t,i){if(i&&void 0!==i.display&&delete i.display,e.globalOpts.reloadRefreshReg&&i.file)try{s.removeShapes("regions",i.file)}catch(r){}s.addShapes("regions",t,i),a&&a.onload&&a.onload(s)};if(a=i.argv[1],(t=i.argv[0])||e.error("JS9.LoadRegions: no file specified for regions load"),s){if("object"==typeof a)a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(n){a={}}else a={};"object"==typeof t?((i=t.path||t.name)&&(a.file=i.split("/").reverse()[0]),(i=new FileReader).onload=function(e){r(e.target.result,a)},i.readAsText(t)):"string"==typeof t?(a.responseType="text",t=e.fixPath(t),a.file=t.split("/").reverse()[0],e.fetchURL(null,t,a,r)):e.error("unknown file type for LoadRegions: "+typeof t)}}),e.mkPublic("InstallDir",function(t){return t?e.cleanPath(e.INSTALLDIR+t):""}),e.mkPublic("AddDivs",function(){var t,a,i,s,r=e.parsePublicArgs(arguments);for(t=0;t<r.argv.length;t++)if(s=r.argv[t])if(0===$("#"+s).length)e.DEBUG&&e.log("warning: can't find div, skipping AddDivs(): %s",s);else{for(a=0;a<e.displays.length;a++)if(e.displays[a].id===s){i=!0;break}i?e.DEBUG&&e.log("warning: div already added, skipping AddDivs(): %s",s):(e.checkNew(new e.Display(s)),e.helper.send("addDisplay",{display:s}))}e.instantiatePlugins()}),e.mkPublic("InstantiatePlugins",function(){e.instantiatePlugins()}),e.mkPublic("ResizeDisplay",function(){var t,a;return"string"!=typeof(t=e.parsePublicArgs(arguments)).argv[0]||e.isNumber(t.argv[0])||"full"===t.argv[0]||"reset"===t.argv[0]||"image"===t.argv[0]?a=e.lookupDisplay(t.display):(a=e.lookupDisplay(t.argv[0]||t.display),t.argv.splice(0,1)),a||e.error("invalid display for resize"),(t=e.Display.prototype.resize.apply(a,t.argv))===a?e.globalOpts.quietReturn?"":"OK":t}),e.mkPublic("SelectDisplay",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.argv[0]||t.display))||e.error("invalid display for select"),e.hasOwnProperty("Menubar")||e.error("Menubar is required for display selection"),e.Menubar.onclick(t)}),e.mkPublic("GatherDisplay",function(t,a){var i;switch((i=e.parsePublicArgs(arguments)).argv.length){case 0:t=i.display,a=null;break;case 1:"object"==typeof i.argv[0]||"string"==typeof i.argv[0]&&"{"===i.argv[0].charAt(0)?(t=i.display,a=i.argv[0]):t=i.argv[0]||i.display;break;default:t=i.argv[0]||i.display,a=i.argv[1]}(i=e.lookupDisplay(t))||e.error("invalid display for gather"),e.Display.prototype.gather.call(i,a)}),e.mkPublic("SeparateDisplay",function(t,a){var i;switch((i=e.parsePublicArgs(arguments)).argv.length){case 0:t=i.display,a=null;break;case 1:"object"==typeof i.argv[0]||"string"==typeof i.argv[0]&&"{"===i.argv[0].charAt(0)?(t=i.display,a=i.argv[0]):t=i.argv[0]||i.display;break;default:t=i.argv[0]||i.display,a=i.argv[1]}(i=e.lookupDisplay(t))||e.error("invalid display for separate"),e.Display.prototype.separate.call(i,a)}),e.mkPublic("CenterDisplay",function(){var t=e.parsePublicArgs(arguments);(t=e.lookupDisplay(t.argv[0]||t.display))||e.error("invalid display for center"),e.Display.prototype.center.call(t)}),e.mkPublic("SaveSession",function(t,a){var i,s,r={};if(a=(s=e.parsePublicArgs(arguments)).argv[1],"object"==typeof(t=s.argv[0]))r=$.extend(!0,{},t);else if("string"==typeof t)try{r=JSON.parse(t)}catch(n){if(i=t,a)if("object"==typeof a)r=$.extend(!0,{},a);else try{r=JSON.parse(a)}catch(o){r={}}}return r.mode||(r.mode="display"),(s=e.lookupDisplay(s.display?s.display:r.display?r.display:0<e.displays.length?e.displays[0].id:e.DEFID)).image?(i||(i="display"===r.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":s.image.id+".ses"),s.image.saveSession(i,r)):null}),e.mkPublic("LoadSession",function(t,a){var i,s;if(i=e.parsePublicArgs(arguments),a=i.argv[1],(t=i.argv[0])||e.error("JS9.LoadSession: no file specified for load"),"object"==typeof a)a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(r){a={}}else a={};s=e.lookupDisplay(i.display?i.display:a.display?a.display:0<e.displays.length?e.displays[0].id:e.DEFID),a.display=s.id,"object"==typeof t?((i=new FileReader).onload=function(i){i=JSON.parse(i.target.result),a.sessionPath=e.dirname(t.path||t.name||""),s.loadSession(i,a)},i.readAsText(t)):"string"==typeof t?(a.responseType="text",a.display=s.id,t=e.fixPath(t),e.fetchURL(null,t,a,function(a,i){var r=JSON.parse(a);i.sessionPath=e.dirname(t),s.loadSession(r,i)})):e.error("unknown file type for LoadSession: "+typeof t)}),e.mkPublic("SaveCatalog",function(t,a){var i=e.parsePublicArgs(arguments),s=e.getImage(i.display);if(s)return s.saveCatalog(t=i.argv[0],a=i.argv[1])}),e.mkPublic("LoadCatalog",function(t,a,i){var s,r;if(s=e.parsePublicArgs(arguments),a=s.argv[1],i=s.argv[2],(t=s.argv[0])&&!a&&(a=t,t=null),a||e.error("JS9.LoadCatalog: no file specified for catalog load"),r=e.getImage(s.display)){if("object"==typeof i)i=$.extend(!0,{},i);else if("string"==typeof i)try{i=JSON.parse(i)}catch(n){i={}}else i={};"object"==typeof a?((s=new FileReader).onload=function(e){!t&&a.name&&(t=a.name.replace(/\.[^.]*$/,"")),r.loadCatalog(t,e.target.result,i),i&&i.onload&&i.onload(r)},s.readAsText(a)):"string"==typeof a?a.match(/\t/)?(r.loadCatalog(t,a,i),i&&i.onload&&i.onload(r)):(i.responseType="text",a=e.fixPath(a),e.fetchURL(null,a,i,function(e){r.loadCatalog(t,e,i),i&&i.onload&&i.onload(r)})):e.error("unknown file type for LoadCatalog: "+typeof a)}}),e.mkPublic("CreateMosaic",function(){var t=e.parsePublicArgs(arguments),a=e.lookupDisplay(t.display),i=t.argv[0];if(t=t.argv[1],a)return a.createMosaic(i,t)}),e.mkPublic("DisplayPlugin",function(t){var a,i,s,r;a=e.parsePublicArgs(arguments);var n=e.lookupDisplay(a.display);if(n&&a.argv[0]){for(r=(t=a.argv[0]).toLowerCase(),a=0;a<e.plugins.length;a++)if((s=(i=e.plugins[a]).name)===t||s.toLowerCase().substr(-r.length)===r)return void n.displayPlugin(i);e.error("can't find plugin: "+t)}}),e.mkPublic("DisplayHelp",function(t){var a,i,s,r=e.lightOpts.dhtml.textWin;t&&(i=t.split("/").reverse()[0],a="help_"+e.uniqueID(),(s=e.helpOpts[t])?(t=e.InstallDir(s.type+"/"+s.url),e.lightWin(a,"iframe",t,s.title||i,r)):e.lightWin(a,"iframe",t,i,r))}),e.mkPublic("LightWindow",function(t,a,i,s,r){var n=e.parsePublicArgs(arguments);return t=n.argv[0]||"lightWindow"+e.uniqueID(),a=n.argv[1]||"inline",(i=n.argv[2])||e.error("no content specified for LightWindow"),e.lightWin(t,a,i,s=n.argv[3]||"JS9 light window",r=n.argv[4]||e.lightOpts.dhtml.textWin)}),e.mkPublic("WindowPrint",function(t){var a={cmd:"print"},i=e.parsePublicArgs(arguments);i.argv[0]&&(a.opts=i.argv[0]),window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",a)}catch(t){e.error("could not print window",t)}},e.TIMEOUT):e.error("WindowPrint is only available for the JS9 desktop app")}),e.mkPublic("WindowToPDF",function(t){var a=e.parsePublicArgs(arguments),i={cmd:"pdf"};i.filename=a.argv[0]||"js9.pdf",a.argv[1]&&(i.opts=a.argv[1]),window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",i)}catch(t){e.error("could not create window pdf",t)}},e.TIMEOUT):e.error("WindowToPDF is only available for the JS9 desktop app")}),e.mkPublic("SaveDir",function(t){var a={cmd:"savedir"},i=e.parsePublicArgs(arguments);i.argv[0]?a.opts=i.argv[0]:e.error("SaveDir requires a directory name"),window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",a)}catch(t){e.error("could not set save directory",t)}},e.TIMEOUT):e.error("SaveDir is only available for the JS9 desktop app")}),e}(),$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.readied||(JS9.readied=!0,JS9.Preload(!0))}),$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})}),$(document).on("astroem:ready",function(){if(JS9.initFITS(),window.isElectron&&JS9.hasNode)try{JS9.vmount("/",JS9.localMount)||delete JS9.localMount}catch(e){delete JS9.localMount}JS9.helper.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})}),$(document).on("JS9:helperReady",function(){JS9.fits.ready&&JS9.inited&&!JS9.readied&&$(document).trigger("JS9:ready",{status:"OK"})}),0===$('div[data-js9init="false"]').length&&JS9.init()}),function e(t,a,i){function s(n,o){if(!a[n]){if(!t[n]){var l="function"==typeof require&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=a[n]={exports:{}};t[n][0].call(p.exports,function(e){return s(t[n][1][e]||e)},p,p.exports,e,t,a,i)}return a[n].exports}for(var r="function"==typeof require&&require,n=0;n<i.length;n++)s(i[n]);return s}({1:[function(e,t,a){"use strict";var i,s;i=e("./xhr"),s=e("./remote-service"),e("./image-services"),e("./catalog-services"),JS9.RegisterPlugin("DataSources","ArchivesCatalogs",function(){var e=this.div;e.innerHTML='<form class="JS9Archive-form">\t    <select class="service-menu"></select>\t    <select class="server-menu"></select>\t    <select class="source-menu"></select>\t    <span style="float: right;"><input type=button value="Set RA/Dec" class="get-ra-dec">&nbsp;&nbsp;<input type=button value="Retrieve Data" class="service-go"></span>\t\t    <p>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    <table width="98%">\t\t\t\t\t\t\t\t\t\t    <tr><td> Object: </td> <td> <input type=text name=object size=12> </td>\t\t\t\t<td></td>\t\t\t\t\t\t\t\t\t\t\t<td></td>\t\t\t\t\t\t\t\t\t\t\t<td>&nbsp;&nbsp;</td>\t\t\t\t\t\t\t\t\t\t<td> <input type=checkbox name=gzip> Use Compression</td>\t\t\t\t    </tr>\t\t\t\t\t\t\t\t\t\t\t    <tr><td> RA:  \t</td><td>\t<input type=text name=ra\tsize=12> </td>\t\t\t<td> Dec: \t</td><td>\t<input type=text name=dec\tsize=12> </td>\t\t\t<td></td>\t\t\t\t\t\t\t\t\t\t\t<td> <input type=checkbox name=CORS checked> Use CORS Proxy</td>\t\t\t    <tr><td> Width: </td><td>\t<input type=text name=width\tsize=12 value=15> </td>\t\t\t<td> Height: </td><td>\t<input type=text name=height\tsize=12 value=15> </td>\t\t    </tr>\t\t\t\t\t\t\t\t\t\t\t    </table>\t\t\t\t\t\t\t\t\t\t\t    <div class=controls></div>\t\t\t\t\t\t\t\t\t    <p><span class=status></span>\t\t\t\t\t\t\t\t    </form>';var t=$(e).find(".service-menu"),a=$(e).find(".server-menu"),r=$(e).find(".source-menu");$(t).data("submenu",a),$(a).data("submenu",r);var n=this.display;$(e).find(".service-go").on("mouseup",function(){!function(e,t){var a=$(e).find(".JS9Archive-form")[0];if(""!==a.ra.value&&""!==a.dec.value){var i=parseFloat(a.width.value),r=parseFloat(a.height.value);"-"!==a.dec.value[0]&&"+"!==a.dec.value[0]&&(a.dec.value="+"+a.dec.value),i>60&&(a.width.value="60",i=60),r>60&&(a.height.value="60",r=60);var n=$(a).find(".server-menu")[0],o=$(a).find(".source-menu")[0],l=o.options[o.selectedIndex].value,c=o.options[o.selectedIndex].innerHTML;s.Services[n.options[n.selectedIndex].value].retrieve({name:a.object.value,e:"J2000",h:r.toString(),w:i.toString(),r:a.ra.value,d:a.dec.value,c:a.gzip.checked,s:l,source:c,CORS:a.CORS.checked,display:t},function(t){$(e).find(".status").html(t)})}}(e,n)}),$(e).find(".get-ra-dec").on("mouseup",function(){!function(e,t){function a(t){$(e).find(".status").html(t)}var s=$(e).find(".JS9Archive-form")[0];if(""!==s.object.value){var r=encodeURI((JS9.globalOpts.simbadProxy||"https://js9.si.edu/cgi-bin/simbad-proxy.cgi")+"?"+s.object.value);i({url:r,title:"Name",status:a},function(e,t){var i=t.responseText.trim().split(" ");":"!==i[0][1]?(s.ra.value=i[0],s.dec.value=i[1]):a("<span style='color: red;'>Object not found?</span>")})}else{var n=JS9.GetImage({display:t}),o=JS9.pix2wcs(n.raw.wcs,n.raw.header.NAXIS1/2,n.raw.header.NAXIS2/2).split(/ +/),l=JS9.PixToWCS(n.raw.header.NAXIS1/2+1,n.raw.header.NAXIS2/2+1,{display:n});s.ra.value=o[0]||"",s.dec.value=o[1]||"";var c=JS9.PixToWCS(1,n.raw.header.NAXIS2/2+1,{display:n}),p=JS9.PixToWCS(n.raw.header.NAXIS1+1,n.raw.header.NAXIS2/2+1,{display:n});s.width.value=Math.floor(Math.abs(60*(c.ra-p.ra))*Math.cos(l.dec/57.2958)*10)/10,c=JS9.PixToWCS(n.raw.header.NAXIS1/2+1,1,{display:n}),p=JS9.PixToWCS(n.raw.header.NAXIS1/2+1,n.raw.header.NAXIS2+1,{display:n}),s.height.value=Math.floor(10*Math.abs(60*(c.dec-p.dec)))/10}}(e,n)});var o=[];$.each(s.Services,function(e,t){"image-service"===t.type&&o.push({text:t.params.text,value:t.params.value,subdata:t.params.surveys})});var l=[];$.each(s.Services,function(e,t){"catalog-service"===t.type&&l.push({text:t.params.text,value:t.params.value,subdata:t.params.surveys})}),$(t).data("menu",[{text:"Image Servers",value:"imgserv",subdata:o},{text:"Catalog Servers",value:"catserv",subdata:l}]),function e(t){var a=t[0],i=$(t).data("menu"),s=$(t).data("submenu");a.options.length=0,$.each(i,function(e,t){a.options[a.options.length]=new Option(t.text,t.value)}),void 0!==s&&($(s).data("menu",i[a.selectedIndex].subdata),e(s),t.change(function(){$(s).data("menu",i[a.selectedIndex].subdata),e(s)}))}(t)},{menu:"view",menuItem:"Archives & Catalogs",winTitle:"Archives & Catalogs",winDims:[625,175],help:"archive/archive.html"})},{"./catalog-services":3,"./image-services":5,"./remote-service":6,"./xhr":10}],2:[function(e,t,a){"use strict";var i=e("./remote-service"),s=(e("./starbase"),e("./strtod"),e("./template")),r=e("./xhr");t.exports=function(e){i.Register(e.value,this),this.type="catalog-service",this.params=e,this.table2cat=function(e,t){var a,i,s,r=this.params.shape,n=t[this.params.xcol],o=t[this.params.ycol],l=function(e,t,a){var i=JS9.WCSToPix(t,a,{display:e});return i?{x:i.x,y:i.y}:null};switch(r){case"box":s=function(e){return{width:7,height:7}};break;case"circle":s=function(e){return{radius:3.5}};break;case"ellipse":s=function(e){return{width:7,height:7}}}var c,p,d,h=[];for(a=0,i=0;a<t.data.length;a++)(c=l(e,15*t.data[a][n],t.data[a][o]))&&(p=s(e,t.data[a][1],t.data[a][1]),d={id:a.toString(),shape:r,x:c.x,y:c.y,width:p.width,height:p.height,radius:p.radius,angle:0,data:{ra:15*t.data[a][n],dec:t.data[a][o]}},h[i++]=d);return h},this.retrieve=function(e,t){this.params.calc(e),e.units=this.params.units;var a=s(this.params.url,e),i=r({url:a,title:"Catalog",status:t,CORS:e.CORS},function(t){var a,s,r;s=JS9.GetImage({display:e.display}),a=i.responseText,(r={}).units=e.units,JS9.LoadCatalog(e.name,a,r,{display:s})})}}},{"./remote-service":6,"./starbase":7,"./strtod":8,"./template":9,"./xhr":10}],3:[function(e,t,a){"use strict";e("./strtod");var i=e("./catalog-service");new i({text:"SAO",value:"saoCat",surveys:[{value:"tmc",text:"Two Mass Catalog"},{value:"gsc2",text:"Guide Star Catalog 2"}],url:"http://www.cfa.harvard.edu/catalog/scat?catalog={s}&ra={r}&dec={d}&width={w}&height={h}&system={e}&compress={c}",calc:function(e){e.c&&(e.c="gzip"),e.w=60*e.w,e.h=60*e.h,e.name=e.source+"@"+this.text},shape:"circle",xcol:"ra",ycol:"dec"}),new i({text:"VizieR",value:"vizCat",surveys:[{value:"II/246",text:"2MASS"},{value:"2MASX",text:"2MASS Extended Source"},{value:"B/DENIS",text:"DENIS 3rd Release 2005"},{value:"GLIMPSE",text:"Spitzer's GLIMPSE"},{value:"GSC2.3",text:"GSC-II Catalog, Version 2.3.2"},{value:"HIP2",text:"Hipparcos (2007)"},{value:"IRAS",text:"IRAS "},{value:"NVSS",text:"NRAO VLA Sky Survey"},{value:"SDSS-DR9",text:"SDSS Photometric Catalog"},{value:"Tycho-2",text:"Tycho-2"},{value:"UCAC4",text:"UCAC 4th Release"},{value:"USNO-A2",text:"USNO-A2"},{value:"USNO-B1",text:"USNO-B1"},{value:"WISE",text:"WISE"}],url:"http://vizier.u-strasbg.fr/viz-bin/asu-tsv?-source={s}&-out.add=_RAJ,_DEJ&-c={r}{d}&-c.bm={w}x{h}&-oc.form=s&-out.meta=h",calc:function(e){e.c&&(e.c="gzip"),e.name=e.source+"@"+this.text},shape:"box",xcol:"_RAJ2000",ycol:"_DEJ2000"})},{"./catalog-service":2,"./strtod":8}],4:[function(e,t,a){"use strict";var i=e("./remote-service"),s=e("./template"),r=e("./xhr");t.exports=function(e){i.Register(e.value,this),this.type="image-service",this.params=e,this.retrieve=function(t,a){var i=t.display;e.calc(t);var n=s(e.url,t);r({url:n,title:"Image",status:a,type:"blob",CORS:t.CORS},function(a,s){if(void 0===e.handler){var r=new Blob([s.response]);r.name=t.name,JS9.fits.handleFITSFile(r,{display:i})}else e.handler(a,s,e,t)})}}},{"./remote-service":6,"./template":9,"./xhr":10}],5:[function(e,t,a){"use strict";var i=e("./image-service"),s=function(e){return(""!==e.name?e.source+"_"+e.name:e.source+"_"+e.r+e.d).replace(/\s+/g,"_")+".fits"};new i({text:"DSS1@SAO",value:"saoDSS",surveys:[{value:"DSS1",text:"DSS1"}],url:"http://www.cfa.harvard.edu/archive/dss?r={r}&d={d}&w={w}&h={h}&e={e}&c={c}",calc:function(e){e.c&&(e.c="gzip"),e.name=s(e)}}),new i({text:"DSS@STScI",value:"stsDSS",surveys:[{value:"poss2ukstu_ir",text:"STScI DSS2 IR"},{value:"poss2ukstu_red",text:"STScI DSS2 Red"},{value:"poss2ukstu_blue",text:"STScI DSS2 Blue"},{value:"poss1_red",text:"STScI DSS1 Red"},{value:"poss1_blue",text:"STScI DSS1 Blue"}],url:"http://stdatu.stsci.edu/cgi-bin/dss_search?r={r}&d={d}&w={w}&h={h}&e={e}&c={c}&v={s}&f=fits",calc:function(e){e.c=e.c?"gz":"none",e.name=s(e)}}),new i({text:"DSS@ESO",value:"esoDSS",surveys:[{value:"DSS2-infrared",text:"ESO DSS2 IR"},{value:"DSS2-red",text:"ESO DSS2 Red"},{value:"DSS2-blue",text:"ESO DSS2 Blue"},{value:"DSS1",text:"ESO DSS1"}],url:"http://archive.eso.org/dss/dss?ra={r}&dec={d}&equinox=J2000&x={w}&y={h}&mime-type={c}&Sky-Survey={s}",calc:function(e){e.c=e.c?"display/gz-fits":"application/x-fits",e.name=s(e)}}),new i({text:"2Mass@IPAC",value:"ipac2m",surveys:[{value:"j",text:"IPAC 2Mass J"},{value:"h",text:"IPAC 2Mass H"},{value:"k",text:"IPAC 2Mass K"}],url:"http://irsa.ipac.caltech.edu/cgi-bin/Oasis/2MASSImg/nph-2massimg?objstr={r},{d}&size={radius}&band={s}",calc:function(e){e.radius=Math.floor(60*Math.sqrt(e.w*e.w+e.h*e.h)),e.name=s(e)}})},{"./image-service":4}],6:[function(e,t,a){"use strict";a.Services={},a.Register=function(e,t){a.Services[e]=t}},{}],7:[function(e,t,a){"use strict";function i(e){return e}function s(e){var t;for(t=0;t<e.length;t++)if(null===e[t].match(/^-+$/))return 0;return t}t.exports=function(e,t){var a,r,n;t=t||{},this.head={},this.type=[],this.data=[],e=e.replace(/\s+$/,"").split("\n");var o=0;if(t.skip)for(n=t.skip.split("");o<e.length&&(n[0]===e[o][0]||"\n"===n[1]&&""===e[o]);o++);if(void 0!==e[o]&&void 0!==e[o+1]){this.headline=e[o++].trim().split(/ *\t */),t.units&&(this.unitline=e[o++].trim().split(/ *\t */)),this.dashline=e[o++].trim().split(/ *\t */);for(var l=s(this.dashline);0===l||l!==this.headline.length;)t.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=e[o++].trim().split(/ *\t */),l=s(this.dashline);for(a=0;a<this.headline.length;a++)this.type[a]=t.type&&t.type[this.headline[a]]?t.type[this.headline[a]]:t.type&&t.type.default?t.type.default:i;for(r=0;o<e.length&&n[0]!==e[o][0]&&("\n"!==n[1]||""!==e[o]);o++,r++)for(this.data[r]=e[o].split("\t"),a=0;a<this.data[r].length;a++)this.data[r][a]=this.type[a](this.data[r][a]);for(a=0;a<this.headline.length;a++)this[this.headline[a]]=a}}},{}],8:[function(e,t,a){"use strict";t.exports=function(e){var t,a=e.trim().split(/[: ]/);if(3===a.length){var i=1;"-"===a[0].substr(0,1)&&(i=-1);var s=parseFloat(a[0]),r=parseFloat(a[1]),n=parseFloat(a[2]);t=i*(Math.abs(s)+r/60+n/3600)}else t=parseFloat(e);return isNaN(t)?e:t}},{}],9:[function(e,t,a){"use strict";function i(e,t){var a,i="";for(a=0;a<t;a++)i+=e;return i}t.exports=function(e,t){return e.replace(/\{([a-zA-Z0-9_.%]*)\}/g,function(e,a){var s,r,n,o,l,c=t;for(o=(a=a.split("%")).length<=1?"%s":a[1],a=(a=a[0]).split("."),l=0;l<a.length;l++){if(!c.hasOwnProperty(a[l]))return"";c=c[a[l]]}switch(s=o.substring(o.length-1),n=0|(r=(r=o.substring(0,o.length-1)).split("."))[0],r=0|r[1],s){case"s":c=c.toString();break;case"f":c=c.toFixed(r);break;case"d":c=c.toFixed(0)}return 0!==n&&n>c.length&&(n>0?c=i(" ",n-c.length)+c:c+=i(" ",n-c.length)),c})}},{}],10:[function(e,t,a){"use strict";t.exports=function(e,t){var a=e.status,i="",s=JS9.globalOpts.corsProxy||"https://js9.si.edu/cgi-bin/CORS-proxy.cgi";e.CORS&&(e.url=e.url.replace(/\?/g,"@"),e.url=e.url.replace(/&/g,"!"),e.url=encodeURI(e.url),e.url=s+"?Q="+e.url),JS9.DEBUG>1&&console.log("archive/catalog url: %s",e.url);var r=new XMLHttpRequest;return r.open("GET",e.url,!0),e.title&&(i=e.title),e.type&&(r.responseType=e.type),void 0!==a&&(r.addEventListener("progress",function(e){a(i+" progress "+e.loaded.toString())}),r.addEventListener("error",function(e){a(i+" service error")}),r.addEventListener("abort",function(e){a(i+" service aborted")})),r.onload=function(e){4===this.readyState&&(200!==this.status&&0!==this.status||(void 0!==a&&a(""),t(e,this)))},r.send(),r}},{}]},{},[1]),function(){function e(e,t){var a,i,s,r=JS9.GetImage({display:t}),n=$(e).find(".binning-form")[0];if(r&&r.raw)switch(a=r.raw.hdu,JS9.fitsLibrary()){case"fitsy":"image"===a.imtab?JS9.error("image binning not implemented"):(i=$.extend(!0,{},JS9.fits.opts,{table:{xcen:n.xcen.value,ycen:n.ycen.value,xdim:n.xdim.value,ydim:n.ydim.value,bin:n.bin.value,filter:n.filter.value}}),Fitsy.readTableHDUData(a.fits,a,i,function(e){!function(e,t,a){var i,s=/(\[.*[a-zA-Z0-9_].*\])\[.*\]/,r={display:a};n.separate.checked?(n.filter.value&&(i="["+n.filter.value.replace(/\s+/g,"")+"]",r.id=e.id.replace(s,"$1")+i,r.file=e.fitsFile?e.fitsFile.replace(s,"$1")+i:r.id),JS9.checkNew(new JS9.Image(t,r))):JS9.RefreshImage(t,r)}(r,e,t)}));break;case"cfitsio":i={xcen:0,ycen:0,xdim:0,ydim:0,bin:1,filter:""},JS9.isNumber(n.xcen.value)&&(i.xcen=parseFloat(n.xcen.value)),JS9.isNumber(n.ycen.value)&&(i.ycen=parseFloat(n.ycen.value)),(s=r.maybePhysicalToImage({x:i.xcen,y:i.ycen}))&&(i.xcen=s.x,i.ycen=s.y),JS9.isNumber(n.xdim.value)&&(i.xdim=Math.floor(parseFloat(n.xdim.value))),JS9.isNumber(n.ydim.value)&&(i.ydim=Math.floor(parseFloat(n.ydim.value))),i.bin=!n.bin.value.match(/^[+-]/)&&JS9.isNumber(n.bin.value)?Math.floor(parseFloat(n.bin.value)):n.bin.value,i.filter=n.filter.value,i.separate=$(n.separate).prop("checked"),r.displaySection(i)}}function t(){var t=this,a=this.div,i=this.display,s=this.winHandle,r="",n=JS9.GetImage({display:this.display});!n||n&&!n.raw.hdu?a.innerHTML='<p style="padding: 5px"><center>FITS image sections, with binning and filtering</center>':(s||(r='disabled="disabled"'),$(a).html('<form class="binning-form js9Form" style="margin: 0px; padding: 8px; width: 100%; height: 100%">\t\t    <table style="margin:0px; cellspacing:0; border-collapse:separate; border-spacing:4px 10px;">       \t           <tr>\t<td><input type=button class=full-image value="Load full image" style="text-align:right;"></td>\t\t\t\t<td>&nbsp;</td>    \t\t\t\t\t\t\t\t\t\t\t<td>&nbsp;</td>\t\t\t\t\t\t\t\t    \t\t\t\t<td>&nbsp;</td> \t\t\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t        \t           <tr>\t<td><b>center:</b></td>\t\t\t\t\t\t\t\t\t\t\t<td><input type=text name=xcen size=10 style="text-align:right;"></td>\t\t\t\t\t<td><input type=text name=ycen size=10 style="text-align:right;"></td>    \t\t\t\t<td>&nbsp(center position of section)</td>\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t           <tr>\t<td><b>size:</b></td>\t\t\t\t\t\t\t\t\t\t\t<td><input type=text name=xdim size=10 style="text-align:right;"></td>\t\t\t\t\t<td><input type=text name=ydim size=10 style="text-align:right;"></td>\t\t\t\t\t<td>&nbsp(width, height of section)</td>\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t                   <tr>\t<td><b>bin:</b></td>\t\t\t\t\t\t\t\t\t\t<td><input type=text name=bin value=1 size=10 style="text-align:right;"></td>\t\t\t\t<td></td>\t\t\t\t\t\t\t\t\t\t\t\t<td>&nbsp(apply bin factor to section)</td>\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t           <tr>\t<td><b>filter:</b></td>\t\t\t\t\t\t\t\t\t\t\t<td colspan="2"><textarea name=filter rows="1" cols="22" style="text-align:left;" autocapitalize="off" autocorrect="off"></textarea></td>\t\t\t\t<td>&nbsp(event/row filter for tables)</td>\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t           <tr>\t<td><b>separate:</b></td>\t\t\t                        <td><input type=checkbox name=separate class="sep-image" style="text-align:left;"></td>\t\t\t\t<td></td>\t\t\t\t\t\t\t\t\t\t\t\t<td>&nbsp(display as separate image?)</td>\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t\t   <tr>\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td><input type=button name=rebin value="Run" class="rebin-image"></td>         \t\t\t<td>&nbsp;</td>\t\t\t\t\t\t\t\t\t\t\t\t<td>&nbsp;</td>\t\t\t\t\t\t\t\t\t                        <td>&nbsp;<input type=button name=close value="Close" class="close-image" '+r+"></td> \t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t    </table>\t\t\t\t\t\t\t\t\t\t\t\t    </form>"),$(a).find(".full-image").on("mouseup",function(){!function(t,a,i,s){var r=JS9.GetImage({display:s}),n=$(i).find(".binning-form")[0],o=r.fileDimensions();n.xcen.value=0,n.ycen.value=0,n.xdim.value=o.xdim,n.ydim.value=o.ydim,e(i,s)}(0,0,a,i)}),$(a).find(".rebin-image").on("mouseup",function(){e(a,i)}),$(a).find(".close-image").on("mouseup",function(){s&&s.close()}),$(a).find(".sep-image").change(function(){t.sep=$(this).prop("checked")}),$(a).find(".sep-image").prop("checked",!!t.sep),n&&function(e,t){var a,i,s,r,n,o,l;void 0===t&&(e=this.div,t=this.display),(a=JS9.GetImage({display:t}))&&(s=$(e).find(".binning-form")[0],void 0!==a.raw.hdu?((r=a.raw.hdu).bin=r.bin||1,s.rebin.disabled=!1,void 0!==r.table?(s.bin.value=String(Math.floor(r.table.bin)),s.xcen.value=String(Math.floor(r.table.xcen)),s.ycen.value=String(Math.floor(r.table.ycen)),s.xdim.value=String(Math.floor(r.table.xdim)),s.ydim.value=String(Math.floor(r.table.ydim)),s.filter.value=r.table.filter||"",s.bin.disabled=!1,s.xcen.disabled=!1,s.ycen.disabled=!1,s.xdim.disabled=!1,s.ydim.disabled=!1,s.filter.disabled=!1):(a.parentFile&&a.raw.header&&void 0!==a.raw.header.LTM1_1?(o=1,l=a.raw.header.LTM1_1):(o=r.bin||1,l=1),n=Math.floor(o/l+.5),i=a.imageToLogicalPos({x:a.raw.width/2,y:a.raw.height/2}),s.xcen.value=String(Math.floor(i.x+.5*(n-1))),s.ycen.value=String(Math.floor(i.y+.5*(n-1))),s.bin.value=String(n),s.xdim.value=String(Math.floor(r.naxis1*n)),s.ydim.value=String(Math.floor(r.naxis2*n)),s.filter.value=a.raw.filter||"",s.bin.disabled=!1,s.xcen.disabled=!1,s.ycen.disabled=!1,s.xdim.disabled=!1,s.ydim.disabled=!1,s.filter.disabled=!1)):s.rebin.disabled=!0)}(a,i))}JS9.RegisterPlugin("FITS","Binning",t,{menu:"view",winTitle:"Image Sections, with Binning and Filtering",winResize:!0,menuItem:"Bin/Filter/Section",onplugindisplay:t,onimageload:t,onimagedisplay:t,help:"fitsy/binning.html",winDims:[520,250]})}(),JS9.Blend={},JS9.Blend.CLASS="JS9",JS9.Blend.NAME="Blend",JS9.Blend.WIDTH=550,JS9.Blend.HEIGHT=270,JS9.Blend.BASE=JS9.Blend.CLASS+JS9.Blend.NAME,JS9.Blend.blendModeHTML='When <b>Image Blending</b> is turned on, the images you select below will be combined using your chosen blend mode and optional opacity. See <a href="https://www.w3.org/TR/compositing-1/" target="blank">W3C Compositing and Blending</a> for info about compositing and blending.<p> <input type="checkbox" class="blendModeCheck" id="active" name="imageBlending" value="active" onclick="javascript:JS9.Blend.xblendmode(\'%s\', this)"><b>Image Blending</b>',JS9.Blend.imageHTML="<span style='float: left'>$active &nbsp;&nbsp; $blend &nbsp;&nbsp; $opacity</span>&nbsp;&nbsp; <span id='blendFile'>$imfile</span>",JS9.Blend.activeHTML='<input class="blendActiveCheck" type="checkbox" id="active" name="active" value="active" onclick="javascript:JS9.Blend.xactive(\'%s\', \'%s\', this)">blend using:',JS9.Blend.blendHTML='<select class="blendModeSelect" onchange="JS9.Blend.xblend(\'%s\', \'%s\', this)"><option selected disabled>blend mode</option><option value="normal">normal</option><option value="screen">screen</option><option value="multiply">multiply</option><option value="overlay">overlay</option><option value="darken">darken</option><option value="lighten">lighten</option><option value="color-dodge">color-dodge</option><option value="color-burn">color-burn</option><option value="hard-light">hard-light</option><option value="soft-light">soft-light</option><option value="difference">difference</option><option value="exclusion">exclusion</option><option value="hue">hue</option><option value="saturation">saturation</option><option value="color">color</option> <option value="luminosity">luminosity</option></select>',JS9.Blend.opacityHTML='<select class="blendOpacitySelect" onchange="JS9.Blend.xopacity(\'%s\', \'%s\', this)"><option selected disabled>opacity</option><option value="1.00">opaque</option><option value="0.95">0.95</option><option value="0.90">0.90</option><option value="0.85">0.85</option><option value="0.80">0.80</option><option value="0.75">0.75</option><option value="0.70">0.70</option><option value="0.65">0.65</option><option value="0.60">0.60</option><option value="0.55">0.55</option><option value="0.50">0.50</option><option value="0.45">0.45</option><option value="0.40">0.40</option><option value="0.35">0.35</option><option value="0.30">0.30</option><option value="0.25">0.25</option><option value="0.20">0.20</option><option value="0.10">0.10</option><option value="0.00">transparent</option></select>',JS9.Blend.imfileHTML="<b>%s</b>",JS9.Blend.nofileHTML='<p><span id="blendNoFile">[Images will appear here as they are loaded]</span>',JS9.Blend.xactive=function(e,t,a){var i=JS9.lookupImage(t,e),s=a.checked;i&&i.blendImage().active!==s&&i.blendImage(s)},JS9.Blend.xblend=function(e,t,a){var i,s=JS9.lookupImage(t,e);a.selectedIndex>=0&&(i=a.options[a.selectedIndex].value),s&&JS9.notNull(i)&&s.blendImage().mode!==i&&s.blendImage(i)},JS9.Blend.xopacity=function(e,t,a){var i,s,r=JS9.lookupImage(t,e);a.selectedIndex>=0&&(s=a.options[a.selectedIndex].value),r&&JS9.notNull(s)&&(i=r.blendImage(),s=parseFloat(s),i.opacity!==s&&r.blendImage(null,s))},JS9.Blend.xblendmode=function(e,t){var a=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e));a&&JS9.BlendDisplay(t.checked,{display:a})},JS9.Blend.imid=function(e){return(e.display.id+"_"+e.id).replace(/[^A-Za-z0-9_]/g,"_")+"BlendImage"},JS9.Blend.dispclass=function(e){return(JS9.Blend.BASE+"_"+e.display.id).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Blend.displayBlend=function(e){var t;e&&(t=e.display,this.divjq.find(".blendModeCheck").prop("checked",t.blendMode))},JS9.Blend.imageBlend=function(e,t){var a,i,s,r,n;i=e.blendImage(),s=JS9.Blend.imid(e),i&&((r=this.divjq.find("#"+s)).find(".blendActiveCheck").prop("checked",i.active),void 0!==i.mode&&(n=r.find(".blendModeSelect").val(i.mode),t&&n.change()),void 0!==i.opacity&&(a="number"==typeof i.opacity?i.opacity.toFixed(2):i.opacity,n=r.find(".blendOpacitySelect").val(a),t&&n.change()))},JS9.Blend.activeImage=function(e){var t,a;e&&(t=JS9.Blend.imid(e),a=JS9.Blend.dispclass(e)+"_Image",$("."+a).removeClass(JS9.Blend.BASE+"ImageActive").addClass(JS9.Blend.BASE+"ImageInactive"),$("#"+t).removeClass(JS9.Blend.BASE+"ImageInactive").addClass(JS9.Blend.BASE+"ImageActive"))},JS9.Blend.addImage=function(e){var t,a,i,s,r,n=[],o=JS9.Blend.BASE+"Image";e&&(r=e.id,s=e.display.id,a=JS9.Blend.imid(e),i=JS9.Blend.dispclass(e)+"_Image",n.push({name:"imid",value:r}),n.push({name:"active",value:sprintf(JS9.Blend.activeHTML,s,r)}),n.push({name:"opacity",value:sprintf(JS9.Blend.opacityHTML,s,r)}),n.push({name:"blend",value:sprintf(JS9.Blend.blendHTML,s,r)}),n.push({name:"imfile",value:sprintf(JS9.Blend.imfileHTML,r)}),this.blendDivs||this.blendImageContainer.html(""),t=JS9.Image.prototype.expandMacro.call(e,JS9.Blend.imageHTML,n),$("<div>").addClass(o).addClass(i).attr("id",a).prop("imid",r).html(t).appendTo(this.blendImageContainer).on("mousedown touchstart",function(){e.displayImage(),JS9.Blend.activeImage.call(this,e)}),JS9.Blend.imageBlend.call(this,e,!1),JS9.Blend.displayBlend.call(this,e),this.blendDivs++,JS9.Blend.activeImage(e))},JS9.Blend.removeImage=function(e){var t;return!!e&&(t=JS9.Blend.imid(e),$("#"+t).remove(),this.blendDivs--,0===this.blendDivs&&this.blendImageContainer.html(JS9.Blend.nofileHTML),!0)},JS9.Blend.init=function(e,t){var a,i,s,r,n=this;for("div"===this.winType&&(this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Blend.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.Blend.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10)),this.divjq.html(""),this.blendDivs=0,this.divjq.addClass("JS9PluginScrolling"),this.blendContainer=$("<div>").addClass(JS9.Blend.BASE+"Container").attr("id",this.id+"BlendContainer").appendTo(this.divjq),this.blendHeader=$("<div>").addClass(JS9.Blend.BASE+"Header").attr("id",this.display.id+"Header").html(sprintf(JS9.Blend.blendModeHTML,this.display.id)).appendTo(this.blendContainer),this.blendImageContainer=$("<div>").addClass(JS9.Blend.BASE+"ImageContainer").attr("id",this.id+"BlendImageContainer").html(JS9.Blend.nofileHTML).appendTo(this.blendContainer),s=(r=JS9.getDynamicDisplayOr(this.display)).blendMode,r.blendMode=!1,a=0;a<JS9.images.length;a++)(i=JS9.images[a]).display===r&&JS9.Blend.addImage.call(this,i);r.blendMode=s,r.image&&r.image.displayImage(),this.divjq.find(".blendModeCheck").prop("checked",!!r.blendMode),this.blendImageContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index();JS9.images.splice(a,0,JS9.images.splice(this.oidx,1)[0]),n.display.image&&n.display.image.displayImage()}})},JS9.Blend.dysel=function(){var e,t=JS9.getDynamicDisplayOr("previous");t&&(e=t.blendMode,t.blendMode=!1,t.image&&t.image.displayImage()),JS9.Blend.init.call(this),t&&(t.blendMode=e)},JS9.Blend.displayblend=function(e){e&&JS9.Blend.displayBlend.call(this,e)},JS9.Blend.imageblend=function(e){e&&JS9.Blend.imageBlend.call(this,e,!1)},JS9.Blend.imageload=function(e){var t=JS9.getDynamicDisplayOr(this.display);e&&e.display===t&&JS9.Blend.addImage.call(this,e)},JS9.Blend.imagedisplay=function(e){JS9.Blend.activeImage.call(this,e)},JS9.Blend.imageclose=function(e){JS9.Blend.removeImage.call(this,e)},JS9.Blend.sessionload=function(e){e&&JS9.Blend.init.call(this)},JS9.RegisterPlugin(JS9.Blend.CLASS,JS9.Blend.NAME,JS9.Blend.init,{menuItem:"Blending",dynamicSelect:!0,onplugindisplay:JS9.Blend.init,ondynamicselect:JS9.Blend.dysel,ondisplayblend:JS9.Blend.displayblend,onimageblend:JS9.Blend.imageblend,onimageload:JS9.Blend.imageload,onimagedisplay:JS9.Blend.imagedisplay,onimageclose:JS9.Blend.imageclose,onsessionload:JS9.Blend.sessionload,help:"help/blend.html",winTitle:"Image Blending",winResize:!0,winDims:[JS9.Blend.WIDTH,JS9.Blend.HEIGHT]}),JS9.Blink={},JS9.Blink.CLASS="JS9",JS9.Blink.NAME="Blink",JS9.Blink.WIDTH=512,JS9.Blink.HEIGHT=270,JS9.Blink.BASE=JS9.Blink.CLASS+JS9.Blink.NAME,JS9.Blink.rate=1e3,JS9.Blink.blinkModeHTML="When <b>Blink Images</b> is turned on, selected images will be displayed at the specified blink rate. You also can blink the selected images manually. The blink sequence can be changed by moving images around in the stack. <p>$mode&nbsp;&nbsp;&nbsp;&nbsp;$rate&nbsp;&nbsp;&nbsp;&nbsp;$manual",JS9.Blink.modeHTML='<input type="checkbox" id="active" name="blinkImages" value="active" onclick="javascript:JS9.Blink.xblinkmode(\'%s\', this)"><b>Blink Images</b>',JS9.Blink.rateHTML='<select id="blinkRateSelect" onfocus="this.selectedIndex=0;" onchange="JS9.Blink.xrate(\'%s\',this)"><option selected disabled>blink rate</option><option value="0.1">0.1</option><option value="0.25">0.25</option><option value="0.5">0.5</option><option value="1.0">1.0</option><option value="2.0">2.0</option><option value="3.0">3.0</option><option value="4.0">4.0</option><option value="5.0">5.0</option><option value="6.0">6.0</option><option value="7.0">7.0</option><option value="8.0">8.0</option><option value="9.0">9.0</option><option value="10.0">10.0</option><option value="15.0">15.0</option><option value="20.0">20.0</option><option value="30.0">30.0</option></select>',JS9.Blink.manualHTML='<input type="button" id="manual" name="manualBlink" value="blink manually" onclick="javascript:JS9.Blink.xblink1(\'%s\', this)">',JS9.Blink.imageHTML="<span style='float: left'>$active&nbsp;&nbsp;</span><span id='blinkFile'>$imfile</span>",JS9.Blink.activeHTML='<input class="blinkActiveCheck" type="checkbox" id="active" name="active" value="active" onclick="javascript:JS9.Blink.xactive(\'%s\', \'%s\', this)">blink',JS9.Blink.imfileHTML="<b>%s</b>",JS9.Blink.nofileHTML='<p><span id="blinkNoFile">[Images will appear here as they are loaded]</span>',JS9.Blink.start=function(e){var t,a=!1,i=e.pluginInstances.JS9Blink,s=i.idx;if(i){for(;!a;)(t=JS9.images[i.idx]).display===e&&t.tmp.blinkMode&&(t.displayImage("display"),a=!0),++i.idx>=JS9.images.length&&(i.idx=0),i.idx===s&&(a=!0);e.blinkMode&&(e.pluginInstances.JS9Blink.tid=window.setTimeout(function(){JS9.Blink.start(e)},i.rate))}},JS9.Blink.stop=function(e){var t=e.pluginInstances.JS9Blink;t&&(t.tid&&(window.clearTimeout(t.tid),delete t.tid),e.blinkMode=!1,t.idx=0)},JS9.Blink.xactive=function(e,t,a){var i=JS9.lookupImage(t,e);i&&(i.tmp.blinkMode=a.checked)},JS9.Blink.xblinkmode=function(e,t){var a=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e)),i=t.checked;a&&($(".blinkActive").prop("disabled",!i),i?(a.blinkMode=!0,JS9.Blink.start(a)):JS9.Blink.stop(a))},JS9.Blink.xblink1=function(e,t){var a=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e)),i=a?a.pluginInstances.JS9Blink:null;i&&a&&(JS9.images[i.idx]===a.image&&++i.idx>=JS9.images.length&&(i.idx=0),JS9.Blink.start(a))},JS9.Blink.xrate=function(e,t){var a=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e)),i=a?a.pluginInstances.JS9Blink:null,s=Math.floor(1e3*t.options[t.selectedIndex].value);i&&a&&(isNaN(s)||(i.rate=s))},JS9.Blink.imid=function(e){return(e.display.id+"_"+e.id).replace(/[^A-Za-z0-9_]/g,"_")+"BlinkImage"},JS9.Blink.dispclass=function(e){return(JS9.Blink.BASE+"_"+e.display.id).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Blink.activeImage=function(e){var t,a;e&&(t=JS9.Blink.imid(e),a=JS9.Blink.dispclass(e)+"_Image",$("."+a).removeClass(JS9.Blink.BASE+"ImageActive").addClass(JS9.Blink.BASE+"ImageInactive"),$("#"+t).removeClass(JS9.Blink.BASE+"ImageInactive").addClass(JS9.Blink.BASE+"ImageActive"))},JS9.Blink.addImage=function(e){var t,a,i,s,r,n=[],o=JS9.Blink.BASE+"Image";e&&(r=e.id,s=e.display.id,a=JS9.Blink.imid(e),i=JS9.Blink.dispclass(e)+"_Image",n.push({name:"imid",value:e.id}),n.push({name:"active",value:sprintf(JS9.Blink.activeHTML,s,r)}),n.push({name:"imfile",value:sprintf(JS9.Blink.imfileHTML,r)}),this.blinkDivs||this.blinkImageContainer.html(""),t=JS9.Image.prototype.expandMacro.call(e,JS9.Blink.imageHTML,n),$("<div>").addClass(o).addClass(i).attr("id",a).prop("imid",r).html(t).appendTo(this.blinkImageContainer).on("mousedown touchstart",function(){e.displayImage(),JS9.Blink.activeImage.call(this,e)}),this.blinkDivs++,e.tmp.blinkMode=!1,JS9.Blink.activeImage(e))},JS9.Blink.removeImage=function(e){var t;return!!e&&(t=JS9.Blink.imid(e),$("#"+t).remove(),this.blinkDivs--,0===this.blinkDivs&&this.blinkImageContainer.html(JS9.Blink.nofileHTML),delete e.tmp.blinkMode,!0)},JS9.Blink.init=function(){var e,t,a,i,s,r=[],n=this;for(void 0===this.idx&&(this.idx=0),void 0===this.rate&&(this.rate=JS9.Blink.rate),this.divjq.html(""),this.blinkDivs=0,this.divjq.addClass("JS9PluginScrolling"),this.blinkContainer=$("<div>").addClass(JS9.Blink.BASE+"Container").attr("id",this.id+"BlinkContainer").css("overflow","auto").appendTo(this.divjq),s=this.display.id,r.push({name:"mode",value:sprintf(JS9.Blink.modeHTML,s)}),r.push({name:"manual",value:sprintf(JS9.Blink.manualHTML,s)}),r.push({name:"rate",value:sprintf(JS9.Blink.rateHTML,s)}),t=JS9.Image.prototype.expandMacro.call(null,JS9.Blink.blinkModeHTML,r),this.blinkHeader=$("<div>").addClass(JS9.Blink.BASE+"Header").attr("id",s+"Header").html(t).appendTo(this.blinkContainer),this.blinkImageContainer=$("<div>").addClass(JS9.Blink.BASE+"ImageContainer").attr("id",this.id+"BlinkImageContainer").html(JS9.Blink.nofileHTML).appendTo(this.blinkContainer),(i=JS9.getDynamicDisplayOr(this.display)).blinkMode=!1,e=0;e<JS9.images.length;e++)(a=JS9.images[e]).display===i&&JS9.Blink.addImage.call(this,a);this.blinkImageContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index();JS9.images.splice(a,0,JS9.images.splice(this.oidx,1)[0]),n.display.image&&n.display.image.displayImage()}})},JS9.Blink.dysel=function(){var e=JS9.getDynamicDisplayOr("previous");e&&JS9.Blink.stop(e),JS9.Blink.init.call(this)},JS9.Blink.imageload=function(e){var t=JS9.getDynamicDisplayOr(this.display);e&&e.display===t&&JS9.Blink.addImage.call(this,e)},JS9.Blink.imagedisplay=function(e){JS9.Blink.activeImage.call(this,e)},JS9.Blink.imageclose=function(e){JS9.Blink.removeImage.call(this,e)},JS9.RegisterPlugin(JS9.Blink.CLASS,JS9.Blink.NAME,JS9.Blink.init,{menuItem:"Blinking",dynamicSelect:!0,onplugindisplay:JS9.Blink.init,ondynamicselect:JS9.Blink.dysel,onimageload:JS9.Blink.imageload,onimagedisplay:JS9.Blink.imagedisplay,onimageclose:JS9.Blink.imageclose,help:"help/blink.html",winTitle:"Image Blinking",winResize:!0,winDims:[JS9.Blink.WIDTH,JS9.Blink.HEIGHT]}),JS9.Cmaps={},JS9.Cmaps.CLASS="JS9",JS9.Cmaps.NAME="Cmaps",JS9.Cmaps.WIDTH=600,JS9.Cmaps.HEIGHT=270,JS9.Cmaps.BASE=JS9.Cmaps.CLASS+JS9.Cmaps.NAME,JS9.Cmaps.DEFMODE="equidistant",JS9.Cmaps.DEFNMAP=3,JS9.Cmaps.DEFASSIGN=!0,JS9.Cmaps.DEFNAME="cmap",JS9.Cmaps.DEFTOL=Math.pow(8,2),JS9.Cmaps.DEFTIMEOUT=0,JS9.Cmaps.COLORCLASS="cmapsColorPicker",JS9.Cmaps.CMAPCLASS="cmapsSelect",JS9.Cmaps.CHECKCLASS="cmapsActiveCheck",JS9.Cmaps.headerHTML='Select a color&nbsp;&nbsp;<input type="color" value="#FF0000" class="'+JS9.Cmaps.COLORCLASS+'">&nbsp;&nbsp;or a &nbsp;&nbsp;<select class="'+JS9.Cmaps.CMAPCLASS+'" onchange="JS9.Cmaps.xCmap(\'%s\',this)"></select>&nbsp;&nbsp;colormap to create&nbsp;&nbsp;<input type="number" onchange="JS9.Cmaps.xNslice(\'%s\',this)" value="'+JS9.Cmaps.DEFNMAP+'" min="1" max="36" size="3" style="width:40px;box-sizing: border-box;">&nbsp;&nbsp;<select class="cmapsMode" onchange="JS9.Cmaps.xMode(\'%s\',this)">&nbsp;&nbsp;<option value="equidistant">equidistant</option><option value="analogous">analogous</option></select><p>slices of the <a href="https://en.wikipedia.org/wiki/Color_wheel" target="_blank">colorwheel</a>,&nbsp;&nbsp;the first&nbsp;&nbsp;<input type="number" onchange="JS9.Cmaps.xNmap(\'%s\',this)" value="'+JS9.Cmaps.DEFNMAP+'" min="1" max="36" size="3" style="width:40px;box-sizing: border-box;">&nbsp;of which will be used to create colormaps.<p><input type="checkbox" onchange="JS9.Cmaps.xAssignCmaps(\'%s\',this)" checked> assign the new colormaps to these images:',JS9.Cmaps.imageHTML="<span style='float: left'>$active</span>&nbsp;&nbsp; <span style='float: right'>$imfile</span>",JS9.Cmaps.activeHTML='<input class="'+JS9.Cmaps.CHECKCLASS+'" type="checkbox" id="active" name="active" value="active" onclick="javascript:JS9.Cmaps.xActive(\'%s\', \'%s\', this)">&nbsp;',JS9.Cmaps.imfileHTML="<b>%s</b>",JS9.Cmaps.nofileHTML='<div class="JS9cmapsNoFile">[Colormap generation options will appear here after an image is loaded]</div>',JS9.Cmaps.equidistant=function(e,t,a){var i,s=tinycolor(e).toHsl(),r=s.h,n=360/a,o=[];for(i=0;i<t;i++)s.h=(r+i*n)%360,o.push(tinycolor(s));return o},JS9.Cmaps.mkColors=function(e,t,a,i){if(t&&a&&i)switch(e=e||"equidistant"){case"analogous":return tinycolor(t).analogous(a,i);case"equidistant":return JS9.Cmaps.equidistant(tinycolor(t),a,i);default:return[tinycolor(t)]}},JS9.Cmaps.assignCmaps=function(e){var t,a,i=0,s="."+JS9.Cmaps.CHECKCLASS;e.cmaps.names&&e.cmaps.names.length&&(a=e.cmaps.that.cmapsImageContainer).length&&(t=e.cmaps.names.length,a.find("."+JS9.Cmaps.BASE+"Image").each(function(a,r){var n=$(r),o=n.prop("imid"),l=JS9.lookupImage(o),c=n.find(s);l&&i<t&&c.prop("checked")&&(l.setColormap(e.cmaps.names[i++]),l.displayImage())}))},JS9.Cmaps.mkCmapsFromCmap=function(e,t,a,i,s){var r,n,o,l,c,p,d,h,g,u=[],m=[],f=[],y="rgb (%s,%s,%s)",b=function(e){return[e.r/255,e.g/255,e.b/255]},S=function(e,t){return JS9.Colormap.prototype.mkColorCell.call(e,t)};if(t&&a&&i)switch(h=(s=s||{}).mode||JS9.Cmaps.DEFMODE,g=t.name,e.cmaps.names=[],t.type){case"lut":for(r=0;r<a;r++)e.cmaps.names[r]=g+"_"+String(r+1),u[r]=[];for(r=0;r<t.colors.length;r++)for(c=sprintf(y,Math.floor(255*t.colors[r][0]+.5),Math.floor(255*t.colors[r][1]+.5),Math.floor(255*t.colors[r][2]+.5)),l=JS9.Cmaps.mkColors(h,c,a,i),n=0;n<a;n++)u[n].push(b(l[n].toRgb()));for(r=0;r<a;r++)(t=JS9.lookupColormap(e.cmaps.names[r],!1))?t.colors=u[r]:JS9.AddColormap(e.cmaps.names[r],u[r],{toplevel:!1});s.assign&&JS9.Cmaps.assignCmaps(e);break;case"sao":for(r=0;r<a;r++)e.cmaps.names[r]=t.name+"_"+String(r+1),m[r]=[[],[],[]];for(r=0;r<3;r++)for(n=0;n<t.vertices[r].length;n++)d=S(t,(p=t.vertices[r][n][0])*JS9.COLORSIZE),f.push({index:p,rgb:d});for(f.sort(function(e,t){return e.index>t.index?1:e.index<t.index?-1:0}),r=f.length-2;r>=0;r--)f[r].index===f[r+1].index&&f.splice(r+1,1);for(r=0;r<f.length;r++)for(c=sprintf(y,f[r].rgb[0],f[r].rgb[1],f[r].rgb[2]),l=JS9.Cmaps.mkColors(h,c,a,i),n=0;n<a;n++)o=b(l[n].toRgb()),m[n][0].push([f[r].index,o[0]]),m[n][1].push([f[r].index,o[1]]),m[n][2].push([f[r].index,o[2]]);for(r=0;r<a;r++)(t=JS9.lookupColormap(e.cmaps.names[r],!1))?t.vertices=m[r]:JS9.AddColormap(e.cmaps.names[r],m[r][0],m[r][1],m[r][2],{toplevel:!1});s.assign&&JS9.Cmaps.assignCmaps(e)}},JS9.Cmaps.mkCmapsFromColor=function(e,t,a,i,s){var r,n,o,l,c;if(t&&a&&i)return l=(s=s||{}).mode||"equidistant",c=e.id||JS9.Cmaps.DEFNAME,o=void 0!==s.rgbtol?s.rgbtol:e.cmaps.tol,r=tinycolor(t),n=r.toRgb(),Math.pow(Math.abs(n.r-e.cmaps.orgb.r),2)+Math.pow(Math.abs(n.g-e.cmaps.orgb.g),2)+Math.pow(Math.abs(n.b-e.cmaps.orgb.b),2)<o?0:e.cmaps.timeOutID?0:void(e.cmaps.timeOutID=window.setTimeout(function(){var t,o,p;for(e.cmaps.names=[],o=JS9.Cmaps.mkColors(l,r,a,i),e.cmaps.orgb.r=n.r,e.cmaps.orgb.g=n.g,e.cmaps.orgb.b=n.b,t=0;t<a;t++)if(n=o[t].toRgb(),e.cmaps.names[t]=c+"_"+String(t+1),p=JS9.lookupColormap(e.cmaps.names[t],!1))switch(p.type){case"lut":p.type="sao",p.vertices=[[[0,0],[1,n.r/255]],[[0,0],[1,n.g/255]],[[0,0],[1,n.b/255]]];break;case"sao":p.vertices=[[[0,0],[1,n.r/255]],[[0,0],[1,n.g/255]],[[0,0],[1,n.b/255]]]}else JS9.AddColormap(e.cmaps.names[t],[[0,0],[1,n.r/255]],[[0,0],[1,n.g/255]],[[0,0],[1,n.b/255]],{toplevel:!1});s.assign&&JS9.Cmaps.assignCmaps(e),e.cmaps.timeOutID=null},JS9.Cmaps.DEFTIMEOUT))},JS9.Cmaps.mkCmaps=function(e,t,a,i,s){var r;if(!t||!a||!i)return 0;(r=JS9.lookupColormap(t,!1))?JS9.Cmaps.mkCmapsFromCmap(e,r,a,i,s):JS9.Cmaps.mkCmapsFromColor(e,t,a,i,s)},JS9.Cmaps.xActive=function(e){var t=JS9.lookupDisplay(e);t&&t.cmaps.assign&&JS9.Cmaps.assignCmaps(t)},JS9.Cmaps.xMode=function(e,t){var a=JS9.lookupDisplay(e);a&&(a.cmaps.mode=t.options[t.selectedIndex].value,JS9.Cmaps.mkCmaps(a,a.cmaps.lastCname,a.cmaps.nmap,a.cmaps.nslice,{mode:a.cmaps.mode,assign:a.cmaps.assign,rgbtol:0}))},JS9.Cmaps.xNmap=function(e,t){var a=JS9.lookupDisplay(e);a&&(a.cmaps.nmap=parseInt(t.value,10)||1,JS9.Cmaps.mkCmaps(a,a.cmaps.lastCname,a.cmaps.nmap,a.cmaps.nslice,{mode:a.cmaps.mode,assign:a.cmaps.assign,rgbtol:0}))},JS9.Cmaps.xNslice=function(e,t){var a=JS9.lookupDisplay(e);a&&(a.cmaps.nslice=parseInt(t.value,10)||1,JS9.Cmaps.mkCmaps(a,a.cmaps.lastCname,a.cmaps.nmap,a.cmaps.nslice,{mode:a.cmaps.mode,assign:a.cmaps.assign,rgbtol:0}))},JS9.Cmaps.xCmap=function(e,t){var a=JS9.lookupDisplay(e),i=t.options[t.selectedIndex].value;a&&(JS9.Cmaps.mkCmaps(a,i,a.cmaps.nmap,a.cmaps.nslice,{mode:a.cmaps.mode,assign:a.cmaps.assign,rgbtol:0}),a.cmaps.lastCname=i)},JS9.Cmaps.xAssignCmaps=function(e,t){var a=JS9.lookupDisplay(e);a&&(a.cmaps.assign=$(t).prop("checked"),a.cmaps.assign&&JS9.Cmaps.assignCmaps(a))},JS9.Cmaps.imid=function(e){return(e.display.id+"_"+e.id).replace(/[^A-Za-z0-9_]/g,"_")+"CmapsImage"},JS9.Cmaps.dispclass=function(){return(JS9.Cmaps.BASE+"_"+this.display.id).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Cmaps.activeImage=function(e){var t,a;e&&(t=JS9.Cmaps.imid.call(this,e),a=JS9.Cmaps.dispclass.call(this)+"_Image",$("."+a).removeClass(JS9.Cmaps.BASE+"ImageActive").addClass(JS9.Cmaps.BASE+"ImageInactive"),$("#"+t).removeClass(JS9.Cmaps.BASE+"ImageInactive").addClass(JS9.Cmaps.BASE+"ImageActive"))},JS9.Cmaps.addImage=function(e){var t,a,i,s,r,n=this,o=[],l=JS9.Cmaps.BASE+"Image";e&&(r=e.id,s=this.display.id,a=JS9.Cmaps.imid.call(this,e),i=JS9.Cmaps.dispclass.call(this)+"_Image",o.push({name:"imid",value:r}),o.push({name:"active",value:sprintf(JS9.Cmaps.activeHTML,s,r)}),o.push({name:"imfile",value:sprintf(JS9.Cmaps.imfileHTML,r)}),t=JS9.Image.prototype.expandMacro.call(e,JS9.Cmaps.imageHTML,o),$("<div>").addClass(l).addClass(i).addClass(JS9.Cmaps.BASE+"ImageInactive").prop("id",a).prop("imid",r).html(t).appendTo(this.cmapsImageContainer).on("mousedown touchstart",function(){s===e.display.id&&(e.displayImage(),JS9.Cmaps.activeImage.call(n,e))}),this.display.id===e.display.id&&JS9.Cmaps.activeImage.call(this,e))},JS9.Cmaps.removeImage=function(e){var t;return!!e&&(t=JS9.Cmaps.imid.call(this,e),$("#"+t).remove(),!0)},JS9.Cmaps.init=function(e,t){var a,i,s,r,n=this,o="."+JS9.Cmaps.COLORCLASS,l="."+JS9.Cmaps.CMAPCLASS,c=this.display;if(this.divjq.addClass("JS9PluginScrolling"),"div"===this.winType&&(this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Cmaps.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.Cmaps.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10)),JS9.colormaps&&JS9.colormaps.length){for(c.cmaps||(c.cmaps={},c.cmaps.mode=JS9.Cmaps.DEFMODE,c.cmaps.nmap=JS9.Cmaps.DEFNMAP,c.cmaps.nslice=JS9.Cmaps.DEFNMAP,c.cmaps.assign=JS9.Cmaps.DEFASSIGN,c.cmaps.tol=JS9.Cmaps.DEFTOL,c.cmaps.lastCname=null,c.cmaps.names=[],c.cmaps.ims=[],c.cmaps.orgb={r:0,g:0,b:0},c.cmaps.that=n),this.divjq.html(""),this.cmapsContainer=$("<div>").addClass(JS9.Cmaps.BASE+"Container").attr("id",this.id+"CMapsContainer").appendTo(this.divjq),i=this.display.id,s=sprintf(JS9.Cmaps.headerHTML,i,i,i,i,i),this.cmapsHeader=$("<div>").addClass(JS9.Cmaps.BASE+"Header").attr("display",this.display.id).attr("id",this.display.id+"CMapsHeader").html(s).appendTo(this.cmapsContainer),this.cmapsImageContainer=$("<div>").addClass(JS9.Cmaps.BASE+"ImageContainer").attr("id",this.id+"CmapsImageContainer").appendTo(this.cmapsContainer),a=0;a<JS9.images.length;a++)JS9.Cmaps.addImage.call(this,JS9.images[a]);this.cmapsImageContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index();JS9.images.splice(a,0,JS9.images.splice(this.oidx,1)[0]),n.display.image&&n.display.image.displayImage()}}),r=this.cmapsContainer.find(o),this.cmapsContainer.find(l).each(function(){var e,t;for(e=0;e<JS9.colormaps.length;e++)t=JS9.colormaps[e].name,$(l).append($("<option>",{value:t,text:t}))}),c.cmaps.inited||(JS9.globalOpts.internalColorPicker&&$.fn.spectrum.inputTypeColorSupport()||(r.spectrum({showButtons:!1,showInput:!0,preferredFormat:"hex6"}),r.on("move.spectrum",function(e,t){var a=t.toHex();JS9.Cmaps.mkCmaps(c,a,c.cmaps.nmap,c.cmaps.nslice,{mode:c.cmaps.mode,assign:c.cmaps.assign}),c.cmaps.lastCname=a}),r.on("change",function(){var e=tinycolor($(this).val()).toHex();JS9.Cmaps.mkCmaps(c,e,c.cmaps.nmap,c.cmaps.nslice,{mode:c.cmaps.mode,assign:c.cmaps.assign}),c.cmaps.lastCname=e})),r.on("input",function(e){var t=e.target.value;$(e.target).parent().attr("display")===c.id&&(JS9.Cmaps.mkCmaps(c,t,c.cmaps.nmap,c.cmaps.nslice,{mode:c.cmaps.mode,assign:c.cmaps.assign}),c.cmaps.lastCname=t)}),c.cmaps.inited=!0)}else this.divjq.html(JS9.Cmaps.nofileHTML)},JS9.Cmaps.imageload=function(e){var t,a,i;for(this.display.cmaps?JS9.Cmaps.addImage.call(this,e):JS9.Cmaps.init.call(this),t=0;t<JS9.displays.length;t++)(a=JS9.displays[t]).image&&a.id!==e.display.id&&(i=a.pluginInstances.JS9Cmaps)&&i.isActive("onimageload")&&JS9.Cmaps.addImage.call(i,e)},JS9.Cmaps.imagedisplay=function(e){JS9.Cmaps.activeImage.call(this,e)},JS9.Cmaps.imageclose=function(e){var t,a,i;for(JS9.Cmaps.removeImage.call(this,e),t=0;t<JS9.displays.length;t++)(a=JS9.displays[t]).image&&a.id!==e.display.id&&(i=a.pluginInstances.JS9Cmaps)&&i.isActive("onimageclose")&&JS9.Cmaps.removeImage.call(i,e)},JS9.RegisterPlugin(JS9.Cmaps.CLASS,JS9.Cmaps.NAME,JS9.Cmaps.init,{menuItem:"Colormaps",help:"help/cmaps.html",onimageload:JS9.Cmaps.imageload,onimagedisplay:JS9.Cmaps.imagedisplay,onimageclose:JS9.Cmaps.imageclose,winTitle:"Create Colormaps",winResize:!0,winDims:[JS9.Cmaps.WIDTH,JS9.Cmaps.HEIGHT]}),JS9.Colorbar={},JS9.Colorbar.CLASS="JS9",JS9.Colorbar.NAME="Colorbar",JS9.Colorbar.WIDTH=512,JS9.Colorbar.HEIGHT=40,JS9.Colorbar.BASE=JS9.Colorbar.CLASS+JS9.Colorbar.NAME,JS9.Colorbar.SCALED=!1,JS9.Colorbar.TICKS=10,JS9.Colorbar.COLORBARHEIGHT=16,JS9.Colorbar.MAXLABELSIZE=10,JS9.Colorbar.display=function(e){var t,a,i,s,r,n,o,l,c,p=[],d=this.colorbarWidth,h=this.colorbarHeight,g=this.ctx.getImageData(0,0,d,h),u=g.data,m=4*d,f=new Uint8Array(u.buffer,0,m);if(n=this.scaled?e.psColors:e.colorCells){for(r=n.length/d,t=0,a=0;t<d;t++,a+=4)s=Math.floor(t*r),u[a]=n[s][0],u[a+1]=n[s][1],u[a+2]=n[s][2],u[a+3]=255;for(t=1;t<h;t++)u.set(f,t*m);if(this.ctx.putImageData(g,0,0),this.showTicks){for(r=e.psInverse.length/this.ticks,this.textctx.clear(),i=JS9.floatPrecision(Math.min(e.params.scalemin,e.psInverse[0]),Math.max(e.params.scalemax,e.psInverse[e.psInverse.length-1])),a=0;a<3;a++){for(c=!0,t=0;t<this.ticks;t++)o=e.psInverse[Math.floor(t*r)],p[t]=JS9.floatFormattedString(o,i,a);for(t=1;t<this.ticks;t++)p[t-1]===p[t]&&(c=!1);if(c)break}for(t=1;t<this.ticks;t++)t>1&&p[t]===p[t-1]||(l=t/this.ticks*this.width,this.textctx.textAlign="center",this.textctx.beginPath(),this.textctx.moveTo(l,0),this.textctx.lineWidth=1,this.textctx.lineTo(l,5),this.textctx.stroke(),p[t].length>=JS9.Colorbar.MAXLABELSIZE&&t%2==0||this.textctx.fillText(p[t],l,15))}}else JS9.Colorbar.imageclear(e)},JS9.Colorbar.init=function(e,t){var a=JS9.PIXEL_RATIO||1;this.showTicks=this.divjq.attr("data-showTicks"),this.showTicks=void 0===this.showTicks||"true"===this.showTicks,this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Colorbar.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=this.showTicks?t||JS9.Colorbar.HEIGHT:t||JS9.Colorbar.COLORBARHEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.colorbarWidth=this.width,this.colorbarHeight=parseInt(this.divjq.attr("data-colorbarHeight"),10),this.colorbarHeight||(this.colorbarHeight=JS9.Colorbar.COLORBARHEIGHT),this.colorbarHeight=Math.min(this.height,this.colorbarHeight),this.scaled=this.divjq.attr("data-scaled"),this.scaled=void 0===this.scaled?JS9.Colorbar.SCALED:"true"===this.scaled,this.ticks=this.divjq.attr("data-ticks"),this.ticks||(this.ticks=JS9.Colorbar.TICKS),this.divjq.html(""),this.colorbarContainer=$("<div>").addClass(JS9.Colorbar.BASE+"Container").attr("id",this.id+"Container").attr("width",this.width).attr("height",this.height).appendTo(this.divjq),this.colorbarjq=$("<canvas>").addClass(JS9.Colorbar.BASE+"Canvas").attr("id",this.id+"Canvas").attr("width",this.width-1).attr("height",this.colorbarHeight).appendTo(this.colorbarContainer),this.ctx=this.colorbarjq[0].getContext("2d"),this.showTicks&&(this.textjq=$("<canvas>").addClass(JS9.Colorbar.BASE+"TextCanvas").attr("id",this.id+"TextCanvas").attr("width",this.width*a).attr("height",(this.height-this.colorbarHeight)*a).css("width",this.width+"px").css("height",this.height-this.colorbarHeight+"px").appendTo(this.colorbarContainer),this.textctx=this.textjq[0].getContext("2d"),this.colorbarFont=this.divjq.attr("data-colorbarFont"),this.colorbarFont?this.textctx.font=this.colorbarFont:JS9.Colorbar.COLORBARFONT&&(this.textctx.font=JS9.Colorbar.COLORBARFONT),this.textctx.setTransform(a,0,0,a,0,0)),this.display.image&&JS9.Colorbar.display.call(this,this.display.image)},JS9.Colorbar.imagedisplay=function(e){e&&JS9.Colorbar.display.call(this,e)},JS9.Colorbar.imageclear=function(e){e&&e===e.display.image&&(this.ctx&&this.ctx.clear(),this.textctx&&this.textctx.clear())},JS9.Colorbar.dynamic=function(e){var t;e&&(t=e.display.pluginInstances.JS9Colorbar)&&t.isDynamic&&JS9.Colorbar.imagedisplay.call(this,e)},JS9.RegisterPlugin(JS9.Colorbar.CLASS,JS9.Colorbar.NAME,JS9.Colorbar.init,{menuItem:"Colorbar",dynamicSelect:!0,ondynamicselect:JS9.Colorbar.dynamic,onimagedisplay:JS9.Colorbar.imagedisplay,onimageclear:JS9.Colorbar.imageclear,onimageclose:JS9.Colorbar.imageclear,help:"help/colorbar.html",winTitle:"Colorbar",winDims:[JS9.Colorbar.WIDTH,JS9.Colorbar.HEIGHT]}),JS9.Console={},JS9.Console.CLASS="JS9",JS9.Console.NAME="Console",JS9.Console.WIDTH=512,JS9.Console.HEIGHT=180,JS9.Console.HTML="<form name='form' onsubmit='return false;' class='JS9CmdForm' action=''><table class='JS9CmdTable'><tr class='JS9Tr'><td><div id='JS9CmdPrompt' class='JS9CmdPrompt'>@@PR@@</div></td><td class='JS9CmdTd'><input type='text' class='JS9CmdIn' autocapitalize='off' autocorrect='off' autocomplete='off' value='' /></td></tr></table></form>",JS9.Console.init=function(e,t){this.display.conMode=2,this.hist=[],this.histpos=0,this.histtemp=0,this.histused=!1,this.consoleConjq=$("<div>").addClass("JS9ConsoleContainer").appendTo(this.divjq),"light"!==this.winType&&(this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.CONWIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.CONHEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.consoleConjq.css("width",this.width).css("height",this.height)),this.consoleConjq.attr("tabindex","0"),this.consoleConjq.on("keydown",this,function(e){return JS9.Console.keyDownCB(e)}),JS9.Console.out.call(this,"Type 'help' for a list of commands","info"),JS9.Console.inp.call(this)},JS9.Console.inp=function(){var e;return this.consoleConjq.find(".JS9CmdIn:last").attr("readonly","readonly"),this.consoleConjq.append(JS9.Console.HTML.replace(/@@PR@@/g,"js9>")),(e=this.consoleConjq.find(".JS9CmdIn:last")).focus().attr("autocapitalize","off").attr("autocorrect","off").attr("autocomplete","off"),JS9.jupyterFocus(e.parent()),this},JS9.Console.out=function(e,t){switch(t.toLowerCase()){case"error":e="ERROR: "+e,t="Error";break;case"info":t="Info";break;case"out":default:t="Out"}return $("<div>").addClass("JS9Cmd"+t).html(e).appendTo(this.consoleConjq),this},JS9.Console.xeq=function(){var e,t,a,i,s=this.consoleConjq.find(".JS9CmdIn:last").val(),r=s.replace(/ {2,}/g," ").split(" "),n=[];if(!r[0])return this;for(t=r[0],e=1;e<r.length;e++)n.push(r[e]);this.histused||(this.hist[this.hist.length]=s),this.histpos=this.hist.length,this.histused=!1;try{if(a=JS9.lookupCommand(t))switch(a.getDisplayInfo(this.display),a.getWhich(n)){case"get":i=a.get(n)||"",JS9.Console.out.call(this,i,"ok");break;case"set":(i=a.set(n))&&JS9.Console.out.call(this,i,"ok");break;default:i=sprintf("unknown cmd type for '%s'",t),JS9.error(i)}else i=sprintf("unknown command '%s'",t),n.length>0&&(i=i+" "+n),JS9.error(i)}catch(o){JS9.Console.out.call(this,o.message,"error")}return this},JS9.Console.keyDownCB=function(e){var t,a=e.data,i=e.which||e.keyCode;if(!JS9.specialKey(e)){if((t=a.consoleConjq.find(".JS9CmdIn:last")).focus(),a.hist.length&&(38===i||40===i)){switch(a.hist[a.histpos]?a.hist[a.histpos]=t.val():a.histtemp=t.val(),i){case 38:a.histpos--,a.histpos<0&&(a.histpos=0);break;case 40:a.histpos++,a.histpos>a.hist.length&&(a.histpos=a.hist.length);break;default:JS9.error("internal keycode switch mixup")}a.hist[a.histpos]?(t.val(a.hist[a.histpos]),a.histused=a.histpos!==a.hist.length):(t.val(a.histtemp),a.histused=!1)}13===i&&(JS9.globalOpts.alerts=!1,JS9.Console.xeq.call(a),JS9.globalOpts.alerts=!0,JS9.Console.inp.call(a))}},JS9.RegisterPlugin("JS9","Console",JS9.Console.init,{menuItem:"Console",winTitle:"Console",winResize:!0,winDims:[JS9.Console.WIDTH,JS9.Console.HEIGHT]}),JS9.Cube={},JS9.Cube.CLASS="JS9",JS9.Cube.NAME="Cube",JS9.Cube.WIDTH=512,JS9.Cube.HEIGHT=240,JS9.Cube.BASE=JS9.Cube.CLASS+JS9.Cube.NAME,JS9.Cube.cubeHTML="<div class='JS9CubeLinegroup'>$header</div><p><div class='JS9CubeLinegroup'><span class='JS9CubeSpan' style='float: left'>$range&nbsp;&nbsp;&nbsp;&nbsp;$value&nbsp;&nbsp;&nbsp;&nbsp;$extname</span><span class='JS9CubeSpan' style='float: right'>$order</span></div><div class='JS9CubeLinegroup'><span class='JS9CubeSpan' style='float: left'>$first&nbsp;$next&nbsp;$prev&nbsp;$last</span><span class='JS9CubeSpan' style='float: right'>$blink&nbsp;$stop&nbsp;$rate</span></div><p><div class='JS9CubeLinegroup'>$header2</div><p><div class='JS9CubeLinegroup'><span class='JS9CubeSpan' style='float: left'>$load</span></div>",JS9.Cube.headerHTML="Use the slider, text box, navigation or blink buttons to display a slice of a <b>FITS data cube</b>. Use the menu at the right to specify the slice axis.",JS9.Cube.rangeHTML='<span class="JS9CubeRangeLine">1<input type="range" min="1" max="%s" value="%s" class="JS9CubeRange" onchange="JS9.Cube.xrange(\'%s\', \'%s\', this)">%s</span>',JS9.Cube.valueHTML='<input type="text" class="JS9CubeValue" min="1" max="%s" value="%s" onchange="JS9.Cube.xvalue(\'%s\', \'%s\', this)" size="4">',JS9.Cube.firstHTML='<input type="button" class=JS9CubeBtn" value="First" onclick="JS9.Cube.xfirst(\'%s\', \'%s\', this)">',JS9.Cube.nextHTML='<input type="button" class=JS9CubeBtn" value="Next" onclick="JS9.Cube.xnext(\'%s\', \'%s\', this)">',JS9.Cube.prevHTML='<input type="button" class=JS9CubeBtn" value="Prev" onclick="JS9.Cube.xprev(\'%s\',\'%s\', this)">',JS9.Cube.lastHTML='<input type="button" class=JS9CubeBtn" value="Last" onclick="JS9.Cube.xlast(\'%s\', \'%s\', this)">',JS9.Cube.blinkHTML='<input type="button" class=JS9CubeBtn" value="Blink" onclick="JS9.Cube.xstart(\'%s\', \'%s\', this)">',JS9.Cube.stopHTML='<input type="button" class=JS9CubeBtn" value="Stop" onclick="JS9.Cube.xstop(\'%s\', \'%s\', this)">',JS9.Cube.extnameHTML='<span class="JS9CubeRangeLine">%s</span>',JS9.Cube.orderHTML='<select class="JS9CubeOrder" onchange="JS9.Cube.xorder(\'%s\', \'%s\', this)"><option value="$slice:*:*">$slice : * : *</option><option value="*:$slice:*">* : $slice : *</option><option value="*:*:$slice">* : * : $slice</option></select>',JS9.Cube.rateHTML='<select class="JS9CubeRate" onchange="JS9.Cube.xrate(\'%s\', \'%s\', this)"><option selected disabled>Rate</option><option value=".1">0.1 sec</option><option value=".25">0.25 sec</option><option value=".5">0.5 sec</option><option value="1" default>1 sec</option><option value="2">2 sec</option><option value="5">5 sec</option></select>',JS9.Cube.header2HTML="Or load each slice separately into JS9:",JS9.Cube.loadHTML='<input type="button" class=JS9CubeBtn" value="Load All" onclick="JS9.Cube.loadall(\'%s\',\'%s\', this)">',JS9.Cube.doSlice=function(e,t,a){var i,s,r=e.display.pluginInstances[JS9.Cube.BASE];if(!e.parentFile||!r.inProcess){for(i=0;i<a.length;i++)r.divjq.find(a[i]).val(t);s=e.expandMacro(r.slice,[{name:"slice",value:t}]),r.sval=t,r.inProcess=!0,e.displaySlice(s,{},function(){r.inProcess=!1})}},JS9.Cube.xrange=function(e,t,a){var i,s=JS9.lookupImage(t,e);s&&(i=parseInt(a.value,10),JS9.Cube.doSlice(s,i,[".JS9CubeValue"]))},JS9.Cube.xvalue=function(e,t,a){var i,s=JS9.lookupImage(t,e);s&&(i=parseInt(a.value,10),JS9.Cube.doSlice(s,i,[".JS9CubeRange"]))},JS9.Cube.xfirst=function(e,t,a){var i=JS9.lookupImage(t,e);i&&JS9.Cube.doSlice(i,1,[".JS9CubeValue",".JS9CubeRange"])},JS9.Cube.xnext=function(e,t,a){var i,s,r=JS9.lookupImage(t,e);r&&((i=(s=r.display.pluginInstances[JS9.Cube.BASE]).sval+1)>(r.parent&&r.parent.raw&&r.parent.raw.header?r.parent.raw.header:r.raw.header)["NAXIS"+s.sidx]&&(i=1),JS9.Cube.doSlice(r,i,[".JS9CubeValue",".JS9CubeRange"]))},JS9.Cube.xprev=function(e,t,a){var i,s,r=JS9.lookupImage(t,e);r&&((i=(s=r.display.pluginInstances[JS9.Cube.BASE]).sval-1)<1&&(i=(r.parent&&r.parent.raw&&r.parent.raw.header?r.parent.raw.header:r.raw.header)["NAXIS"+s.sidx]),JS9.Cube.doSlice(r,i,[".JS9CubeValue",".JS9CubeRange"]))},JS9.Cube.xlast=function(e,t,a){var i=JS9.lookupImage(t,e);i&&JS9.Cube.doSlice(i,(i.parent&&i.parent.raw&&i.parent.raw.header?i.parent.raw.header:i.raw.header)["NAXIS"+i.display.pluginInstances[JS9.Cube.BASE].sidx],[".JS9CubeValue",".JS9CubeRange"])},JS9.Cube.xorder=function(e,t,a){var i,s,r,n,o=JS9.lookupImage(t,e);if(o){for(n=o.parent&&o.parent.raw&&o.parent.raw.header?o.parent.raw.header:o.raw.header,(r=o.display.pluginInstances[JS9.Cube.BASE]).slice=a.value,s=r.slice.split(/[ ,:]/),i=0;i<s.length;i++)"*"!==s[i]&&(r.sidx=i+1,r.sval=1,r.smax=n["NAXIS"+r.sidx]);$(".JS9CubeRange").prop("max",r.smax),JS9.Cube.doSlice(o,r.sval,[".JS9CubeValue",".JS9CubeRange"])}},JS9.Cube.blink=function(e,t,a){var i,s=JS9.lookupImage(t,e);if(s){if(!1===(i=s.display.pluginInstances[JS9.Cube.BASE]).blinkMode)return void delete i.blinkMode;JS9.Cube.xnext(e,t,a),void 0===i.blinkMode&&(i.blinkMode=!0),JS9.Cube.tid=window.setTimeout(function(){JS9.Cube.blink(e,t,a)},i.rate)}},JS9.Cube.xstart=function(e,t,a){var i=JS9.lookupImage(t,e);i&&(i.display.pluginInstances[JS9.Cube.BASE].blinkMode||JS9.Cube.blink(e,t,a))},JS9.Cube.xstop=function(e,t,a){var i,s=JS9.lookupImage(t,e);s&&((i=s.display.pluginInstances[JS9.Cube.BASE]).inProcess=!1,i.blinkMode&&(i.tid&&(window.clearTimeout(i.tid),delete i.tid),i.blinkMode=!1))},JS9.Cube.xrate=function(e,t,a){var i=JS9.lookupImage(t,e);i&&(i.display.pluginInstances[JS9.Cube.BASE].rate=Math.floor(1e3*parseFloat(a.value)))},JS9.Cube.loadall=function(e,t,a){var i=JS9.lookupImage(t,e);i&&i.displaySlice("all")},JS9.Cube.display=function(){this.lastimage!==this.display.image&&JS9.Cube.init.call(this)},JS9.Cube.close=function(){JS9.Cube.init.call(this,{mode:"clear"})},JS9.Cube.init=function(e){var t,a,i,s,r,n,o,l;if(e=e||{},this.width=this.divjq.attr("data-width"),this.width||(this.width=JS9.Cube.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=JS9.Cube.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.cubeWidth=this.width,this.cubeHeight=parseInt(this.divjq.attr("data-cubeHeight"),10),this.cubeHeight||(this.cubeHeight=JS9.Cube.CUBEHEIGHT),(i=this.display.image)&&"clear"!==e.mode){if(l=i.parent&&i.parent.raw&&i.parent.raw.header?i.parent.raw.header:i.raw.header,n=i.id,o=i.display.id,i.slice)for(this.slice=i.slice.replace(/[0-9][0-9]*/,"$slice"),s=i.slice.split(/[ ,:]/),t=0;t<s.length;t++)"*"!==s[t]&&(this.sidx=t+1,this.smax=l["NAXIS"+this.sidx],this.sval=parseInt(s[t],10));else this.slice="*:*:$slice",this.smax=l.NAXIS3,this.sidx=3,this.sval=1;this.rate||(this.rate=1e3),void 0!==this.tid&&(window.clearTimeout(this.tid),delete this.tid),void 0!==this.blinkMode&&delete this.blinkMode,l.NAXIS>2?((r=[]).push({name:"header",value:JS9.Cube.headerHTML}),r.push({name:"range",value:sprintf(JS9.Cube.rangeHTML,this.smax,this.sval,o,n,this.smax)}),r.push({name:"value",value:sprintf(JS9.Cube.valueHTML,this.smax,this.sval,o,n)}),r.push({name:"first",value:sprintf(JS9.Cube.firstHTML,o,n)}),r.push({name:"next",value:sprintf(JS9.Cube.nextHTML,o,n)}),r.push({name:"prev",value:sprintf(JS9.Cube.prevHTML,o,n)}),r.push({name:"last",value:sprintf(JS9.Cube.lastHTML,o,n)}),r.push({name:"blink",value:sprintf(JS9.Cube.blinkHTML,o,n)}),r.push({name:"stop",value:sprintf(JS9.Cube.stopHTML,o,n)}),r.push({name:"order",value:sprintf(JS9.Cube.orderHTML,o,n)}),r.push({name:"rate",value:sprintf(JS9.Cube.rateHTML,o,n)}),r.push({name:"extname",value:sprintf(JS9.Cube.extnameHTML,l.EXTNAME||"")}),r.push({name:"header2",value:JS9.Cube.header2HTML}),r.push({name:"load",value:sprintf(JS9.Cube.loadHTML,o,n)}),a=i.expandMacro(JS9.Cube.cubeHTML,r)):a="<p><center>This image is not a FITS data cube.</center>",this.lastimage=i}else a="<p><center>FITS cube processing will appear here.</center>";this.divjq.html(""),this.cubeContainer=$("<div>").addClass(JS9.Cube.BASE+"Container").attr("id",this.id+"Container").attr("width",this.width).attr("height",this.height).appendTo(this.divjq),this.cubeContainer.html(a),this.divjq.find(".JS9CubeRange").prop("max",this.smax),this.divjq.find(".JS9CubeValue").prop("max",this.smax),this.divjq.find(".JS9CubeOrder").val(this.slice)},JS9.RegisterPlugin(JS9.Cube.CLASS,JS9.Cube.NAME,JS9.Cube.init,{menuItem:"Data Cube",onplugindisplay:JS9.Cube.init,onimageload:JS9.Cube.init,onimagedisplay:JS9.Cube.display,onimageclose:JS9.Cube.close,help:"help/cube.html",winTitle:"FITS Data Cubes",winDims:[JS9.Cube.WIDTH,JS9.Cube.HEIGHT]}),JS9.Divs={},JS9.Divs.CLASS="JS9",JS9.Divs.NAME="Divs",JS9.Divs.WIDTH=400,JS9.Divs.HEIGHT=146,JS9.Divs.BASE=JS9.Divs.CLASS+JS9.Divs.NAME,JS9.Divs.headerHTML="JS9 plugin divs can be hidden or made visible below.",JS9.Divs.divHTML="<span style='float: left'>$visible&nbsp;&nbsp;</span>&nbsp;&nbsp; <span class='JS9DivsSpan'>$div&nbsp;&nbsp</span>",JS9.Divs.nodivsHTML='<p><span class="JS9NoDivs">[No JS9 divs have been created for this display]</span>',JS9.Divs.visibleHTML='<input class="JS9DivsVisibleCheck" type="checkbox" id="visible" name="visible" value="visible" onclick="javascript:JS9.Divs.xvisible(\'%s\', \'%s\', this)">visible',JS9.Divs.divNameHTML="<b>%s</b>",JS9.Divs.xvisible=function(e,t,a){var i,s,r=JS9.lookupDisplay(e);r&&((s=r.pluginInstances[t])&&(i=a.checked?"visible":"hidden"),s.divjq.closest(".JS9PluginContainer").css("visibility",i))},JS9.Divs.addDiv=function(e){var t,a=JS9.Divs.BASE+"Div",i=[];e&&this.display.pluginInstances[e]&&(this.ndiv||this.divsDivContainer.html(""),i.push({name:"visible",value:sprintf(JS9.Divs.visibleHTML,this.display.id,e)}),i.push({name:"div",value:sprintf(JS9.Divs.divNameHTML,e)}),t=JS9.Image.prototype.expandMacro.call(null,JS9.Divs.divHTML,i),$("<div>").addClass(a).html(t).appendTo(this.divsDivContainer).find(".JS9DivsVisibleCheck").prop("checked","visible"===this.display.pluginInstances[e].divjq.css("visibility")),this.ndiv++)},JS9.Divs.init=function(e){var t,a;if(e=e||{},this.divjq.html(""),this.ndiv=0,this.divjq.addClass("JS9PluginScrolling"),this.divsContainer=$("<div>").addClass(JS9.Divs.BASE+"Container").attr("id",this.id+"DivsContainer").css("overflow","auto").appendTo(this.divjq),this.divsHeader=$("<div>").addClass(JS9.Divs.BASE+"Header").attr("id",this.display.id+"Header").html(JS9.Divs.headerHTML).appendTo(this.divsContainer),this.divsDivContainer=$("<div>").addClass(JS9.Divs.BASE+"DivContainer").attr("id",this.id+"DivsDivContainer").html(JS9.Divs.nodivsHTML).appendTo(this.divsContainer),"clear"!==e.mode)for(t in a=this.display.pluginInstances)a.hasOwnProperty(t)&&"div"===a[t].winType&&JS9.Divs.addDiv.call(this,t)},JS9.RegisterPlugin(JS9.Divs.CLASS,JS9.Divs.NAME,JS9.Divs.init,{menuItem:"Show/Hide Plugins",onplugindisplay:JS9.Divs.init,help:"help/divs.html",winTitle:"Show/Hide Plugins",winResize:!0,winDims:[JS9.Divs.WIDTH,JS9.Divs.HEIGHT]}),JS9.Imarith={},JS9.Imarith.CLASS="JS9",JS9.Imarith.NAME="Imarith",JS9.Imarith.WIDTH=512,JS9.Imarith.HEIGHT=170,JS9.Imarith.BASE=JS9.Imarith.CLASS+JS9.Imarith.NAME,JS9.Imarith.imageHTML="<div class='JS9ImarithLinegroup'>Choose an op (add, subtract, multiply, divide, min, max) and an operand (number or image) and click Run. Reset will revert to the original data.</div><div class='JS9ImarithLinegroup'><span class='JS9ImarithSpan' style='float: left'><b>$imid</b> &nbsp;&nbsp; $op &nbsp;&nbsp; $arg1 &nbsp;&nbsp; $num</span></div><p><div class='JS9ImarithLinegroup'><span class='JS9ImarithSpan' style='float: left'>$run</span><span style='float: right'>$reset</span></div>",JS9.Imarith.opHTML='<select class=JS9ImarithOp" onchange="JS9.Imarith.xop(\'%s\', \'%s\', this)"><option value="" selected disabled>op</option><option value="add">add</option><option value="sub">sub</option><option value="mul">mul</option><option value="div">div</option><option value="min">min</option><option value="max">max</option></select>',JS9.Imarith.arg1HTML='<select class=JS9ImarithArg1" onchange="JS9.Imarith.xarg1(\'%s\', \'%s\', this)"><option val="" selected disabled>operand</option><option value="num">number &#8594;</option>%s</select>',JS9.Imarith.numHTML='<input type="text" class="JS9ImarithNum" value="" onchange="JS9.Imarith.xnum(\'%s\', \'%s\', this)" size="10" placeholder="number">',JS9.Imarith.runHTML='<input type="button" class=JS9ImarithBtn" value="Run" onclick="JS9.Imarith.xrun(\'%s\', \'%s\', this)">',JS9.Imarith.resetHTML='<input type="button" class=JS9ImarithBtn" value="Reset" onclick="JS9.Imarith.xreset(\'%s\', \'%s\', this)">',JS9.Imarith.xop=function(e,t,a){var i=a.options[a.selectedIndex].value,s=JS9.lookupImage(t,e);s&&i&&(s.display.pluginInstances.JS9Imarith.op=i)},JS9.Imarith.xarg1=function(e,t,a){var i=JS9.lookupImage(t,e),s=a.options[a.selectedIndex].value;i&&s&&(i.display.pluginInstances.JS9Imarith.arg1=s,"num"===s?$(".JS9ImarithNum").css("visibility","visible"):$(".JS9ImarithNum").css("visibility","hidden"))},JS9.Imarith.xnum=function(e,t,a){var i=JS9.lookupImage(t,e),s=a.value;JS9.isNumber(s)?i.display.pluginInstances.JS9Imarith.num=parseFloat(s):s&&JS9.error("please enter a real number: "+s)},JS9.Imarith.xrun=function(e,t,a){var i,s,r=JS9.lookupImage(t,e);r&&((s=r.display.pluginInstances.JS9Imarith).op&&s.arg1||JS9.error("please select an operation and an operand"),"num"===s.arg1?(void 0===s.num&&JS9.error("please enter a real number for the operand"),i=s.num):i=s.arg1,r.imarithData(s.op,i))},JS9.Imarith.xreset=function(e,t,a){var i=JS9.lookupImage(t,e);i&&i.imarithData("reset")},JS9.Imarith.display=function(){this.lastimage!==this.display.image&&JS9.Imarith.init.call(this)},JS9.Imarith.close=function(){JS9.Imarith.init.call(this,{mode:"clear"})},JS9.Imarith.init=function(e){var t,a,i,s,r,n,o,l="";if(e=e||{},this.width=this.divjq.attr("data-width"),this.width||(this.width=JS9.Imarith.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=JS9.Imarith.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.imarithWidth=this.width,this.imarithHeight=parseInt(this.divjq.attr("data-imarithHeight"),10),this.imarithHeight||(this.imarithHeight=JS9.Imarith.IMARITHHEIGHT),delete this.arg1,delete this.op,delete this.num,(i=this.display.image)&&"clear"!==e.mode){for(n=i.id,o=i.display.id,this.lastim=i.id,t=0;t<JS9.images.length;t++)(s=JS9.images[t])!==i&&(l+=sprintf('<option value="%s">%s</option>',s.id,s.id));(r=[]).push({name:"images",value:l}),r.push({name:"imid",value:n}),r.push({name:"op",value:sprintf(JS9.Imarith.opHTML,o,n)}),r.push({name:"arg1",value:sprintf(JS9.Imarith.arg1HTML,o,n,l)}),r.push({name:"num",value:sprintf(JS9.Imarith.numHTML,o,n)}),r.push({name:"run",value:sprintf(JS9.Imarith.runHTML,o,n)}),r.push({name:"reset",value:sprintf(JS9.Imarith.resetHTML,o,n)}),a=JS9.Image.prototype.expandMacro.call(i,JS9.Imarith.imageHTML,r),this.lastimage=i}else a="<p><center>Image arithmetic will appear here.</center>";this.divjq.html(""),this.imarithContainer=$("<div>").addClass(JS9.Imarith.BASE+"Container").attr("id",this.id+"Container").attr("width",this.width).attr("height",this.height).appendTo(this.divjq),this.imarithContainer.html(a),this.imarithContainer.find(".JS9ImarithNum").css("visibility","hidden")},JS9.RegisterPlugin(JS9.Imarith.CLASS,JS9.Imarith.NAME,JS9.Imarith.init,{menuItem:"Imarith",onplugindisplay:JS9.Imarith.init,onimageload:JS9.Imarith.init,onimagedisplay:JS9.Imarith.display,onimageclose:JS9.Imarith.close,help:"help/imarith.html",winTitle:"Image Arithmetic",winDims:[JS9.Imarith.WIDTH,JS9.Imarith.HEIGHT]}),JS9.Info={},JS9.Info.CLASS="JS9",JS9.Info.NAME="Info",JS9.Info.WIDTH=325,JS9.Info.HEIGHT=250,JS9.Info.REGHEIGHT=75,JS9.Info.opts={infoURL:"./params/info.html",infoObj:{file:'<tr><td><input type="text" class="column0" value="file" readonly="readonly"></td><td colspan="2"><input type="text" name="id" class="input2" value="" readonly="readonly" onclick="this.scrollLeft=this.scrollWidth;"></td></tr>',object:'<tr><td><input type="text" class="column0" value="object" readonly="readonly"></td><td colspan="2"><input type="text" name="object" class="input2" value="" readonly="readonly"></td></tr>',wcscen:'<tr><td><input type="text" class="column0" value="center" readonly="readonly"></td><td colspan="2"><input type="text" name="wcscen" class="input2" value="" readonly="readonly"></td></tr>',wcsfov:'<tr><td><input type="text" class="column0" value="fov" readonly="readonly"></td><td colspan="2"><input type="text" name="wcsfovpix" class="input2" value="" readonly="readonly"></td></tr>',value:'<tr><td><input type="text" class="column0" value="value" readonly="readonly"></td><td colspan="2"><input type="text" name="val3" class="input2" value="" readonly="readonly"></td></tr>',impos:'<tr><td><input type="text" class="column0" value="image" readonly="readonly"></td><td colspan="2"><input type="text" name="ipos" class="input2" value="" readonly="readonly"></td></tr>',physpos:'<tr><td><input type="text" class="column0" value="physical" readonly="readonly"></td><td colspan="2"><input type="text" name="ppos" class="input2" value="" readonly="readonly"></td></tr>',wcspos:'<tr><td><input type="text" class="column0" value="wcs" name="wcssys" readonly="readonly"></td><td colspan="2"><input type="text" name="wcspos" class="input2" value="" readonly="readonly"></td></tr>',regions:'<tr><td><input type="text" class="column0" value="regions" readonly="readonly"></td><td colspan="2"><textarea class="text2" name="regions" rows="4" value="" readonly="readonly"></textarea></td></tr>',progress:'<tr><td colspan="2"><div class="JS9Progress"><progress name="progress" class="JS9ProgressBar" value="0" max="100"></progress></div></td></tr>'}},JS9.Info.init=function(){var e,t,a,i,s;if(this.display.image&&this.display.image===this.lastimage){switch(this.display.image.callingPlugin){case"onplugindisplay":case"onimagerefresh":case"onupdateprefs":break;default:return}this.lastimage=this.display.image}for(a=JS9.globalOpts.infoBox,i=JS9.Info.opts.infoObj,s='<table name="info" class="js9InfoTable">',e=0;e<a.length;e++)(t=a[e]).match(/^wcs/)&&JS9.globalOpts.infoBoxResize&&this.display.image&&!(this.display.image.raw.wcs>0)||t.match(/^regions/)&&"lightwin"===JS9.globalOpts.regionDisplay||t in i&&(s+=i[t]);s+="</table>",this.infoConjq&&this.infoConjq.html(""),this.width=this.divjq.attr("data-width"),this.width||(this.width=JS9.Info.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=JS9.Info.HEIGHT,"lightwin"!==JS9.globalOpts.regionDisplay&&(this.height+=JS9.Info.REGHEIGHT)),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.infoConjq=$("<div>").addClass("JS9Container").append(s).appendTo(this.divjq),this.jq=this.infoConjq.find("[name='info']")},JS9.Info.display=function(e,t,a,i){var s,r,n,o,l,c,p,d,h,g,u,m,f,y=this,b=this;if(this.display&&(b=this.display),f=b.image,b.pluginInstances&&(d=b.pluginInstances.JS9Info),!d||"active"!==d.status||a&&i?a?(a===b?(n=b,a=null):n=a instanceof jQuery?a:"object"==typeof a?$(a):$("#"+a),n.length||(n=b,a=null),this.lasttarget=a):(n=b,this.lasttarget=b):n=d,"progress"!==e){if(n===d&&("regions"!==e||"lightwin"!==JS9.globalOpts.regionDisplay)){switch(typeof t){case"string":(u=d.jq.find("[name='"+e+"']")).length>0&&u.val(t);break;case"object":for(h in t)t.hasOwnProperty(h)&&(u=d.jq.find("[name='"+h+"']")).length>0&&u.val(t[h])}return b}switch(e){case"regions":if("lightwin"===JS9.globalOpts.regionDisplay){if(m=b.id+"_regions",!(g=$("#"+m)).length||g[0].isClosed)return t?($("#dhtmlwindowholder").arrive("#"+m,{fireOnAttributesModification:!0},function(){JS9.Info.display.call(y,e,t,a,i)}),r="Regions",f&&(r+=": "+f.id),r+=" ",r+=sprintf(JS9.IDFMT,this.id),void JS9.lightWin(m,"inline","<div class='JS9Message'></div>",r,JS9.lightOpts[JS9.LIGHTWIN].regWin0)):void 0;l=g.find(".JS9Message")}else a?l=n:(l=n.regionsArea,n.infoheight=n.infoArea.height()+4,n.regheight=Math.max(2*n.infoheight+10,n.infoheight+n.regionsArea.height()+10),p=!b.image||b.image.iy>n.regheight?JS9.textColorOpts.inimage:JS9.textColorOpts.regions);o=";";break;case"info":default:a?l=n:(l=n.infoArea,n.infoheight=n.infoArea.height()+4,p=!b.image||b.image.iy>n.infoheight?JS9.textColorOpts.inimage:JS9.textColorOpts.info,o="")}switch(typeof t){case"string":s=t;break;case"object":s=t[h="vstr"+JS9.globalOpts.valposWidth]||t.vstrmedium||t.vstr||""}return""!==o&&s.split(o).length>2&&(c=new RegExp(o,"g"),s=s.replace(c,"<br>")),p&&l.css("color",p),l.html(s),b}if((g=n===d?d.jq:n.divjq).length>0)switch(g=g.find("[name='progress']"),typeof t){case"string":case"boolean":t?("indeterminate"===t&&g.removeAttr("value"),g.parent().css("display","inline-block")):(g.parent().css("display","none"),g.attr("value",0));break;case"object":t[1]&&g.attr("max",t[1]),g.attr("value",t[0])}},JS9.Display.prototype.displayMessage=JS9.Info.display,JS9.Image.prototype.displayMessage=JS9.Info.display,JS9.Info.clear=function(e){var t=this;return this.display&&(t=this.display),e?t.displayMessage(e,""):(t.displayMessage("info",""),t.displayMessage("regions",""),t.displayMessage("progress",!1)),t},JS9.Display.prototype.clearMessage=JS9.Info.clear,JS9.Image.prototype.clearMessage=JS9.Info.clear,JS9.Info.pluginDisplay=function(e){var t;e&&e.display&&(e.tmp&&(e.tmp.info_ovalpos=e.params.valpos),e.params.valpos=!0,this.display.lasttarget&&((t=this.display).displayMessage("info","",t.lasttarget,!0),t.displayMessage("regions","",t.lasttarget,!0),t.displayMessage("progress",!1,t.lasttarget,!0),delete t.lasttarget))},JS9.Info.pluginClose=function(e){e&&e.display&&e.tmp&&void 0!==e.tmp.info_ovalpos&&(e.params.valpos=e.tmp.info_ovalpos)},JS9.mkPublic("DisplayMessage",function(e,t,a){var i,s=JS9.parsePublicArgs(arguments),r=JS9.lookupDisplay(s.display);return r||JS9.error("invalid display for display message"),(i=r.displayMessage(e=s.argv[0],t=s.argv[1],a=s.argv[2]))===r&&(i="OK"),i}),JS9.RegisterPlugin("JS9","Info",JS9.Info.init,{menuItem:"InfoBox",dynamicSelect:!0,onplugindisplay:JS9.Info.pluginDisplay,onpluginclose:JS9.Info.pluginClose,onimagedisplay:JS9.Info.init,onimagerefresh:JS9.Info.init,onupdateprefs:JS9.Info.init,winTitle:"Info",winResize:!0,winDims:[JS9.Info.WIDTH,JS9.Info.HEIGHT]}),JS9.Keyboard={},JS9.Keyboard.CLASS="JS9",JS9.Keyboard.NAME="Keyboard",JS9.Keyboard.WIDTH=450,JS9.Keyboard.HEIGHT=420,JS9.Keyboard.BASE=JS9.Keyboard.CLASS+JS9.Keyboard.NAME,JS9.Keyboard.actionHTML="<div class='JS9KeyboardText'><button class='JS9Button JS9KeyboardButton' type='button' value='%s'>%s</button></div><div class='JS9KeyboardAction'>%s</div>",JS9.Keyboard.actionid=function(e,t){return(e+"_"+t).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Keyboard.addAction=function(e,t,a){var i,s,r,n=this;return s=JS9.Keyboard.actionid(t,a),i=sprintf(JS9.Keyboard.actionHTML,a,t,a),(r=$("<div class='JS9KeyboardItem'>").attr("id",s).html(i).appendTo(e)).find(".JS9KeyboardButton").on("click",function(e){var t=this.value,a=n.display.image;a&&t&&JS9.Keyboard.Actions[t]&&JS9.Keyboard.Actions[t](a,a.ipos,e)}),r},JS9.Keyboard.arrowKey=function(e,t,a,i){e.pos.x+=a.x,e.pos.y+=a.y,e.ipos=e.displayToImagePos(e.pos),JS9.hasOwnProperty("MouseTouch")&&(e.valpos=null,JS9.MouseTouch.Actions["display value/position"](e,e.ipos,t)),JS9.hasOwnProperty("Magnifier")&&JS9.Magnifier.display(e,e.ipos),JS9.hasOwnProperty("Crosshair")&&!i&&(e.clickInRegion||(e.tmp.arrowCrosshair=!0,e.tmp.arrowCrosshairVisible=!0,JS9.Crosshair.display(e,e.ipos,t),delete e.tmp.arrowCrosshair))},JS9.Keyboard.Actions={},JS9.Keyboard.Actions["open local file"]=function(e,t,a){JS9.OpenFileMenu({display:a.data})},JS9.Keyboard.Actions["close image"]=function(e,t,a){e&&e.closeImage()},JS9.Keyboard.Actions["new JS9 light window"]=function(e,t,a){JS9.LoadWindow(null,{clone:a.data.id},"light")},JS9.Keyboard.Actions["copy wcs position to clipboard"]=function(e,t,a){var i,s;if(e&&e.raw.wcs&&t)return i=JS9.pix2wcs(e.raw.wcs,t.x,t.y).trim(),JS9.globalOpts.copyWcsPosFormat&&(s=i.split(/\s+/),i=e.expandMacro(JS9.globalOpts.copyWcsPosFormat,[{name:"ra",value:s[0]},{name:"dec",value:s[1]},{name:"sys",value:s[2]}])),JS9.CopyToClipboard(i,e),i},JS9.Keyboard.Actions["copy physical position to clipboard"]=function(e,t,a){var i,s;if(e&&t)return i=e.imageToLogicalPos(t),s=sprintf("%f %f",i.x,i.y),JS9.CopyToClipboard(s,e),s},JS9.Keyboard.Actions["copy pixel value to clipboard"]=function(e,t,a){var i,s,r;if(e&&t)return s=e.raw.data[Math.floor(t.y-.5)*e.raw.width+Math.floor(t.x-.5)],r=JS9.floatPrecision(e.params.scalemin,e.params.scalemax),i=JS9.floatFormattedString(s,r,3),JS9.CopyToClipboard(i,e),i},JS9.Keyboard.Actions["copy value and position to clipboard"]=function(e,t,a){var i,s,r;if(e&&t)return r=e.setParam("valpos",!0),i=e.updateValpos(t,!1),e.setParam("valpos",r),s="vstr"+JS9.globalOpts.valposWidth,i=i&&i[s]?i[s].replace(/&nbsp;/g," "):" ",JS9.CopyToClipboard(i,e),i},JS9.Keyboard.Actions["edit selected region"]=function(e,t,a){var i,s;e&&(i=e.layers.regions)&&(s=i.canvas.getActiveObject(),JS9.Regions.displayConfigForm.call(e,s))},JS9.Keyboard.Actions["toggle selected region: source/background"]=function(e,t,a){if(e)return e.toggleRegionTags("selected","source","background")},JS9.Keyboard.Actions["toggle selected region: include/exclude"]=function(e,t,a){if(e)return e.toggleRegionTags("selected","include","exclude")},JS9.Keyboard.Actions["tag selected region as 'source'"]=function(e,t,a){if(e)return JS9.Keyboard.editregion(e,"source","background")},JS9.Keyboard.Actions["tag selected region as 'background'"]=function(e,t,a){if(e)return JS9.Keyboard.editregion(e,"background","source")},JS9.Keyboard.Actions["tag selected region as 'include'"]=function(e,t,a){if(e)return JS9.Keyboard.editregion(e,"include","exclude")},JS9.Keyboard.Actions["tag selected region as 'exclude'"]=function(e,t,a){if(e)return JS9.Keyboard.editregion(e,"exclude","include")},JS9.Keyboard.Actions["toggle full screen mode"]=function(e,t,a){var i=a.data;i.width===i.width0&&i.height===i.height0?i.resize("full",{center:!0}):i.resize("reset")},JS9.Keyboard.Actions["reset zoom"]=function(e,t,a){e&&e.setZoom("1")},JS9.Keyboard.Actions["zoom in"]=function(e,t,a){e&&e.setZoom("*2")},JS9.Keyboard.Actions["zoom out"]=function(e,t,a){e&&e.setZoom("/2")},JS9.Keyboard.Actions["display next image"]=function(e,t,a){e&&e.display.nextImage(1)},JS9.Keyboard.Actions["display previous image"]=function(e,t,a){e&&e.display.nextImage(-1)},JS9.Keyboard.Actions["open a local FITS file"]=function(e,t,a){JS9.OpenFileMenu({display:a.data})},JS9.Keyboard.Actions["save image as a FITS file"]=function(e,t,a){e&&e.saveFITS()},JS9.Keyboard.Actions["save image as a PNG file"]=function(e,t,a){e&&e.savePNG()},JS9.Keyboard.Actions["save regions as a text file"]=function(e,t,a){e&&e.saveRegions()},JS9.Keyboard.Actions["move region/position up"]=function(e,t,a){var i,s,r,n=1;a&&a.preventDefault(),e&&(JS9.specialKey(a)&&(n*=5),i=e.display.layers[s=e.layer||"regions"].canvas,(r=1===fabric.major_version?i.getActiveObject()||i.getActiveGroup():i.getActiveObject())&&e.changeShapes(s,"selected",{dy:n}),JS9.Keyboard.arrowKey(e,a,{x:0,y:-1*n},r),i.fire("mouse:up"))},JS9.Keyboard.Actions["move region/position down"]=function(e,t,a){var i,s,r,n=-1;a&&a.preventDefault(),e&&(JS9.specialKey(a)&&(n*=5),i=e.display.layers[s=e.layer||"regions"].canvas,(r=1===fabric.major_version?i.getActiveObject()||i.getActiveGroup():i.getActiveObject())&&e.changeShapes(s,"selected",{dy:n}),JS9.Keyboard.arrowKey(e,a,{x:0,y:-1*n},r),i.fire("mouse:up"))},JS9.Keyboard.Actions["move region/position left"]=function(e,t,a){var i,s,r,n=-1;a&&a.preventDefault(),e&&(JS9.specialKey(a)&&(n*=5),i=e.display.layers[s=e.layer||"regions"].canvas,(r=1===fabric.major_version?i.getActiveObject()||i.getActiveGroup():i.getActiveObject())&&e.changeShapes(s,"selected",{dx:n}),JS9.Keyboard.arrowKey(e,a,{x:n,y:0},r),i.fire("mouse:up"))},JS9.Keyboard.Actions["move region/position right"]=function(e,t,a){var i,s,r,n=1;a&&a.preventDefault(),e&&(JS9.specialKey(a)&&(n*=5),i=e.display.layers[s=e.layer||"regions"].canvas,(r=1===fabric.major_version?i.getActiveObject()||i.getActiveGroup():i.getActiveObject())&&e.changeShapes(s,"selected",{dx:n}),JS9.Keyboard.arrowKey(e,a,{x:n,y:0},r),i.fire("mouse:up"))},JS9.Keyboard.Actions["remove selected region"]=function(e,t,a){var i,s;a&&a.preventDefault(),e&&(i=e.display.layers[s=e.layer||"regions"].canvas,e.removeShapes(s,"selected"),e.display.clearMessage(s),i.fire("mouse:up"))},JS9.Keyboard.Actions["raise region layer to top"]=function(e,t,a){a&&a.preventDefault(),e&&e.activeShapeLayer("regions")},JS9.Keyboard.Actions["toggle active shape layers"]=function(e,t,a){a&&a.preventDefault(),e&&e.toggleShapeLayers()},JS9.Keyboard.Actions["send selected region to back"]=function(e,t,a){a&&a.preventDefault(),e&&e.changeShapes("regions","selected",{send:"back"})},JS9.Keyboard.Actions["copy selected region to clipboard"]=function(e,t,a){var i;if(e)return i=e.listRegions("selected",{mode:1}),JS9.CopyToClipboard(i,e),i},JS9.Keyboard.Actions["copy all regions to clipboard"]=function(e,t,a){var i;if(e)return i=e.listRegions("all",{mode:1}),JS9.CopyToClipboard(i,e),i},JS9.Keyboard.Actions["paste regions from local clipboard"]=function(e,t,a){return JS9.Regions.pasteFromClipboard.call(e,!1)},JS9.Keyboard.Actions["paste regions to current position"]=function(e,t,a){return JS9.Regions.pasteFromClipboard.call(e,!0)},JS9.Keyboard.Actions["undo remove of region(s)"]=function(e,t,a){e&&e.unremoveRegions()},JS9.Keyboard.Actions["select region"]=function(e,t,a){var i,s,r,n;if(e)for(n=(s=e.layers[e.layer||"regions"].canvas).getObjects(),i=0;i<n.length;i++)if(s.containsPoint(null,r=n[i],e.pos)){s.setActiveObject(r);break}},JS9.Keyboard.Actions["select all regions"]=function(e,t,a){var i,s;e&&1!==fabric.major_version&&(i=e.layers[e.layer||"regions"].canvas,s=new fabric.ActiveSelection(i.getObjects(),{canvas:i}),i.setActiveObject(s),i.renderAll())},JS9.Keyboard.Actions["refresh image"]=function(e,t,a){e&&(a&&a.preventDefault(),e.refreshImage())},JS9.Keyboard.Actions["display full image"]=function(e,t,a){e&&(a&&a.preventDefault(),e.displaySection("full"))},JS9.Keyboard.Actions["display selected cutouts"]=function(e,t,a){e&&(a&&a.preventDefault(),e.displaySection("selected"))},JS9.Keyboard.Actions["toggle coordinate grid"]=function(e,t,a){JS9.Grid.toggle(e)},JS9.Keyboard.Actions["toggle crosshair"]=function(e,t,a){e&&(a&&a.preventDefault(),e.params.crosshair=!e.params.crosshair,e.params.crosshair||JS9.Crosshair.hide(e))},JS9.Keyboard.Actions["toggle mouse/touch plugin"]=function(e,t,a){e&&e.display.displayPlugin("JS9MouseTouch")},JS9.Keyboard.Actions["toggle keyboard actions plugin"]=function(e,t,a){e&&e.display.displayPlugin("JS9Keyboard")},JS9.Keyboard.Actions["toggle preferences plugin"]=function(e,t,a){e&&e.display.displayPlugin("JS9Preferences")},JS9.Keyboard.Actions["toggle shape layers plugin"]=function(e,t,a){e&&e.display.displayPlugin("JS9Layers")},JS9.Keyboard.getAction=function(e,t){var a,i=JS9.eventToCharStr(t);return i&&(a=JS9.globalOpts.keyboardActions[i]),a},JS9.Keyboard.action=function(e,t,a,i){(i=i||JS9.Keyboard.getAction(e,a))&&JS9.Keyboard.Actions[i]&&(JS9.Keyboard.Actions[i](e,t,a),e&&JS9.globalOpts.extendedPlugins&&e.xeqPlugins("keypress","onkeyboardaction",a))},JS9.Keyboard.editregion=function(e,t,a){var i,s,r,n;if((r=e.getShapes("regions","selected")).length){for(i=0;i<r.length;i++){for(n=r[i].tags,s=0;s<n.length;s++){if(n[s]===t){t="";break}if(n[s]===a){n[s]=t,t="";break}}t&&n.push(t)}e.changeShapes("regions","selected",{tags:n})}},JS9.Keyboard.init=function(){var e,t;for(t in this.divjq.html(""),this.divjq.addClass("JS9PluginScrolling"),this.keyboardContainer=$("<div>").addClass(JS9.Keyboard.BASE+"Container").attr("id",this.id+"KeyboardContainer").appendTo(this.divjq),e=sprintf("<div class='%s'><b>Keys and their actions (or click the buttons):</b></div><p>",JS9.Keyboard.BASE+"Header"),this.keyboardHeadContainer=$("<div>").addClass(JS9.Keyboard.BASE+"Container").attr("id",this.id+"KeyboardHeadContainer").html(e).appendTo(this.keyboardContainer),this.keyboardActionContainer=$("<div>").addClass(JS9.Keyboard.BASE+"ActionContainer").attr("id",this.id+"ActionContainer").html("").appendTo(this.keyboardContainer),JS9.globalOpts.keyboardActions)JS9.globalOpts.keyboardActions.hasOwnProperty(t)&&JS9.Keyboard.addAction.call(this,this.keyboardActionContainer,t,e=JS9.globalOpts.keyboardActions[t])},JS9.RegisterPlugin(JS9.Keyboard.CLASS,JS9.Keyboard.NAME,JS9.Keyboard.init,{menuItem:"Keyboard Actions",onplugindisplay:JS9.Keyboard.init,help:"help/keyboard.html",winTitle:"Keyboard Actions",winResize:!0,winDims:[JS9.Keyboard.WIDTH,JS9.Keyboard.HEIGHT]}),JS9.Layers={},JS9.Layers.CLASS="JS9",JS9.Layers.NAME="Layers",JS9.Layers.WIDTH=460,JS9.Layers.HEIGHT=250,JS9.Layers.BASE=JS9.Layers.CLASS+JS9.Layers.NAME,JS9.Layers.headerHTML="Shape layers can be hidden or made visible below. The topmost visible layer in the stack is <b>active</b>: it responds to mouse and touch events. Move a layer to the top of the stack to make it active.",JS9.Layers.layerHTML="<span style='float: left'>$visible&nbsp;&nbsp;$save&nbsp;&nbsp;</span>&nbsp;&nbsp; <span class='JS9LayersSpan'>$layer&nbsp;&nbsp</span>",JS9.Layers.nolayersHTML='<p><span class="JS9NoLayers">[Layers will appear here as they are created]</span>',JS9.Layers.visibleHTML='<input class="JS9LayersVisibleCheck" type="checkbox" id="visible" name="visible" value="visible" onclick="javascript:JS9.Layers.xvisible(\'%s\', \'%s\', \'%s\', this)">visible',JS9.Layers.saveBothHTML='<select class="JS9LayersSaveBothSelect" onfocus="this.selectedIndex=0;" onchange="JS9.Layers.xsave(\'%s\', \'%s\', \'%s\', this)"><option selected disabled>save as ...</option><option value="catalog">catalog</option><option value="regions">regions</option><option value="svg">svg</option></select>',JS9.Layers.saveRegionsHTML='<select class="JS9LayersSaveSelect" onfocus="this.selectedIndex=0;" onchange="JS9.Layers.xsave(\'%s\', \'%s\', \'%s\', this)"><option selected disabled>save as ...</option><option value="regions">regions</option><option value="svg">svg</option></select>',JS9.Layers.layerNameHTML="<b>%s</b>",JS9.Layers.imid=function(e,t){return(e.display.id+"_"+e.id+"_"+t+"_").replace(/[^A-Za-z0-9_]/g,"_")+"Layer"},JS9.Layers.dispclass=function(e){return(JS9.Layers.BASE+"_"+e.display.id).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Layers.activeLayer=function(e,t){var a,i,s,r,n;if(e){if(1===(n=t.layersLayerContainer.sortable("toArray")).length&&!n[0])return;for(a=0;a<n.length;a++)n[a]=$("#"+n[a]).attr("layer");i=e.activeShapeLayer(n),s=JS9.Layers.imid(e,i),r=JS9.Layers.dispclass(e)+"_Layer",$("."+r).removeClass(JS9.Layers.BASE+"LayerActive").addClass(JS9.Layers.BASE+"LayerInactive"),$("#"+s).removeClass(JS9.Layers.BASE+"LayerInactive").addClass(JS9.Layers.BASE+"LayerActive")}},JS9.Layers.xvisible=function(e,t,a,i){var s=JS9.lookupImage(t,e);s&&(s.showShapeLayer(a,!!i.checked),JS9.Layers.activeLayer(s,s.display.pluginInstances[JS9.Layers.BASE],!0))},JS9.Layers.xsave=function(e,t,a,i){var s=JS9.lookupImage(t,e),r=i.options[i.selectedIndex].value;s&&("catalog"===r?s.saveCatalog(null,a):"regions"===r?s.saveRegions(null,null,a):"svg"===r&&s.saveRegions(null,null,{layer:a,type:"svg"}))},JS9.Layers.addLayer=function(e,t){var a,i,s,r,n,o,l,c,p,d=JS9.Layers.BASE+"Layer",h=[];e&&t&&e.layers[t]&&"main"===e.layers[t].dlayer.dtype&&(this.nlayer||this.layersLayerContainer.html(""),c=e.id,p=e.display.id,n=parseInt(e.display.layers[t].divjq.css("z-index"),10),s=JS9.Layers.imid(e,t),l=JS9.Layers.dispclass(e)+"_Layer",h.push({name:"imid",value:c}),h.push({name:"visible",value:sprintf(JS9.Layers.visibleHTML,p,c,t)}),h.push(e.layers[t].catalog?{name:"save",value:sprintf(JS9.Layers.saveBothHTML,p,c,t)}:{name:"save",value:sprintf(JS9.Layers.saveRegionsHTML,p,c,t)}),a=JS9.DEBUG>1?sprintf("%s layer [zindex: %s]",t,n):sprintf("%s layer",t),h.push({name:"layer",value:sprintf(JS9.Layers.layerNameHTML,a)}),i=JS9.Image.prototype.expandMacro.call(e,JS9.Layers.layerHTML,h),r=$("<div>").addClass(d).addClass(l).attr("id",s).attr("layer",t).prop("imid",c).html(i),this.nlayer?(this.layersLayerContainer.find("."+d).each(function(t,a){var i,s,l=$(a);o||(i=l.attr("layer"))&&(s=parseInt(e.display.layers[i].divjq.css("z-index"),10),Math.abs(n)>Math.abs(s)&&(r.insertBefore(l),o=!0))}),o||r.appendTo(this.layersLayerContainer)):r.appendTo(this.layersLayerContainer),r.find(".JS9LayersVisibleCheck").prop("checked",!!e.layers[t].show),this.nlayer++)},JS9.Layers.display=function(){this.lastimage!==this.display.image&&JS9.Layers.init.call(this)},JS9.Layers.close=function(){JS9.Layers.init.call(this,{mode:"clear"})},JS9.Layers.init=function(e){var t,a,i=this;if(e=e||{},this.divjq.html(""),this.nlayer=0,this.divjq.addClass("JS9PluginScrolling"),this.layersContainer=$("<div>").addClass(JS9.Layers.BASE+"Container").attr("id",this.id+"LayersContainer").css("overflow","auto").appendTo(this.divjq),this.layersHeader=$("<div>").addClass(JS9.Layers.BASE+"Header").attr("id",this.display.id+"Header").html(JS9.Layers.headerHTML).appendTo(this.layersContainer),this.layersLayerContainer=$("<div>").addClass(JS9.Layers.BASE+"LayerContainer").attr("id",this.id+"LayersLayerContainer").html(JS9.Layers.nolayersHTML).appendTo(this.layersContainer),"clear"!==e.mode){if(this.display.image){for(t in(a=this.display.image).layers)"crosshair"!==t&&a.layers.hasOwnProperty(t)&&JS9.Layers.addLayer.call(this,a,t);this.lastimage=a}this.layersLayerContainer.sortable({start:function(e,t){},stop:function(e,t){JS9.Layers.activeLayer(a,i)}}),JS9.Layers.activeLayer(a,this)}},JS9.RegisterPlugin(JS9.Layers.CLASS,JS9.Layers.NAME,JS9.Layers.init,{menuItem:"Shape Layers",onplugindisplay:JS9.Layers.init,onshapelayercreate:JS9.Layers.init,onshapelayershow:JS9.Layers.init,onshapelayeractive:JS9.Layers.init,onshapelayerhide:JS9.Layers.init,onimageload:JS9.Layers.init,onimagedisplay:JS9.Layers.display,onimageclose:JS9.Layers.close,help:"help/layers.html",winTitle:"Shape Layers",winResize:!0,winDims:[JS9.Layers.WIDTH,JS9.Layers.HEIGHT]}),JS9.Magnifier={},JS9.Magnifier.CLASS="JS9",JS9.Magnifier.NAME="Magnifier",JS9.Magnifier.WIDTH=JS9.WIDTH/2,JS9.Magnifier.HEIGHT=JS9.HEIGHT/2,JS9.Magnifier.SWIDTH=250,JS9.Magnifier.SHEIGHT=250,JS9.Magnifier.opts={originX:"left",originY:"top",hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,zoom:4,canvas:{selection:!1},tagcolors:{defcolor:"#00FF00"}},JS9.Magnifier.bcall=function(e,t,a){var i,s;switch((i=$(e).closest("div[class^=JS9PluginToolbar]").data("displayid"))?s=JS9.getImage(i):JS9.error("can't find display for cmd: "+t),s||JS9.error("can't find image for cmd: "+t),t){case"zoomMagnifier":arguments.length<3&&JS9.error("missing argument(s) for cmd: "+t);try{JS9.Magnifier.zoom(s,a)}catch(r){JS9.error("error calling zoomMagnifier()",r)}}},JS9.Magnifier.HTML="<span><button type='button' class='JS9Button' onClick='JS9.Magnifier.bcall(this, \"zoomMagnifier\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.Magnifier.bcall(this, \"zoomMagnifier\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.Magnifier.bcall(this, \"zoomMagnifier\", \""+JS9.Magnifier.opts.zoom+"\"); return false'>"+JS9.Magnifier.opts.zoom+"</button></span>",JS9.Magnifier.init=function(e,t){this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Magnifier.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.Magnifier.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.canvas=document.createElement("canvas"),this.canvasjq=$(this.canvas),this.canvasjq.addClass("JS9Magnifier"),this.canvasjq.css("z-index",JS9.ZINDEX),this.canvasjq.attr("width",this.width),this.canvasjq.attr("height",this.height),this.context=this.canvas.getContext("2d"),JS9.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1),this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq),this.display.newShapeLayer("magnifier",JS9.Magnifier.opts,this.divjq)},JS9.Magnifier.display=function(e,t){var a,i,s,r,n,o,l,c,p,d,h,g,u;e&&e.display.pluginInstances.JS9Magnifier&&"active"===e.display.pluginInstances.JS9Magnifier.status&&(e.clickState>0||e.clickState<-1||(e.magnifier||(e.magnifier={zoom:JS9.Magnifier.opts.zoom,posx:0,posy:0}),s=e.display.pluginInstances.JS9Magnifier,n=e.display.canvas,r=e.magnifier.zoom,c=Math.floor(s.width/r),p=Math.floor(s.height/r),t?(l=(a=e.imageToDisplayPos(t)).y-p/2,e.magnifier.posx=o=a.x-c/2,e.magnifier.posy=l):(o=e.magnifier.posx,l=e.magnifier.posy),d=0,h=0,g=s.canvas.width,u=s.canvas.height,o<0&&(c+=o,d-=o*r,g+=o*r,o=0),(i=o+c-n.width)>0&&(g=(c-=i)*r),l<0&&(p+=l,h-=l*r,u+=l*r,l=0),(i=l+p-n.height)>0&&(u=(p-=i)*r),s.context.clear(),s.context.drawImage(n,o,l,c,p,d,h,g,u),JS9.globalOpts.magnifierRegions&&e.display.layers&&e.display.layers.regions&&(n=e.display.layers.regions.canvas.getElement(),o*=fabric.devicePixelRatio,l*=fabric.devicePixelRatio,c*=fabric.devicePixelRatio,p*=fabric.devicePixelRatio,s.context.drawImage(n,o,l,c,p,d,h,g,u)),e.magnifier.boxid||(e.magnifier.boxid=e.addShapes("magnifier","box"),$(s.canvas).css("background-color","black")),e.magnifier.ozoom!==r&&(e.changeShapes("magnifier",e.magnifier.boxid,{left:s.width/2,top:s.height/2,width:r,height:r}),e.magnifier.ozoom=e.magnifier.zoom)))},JS9.Magnifier.zoom=function(e,t){var a,i,s;if(e&&e.magnifier){switch(i=(a=e.magnifier).zoom,t.charAt(0)){case"x":case"*":s=i*parseFloat(t.slice(1));break;case"/":s=i/parseFloat(t.slice(1));break;default:s=parseFloat(t)}(!s||s<1)&&(s=1),a.ozoom=a.zoom,a.zoom=s,JS9.Magnifier.display(e)}},JS9.Magnifier.clear=function(e){var t=e.display.pluginInstances.JS9Magnifier;return t&&e===e.display.image&&(t.context.clear(),e.removeShapes("magnifier","all"),e.magnifier.boxid=null,e.magnifier.ozoom=0,$(t.canvas).css("background-color","#E9E9E9")),e},JS9.RegisterPlugin(JS9.Magnifier.CLASS,JS9.Magnifier.NAME,JS9.Magnifier.init,{menuItem:"Magnifier",dynamicSelect:!0,toolbarSeparate:!1,toolbarHTML:JS9.Magnifier.HTML,onplugindisplay:JS9.Magnifier.display,onmousemove:JS9.Magnifier.display,onimagedisplay:JS9.Magnifier.display,onimageclose:JS9.Magnifier.clear,onimageclear:JS9.Magnifier.clear,winTitle:"Magnifier",winDims:[JS9.Magnifier.WIDTH,JS9.Magnifier.HEIGHT],divArgs:[JS9.Magnifier.SWIDTH,JS9.Magnifier.SHEIGHT]}),JS9.Mef={},JS9.Mef.CLASS="JS9",JS9.Mef.NAME="Mef",JS9.Mef.WIDTH=800,JS9.Mef.HEIGHT=240,JS9.Mef.BASE=JS9.Mef.CLASS+JS9.Mef.NAME,JS9.Mef.xseparate=function(e,t){var a=JS9.lookupDisplay(e);a&&(a.pluginInstances[JS9.Mef.BASE].separate=t.checked)},JS9.Mef.imid=function(e,t,a){var i=e.display.id+"_"+e.id;return a&&(i=i.replace(/\[[a-zA-Z0-9][a-zA-Z0-9_]*\]/g,"")),i.replace(/[^A-Za-z0-9_]/g,"_")+"_MefExtension_"+t},JS9.Mef.activeExtension=function(e,t){var a;e&&($("."+e.display.id+"_"+JS9.Mef.BASE+"Extension").removeClass(JS9.Mef.BASE+"ExtensionActive").addClass(JS9.Mef.BASE+"ExtensionInactive"),a=JS9.Mef.imid(e,t,!0),$("."+a).removeClass(JS9.Mef.BASE+"ExtensionInactive").addClass(JS9.Mef.BASE+"ExtensionActive"))},JS9.Mef.display=function(){this.lastimage!==this.display.image&&JS9.Mef.init.call(this)},JS9.Mef.close=function(){JS9.Mef.init.call(this,{mode:"clear"})},JS9.Mef.init=function(e){var t,a,i,s,r,n,o,l,c,p,d=this,h=function(e,t,r){var n,o,h="",g=!0;switch(e.type){case"image":e.naxes.length<2&&(g=!1);break;case"table":case"ascii":for(o=0;o<e.cols.length;o++)"X"!==(n=e.cols[o]).name&&"x"!==n.name||(h+="x"),"Y"!==n.name&&"y"!==n.name||(h+="y");"xy"!==h&&"yx"!==h&&(g=!1)}c=g?"<pre>&nbsp;&nbsp;"+t+"</pre>":"<pre>&nbsp;&nbsp;<span class='JS9MefStrike'><span>"+t+"</span></span></pre>",i=JS9.Mef.imid(a,r),s=JS9.Mef.imid(a,r,!0),p=a.display.id+"_"+JS9.Mef.BASE,l=$("<div>").addClass(s).addClass(p+"Extension").addClass(JS9.Mef.BASE+"Extension").addClass(JS9.Mef.BASE+"ExtensionInactive").attr("id",i).html(c).appendTo(d.mefContainer),g&&l.on("mousedown touchstart",function(){a.displayExtension(e.hdu,{separate:d.separate}),JS9.Mef.activeExtension(a,e.hdu)})};if(e=e||{},this.divjq.addClass("JS9PluginScrolling"),this.divjq.html(""),this.mefContainer=$("<div>").addClass(JS9.Mef.BASE+"Container").attr("id",this.id+"MefContainer").appendTo(this.divjq),void 0===this.separate&&(this.separate=!1),(a=this.display.image)&&"clear"!==e.mode)if(a.hdus){for(this.lastimage=a,n=sprintf("<div class='%s'><span><b>Click on a FITS HDU extension to display it:</b></span>",JS9.Mef.BASE+"Header"),o=JS9.Mef.imid(a,"Separate"),n+=sprintf('<span style="float: right"><input type="checkbox" id="%s" name="separate" value="separate" onclick="javascript:JS9.Mef.xseparate(\'%s\', this)"><b>Display each extension as a separate image</b></span></div>',o,this.display.id),this.mefContainer.html(n),t=0;t<a.hdus.length;t++)h(r=a.hdus[t],n=JS9.hdus2Str([r]).trim(),t);$("#"+o).prop("checked",this.separate),void 0!==a.raw.hdu.fits.extnum&&JS9.Mef.activeExtension(a,a.raw.hdu.fits.extnum)}else this.mefContainer.html("<p><center>No FITS HDU extensions are present in this image.</center>");else this.mefContainer.html("<p><center>FITS HDU extensions will be displayed here.</center>")},JS9.RegisterPlugin(JS9.Mef.CLASS,JS9.Mef.NAME,JS9.Mef.init,{menuItem:"Extensions",help:"help/mef.html",onplugindisplay:JS9.Mef.init,onimageload:JS9.Mef.init,onimagedisplay:JS9.Mef.display,onimageclose:JS9.Mef.close,winTitle:"Multi-Extension FITS",winResize:!0,winDims:[JS9.Mef.WIDTH,JS9.Mef.HEIGHT]}),JS9.Menubar={},JS9.Menubar.CLASS="JS9",JS9.Menubar.NAME="Menubar",JS9.Menubar.WIDTH=JS9.WIDTH||512,JS9.Menubar.HEIGHT="auto",JS9.Menubar.buttonOptsArr=[{name:"file",label:"File"},{name:"edit",label:"Edit"},{name:"view",label:"View"},{name:"zoom",label:"Zoom"},{name:"scale",label:"Scale"},{name:"color",label:"Color"},{name:"region",label:"Regions"},{name:"wcs",label:"WCS"},{name:"analysis",label:"Analysis"},{name:"help",label:"Help"}],JS9.Menubar.keyMap={"local file ...":"open local file","toggle: src/bkgd":"toggle selected region: source/background","crosshair for this image":"toggle crosshair","toggle: incl/excl":"toggle selected region: include/exclude","full image":"display full image","selected cutouts":"display selected cutouts","refreshed image":"refresh image","light window":"new JS9 light window","active shape layers":"toggle active shape layers","Keyboard Actions":"toggle keyboard actions plugin","Mouse/Touch":"toggle mouse/touch plugin",Preferences:"toggle preferences plugin","Shape Layers":"toggle shape layers plugin","edit selected":"edit selected region","copy selected":"copy selected region to clipboard",edit:"edit selected region","to back":"send selected region to back",copy:"copy selected region to clipboard","copy all":"copy all regions to clipboard","paste to region pos":"paste regions from local clipboard","paste to current pos":"paste regions to current position","undo remove":"undo remove of region(s)","copy wcs pos":"copy wcs position to clipboard","copy value/pos":"copy value and position to clipboard","zoom 1":"reset zoom","zoom in":"zoom in","zoom out":"zoom out"},JS9.menuButtonOptsArr&&(JS9.Menubar.buttonOptsArr=JS9.menuButtonOptsArr),JS9.Menubar.getDisplays=function(e,t){var a,i,s,r=[];if(e=e||"any",t=t||"",this.id.search(JS9.SUPERMENU)>=0&&!t.match(/^super_/)){if("all"!==e&&this.selectedDisplay){if($.inArray(this.selectedDisplay,JS9.displays)>=0)return[this.selectedDisplay];this.selectedDislay=null}if("*"===(i=(this.divjq.data("displays")||"*").split(","))[0])for(a=0;a<JS9.displays.length;a++)r.push(JS9.displays[a]);else for(a=0;a<i.length;a++)(s=JS9.lookupDisplay(i[a]))&&r.push(s)}else"*"===this.divjq.data("js9id")&&r.push(JS9.getDynamicDisplayOr(JS9.displays[0]));return r.length||r.push(this.display),r},JS9.Menubar.onclick=function(e){var t,a,i;for("string"==typeof e&&"all"!==e&&(e=JS9.lookupDisplay(e)),t=0;t<JS9.supermenus.length;t++)a=JS9.Menubar.getDisplays.call(i=JS9.supermenus[t],"all"),($.inArray(e,a)>=0||"all"===e)&&(JS9.bugs.webkit_resize?$(".JS9").find(".JS9Image").removeClass("JS9Highlight"):$(".JS9").removeClass("JS9Highlight"),e===i.selectedDisplay||"all"===e?i.selectedDisplay=null:(i.selectedDisplay=e,JS9.bugs.webkit_resize?$(e.divjq).find(".JS9Image").addClass("JS9Highlight"):$(e.divjq).addClass("JS9Highlight")))},JS9.Menubar.reset=function(e){JS9.Menubar.rkeyMap=null},JS9.Menubar.createMenus=function(){var e=this,t=function(e,t,a){var i;window.hasOwnProperty("Jupyter")?(i=this.offset(),e.$menu.css({left:i.left+20,top:i.top+10})):e.$menu.position({my:"left top",at:"right-5 bottom-5",of:e.$trigger,collision:"fit"})},a=function(){var t=e.display;JS9.bugs.hide_menu&&t.image&&t.image.displayImage("rgb")},i=function(e,t){var a,i={name:e},s=JS9.globalOpts.keyboardActions,r=JS9.Menubar.keyMap[e];if(!JS9.Menubar.rkeyMap){for(a in JS9.Menubar.rkeyMap={},s)s.hasOwnProperty(a)&&(JS9.Menubar.rkeyMap[s[a]]=a);JS9.Menubar.keyActions=$.extend(!0,{},s)}if(JS9.notNull(r)&&JS9.Menubar.rkeyMap)(a=JS9.Menubar.rkeyMap[r])&&(i={name:"<span>"+e+" <span style='float:right;font:bold 10pt Courier;'>&nbsp;&nbsp;&nbsp;"+a+"</span></span>",isHtmlName:!0});else if(t&&JS9.Menubar.rkeyMap)for(r in JS9.Menubar.rkeyMap)JS9.Menubar.rkeyMap.hasOwnProperty(r)&&r===t&&(a=JS9.Menubar.rkeyMap[r])&&(i={name:"<span>"+e+" <span style='float:right;font:bold 10pt Courier;'>&nbsp;&nbsp;&nbsp;"+a+"</span></span>",isHtmlName:!0});return i},s=function(t){var a=t.data;t.preventDefault(),$("#"+a.name+"UserMenu"+e.id).contextMenu()},r=function(s){s&&s.name&&s.title&&s.options&&$.contextMenu({selector:"#"+s.name+"UserMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,r,n={};for(t=0;t<s.options.length;t++)r=i((a=s.options[t]).name,a.shortcut),n[a.name]=a.image?{name:"<div class='JS9MenubarUserImage'><img src='"+a.image+"' alt='"+a.name+"' class='JS9MenubarUserImage' >&nbsp;&nbsp;"+r.name+"</div>",isHtmlName:!0}:r;return{callback:function(t,i){JS9.Menubar.getDisplays.call(e).forEach(function(e){var r,n,o,l=e;for(r=0;r<s.options.length;r++)t===(a=s.options[r]).name&&("function"==typeof JS9.publics[a.cmd]?((n=JSON.parse(JSON.stringify(a.args||[]))).push({display:l}),JS9.publics[a.cmd].apply(null,n),!1!==a.updateTitle&&(a.image&&s.updateTitle&&!1!==a.updateTitle&&s.updateTitle.match(/(both|image)/)?("both"===s.updateTitle?o="<div style='white-space:nowrap;'><img src='"+a.image+"' alt='"+a.name+"' class='JS9MenubarUserImage' >&nbsp;&nbsp;"+a.name+"</div>":"image"===s.updateTitle&&(o="<div style='white-space:nowrap;'><img src='"+a.image+"' alt='"+a.name+"' class='JS9MenubarUserImage' ></div>"),$(i.selector).html(o)):s.updateTitle&&a.name&&$(i.selector).text(a.name))):JS9.error("unknown function for user menubar: "+s.cmd))})},items:n}}})};$("#fileMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#fileMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#fileMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n,o,l,c,p=0,d={},h=JS9.Menubar.getDisplays.call(e)[0],g=h.image,u=JS9.images.length;for(t=0,l=0;t<u;t++)(s=JS9.images[t]).display===h&&l++;for((!l||l>=JS9.globalOpts.imagesFileSubmenu)&&(d.filetitle={name:"Files and Displays:",disabled:!0}),l&&l<JS9.globalOpts.imagesFileSubmenu?(d.imagestitle={name:"Images:",disabled:!0},c=d):l&&(d.images={name:"images ...",items:{imagestitle:{name:"display this image:",disabled:!0}}},c=d.images.items),t=0;t<u;t++)(s=JS9.images[t]).display===h&&(r=s.id,JS9.globalOpts.rgb.active&&(s===JS9.globalOpts.rgb.rim&&(r+=" (red)"),s===JS9.globalOpts.rgb.gim&&(r+=" (green)"),s===JS9.globalOpts.rgb.bim&&(r+=" (blue)")),c[r]=i(r),h.image&&h.image.id===s.id&&(c[r].icon="sun"));if(l&&l<JS9.globalOpts.imagesFileSubmenu&&(d["sep"+p++]="------",d.filetitle={name:"Files and Displays:",disabled:!0}),d.opens={name:"open ...",items:{openstitle:{name:"open:",disabled:!0}}},d.opens.items.open=i("local file ..."),d.opens.items.loadproxy=i("url via proxy ..."),d.opens.items.loadproxy.disabled=!(!JS9.allinone&&"none"!==JS9.globalOpts.helperType&&JS9.globalOpts.workDir&&JS9.globalOpts.loadProxy),d.opens.items.loadcors=i("url via CORS ..."),d.opens.items.loadcors.disabled=!!window.hasOwnProperty("Jupyter"),d.disps={name:"display ...",items:{dispstitle:{name:"display:",disabled:!0}}},d.disps.items.header=i("FITS header"),d.disps.items.hdus=i("FITS HDUs"),g||(d.disps.items.header.disabled=!0),g&&g.hdus||(d.disps.items.hdus.disabled=!0),d.disps.items.refresh=i("refreshed image"),d.disps.items.full=i("full image"),d.disps.items.cutout=i("selected cutouts"),d.disps.items.pageid=i("page id"),g&&g.raw&&g.raw.hdu&&g.raw.hdu.fits||(d.disps.items.refresh.disabled=!0,d.disps.items.full.disabled=!0,d.disps.items.cutout.disabled=!0),d.moveto={name:"move ...",items:{movetotitle:{name:"move to this display:",disabled:!0}}},g){for(d.moveto.disabled=!1,t=0;t<JS9.displays.length;t++)$("#"+JS9.displays[t].id).length>0&&h!==JS9.displays[t]&&(d.moveto.items["moveto_"+JS9.displays[t].id]=i(JS9.displays[t].id));d.moveto.items.moveto_newdisp=i("a new display")}else d.moveto.disabled=!0;if(d.saveas={name:"save ...",items:{saveastitle:{name:"choose output format:",disabled:!0},savefits:i("FITS"),savejpeg:i("JPEG"),savepng:i("PNG")}},g||(d.saveas.disabled=!0),d.separates={name:"separate ...",items:{}},d.separates.items.separate=i("separate these images"),d.separates.items.gather=i("gather all images here"),g||(d.separates.disabled=!0),d.syncs={name:"sync ...",items:{syncstitle:{name:"sync/unsync images:",disabled:!0}}},d.syncs.items.sync={name:"sync images ...",items:{}},d.syncs.items.unsync={name:"unsync images ...",items:{}},g){for(d.syncs.items.sync.disabled=!1,d.syncs.items.sync.items.sync_opstitle={name:"op(s) that trigger syncing:",disabled:!0},d.syncs.items.sync.items.syncops={value:JS9.globalOpts.syncOps,type:"textarea"},d.syncs.items.sync.items.syncreciprocate={name:"reciprocal syncing",selected:JS9.globalOpts.syncReciprocate,type:"checkbox"},d.syncs.items.sync.items["sep"+p++]="------",d.syncs.items.sync.items.title={name:"image(s) to keep in sync:",disabled:!0},t=0;t<JS9.images.length;t++)g!==JS9.images[t]&&(d.syncs.items.sync.items["sync_"+JS9.images[t].id]=i(JS9.images[t].id));for(d.syncs.items.sync.items.sync_allimages=i("all images"),d.syncs.items.unsync.disabled=!1,d.syncs.items.unsync.items.unsync_opstitle={name:"op(s) to unsync:",disabled:!0},d.syncs.items.unsync.items.unsyncops={value:JS9.globalOpts.syncOps,type:"textarea"},d.syncs.items.unsync.items.unsyncreciprocate={name:"unsync reciprocals",selected:JS9.globalOpts.syncReciprocate,type:"checkbox"},d.syncs.items.unsync.items["sep"+p++]="------",d.syncs.items.unsync.items.title={name:"image(s) to unsync:",disabled:!0},t=0;t<JS9.images.length;t++)g!==JS9.images[t]&&(d.syncs.items.unsync.items["unsync_"+JS9.images[t].id]=i(JS9.images[t].id));d.syncs.items.unsync.items.unsync_allimages=i("all images")}else d.syncs.disabled=!0,d.syncs.items.sync.disabled=!0,d.syncs.items.unsync.disabled=!0;if(d.closes={name:"close ...",items:{closestitle:{name:"close:",disabled:!0}}},g||(d.closes.disabled=!0),d.closes.items.close=i("this image"),d.closes.items.closeall=i("all images"),d.closes.items.free=i("this image's memory"),d.closes.items.removeproxy=i("proxy file"),g&&g.raw&&g.raw.hdu&&g.raw.hdu.fits||(d.closes.items.free.disabled=!0),g&&g.proxyFile||(d.closes.items.removeproxy.disabled=!0),d.catalogs={name:"catalog ...",items:{}},g||(d.catalogs.disabled=!0),d.catalogs.items.loadcatalog=i("load ..."),d.catalogs.items.savecatalog=i("save active"),d.createmosaic={name:"mosaic ...",items:{createmosaictitle:{name:"create a mosaic using:",disabled:!0},mosaiccurrent:i("images in the current file"),mosaicdisplay:i("images in this display")}},g||(d.createmosaic.disabled=!0),d.sessions={name:"session ...",items:{}},d.sessions.items.loadsession=i("load ..."),d.sessions.items.savesession={name:"save ...",items:{savesessiontitle:{name:"include these images:",disabled:!0},savecurrent:i("the current image"),savedisplay:i("all images in this display")}},d.windows={name:"window ...",items:{windowstitle:{name:"create a new:",disabled:!0}}},d.windows.items.lite=i("light window"),d.windows.items.xnew=i("separate window"),window.isElectron&&(d.windows.items.xnew.disabled=!0),window.isElectron&&window.electronIPC&&(d.electronHelper=i("connect to JS9 helper"),JS9.helper.connected&&(d.electronHelper.disabled=!0)),e.issuper){for(n=JS9.Menubar.getDisplays.call(e,"all"),d.supermenu={name:"supermenu ...",items:{supertitle:{name:"target this display:",disabled:!0}}},t=0,a=0;t<n.length;t++)d.supermenu.items["super_"+(r=(o=n[t]).id)]=i(r),e.selectedDisplay===o&&(d.supermenu.items["super_"+r].icon="sun",a++);d.supermenu.items.super_all=i(r="all displays"),a||(d.supermenu.items.super_all.icon="sun")}return d["sep"+p++]="------",d.print=i("print ..."),g||(d.print.disabled=!0),window.isElectron&&window.electronIPC&&(d.windowPrint=i("print window ..."),d.windowPDF=i("save window to pdf")),{callback:function(t,a){JS9.Menubar.getDisplays.call(e,"any",t).forEach(function(i){var s,r,n,o,l,c,p,d,h,g,u=i,m=u.image;if(!($.inArray(u,JS9.displays)<0))switch(t){case"refresh":m&&m.raw.hdu&&m.raw.hdu.fits&&m.refreshImage();break;case"full":m&&m.raw.hdu&&m.raw.hdu.fits&&m.displaySection("full");break;case"cutout":m&&m.raw.hdu&&m.raw.hdu.fits&&m.displaySection("selected");break;case"free":m&&m.raw.hdu&&m.raw.hdu.fits&&JS9.cleanupFITSFile(m.raw.hdu.fits,!0);break;case"close":m&&m.closeImage();break;case"closeall":u&&JS9.CloseDisplay(u.id);break;case"removeproxy":m&&m.removeProxyFile();break;case"savecurrent":u&&m&&JS9.SaveSession({mode:"image"},{display:u});break;case"savedisplay":u&&JS9.SaveSession({mode:"display"},{display:u});break;case"loadsession":u&&JS9.OpenSessionMenu({display:u});break;case"loadcatalog":u&&JS9.OpenCatalogsMenu({display:u});break;case"savecatalog":m&&m.saveCatalog();break;case"mosaiccurrent":u&&m&&JS9.CreateMosaic("current",{display:u});break;case"mosaicdisplay":u&&JS9.CreateMosaic("all",{display:u});break;case"header":m&&(m.raw.header?m.displayAnalysis("text",JS9.raw2FITS(m.raw,{addcr:!0}),{title:"FITS Header: "+m.id}):JS9.error("no FITS header for "+m.id));break;case"hdus":m&&(m.hdus?m.displayAnalysis("text",JS9.hdus2Str(m.hdus),{title:"FITS HDUs: "+m.id,winformat:"width=800px,height=200px,center=1,resize=1,scrolling=1"}):JS9.error("no FITS header for "+m.id));break;case"lite":JS9.LoadWindow(null,{clone:u.id},"light");break;case"xnew":JS9.LoadWindow(null,null,"new");break;case"electronHelper":if(window.isElectron&&window.electronIPC)try{window.electronIPC.send("msg","startHelper")}catch(f){}break;case"pageid":r=sprintf("<center><p>pageid: %s</center>",JS9.helper.pageid||"none"),n="JS9 page id",n+=sprintf(JS9.IDFMT,u.id),JS9.lightWin("fileid"+JS9.uniqueID(),"inline",r,n,JS9.lightOpts[JS9.LIGHTWIN].lineWin);break;case"open":JS9.OpenFileMenu({display:u});break;case"loadcors":o=JS9.Image.prototype.displayAnalysis.call(null,"textline",JS9.allinone?JS9.allinone.loadCorsHTML:JS9.InstallDir(JS9.globalOpts.corsURL),{title:"Open a shared CORS link"}),$(o).data("dispid",u.id);break;case"loadproxy":o=JS9.Image.prototype.displayAnalysis.call(null,"textline",JS9.InstallDir(JS9.globalOpts.proxyURL),{title:"Open a link via server proxy"}),$(o).data("dispid",u.id).data("aname","loadproxy");break;case"savefits":m&&(r=m.id.replace(/\.png/i,".fits").replace(/\.gz$/i,"").replace(/\[.*\]/,""),m.saveFITS(r));break;case"savepng":m&&(r=m.id.replace(/\.fit[s]?/i,".png").replace(/\.gz$/i,"").replace(/\[.*\]/,""),m.savePNG(r));break;case"savejpeg":m&&(r=m.id.replace(/\.fit[s]?/i,".jpeg").replace(/\.png$/i,".jpeg").replace(/\.gz$/i,"").replace(/\[.*\]/,""),m.saveJPEG(r));break;case"print":m&&m.print();break;case"windowPrint":window.isElectron&&window.electronIPC&&JS9.WindowPrint();break;case"windowPDF":window.isElectron&&window.electronIPC&&JS9.WindowToPDF();break;case"separate":u&&u.separate();break;case"gather":u&&(e.id.search(JS9.SUPERMENU)>=0&&!e.selectedDisplay&&JS9.error("gather requires a selected display"),u.gather());break;default:if(t.match(/^super_/))return c=t.replace(/^super_/,""),void JS9.Menubar.onclick.call(e,c);if(t.match(/^moveto_/))return void("newdisp"===(c=t.replace(/^moveto_/,""))?(p="JS9_light"+JS9.uniqueID(),$("#dhtmlwindowholder").arrive("#"+p,{onceOnly:!0},function(){m.moveToDisplay(p)}),JS9.LoadWindow(null,{id:p,clone:u.id},"light")):m.moveToDisplay(c));if(m&&t.match(/^sync_/))return h=(d=$.contextMenu.getInputValues(a)).syncops?d.syncops.trim().split(","):null,g={reciprocate:d.syncreciprocate},c=t.replace(/^sync_/,""),void m.syncImages(h,"allimages"===c?null:[c],g);if(m&&t.match(/^unsync_/))return h=(d=$.contextMenu.getInputValues(a)).unsyncops?d.unsyncops.trim().split(","):null,g={reciprocate:d.syncreciprocate},c=t.replace(/^unsync_/,""),void m.unsyncImages(h,"allimages"===c?null:[c],g);for(s=0;s<JS9.images.length;s++)if(m=JS9.images[s],l=t.replace(/ *\((red|green|blue)\)/,""),u.id===m.display.id&&m.id===l){m.displayImage("all"),m.refreshLayers(),u.clearMessage();break}}})},items:d}}}),$("#editMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#editMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#editMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t=0,a={edittitle1:{name:"Regions:",disabled:!0}};return a.configSelReg=i("edit selected"),a.copySelReg=i("copy selected"),a.copyAllReg=i("copy all"),a.pasteReg=i("paste to region pos"),a.pastePos=i("paste to current pos"),a.undoRemove=i("undo remove"),a["sep"+t++]="------",a.edittitle2={name:"Position/Value:",disabled:!0},a.copyWCSPos=i("copy wcs pos"),a.copyValPos=i("copy value/pos"),{callback:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a,i,s,r=e.image;if(!($.inArray(e,JS9.displays)<0))switch(t){case"copyAllReg":r&&(a=r.listRegions("all",{mode:1}),JS9.CopyToClipboard(a));break;case"copySelReg":r&&(a=r.listRegions("selected",{mode:1}),JS9.CopyToClipboard(a));break;case"configSelReg":r&&(i=r.layers.regions)&&(s=i.canvas.getActiveObject(),JS9.Regions.displayConfigForm.call(r,s));break;case"pasteReg":r&&JS9.Regions.pasteFromClipboard.call(r);break;case"pastePos":r&&JS9.Regions.pasteFromClipboard.call(r,!0);break;case"undoRemove":r&&r.unremoveRegions();break;case"copyWCSPos":JS9.hasOwnProperty("Keyboard")&&JS9.Keyboard.Actions["copy wcs position to clipboard"](r,r.ipos);break;case"copyValPos":JS9.hasOwnProperty("Keyboard")&&JS9.Keyboard.Actions["copy value and position to clipboard"](r,r.ipos)}})},items:a}}}),$("#viewMacMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#viewMacMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#viewMacMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,i={edittitle1:{name:"View:",disabled:!0}};for(t=0;t<e.macmenus.length;t++)i[(a=e.macmenus[t]).name]={name:a.title+" ..."};return{callback:function(t){$("#"+t+"Menu"+e.id).contextMenu()},items:i}}}),$("#viewMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#viewMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#viewMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n,o="",l=0,c={},p=JS9.Menubar.getDisplays.call(e)[0],d=p.image,h=function(e,t){var a,i,s;if(delete p.tmp.editingMenu,t.resize)switch((s=t.resize.split(/[\s,\/]+/)).length){case 0:break;case 1:d?(a=d.wcs2imlen(s[0]),e.resize(a,a)):JS9.isNumber(s[0])&&(a=parseInt(s[0],10),e.resize(a,a));break;default:d&&d.wcs?(a=d.wcs2imlen(s[0]),i=d.wcs2imlen(s[1]),e.resize(a,i)):JS9.isNumber(s[0])&&JS9.isNumber(s[1])&&(a=parseInt(s[0],10),i=parseInt(s[1],10),e.resize(a,i))}};for(c["sep"+l++]={name:"Plugins:"},c["sep"+(l-1)].disabled=!0,t=0;t<JS9.plugins.length;t++)s=(a=JS9.plugins[t]).name,a.opts.menuItem&&"view"===a.opts.menu&&((r=p.pluginInstances[s])&&!r.winHandle||(a.xclass!==o&&(l+=1),o=a.xclass,c[s]=i(a.opts.menuItem),r&&"active"===r.status&&(c[s].icon="sun")));if(c["sep"+l++]="------",c.vdispstitle={name:"Display Options:",disabled:!0},c.vdisps={name:"show ...",items:{vdispstitle:{name:"show options:",disabled:!0}}},c.vdisps.items.valpos=i("value/position"),JS9.hasOwnProperty("Info")?p.image&&p.image.params.valpos&&(c.vdisps.items.valpos.icon="sun"):c.vdisps.items.valpos.disabled=!0,c.vdisps.items.toggleLayers=i("active shape layers"),d&&!d.toggleLayers&&(c.vdisps.items.toggleLayers.icon="sun"),c.vdisps.items.xhair=i("crosshair for this image"),JS9.hasOwnProperty("Crosshair")&&d?d&&d.params.crosshair&&(c.vdisps.items.xhair.icon="sun"):c.vdisps.items.xhair.disabled=!0,c.vdisps.items.xhairwcs=i("match wcs crosshairs"),JS9.hasOwnProperty("Crosshair")?JS9.globalOpts.wcsCrosshair&&(c.vdisps.items.xhairwcs.icon="sun"):c.vdisps.items.xhairwcs.disabled=!0,c.vdisps.items.toolbar=i("toolbar tooltips"),JS9.hasOwnProperty("Toolbar")?JS9.GetToolbar("showTooltips")&&(c.vdisps.items.toolbar.icon="sun"):c.vdisps.items.toolbar.disabled=!0,JS9.allinone||(c.vdisps.items.logo=i("js9 logo"),JS9.globalOpts.logoDisplay&&(c.vdisps.items.logo.icon="sun")),c.vdisps.items.inherit=i("new images inherit current params"),p.image&&p.image.params.inherit&&(c.vdisps.items.inherit.icon="sun"),c.vdisps.items.rawlayer={name:"raw data sources ...",items:{}},d&&d.raws.length>1){for(c.vdisps.items.rawlayer.items.whichrawtitle={name:"current raw data:"},t=0;t<d.raws.length;t++)c.vdisps.items.rawlayer.items[n="rawlayer_"+d.raws[t].id]={name:d.raws[t].id},d.raw===d.raws[t]&&(c.vdisps.items.rawlayer.items[n].icon="sun");c.vdisps.items.rawlayer.items["sep"+l++]="------",c.vdisps.items.rawlayer.items.rawlayer_remove=i("remove")}else c.vdisps.items.rawlayer.disabled=!0;return c.resizes={name:"resize ...",items:{resizestitle:{name:"resize the display:",disabled:!0}}},c.resizes.items.resize={events:{keyup:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:h(s,a);break;default:s.tmp.editingMenu=!0}})}},name:"change width/height:",type:"text"},c.resizes.items.imagesize=i("set to image size"),c.resizes.items.fullsize=i("set size to full window"),c.resizes.items.resetsize=i("reset to original size"),JS9.globalOpts.resize?d||(c.resizes.items.imagesize.disabled=!0):(c.resizes.items.resize.disabled=!0,c.resizes.items.fullsize.disabled=!0,c.resizes.items.imagesize.disabled=!0,c.resizes.items.resetsize.disabled=!0),{callback:function(a){JS9.Menubar.getDisplays.call(e).forEach(function(e){var i,s,r,n=e,o=n.image;if(!($.inArray(n,JS9.displays)<0))switch(a){case"valpos":o&&o.toggleValpos();break;case"xhair":o&&o.toggleCrosshair();break;case"xhairwcs":o&&o.toggleWCSCrosshair();break;case"toolbar":r=!JS9.GetToolbar("showTooltips"),JS9.SetToolbar("showTooltips",r);break;case"logo":for(JS9.globalOpts.logoDisplay=!JS9.globalOpts.logoDisplay,r=JS9.globalOpts.logoDisplay?"block":"none",i=0;i<JS9.displays.length;i++)JS9.displays[i].iconjq.css("display",r);break;case"toggleLayers":o&&o.toggleShapeLayers();break;case"inherit":o&&(o.params.inherit=!o.params.inherit);break;case"fullsize":n.resize("full",{center:!0});break;case"imagesize":n.resize("image");break;case"resetsize":n.resize("reset");break;default:for(i=0;i<JS9.plugins.length;i++)if((s=JS9.plugins[i]).name===a)return void n.displayPlugin(s);if(d&&a.match(/^rawlayer_/))if("remove"===(r=a.replace(/^rawlayer_/,""))){if(d.raw.id!==JS9.RAWID0)for(t=0;t<d.raws.length;t++)d.raw===d.raws[t]&&d.rawDataLayer(d.raw.id,"remove")}else d.rawDataLayer(r)}})},events:{show:function(t){var a=e.display,i={};a&&(i.resize=sprintf("%d %d",a.width,a.height),$.contextMenu.setInputValues(t,i),JS9.jupyterFocus(".context-menu-item"))},hide:function(t){var a,i=e.display;i&&i.tmp.editingMenu&&(a=$.contextMenu.getInputValues(t),h(i,a))}},items:c}}}),$("#zoomMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#zoomMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#zoomMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n,o,l=0,c=JS9.Menubar.getDisplays.call(e)[0],p=c.image,d=function(e,t){delete c.tmp.editingMenu,isNaN(t.zoom)||e.setZoom(t.zoom)},h={zoomtitle:{name:"Zoom Factors:",disabled:!0}};for(t=JS9.imageOpts.zooms;t>=1;t--)a=Math.pow(2,-t),s=Math.pow(2,t),r=sprintf("zoom%s",a),n=sprintf("zoom 1/%s",s),h[r]=i(n),p&&p.rgb.sect.zoom===a&&(h[r].icon="sun");for(t=0;t<=JS9.imageOpts.zooms;t++)a=Math.pow(2,t),r=sprintf("zoom%s",a),n=sprintf("zoom %s",a),h[r]=i(n),p&&p.rgb.sect.zoom===a&&(h[r].icon="sun");for(h.zoom={events:{keyup:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:r&&d(r,a);break;default:s.tmp.editingMenu=!0}})}},name:"other zoom:",type:"text"},h["sep"+l++]="------",h.zoomiotitle={name:"Zoom In/Out:",disabled:!0},h.zoomIn=i("zoom in"),h.zoomOut=i("zoom out"),h.zoomToFit=i("zoom to fit"),h["sep"+l++]="------",h.panzoomtitle={name:"Pand and Zoom:",disabled:!0},h.center=i("pan to center"),h.alignpanzoom={name:"align pan/zoom ...",items:{alignpanzoomtitle:{name:"to this image:",disabled:!0}}},t=0,o=0;t<JS9.images.length;t++)if(JS9.images[t].raw.wcs){if(p===JS9.images[t]&&e.id.search(JS9.SUPERMENU)<0)continue;h.alignpanzoom.items["alignpanzoom_"+JS9.images[t].id]={name:JS9.images[t].id},o++}return 0===o?h.alignpanzoom.items.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}}:h.alignpanzoom.disabled=!1,h.reset=i("reset pan/zoom"),{callback:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=e.image;if(!($.inArray(e,JS9.displays)<0)&&a)switch(t){case"zoomIn":a.setZoom("x2");break;case"zoomOut":a.setZoom("/2");break;case"zoomToFit":a.setZoom("tofit");break;case"center":a.setPan();break;case"reset":a.setZoom("1"),a.setPan();break;default:t.match(/^zoom/)?a.setZoom(t.slice(4)):t.match(/^alignpanzoom_/)&&a.alignPanZoom(t.slice(13))}})},events:{show:function(t){var a=e.display.image,i={};a&&(i.zoom=String(a.rgb.sect.zoom)),$.contextMenu.setInputValues(t,i),JS9.jupyterFocus(".context-menu-item")},hide:function(t){var a,i=e.display,s=i.image;s&&i.tmp.editingMenu&&(a=$.contextMenu.getInputValues(t),d(s,a))}},items:h}}}),$("#scaleMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#scaleMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#scaleMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n,o="",l=0,c={},p=JS9.Menubar.getDisplays.call(e)[0],d=function(e,t){var a=e.params.scalemin,i=e.params.scalemax;delete p.tmp.editingMenu,JS9.isNumber(t.scalemin)&&(a=parseFloat(t.scalemin)),JS9.isNumber(t.scalemax)&&(i=parseFloat(t.scalemax)),e.setScale(a,i),e.displayImage("colors")},h=function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:r&&d(r,a);break;default:s.tmp.editingMenu=!0}})};for(c.scaletitle={name:"Scaling Algorithms:",disabled:!0},t=0;t<JS9.scales.length;t++)c[a=JS9.scales[t]]=i(a),p.image&&p.image.params.scale===a&&(c[a].icon="sun");for(c["sep"+l++]="------",c.scalelims={name:"Data Limits:",disabled:!0},c.scalemin={events:{keyup:h},name:"low:",type:"text"},c.scalemax={events:{keyup:h},name:"high:",type:"text"},c["sep"+l++]="------",t=0;t<JS9.plugins.length;t++)r=(s=JS9.plugins[t]).name,s.opts.menuItem&&"scale"===s.opts.menu&&((n=p.pluginInstances[r])&&!n.winHandle||(s.xclass!==o&&(l+=1),o=s.xclass,c[r]=i(s.opts.menuItem),n&&"active"===n.status&&(c[r].icon="sun")));return{callback:function(t){var a,i;JS9.Menubar.getDisplays.call(e).forEach(function(e){var s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0)&&r){for(a=0;a<JS9.plugins.length;a++)if((i=JS9.plugins[a]).name===t)return void s.displayPlugin(i);r.setScale(t)}})},events:{show:function(t){var a=e.display.image,i={};a&&(i.scalemin=JS9.floatToString(a.params.scalemin),i.scalemax=JS9.floatToString(a.params.scalemax)),$.contextMenu.setInputValues(t,i),JS9.jupyterFocus(".context-menu-item")},hide:function(t){var a,i=e.display,s=i.image;s&&i.tmp.editingMenu&&(a=$.contextMenu.getInputValues(t),d(s,a))}},items:c}}}),$("#colorMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#colorMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#colorMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r=0,n={},o=JS9.Menubar.getDisplays.call(e)[0],l=function(e,t){delete o.tmp.editingMenu,t.contrast&&!isNaN(t.contrast)&&(e.params.contrast=parseFloat(t.contrast)),t.bias&&!isNaN(t.bias)&&(e.params.bias=parseFloat(t.bias)),isNaN(t.opacity)||(e.params.opacity=""!==t.opacity?parseFloat(t.opacity):1),e.displayImage("colors")},c=function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:l(r,a);break;default:s.tmp.editingMenu=!0}})};for(n.cmaptitle={name:"Colormaps:",disabled:!0},t=0;t<JS9.globalOpts.topColormaps.length;t++)n[a=JS9.globalOpts.topColormaps[t]]=i(a),o.image&&o.image.cmapObj.name===a&&(n[a].icon="sun");for(n.morecmaps={name:"more colormaps ...",items:{morecmapstitle:{name:"Colormaps:",disabled:!0}}},t=0;t<JS9.colormaps.length;t++)-1===JS9.globalOpts.topColormaps.indexOf(a=JS9.colormaps[t].name)&&(n.morecmaps.items[a]=i(a),o.image&&o.image.cmapObj.name===a&&(n.morecmaps.items[a].icon="sun"));for(n["sep"+r++]="------",n.imfilter={name:"image filters",items:{imfiltertitle:{name:"adjust colors using:",disabled:!0}}},s=JS9.Image.prototype.filterRGBImage.call(null).sort(),t=0;t<s.length;t++)"convolve"!==s[t]&&(n.imfilter.items[a="imfilter_"+s[t]]={name:s[t]});return n["sep"+r++]="------",n.contrast={events:{keyup:c},name:"contrast:",type:"text"},n.bias={events:{keyup:c},name:"bias:",type:"text"},n.opacity={events:{keyup:c},name:"opacity:",type:"text"},n.reset=i("reset contrast/bias"),n["sep"+r++]="------",n.loadcmap=i("load ..."),n.savecmap=i("save"),n["sep"+r++]="------",n.invert=i("invert"),o.image&&o.image.params.invert&&(n.invert.icon="sun"),n.rgb=i("rgb mode"),JS9.globalOpts.rgb.active&&(n.rgb.icon="sun"),{callback:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var i=e,s=i.image;if(!($.inArray(i,JS9.displays)<0))switch(t){case"loadcmap":JS9.OpenColormapMenu({display:i});break;case"savecmap":JS9.SaveColormap({display:i});break;default:if(s){if(t.match(/^imfilter_/))return a=t.replace(/^imfilter_/,""),void s.filterRGBImage(a);s.setColormap(t)}}})},events:{show:function(t){var a=e.display.image,i={};a&&(i.contrast=String(a.params.contrast),i.bias=String(a.params.bias),i.opacity=String(a.params.opacity),i.sigma=String(a.params.sigma)),$.contextMenu.setInputValues(t,i),JS9.jupyterFocus(".context-menu-item")},hide:function(t){var a,i=e.display,s=i.image;s&&i.tmp.editingMenu&&(a=$.contextMenu.getInputValues(t),l(s,a))}},items:n}}}),$("#regionMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#regionMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#regionMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a=JS9.Menubar.getDisplays.call(e)[0].image,s={},r=function(e,t){switch(e){case"color":if("#"!==t.charAt(0)&&JS9.colorToHex(t)===t)return null;break;case"strokeWidth":if(!JS9.isNumber(t))return null;t=parseFloat(t);break;case"strokeDashArray":if(!(t=t.split(/[\s,]+/))||!t.length)return null;if(t.length<2&&(t[1]="0"),!JS9.isNumber(t[0])||!JS9.isNumber(t[1]))return null;t[0]=parseFloat(t[0]),t[1]=parseFloat(t[1])}return t},n=function(e,t,a){var i,s,n={};if(a)i=a.substring(3),s=t[a],i&&s&&e.tmp["editingReg"+a]&&(delete e.tmp["editingReg"+a],(s=r(i,s))&&(n[i]=s,e.changeShapes("regions","selected",n)));else{for(a in t)t.hasOwnProperty(a)&&(i=a.substring(3),s=t[a],i&&s&&e.tmp["editingReg"+a]&&(delete e.tmp["editingReg"+a],(s=r(i,s))&&(n[i]=s)));Object.keys(n).length&&e.changeShapes("regions","selected",n)}},o=function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a,i=$.contextMenu.getInputValues(t.data),s=t.which||t.keyCode,r=e.image;if(!($.inArray(e,JS9.displays)<0))switch(t&&t.target&&t.target.name&&(a=t.target.name.split("-").reverse()[0]),s){case 9:case 13:r&&a&&n(r,i,a);break;default:r&&a&&(r.tmp["editingReg"+a]=!0)}})};if(s.regiontitle={name:"Regions:",disabled:!0},s.annulus=i("annulus"),s.box=i("box"),s.circle=i("circle"),s.ellipse=i("ellipse"),s.line=i("line"),s.point=i("point"),s.polygon=i("polygon"),s.text=i("text"),s.sep1="------",s.loadRegions=i("load"),s.listRegions=i("list"),fabric.major_version>1&&(s.selectRegions=i("select")),s.saveas={name:"save ...",items:{saveastitle:{name:"choose output format:",disabled:!0},saveas_reg:i("regions"),saveas_svg:i("SVG")}},s.copyto={name:"copy to ...",items:{copytotitle:{name:"choose image:",disabled:!0}}},s.removeRegions=i("remove"),s.sep2="------",s.selectops={name:"selected regions ...",items:{selopstitle:{name:"actions on selected:",disabled:!0},configSelReg:i("edit"),listSelReg:i("list"),backSelReg:i("to back"),saveSelReg:i("save"),copySelReg:{name:"copy to ...",items:{copyseltotitle:{name:"choose image:",disabled:!0}}},removeSelReg:i("remove"),regcolor:{events:{keyup:o},name:"color:",type:"text"},regstrokeWidth:{events:{keyup:o},name:"width:",type:"text"},regstrokeDashArray:{events:{keyup:o},name:"dash:",type:"text"},regtags:{events:{keyup:o},name:"tag:",type:"text"},sbSelReg:i("toggle: src/bkgd"),ieSelReg:i("toggle: incl/excl")}},s.sep3="------",s.onchange={name:"onchange ...",items:{listonchange:i("list on change"),xeqonchange:i("xeq on change")}},a&&a.params.listonchange&&(s.onchange.items.listonchange.icon="sun"),a&&a.params.xeqonchange&&(s.onchange.items.xeqonchange.icon="sun"),a&&JS9.images.length>1){for(t=0;t<JS9.images.length;t++)a!==JS9.images[t]&&(s.copyto.items["copyto_"+JS9.images[t].id]=i(JS9.images[t].id),s.selectops.items.copySelReg.items["copyselto_"+JS9.images[t].id]=i(JS9.images[t].id));s.copyto.items.copyto_all=i("all images"),s.copyto.disabled=!1,s.selectops.items.copySelReg.disabled=!1}else s.copyto.disabled=!0,s.selectops.items.copySelReg.disabled=!0;return JS9.hasOwnProperty("Info")||(s.listRegions.disabled=!0),{callback:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a,i,s,r=e,n=r.image;if(!($.inArray(r,JS9.displays)<0)&&n)switch(t){case"loadRegions":JS9.OpenRegionsMenu({display:r});break;case"listRegions":n.listRegions("all",{mode:2});break;case"selectRegions":JS9.hasOwnProperty("Keyboard")&&JS9.Keyboard.Actions["select all regions"](n,n.ipos);break;case"removeRegions":n.removeShapes("regions","all"),r.clearMessage("regions");break;case"srcSelReg":n.editRegionTags("selected","source","background");break;case"bkgSelReg":n.editRegionTags("selected","background","source");break;case"incSelReg":n.editRegionTags("selected","include","exclude");break;case"exclSelReg":n.editRegionTags("selected","exclude","include");break;case"sbSelReg":n.toggleRegionTags("selected","source","background");break;case"ieSelReg":n.toggleRegionTags("selected","exclude","include");break;case"configSelReg":(i=n.layers.regions)&&(s=i.canvas.getActiveObject(),JS9.Regions.displayConfigForm.call(n,s));break;case"saveSelReg":n.saveRegions("js9.reg","selected");break;case"listSelReg":n.listRegions("selected",{mode:2});break;case"backSelReg":JS9.hasOwnProperty("Keyboard")&&JS9.Keyboard.Actions["send selected region to back"](n,n.ipos);break;case"removeSelReg":n.removeShapes("regions","selected"),r.clearMessage("regions");break;case"xeqonchange":n.params.xeqonchange=!n.params.xeqonchange;break;case"listonchange":n.params.listonchange=!n.params.listonchange;break;default:if(t.match(/^saveas_/))return a=t.replace(/^saveas_/,""),void n.saveRegions("js9."+a,"all",{type:a});if(t.match(/^copyto_/))return a=t.replace(/^copyto_/,""),void n.copyRegions(a);if(t.match(/^copyselto_/))return a=t.replace(/^copyselto_/,""),void n.copyRegions(a,"selected");n.addShapes("regions",t,{ireg:!0})}})},events:{show:function(e){$.contextMenu.setInputValues(e,{color:""}),JS9.jupyterFocus(".context-menu-item")},hide:function(t){var a,i=e.display.image;i&&(a=$.contextMenu.getInputValues(t),n(i,a))}},items:s}}}),$("#wcsMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#wcsMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#wcsMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n=0,o=0,l=0,c={},p=JS9.Menubar.getDisplays.call(e)[0],d=p.image,h=function(e,t){delete p.tmp.editingMenu,JS9.isNumber(t.rot)&&e.rotateData(parseFloat(t.rot))};for(c.wcssystitle={name:"WCS Systems:",disabled:!0},t=0;t<JS9.wcssyss.length;t++)c[a=JS9.wcssyss[t]]=i(a),d&&d.params.wcssys===a&&(c[a].icon="sun",l++);for(l||(c[a="native"].icon="sun"),c["sep"+n++]="------",c.wcsutitle={name:"WCS Units:",disabled:!0},t=0;t<JS9.wcsunitss.length;t++)c[a=JS9.wcsunitss[t]]=i(a),d&&d.params.wcsunits===a&&(c[a].icon="sun");if(c["sep"+n++]="------",c.altwcs={name:"alternate wcs",items:{altwcstitle:{name:"choose a wcs:",disabled:!0}}},d&&d.raw&&d.raw.altwcs){for(s in r=d.raw.altwcs)r.hasOwnProperty(s)&&(c.altwcs.items[a="altwcs_"+s]=i(r[s].header.WCSNAME?r[s].header.WCSNAME+"    ("+s+")":s),d.raw.wcs===r[s].wcs&&(c.altwcs.items[a].icon="sun"),o++);o<2&&(c.altwcs.disabled=!0,c.altwcs.items.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}})}else c.altwcs.disabled=!0;for(c["sep"+n++]="------",c.reproject={name:"wcs reproject ...",items:{reprojtitle:{name:"using the wcs from:",disabled:!0}}},t=0,o=0;t<JS9.images.length;t++)if(JS9.images[t].raw.wcs){if(d===JS9.images[t]&&e.id.search(JS9.SUPERMENU)<0)continue;c.reproject.items[a="reproject_"+JS9.images[t].id]={name:JS9.images[t].id},o++}return 0===o?c.reproject.items.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}}:(c.reproject.disabled=!1,c.reproject.items["sep"+n++]="------",c.reproject.items.reproject_wcsalign={name:"display wcs-aligned"},d&&d.params.wcsalign&&(c.reproject.items.reproject_wcsalign.icon="sun")),c.reproject.items["sep"+n++]="------",c.reproject.items.rotatetitle={name:"by rotating the image:",disabled:!0},c.reproject.items.reproject_northup={name:"so that north is up"},c.reproject.items.rot={events:{keyup:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:r&&h(r,a);break;default:s.tmp.editingMenu=!0}})}},name:"by this angle in deg:",type:"text"},d&&d.raw&&d.raw.header&&d.raw.wcsinfo||(c.reproject.disabled=!0),c.reproject.items["sep"+n++]="------",c.reproject.items.reproject_revert={name:"revert"},{callback:function(a){JS9.Menubar.getDisplays.call(e).forEach(function(e){var i,s,r=new RegExp(a),n=e.image;if(!($.inArray(e,JS9.displays)<0)&&n){if(a.match(/^altwcs_/))return s=a.replace(/^altwcs_/,""),void n.setWCS(s);if(a.match(/^reproject_/)){if("reproject_wcsalign"===a)n.params.wcsalign=!n.params.wcsalign,n.displayImage("display");else if("reproject_northup"===a)n.rotateData("northisup");else if("reproject_revert"===a){if(n.raw.id!==JS9.RAWID0)for(t=0;t<n.raws.length;t++)n.raw===n.raws[t]&&n.rawDataLayer(n.raw.id,"remove")}else i=a.replace(/^reproject_/,""),n.reprojectData(i);return}JS9.wcssyss.join("@").search(r)>=0?(n.setWCSSys(a),n.updateShapes("regions","all","wcs")):JS9.wcsunitss.join("@").search(r)>=0?(n.setWCSUnits(a),n.updateShapes("regions","all","wcs")):JS9.error("unknown wcs sys/units: "+a)}})},events:{show:function(t){var a={};e.display.image&&(a.rot="",$.contextMenu.setInputValues(t,a),JS9.jupyterFocus(".context-menu-item"))},hide:function(t){var a,i=e.display,s=i.image;s&&(a=$.contextMenu.getInputValues(t),i.tmp.editingMenu&&h(s,a))}},items:c}}}),$("#analysisMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#analysisMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#analysisMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var t,a,s,r,n,o,l,c,p,d=/fitsHeader\(([A-Za-z0-9_]+),(.*)\)/,h=/winVar\((.*),(.*)\)/,g=/js9Var\((.*),(.*)\)/,u=/imVar\((.*),(.*)\)/,m=0,f=0,y={},b=JS9.Menubar.getDisplays.call(e)[0],S=b.image,v="",w=function(e,t){return!(!e||!t)&&String(e).toUpperCase()===String(t).toUpperCase()},x=function(e,t){delete b.tmp.editingMenu,t.sigma=t.sigma||"0","none"===t.sigma&&(t.sigma="0");try{e.params.sigma=parseFloat(t.sigma)}catch(a){e.params.sigma=0}e.gaussBlurData(e.params.sigma)};for(t=0;t<JS9.plugins.length;t++)c=(o=JS9.plugins[t]).name,o.opts.menuItem&&"analysis"===o.opts.menu&&((l=b.pluginInstances[c])&&!l.winHandle||(o.xclass!==v&&(f>0&&(y["sep"+f++]="------"),y["sep"+f++]={name:o.xclass+" Plugins:"},y["sep"+(f-1)].disabled=!0),v=o.xclass,y[c]={name:o.opts.menuItem},l&&"active"===l.status&&(y[c].icon="sun"),f++));if(!JS9.allinone){if(f>0&&(y["sep"+f++]="------"),y.localtitle={name:"Client-side Analysis:",disabled:!0},y.grid=i("Coordinate Grid"),!S||!S.raw.wcs||S.raw.wcs<=0?y.grid.disabled=!0:S.displayCoordGrid()&&(y.grid.icon="sun"),y.regcnts=i("Counts in Regions"),y.radprof=i("Radial Profile"),y.cnts3d=i("3D Counts in Regions"),y.plot3d=i("3D Plot using Regions"),S&&S.raw&&S.raw.hdu&&S.raw.hdu.vfile?3!==S.raw.header.NAXIS&&(y.cnts3d.disabled=!0,y.plot3d.disabled=!0):(y.regcnts.disabled=!0,y.radprof.disabled=!0,y.cnts3d.disabled=!0,y.plot3d.disabled=!0),y.sigma={events:{keyup:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a=$.contextMenu.getInputValues(t.data),i=t.which||t.keyCode,s=e,r=s.image;if(!($.inArray(s,JS9.displays)<0))switch(i){case 9:case 13:x(r,a);break;default:s.tmp.editingMenu=!0}})}},name:"Blur, equivalent sigma:",type:"text"},y["sep"+f++]="------",y.remotetitle={name:"Server-side Analysis:",disabled:!0},S&&S.analysisPackages)for(r=S.analysisPackages,a=0;a<r.length;a++)for(n=r[a],t=0;t<n.length;t++)if(n[t].title&&n[t].name&&!n[t].hidden){if(n[t].files){if(n[t].files.match(/^fits$/)&&!S.fitsFile)continue;if(n[t].files.match(/^png$/)&&"fits2png"!==S.source)continue;if(n[t].files.match(/^table$/)&&"table"!==S.imtab)continue;if(n[t].files.match(/^image$/)&&"image"!==S.imtab)continue;if((p=n[t].files.match(d))&&!w(s=S.raw.header[p[1].toUpperCase()],p[2]))continue;if((p=n[t].files.match(h))&&!w(s=JS9.varByName(p[1],window),p[2]))continue;if((p=n[t].files.match(g))&&!w(s=JS9.varByName(p[1],JS9),p[2]))continue;if((p=n[t].files.match(u))&&!w(s=JS9.varByName(p[1],S),p[2]))continue}n[t].rtype&&n[t].rtype.match(/^---/)?(y["sep"+f++]="------",y[n[t].name]={name:n[t].title+":",disabled:!0}):(s=n[t].title,n[t].purl&&(s+=" ..."),y[n[t].name]={name:s},m++)}m||(y.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}},JS9.globalOpts.loadProxy&&S&&S.raw&&S.raw.hdu&&S.raw.hdu.vfile&&(y.upload={name:"upload FITS to make tasks available"},(!JS9.helper.connected||"nodejs"!==JS9.helper.type&&"socket.io"!==JS9.helper.type)&&(y.upload.disabled=!0))),y["sep"+f++]="------",y.sconfig={name:"server-side params ...",items:{}},y.sconfig.items.dpath=i("set data analysis path ..."),!1===JS9.globalOpts.dataPathModify&&(y.sconfig.items.dpath.disabled=!0),y.sconfig.items.fpath=i("set this image file's path ..."),(!S||document.domain&&"localhost"!==document.domain)&&(y.sconfig.items.fpath.disabled=!0)}return{callback:function(t){JS9.Menubar.getDisplays.call(e).forEach(function(e){var a,i,s,r,n=e,o=n.image;if(!($.inArray(n,JS9.displays)<0)){for(s=0;s<JS9.plugins.length;s++)if((r=JS9.plugins[s]).name===t)return void n.displayPlugin(r);if(o)switch(t){case"regcnts":JS9.CountsInRegions("$sregions","$bregions",{lightwin:!0},{display:n.id});break;case"radprof":JS9.RadialProfile("$sregions","$bregions",{display:n.id});break;case"cnts3d":JS9.CountsInRegions("$sregions","$bregions",{lightwin:!0,cmdswitches:"-c "+JS9.globalOpts.plot3d.cube},{display:n.id});break;case"plot3d":JS9.Plot3D("$sregions","$bregions",null,{display:n.id});break;case"dpath":$("#dhtmlwindowholder").arrive("#dataPathForm",{onceOnly:!0},function(){$("#dataPath").val(JS9.globalOpts.dataPath)}),i=o.displayAnalysis("textline",JS9.InstallDir(JS9.analOpts.dpathURL),{title:"Data path for analysis"}),$(i).data("dispid",n.id),$(i).data("imid",o.id);break;case"fpath":$("#dhtmlwindowholder").arrive("#filePathForm",{onceOnly:!0},function(){$("#filePath").val(o.file)}),i=o.displayAnalysis("textline",JS9.InstallDir(JS9.analOpts.fpathURL),{title:"File path for this image"}),$(i).data("dispid",n.id),$(i).data("imid",o.id);break;case"grid":o.displayCoordGrid(!o.displayCoordGrid());break;case"upload":o.uploadFITSFile();break;default:return void((a=o.lookupAnalysis(t))&&(a.purl?(i=o.displayAnalysis("params",JS9.InstallDir(a.purl),{title:a.title+": "+o.fitsFile,winformat:a.pwin}),$(i).data("dispid",n.id).data("aname",a.name)):o.runAnalysis(a.name)))}}})},events:{show:function(t){var a=e.display.image,i={};a&&(i.sigma=String(a.params.sigma)),$.contextMenu.setInputValues(t,i),JS9.jupyterFocus(".context-menu-item")},hide:function(t){var a,i=e.display,s=i.image;s&&i.tmp.editingMenu&&(a=$.contextMenu.getInputValues(t),x(s,a))}},items:y}}}),$("#helpMenu"+e.id).on("mousedown",function(t){t.preventDefault(),$("#helpMenu"+e.id).contextMenu()}),$.contextMenu({selector:"#helpMenu"+e.id,zIndex:JS9.MENUZINDEX,events:{hide:a},position:t,build:function(){var e,t,a,s=1,r="",n={js9help:{name:"General help ...",items:{helptitle:{name:"General help:",disabled:!0}}}};for(t in JS9.helpOpts)JS9.helpOpts.hasOwnProperty(t)&&"JS9Help"===(a=JS9.helpOpts[t]).heading&&(r=a.type,n.js9help.items[t]={name:a.title});for(t in n["sep"+s++]="------",n.pluginhelp={name:"JS9 plugins ...",items:{helptitle:{name:"JS9 plugins:",disabled:!0}}},JS9.helpOpts)JS9.helpOpts.hasOwnProperty(t)&&"JS9"===(a=JS9.helpOpts[t]).heading&&(r=a.type,n.pluginhelp.items[t]={name:a.title.replace(/ \.\.\./,"")});for(t in JS9.helpOpts)if(JS9.helpOpts.hasOwnProperty(t)){if("JS9Help"===(a=JS9.helpOpts[t]).heading||"JS9"===a.heading)continue;""!==r&&a.type!==r&&(n["sep"+s++]="------",a.heading&&(n["sep"+s++]={name:(e=a.heading+" plugins")+" ...",items:{title:{name:e+":",disabled:!0}}})),r=a.type,n["sep"+(s-1)].items[t]={name:a.title}}return n["sep"+s++]="------",n.about=i("about JS9"),{callback:function(e){switch(e){case"about":alert(sprintf("JS9: astronomical image display everywhere\nversion: %s\nEric Mandel, Alexey Vikhlinin\ncontact: eric@cfa.harvard.edu\n%s",JS9.VERSION,JS9.COPYRIGHT));break;default:JS9.DisplayHelp(e)}},items:n}}}),function(){var t,a;if(JS9.globalOpts.userMenuBar)for(t=0;t<JS9.globalOpts.userMenuBar.length;t++)(a=JS9.globalOpts.userMenuBar[t])&&a.name&&a.title&&($("#"+a.name+"UserMenu"+e.id).on("mousedown",a,s),r(a))}()},JS9.Menubar.init=function(e,t){var a,i,s,r,n,o;for(this.issuper=this.id.search(JS9.SUPERMENU)>=0,this.issuper&&JS9.supermenus.push(this),this.style=this.divjq.attr("data-style")||JS9.globalOpts.menubarStyle||"classic",this.style=this.style.toLowerCase(),this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Menubar.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.buttonClass=this.divjq.attr("data-buttonClass")||"JS9Button",this.containerClass="JS9MenubarContainer",this.buttonClass.match(/-flat/)?this.containerClass+="-flat":this.buttonClass.match(/-border/)&&(this.containerClass+="-border"),this.backgroundColor=this.divjq.attr("data-backgroundColor"),this.height||(this.height=t||JS9.MENUHEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.usermenus="true"===this.divjq.attr("data-usermenus")||JS9.globalOpts.userMenus,o="<span id='JS9Menus_@@ID@@'>",i=0;i<JS9.globalOpts.menuBar.length;i++)for(n=JS9.globalOpts.menuBar[i],a=0;a<JS9.Menubar.buttonOptsArr.length;a++)if(n===(s=JS9.Menubar.buttonOptsArr[a].name)){if(r=JS9.Menubar.buttonOptsArr[a].label,JS9.allinone&&"help"===s)break;if("#"===s[0])"classic"===this.syle&&"#"!==(s=s.slice(1))[1]&&(o+="<button type='button' id='"+s+"Menu@@ID@@' class='"+this.buttonClass+"' disabled='disabled'>"+r+" </button>");else if("classic"===this.style)o+="<button type='button' id='"+s+"Menu@@ID@@' class='"+this.buttonClass+"'>"+r+"</button>";else switch(s){case"file":case"edit":o+="<button type='button' id='"+s+"Menu@@ID@@' class='"+this.buttonClass+"'>"+r+"</button>";break;case"help":o+="<span style='float:right'><button type='button' id='"+s+"Menu@@ID@@' class='"+this.buttonClass+"'>"+r+"</button></span>";break;default:this.macmenus||(o+="<span style='position:relative;'><button type='button' id='viewMacMenu@@ID@@' class='"+this.buttonClass+"'>View</button>",this.macmenus=[]),"View"===r&&(r="Plugins"),o+="<button type='button' id='"+s+"Menu@@ID@@' class='"+this.buttonClass+"' style='position:absolute;top:0px;left:0px;visibility:hidden;zindex:-1'></button>",this.macmenus.push({name:s,title:r})}break}if(this.macmenus&&(o+="</span>"),this.usermenus&&JS9.globalOpts.userMenuBar)for(o+=JS9.globalOpts.userMenuDivider||"",i=0;i<JS9.globalOpts.userMenuBar.length;i++)(n=JS9.globalOpts.userMenuBar[i])&&n.name&&n.title&&n.options&&(o+="<button type='button' id='"+n.name+"UserMenu@@ID@@' class='"+this.buttonClass+"'>"+(n.imageTitle?"<div class='JS9MenubarUserImage'><img src='"+n.imageTitle+"' alt='"+n.title+"' class='JS9MenubarUserImage' ></div>":n.title)+"</button>");o+="<button type='button' id='hiddenRegionMenu@@ID@@'class='JS9Button' style='display:none'>R</button>",o+="<button type='button' id='hiddenAnchorMenu@@ID@@'class='JS9Button' style='display:none'>R</button>",o+="</span>",this.display.menubar=this,this.html=o.replace(/@@ID@@/g,this.id),this.menuConjq=$("<div>").addClass(this.containerClass).attr("width",this.width).attr("height",this.height).html(this.html).appendTo(this.divjq),this.backgroundColor&&this.menuConjq.css("background",this.backgroundColor),JS9.Menubar.createMenus.call(this)},JS9.RegisterPlugin("JS9","Menubar",JS9.Menubar.init,{onupdateprefs:JS9.Menubar.reset,dynamicSelect:!0,winDims:[JS9.Menubar.WIDTH,JS9.Menubar.HEIGHT]}),JS9.Panner={},JS9.Panner.CLASS="JS9",JS9.Panner.NAME="Panner",JS9.Panner.WIDTH=320,JS9.Panner.HEIGHT=320,JS9.Panner.SWIDTH=250,JS9.Panner.SHEIGHT=250,JS9.Panner.VSIZE=30,JS9.Panner.NORTH={color:"#00FF00",text:"N",fontSize:12,strokeWidth:1,strokeDashArray:[2,1]},JS9.Panner.EAST={color:"#FFFF00",text:"E",fontSize:12,strokeWidth:1,strokeDashArray:[2,1]},JS9.Panner.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,zoom:4,canvas:{selection:!0},tagcolors:{defcolor:"#00FF00"}},JS9.Panner.bcall=function(e,t,a){var i,s,r;switch((i=$(e).closest("div[class^=JS9PluginToolbar]").data("displayid"))?s=(r=JS9.getImage(JS9.getDynamicDisplayOr(i))).display.pluginInstances.JS9Panner:JS9.error("can't find display for cmd: "+t),r||JS9.error("can't find image for cmd: "+t),t){case"zoomPanner":arguments.length<3&&JS9.error("missing argument(s) for cmd: "+t);try{JS9.Panner.zoom.call(s,r,a)}catch(n){JS9.error("error calling zoomPanner()",n)}break;case"panImage":try{r.setPan()}catch(n){JS9.error("error calling setPan()",n)}}},JS9.Panner.HTML="<span><button type='button' class='JS9Button' onClick='JS9.Panner.bcall(this, \"zoomPanner\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.Panner.bcall(this, \"zoomPanner\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.Panner.bcall(this, \"zoomPanner\", \"1\"); return false'>z1</button><button type='button' class='JS9Button' onClick='JS9.Panner.bcall(this, \"panImage\"); return false'>center</button></span>",JS9.Panner.init=function(e,t){this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Panner.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.Panner.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.canvas=document.createElement("canvas"),this.canvasjq=$(this.canvas),this.canvasjq.addClass("JS9Panner"),this.canvasjq.css("z-index",JS9.ZINDEX),this.canvasjq.attr("width",this.width),this.canvasjq.attr("height",this.height),this.context=this.canvas.getContext("2d"),JS9.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1),this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq),this.display.image&&JS9.Panner.disp.call(this,this.display.image)},JS9.Panner.create=function(e){var t,a,i,s,r,n,o,l,c,p,d,h,g,u,m,f,y,b,S,v,w,x=this;if(e&&e.raw&&e.display.pluginInstances.JS9Panner){if(e.panner||(e.panner={}),e.panner.zoom||(e.panner.zoom=1),t=e.display.pluginInstances.JS9Panner,a=e.panner,i=e.rgb.sect,f=Math.min(e.raw.width,t.width),y=Math.min(e.raw.height,t.height),a.xblock=e.raw.width/f,a.yblock=e.raw.height/y,a.xblock>a.yblock?(y=Math.floor(y/a.xblock*a.yblock+.5),a.yblock=a.xblock):a.yblock>a.xblock&&(f=Math.floor(f/a.yblock*a.xblock+.5),a.xblock=a.yblock),s=e.display.context.createImageData(f,y),1===a.zoom?(o=a.xblock,l=a.yblock,r=0,n=0):(o=a.xblock/a.zoom,l=a.yblock/a.zoom,r=Math.max(0,(i.x0+i.x1-f*o)/2),n=Math.max(0,(i.y0+i.y1-y*l)/2)),a.x0=r,a.y0=n,a.img=s,a.ix=0,a.iy=0,e.rgbFile){for(p=0;p<y;p++)for(h=Math.floor(n+p*l)*e.offscreen.img.width,g=p*f,c=0;c<f;c++)d=Math.floor(r+c*o),s.data[m=4*(g+c)]=e.offscreen.img.data[u=4*(d+h)],s.data[m+1]=e.offscreen.img.data[u+1],s.data[m+2]=e.offscreen.img.data[u+2],s.data[m+3]=255;return e}for(p=0;p<y;p++)for(h=Math.floor(n+(y-p-1)*l)*e.raw.width,g=p*f,c=0;c<f;c++)d=Math.floor(r+c*o),m=4*(g+c),e.psColors[u=e.colorData[d+h]]&&(s.data[m]=e.psColors[u][0],s.data[m+1]=e.psColors[u][1],s.data[m+2]=e.psColors[u][2],s.data[m+3]=255);return this.display.layers.panner?(this.display.image&&this.isDynamic&&(this.display.layers.panner&&!e.display.layers.panner&&(e.display.layers.panner=this.display.layers.panner),this.display.image.layers.panner&&!e.layers.panner&&(e.layers.panner=this.display.image.layers.panner)),e):((w=this.display.newShapeLayer("panner",JS9.Panner.opts,this.divjq)).canvas.on("object:modified",function(e){var t,a;if(t=(a=JS9.getDynamicDisplayOr(x.display))&&a.image?a.image:x.display.image){b=e.target.getCenterPoint(),S=(b.x-t.panner.ix)*t.panner.xblock/t.panner.zoom+t.panner.x0,v=(w.canvas.height-(b.y+t.panner.iy))*t.panner.yblock/t.panner.zoom+t.panner.y0;try{t.display.pluginInstances.JS9Panner.status="inactive",t.setPan(S,v)}catch(i){JS9.log("couldn't pan image",i)}finally{t.display.pluginInstances.JS9Panner.status="active"}}}),e)}},JS9.Panner.disp=function(e){var t,a,i,s,r,n,o,l,c,p,d,h,g,u,m,f;if(e&&e.display.pluginInstances.JS9Panner&&"active"===e.display.pluginInstances.JS9Panner.status&&(JS9.Panner.create.call(this,e),i=e.rgb.sect,d=(t=e.display.pluginInstances.JS9Panner).width/2,h=t.height/2,(a=e.panner).img))return a.img.width<t.canvas.width&&(a.ix=Math.floor((t.canvas.width-a.img.width)/2)),a.img.height<t.canvas.height&&(a.iy=Math.floor((t.canvas.height-a.img.height)/2)),JS9.Panner.clear.call(this,e),t.context.putImageData(a.img,a.ix,a.iy),o=(i.x0-a.x0)*(s=a.zoom/a.xblock)+a.ix,l=t.height-1-((i.y1-a.y0)*(r=a.zoom/a.yblock)+a.iy),o+=1,l+=1,o+=(c=i.width*s/i.zoom)/2,l+=(p=i.height*r/i.zoom)/2,n={left:o=Math.floor(o),top:l=Math.floor(l),width:c=Math.floor(c),height:p=Math.floor(p)},e.panner.boxid?e.changeShapes("panner",e.panner.boxid,n):e.panner.boxid=e.addShapes("panner","box",n),e.panner.northid&&(e.removeShapes("panner",e.panner.northid),e.removeShapes("panner",e.panner.northidt)),e.panner.eastid&&(e.removeShapes("panner",e.panner.eastid),e.removeShapes("panner",e.panner.eastidt)),!JS9.globalOpts.pannerDirections||!e.raw.wcs||e.raw.wcs<=0?e:(g={x:d,y:h},u=e.raw.wcsinfo&&e.raw.wcsinfo.cdelt2&&e.raw.wcsinfo.cdelt2>=0?{x:d,y:h-JS9.Panner.VSIZE}:{x:d,y:h+JS9.Panner.VSIZE},e.raw.wcsinfo&&e.raw.wcsinfo.crot&&(u=JS9.rotatePoint(u,-e.raw.wcsinfo.crot,g)),e.panner.northid=e.addShapes("panner","line",{color:JS9.Panner.NORTH.color,strokeWidth:JS9.Panner.NORTH.strokeWidth,strokeDashArray:JS9.Panner.NORTH.strokeDashArray,points:[g,u],changeable:!1,originX:"left",originY:"top",noLeftTop:!0}),e.panner.northidt=e.addShapes("panner","text",{color:JS9.Panner.NORTH.color,text:JS9.Panner.NORTH.text,fontSize:JS9.Panner.NORTH.fontSize,changeable:!1,left:u.x,top:u.y}),m={x:d,y:h},f=e.raw.wcsinfo&&e.raw.wcsinfo.cdelt1&&e.raw.wcsinfo.cdelt1<0?{x:d-JS9.Panner.VSIZE,y:h}:{x:d+JS9.Panner.VSIZE,y:h},e.raw.wcsinfo&&e.raw.wcsinfo.crot&&(f=JS9.rotatePoint(f,-e.raw.wcsinfo.crot,m)),e.panner.eastid=e.addShapes("panner","line",{color:JS9.Panner.EAST.color,strokeWidth:JS9.Panner.EAST.strokeWidth,strokeDashArray:JS9.Panner.EAST.strokeDashArray,changeable:!1,points:[m,f],originX:"left",originY:"top",noLeftTop:!0}),e.panner.eastidt=e.addShapes("panner","text",{color:JS9.Panner.EAST.color,text:JS9.Panner.EAST.text,fontSize:JS9.Panner.EAST.fontSize,changeable:!1,left:f.x,top:f.y}),e)},JS9.Panner.zoom=function(e,t){var a,i,s;if(e&&e.panner&&e.display.pluginInstances.JS9Panner){switch(i=(a=e.panner).zoom,t.charAt(0)){case"*":case"x":case"X":s=Math.min(Math.min(this.width,this.height),i*parseFloat(t.slice(1)));break;case"/":s=Math.max(1,i/parseFloat(t.slice(1)));break;default:s=parseFloat(t)}return(!s||s<1)&&(s=1),a.zoom=s,JS9.Panner.disp.call(this,e),e}},JS9.Panner.dysel=function(e){var t;e&&(t=e.display.pluginInstances.JS9Panner)&&t.isDynamic&&JS9.Panner.disp.call(this,e)},JS9.Panner.clear=function(e){var t,a;if(e)return a=JS9.getDynamicDisplayOr(this.display),(t=e.display.pluginInstances.JS9Panner)&&e.display===a&&(t.context.clear(),e.removeShapes("panner","all"),e.panner.boxid=null),e},JS9.RegisterPlugin(JS9.Panner.CLASS,JS9.Panner.NAME,JS9.Panner.init,{menuItem:"Panner",dynamicSelect:!0,toolbarSeparate:!1,toolbarHTML:JS9.Panner.HTML,ondynamicselect:JS9.Panner.dysel,onplugindisplay:JS9.Panner.disp,onimagedisplay:JS9.Panner.disp,onimageclose:JS9.Panner.clear,onimageclear:JS9.Panner.clear,onupdateprefs:JS9.Panner.disp,winTitle:"Panner",winDims:[JS9.Panner.WIDTH,JS9.Panner.HEIGHT],divArgs:[JS9.Panner.SWIDTH,JS9.Panner.SHEIGHT]}),JS9.Prefs={},JS9.Prefs.CLASS="JS9",JS9.Prefs.NAME="Preferences",JS9.Prefs.WIDTH=750,JS9.Prefs.HEIGHT=400,JS9.Prefs.imagesSchema={title:"Image Preferences",description:"Preferences for each displayed image",properties:{colormap:{type:"string",helper:"default color map"},contrast:{type:"number",helper:"default color contrast"},bias:{type:"number",helper:"default color bias"},scale:{type:"string",helper:"default scale algorithm"},scaleclipping:{type:"string",helper:"'dataminmax' or 'zscale'"},zscalecontrast:{type:"number",helper:"default from ds9"},zscalesamples:{type:"number",helper:"default from ds9"},zscaleline:{type:"number",helper:"default from ds9"},exp:{type:"number",helper:"default exp value for scaling"},wcssys:{type:"string",helper:"current WCS system"},wcsunits:{type:"string",helper:"current WCS units"},lcs:{type:"string",helper:"default logical coordinate system"},opacity:{type:"number",helper:"opacity for images (0.0 to 1.0)"},zoom:{type:"number",helper:"default zoom factor"},zooms:{type:"number",helper:"how many zooms in each direction?"},nancolor:{type:"string",helper:"6-digit #hex color for NaN values"},listonchange:{type:"boolean",helper:"list after a region change?"},whichonchange:{type:"string",helper:"list 'all' or 'selected'?"},valpos:{type:"boolean",helper:"display value/position?"},inherit:{type:"boolean",helper:"new images inherit current params?"},invert:{type:"boolean",helper:"by default, invert colormap?"},disable:{type:"mobject",helper:"array of core functions to disable"}}},JS9.Prefs.regionsSchema={title:"Region Preferences",description:"Preferences for each displayed region",type:"object",properties:{iradius:{type:"number",helper:"annulus: initial inner radius"},oradius:{type:"number",helper:"annulus: initial outer radius"},nannuli:{type:"number",helper:"annulus: initial number of annuli"},width:{type:"number",helper:"box: initial width"},height:{type:"number",helper:"box: initial height"},radius:{type:"number",helper:"circle: initial radius"},r1:{type:"number",helper:"ellipse: initial radius1"},r2:{type:"number",helper:"ellipse: initial radius2"},ptshape:{type:"string",helper:"point shape: box, circle, ellipse"},ptsize:{type:"number",helper:"point size"},points:{type:"string",helper:"array of x,y relative positions"},angle:{type:"number",helper:"box, ellipse: initial angle in degrees"},tags:{type:"string",helper:"initial tags for a region"},strokeWidth:{type:"number",helper:"region stroke width"},fontFamily:{type:"string",helper:"region font"},fontSize:{type:"string",helper:"region font size"},fontStyle:{type:"string",helper:"region font style"},fontWeight:{type:"string",helper:"region font weight"},textAlign:{type:"string",helper:"text alignment"}}},JS9.Prefs.gridSchema={title:"Grid Preferences",description:"Preferences for wcs coordinate grids",type:"object",properties:{strokeWidth:{type:"number",helper:"grid stroke width"},lineColor:{type:"string",helper:"color of grid lines"},raLines:{type:"number",helper:"approx. number of RA grid lines"},raAngle:{type:"number",helper:"rotation for RA label"},raSkip:{type:"number",helper:"number of RA lines to skip"},decLines:{type:"number",helper:"approx. number of Dec grid lines"},decAngle:{type:"number",helper:"rotation for Dec label"},decSkip:{type:"number",helper:"number of Dec lines to skip"},labelColor:{type:"string",helper:"color of text labels"},labelFontFamily:{type:"string",helper:"label font"},labelFontSize:{type:"string",helper:"label font size"},labelFontStyle:{type:"string",helper:"label font style"},labelFontWeight:{type:"string",helper:"label font weight"},labelRAOffx:{type:"number",helper:"x offset of RA labels"},labelRAOffy:{type:"number",helper:"y offset of RA labels"},labelDecOffx:{type:"number",helper:"x offset of Dec labels"},labelDecOffy:{type:"number",helper:"y offset of Dec labels"},degPrec:{type:"number",helper:"precision for degree labels"},sexaPrec:{type:"number",helper:"precision for sexagesimal labels"},reduceDims:{type:"boolean",helper:"reduce lines of smaller image dim?"},stride:{type:"number",helper:"fineness of grid lines"},margin:{type:"number",helper:"edge margin for displaying a grid line"},labelMargin:{type:"number",helper:"edge margin for displaying a label"},cover:{type:"string",helper:"grid lines cover: display or image"}}},JS9.Prefs.fitsSchema={title:"FITS Preferences",description:"Preferences for processing FITS files",properties:{extlist:{type:"string",helper:"default binary table extensions"},xdim:{type:"string",helper:"x dim of image section from table"},ydim:{type:"string",helper:"y dim of image section from table"},bin:{type:"string",helper:"bin factor for tables"},ixdim:{type:"string",helper:"x dim of image section from image"},iydim:{type:"string",helper:"y dim of image section from table"},ibin:{type:"string",helper:"bin factor for images"},binMode:{type:"string",helper:"'s' for summing, 'a' for averaging"},clear:{type:"string",helper:"clear image's virtual file memory"}}},JS9.Prefs.catalogsSchema={title:"Catalogs Preferences",description:"Preferences for loading tab-delimited catalogs",properties:{ras:{type:"mobject",helper:"RA patterns to look for in table"},decs:{type:"mobject",helper:"Dec patterns to look for in table"},wcssys:{type:"string",helper:"wcs system of catalog"},shape:{type:"string",helper:"shape of objects"},color:{type:"string",helper:"color of objects"},width:{type:"number",helper:"width of box objects"},height:{type:"number",helper:"height of box objects"},radius:{type:"number",helper:"radius of circle objects"},r1:{type:"number",helper:"r1 of ellipse objects"},r2:{type:"number",helper:"r2 of ellipse objects"},tooltip:{type:"string",helper:"tooltip format for objects"},skip:{type:"string",helper:"comment character in table"}}},JS9.Prefs.globalsSchema={title:"Global Preferences",description:"Global preferences for all JS9 displays",properties:{topColormaps:{type:"mobject",helper:"array of top-level colormaps"},infoBox:{type:"mobject",helper:"array of infoBox items to display"},toolBar:{type:"mobject",helper:"array of toolbar tools to display"},separate:{type:"mobject",helper:"options when separating images"},mouseActions:{type:"mobject",helper:"array of mouse actions"},touchActions:{type:"mobject",helper:"array of touch actions"},keyboardActions:{type:"mobject",helper:"object containing keyboard actions"},centerDivs:{type:"mobject",helper:"divs used when centering"},resizeDivs:{type:"mobject",helper:"divs used when resizing"},plot3d:{type:"mobject",helper:"options for 3D data cube plot"},syncOps:{type:"mobject",helper:"ops to sync between images"},wcsUnits:{type:"mobject",helper:"default units for WCS systems"},copyWcsPosFormat:{type:"string",helper:"format string using: $ra $dec $sys"},regionDisplay:{type:"string",helper:"show regions in 'lightwin' or 'display'"},regionConfigSize:{type:"string",helper:"size of region dialog: small, medium"},lightWinClose:{type:"string",helper:"ask, close, move images when closing lightwin"},fits2fits:{type:"string",helper:"make rep file?: true,false,size>N"},dynamicSelect:{type:"string",helper:"select display: click, move, false"},fits2png:{type:"boolean",helper:"convert FITS to PNG rep files?"},mousetouchZoom:{type:"boolean",helper:"scroll/pinch to zoom?"},toolbarTooltips:{type:"boolean",helper:"show tooltips in Toolbar plugin?"},logoDisplay:{type:"boolean",helper:"show JS9 logo?"},reloadRefresh:{type:"boolean",helper:"does a reload refresh the data?"},reloadRefreshReg:{type:"boolean",helper:"reloading regions file removes prev?"},regionsToClipboard:{type:"boolean",helper:"copy region mods to pseudo-clipboard?"},syncReciprocate:{type:"boolean",helper:"reciprocal image sync'ing?"},panWithinDisplay:{type:"boolean",helper:"keep panned image within the display?"},pannerDirections:{type:"boolean",helper:"show direction vectors in panner?"},magnifierRegions:{type:"boolean",helper:"show regions in magnifier?"},svgBorder:{type:"boolean",helper:"add border when exporting SVG?"}}},JS9.Prefs.sources=[{name:"globals",schema:JS9.Prefs.globalsSchema},{name:"images",schema:JS9.Prefs.imagesSchema},{name:"fits",schema:JS9.Prefs.fitsSchema},{name:"regions",schema:JS9.Prefs.regionsSchema},{name:"grid",schema:JS9.Prefs.gridSchema},{name:"catalogs",schema:JS9.Prefs.catalogsSchema}],JS9.Prefs.init=function(){var e,t,a,i,s,r,n,o,l,c,p;for(r=JS9.Prefs.sources,l=this.id+"prefsTabs",c="<div style='padding: 8px'>",c+=sprintf("<div id='%s' class='indentmenu'>\n",l),c+="<ul>",e=0;e<r.length;e++)o=this.id+JS9.Prefs.CLASS+JS9.Prefs.NAME+(n=r[e]).name,c+=sprintf("  <li><a href='#' rel='%s'>%s</a></li>\n",o+"Div",n.name);for(c+="</ul>",c+="<br style='clear:left'></div></div><p>\n",e=0;e<r.length;e++){switch(o=this.id+JS9.Prefs.CLASS+JS9.Prefs.NAME+(n=r[e]).name,n.name){case"images":n.data=JS9.imageOpts;break;case"regions":n.data=JS9.Regions.opts;break;case"grid":n.data=JS9.Grid.opts;break;case"fits":n.data={extlist:JS9.fits.options.extlist,xdim:JS9.fits.options.table.xdim,ydim:JS9.fits.options.table.ydim,bin:JS9.fits.options.table.bin,ixdim:JS9.fits.options.image.xdim,iydim:JS9.fits.options.image.ydim,ibin:JS9.fits.options.image.bin,binMode:JS9.globalOpts.binMode,clear:JS9.globalOpts.clearImageMemory};break;case"catalogs":n.data={ras:JS9.globalOpts.catalogs.ras,decs:JS9.globalOpts.catalogs.decs,wcssys:JS9.globalOpts.catalogs.wcssys,shape:JS9.globalOpts.catalogs.shape,color:JS9.globalOpts.catalogs.color,width:JS9.globalOpts.catalogs.width,height:JS9.globalOpts.catalogs.height,radius:JS9.globalOpts.catalogs.radius,r1:JS9.globalOpts.catalogs.r1,r2:JS9.globalOpts.catalogs.r2,tooltip:JS9.globalOpts.catalogs.tooltip,skip:JS9.globalOpts.catalogs.skip};break;case"globals":n.data={fits2png:JS9.globalOpts.fits2png,fits2fits:JS9.globalOpts.fits2fits,dynamicSelect:JS9.globalOpts.dynamicSelect,toolbarTooltips:JS9.globalOpts.toolbarTooltips,logoDisplay:JS9.globalOpts.logoDisplay,syncReciprocate:JS9.globalOpts.syncReciprocate,reloadRefresh:JS9.globalOpts.reloadRefresh,reloadRefreshReg:JS9.globalOpts.reloadRefreshReg,regionsToClipboard:JS9.globalOpts.regionsToClipboard,panWithinDisplay:JS9.globalOpts.panWithinDisplay,pannerDirections:JS9.globalOpts.pannerDirections,magnifierRegions:JS9.globalOpts.magnifierRegions,svgBorder:JS9.globalOpts.svgBorder,topColormaps:JS9.globalOpts.topColormaps,mouseActions:JS9.globalOpts.mouseActions,touchActions:JS9.globalOpts.touchActions,keyboardActions:JS9.globalOpts.keyboardActions,centerDivs:JS9.globalOpts.centerDivs,resizeDivs:JS9.globalOpts.resizeDivs,plot3d:JS9.globalOpts.plot3d,syncOps:JS9.globalOpts.syncOps,wcsUnits:JS9.globalOpts.wcsUnits,mousetouchZoom:JS9.globalOpts.mousetouchZoom,copyWcsPosFormat:JS9.globalOpts.copyWcsPosFormat,regionDisplay:JS9.globalOpts.regionDisplay,regionConfigSize:JS9.globalOpts.regionConfigSize,lightWinClose:JS9.globalOpts.lightWinClose,infoBox:JS9.globalOpts.infoBox,toolBar:JS9.globalOpts.toolBar,separate:JS9.globalOpts.separate}}for(i in c+=sprintf("<div id='%s' class='tabcontent'>",o+"Div"),c+=sprintf("<form id='%s' class='js9AnalysisForm' style='max-height: %spx; overflow: hidden'>",o+"Form",this.height-90),c+=sprintf("<center><b>%s</b></center><p>",n.schema.description),s=n.schema.properties)if(s.hasOwnProperty(i))switch(p=(a=s[i]).prompt||i+":",a.type){case"boolean":t=n.data[i]?"checked":"",c+=sprintf("<div class='linegroup'><span class='column_R1'><b>%s</b></span><span class='column_R2'><input type='checkbox' name='%s' value='true' %s></span><span class='column_R4l'>%s</span></div>",p,i,t,a.helper);break;default:t="object"==typeof n.data[i]?"mobject"===a.type?JSON.stringify(n.data[i],null,2):JSON.stringify(n.data[i]):n.data[i],c+="mobject"===a.type?sprintf("<div class='linegroup' style='height:64px'><span class='column_R1'><b>%s</b></span><span class='column_R2l'><textarea name='%s' class='text_R' rows='5' style='overflow-x: hidden; resize: none'>%s</textarea></span><span class='column_R4l'>%s</span></div>",p,i,t,a.helper):sprintf("<div class='linegroup'><span class='column_R1'><b>%s</b></span><span class='column_R2l'><input type='text' name='%s' class='text_R' value='%s'></span><span class='column_R4l'>%s</span></div>",p,i,t,a.helper)}c+="<input id='"+this.id+"_applyPrefs' name='Apply' type='button' class='button' value='Apply' onclick='JS9.Prefs.applyForm.call(this);' style='margin: 8px'>",window.hasOwnProperty("localStorage")&&(c+="<input id='"+this.id+"_savePrefs' name='Save' type='button' class='button' value='Save' onclick='JS9.Prefs.saveForm.call(this)' style='margin: 8px'>",c+="<input id='"+this.id+"_showPrefs' name='Show' type='button' class='button' value='Show Saved' onclick='JS9.Prefs.showForm.call(this)' style='margin: 8px'>",c+="<input id='delete' name='Delete' type='button' class='button' value='Delete Saved' onclick='JS9.Prefs.deleteForm.call(this)' style='margin: 8px'>"),"light"===this.winType&&(c+="<input id='"+this.id+"_closePrefs' name='Close' type='button' class='button' value='Close' onclick='var form = $(this).closest(\"form\"); var winid = form.data(\"winid\"); winid.close(); return false;' style='float: right; margin: 8px'>"),c+="</form>",c+="</div>"}for(this.divjq.addClass("JS9PluginScrolling"),this.divjq.html(c),e=0;e<r.length;e++)o=this.id+JS9.Prefs.CLASS+JS9.Prefs.NAME+(n=r[e]).name,$("#"+o+"Form").data("display",this.display),$("#"+o+"Form").data("source",n),"light"===this.winType&&$("#"+o+"Form").data("winid",this.winHandle);this.tabs=new ddtabcontent(l),this.tabs.setpersist(!1),this.tabs.setselectedClassTarget("link"),this.tabs.init()},JS9.Prefs.applyForm=function(){var e=$(this).closest("form"),t=e.serializeArray(),a=e.data("display"),i=e.data("source"),s=e.data("winid");return t=t.concat($("#"+e.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get()),JS9.Prefs.processForm(i,t,a,s),!1},JS9.Prefs.saveForm=function(){var e=$(this).closest("form").data("source");JS9.Prefs.applyForm.call(this);try{localStorage.setItem(e.name,JSON.stringify(e.data,null,2)),JS9.userOpts[e.name]=localStorage.getItem(e.name)}catch(t){JS9.error("could not save prefs: "+e.name)}return!1},JS9.Prefs.showForm=function(){var e,t,a=$(this).closest("form").data("source");try{e=localStorage.getItem(a.name)}catch(i){}return t=e&&"null"!==e?"<pre>"+e+"</pre>":sprintf("<p><center>No saved prefs: %s</center>",a.name),JS9.lightWin("savedPrefs"+JS9.uniqueID(),"inline",t,"Saved prefs: "+a.name,JS9.lightOpts[JS9.LIGHTWIN].textWin),!1},JS9.Prefs.deleteForm=function(){var e=$(this).closest("form").data("source");try{localStorage.removeItem(e.name),delete JS9.userOpts[e.name]}catch(t){}return!1},JS9.Prefs.processForm=function(e,t,a,i){var s,r,n,o,l,c,p,d=t.length;switch(e.name){case"images":c=JS9.imageOpts;break;case"regions":c=JS9.Regions.opts;break;case"grid":c=JS9.Grid.opts;break;case"fits":c=JS9.fits.options;break;case"catalogs":c=JS9.globalOpts.catalogs;break;case"globals":c=JS9.globalOpts}for(s=0;s<d;s++){switch("true"===(l=t[s].value)&&(l=!0),"false"===l&&(l=!1),typeof c[o=t[s].name]){case"boolean":break;case"number":l=parseFloat(l);break;case"object":try{l=JSON.parse(l)}catch(h){JS9.error("invalid JSON (see jsonlint.com): "+l,h)}}if(c[o]!==l)switch(e.name){case"images":c[o]=l,a&&a.image&&("disable"===o?a.image.params.disable=l:a.image.setParam(o,l));break;case"regions":for(c[o]=l,r=0;r<JS9.displays.length;r++)(p=JS9.displays[r].layers.regions)&&(p.opts[o]=l);break;case"fits":switch(o){case"xdim":c.table.xdim=Math.floor(parseFloat(l));break;case"ydim":c.table.ydim=Math.floor(parseFloat(l));break;case"bin":c.table.bin=Math.floor(parseFloat(l));break;case"ixdim":c.image.xdim=Math.floor(parseFloat(l));break;case"iydim":c.image.ydim=Math.floor(parseFloat(l));break;case"ibin":c.image.bin=Math.floor(parseFloat(l));break;case"binMode":JS9.globalOpts.binMode=l;break;case"clear":JS9.globalOpts.clearImageMemory=l;break;default:c[o]=l}e.data[o]=l;break;case"catalogs":switch(o){case"skip":c[o]=l+"\n";break;default:c[o]=l}break;case"globals":switch(o){case"toolBar":c[o]=l,JS9.SetToolbar("init"),e.data[o]=l;break;case"toolbarTooltips":c[o]=l,e.data[o]=l;break;case"logoDisplay":for(c[o]=l,JS9.SetToolbar("init"),e.data[o]=l,n=l?"block":"none",r=0;r<JS9.displays.length;r++)JS9.displays[r].iconjq.css("display",n);break;case"separate":default:c[o]=l,e.data[o]=l}break;default:c[o]=l}}if(JS9.globalOpts.extendedPlugins)for(r=0;r<JS9.displays.length;r++)JS9.displays[r].image&&JS9.displays[r].image.xeqPlugins("image","onupdateprefs")},JS9.RegisterPlugin(JS9.Prefs.CLASS,JS9.Prefs.NAME,JS9.Prefs.init,{menuItem:"Preferences",help:"help/prefs.html",winTitle:"User Preferences",winResize:!0,winDims:[JS9.Prefs.WIDTH,JS9.Prefs.HEIGHT]}),JS9.ScaleLimits={},JS9.ScaleLimits.CLASS="JS9",JS9.ScaleLimits.NAME="Scale",JS9.ScaleLimits.WIDTH=512,JS9.ScaleLimits.HEIGHT=400,JS9.ScaleLimits.WIDTHOFFSET=40,JS9.ScaleLimits.HEIGHTOFFSET=210,JS9.ScaleLimits.BASE=JS9.ScaleLimits.CLASS+JS9.ScaleLimits.NAME,JS9.ScaleLimits.XSCALE="linear",JS9.ScaleLimits.YSCALE="log",JS9.ScaleLimits.NDIST=512,JS9.ScaleLimits.TIMEOUT=250,JS9.ScaleLimits.CARET=4,JS9.ScaleLimits.XTEXTHEIGHT=14,JS9.ScaleLimits.XTEXTFONT="Ariel",JS9.ScaleLimits.XTEXTCOLOR="black",JS9.ScaleLimits.XTEXTFRAC=.75,JS9.ScaleLimits.YTEXTFRAC=.15,JS9.ScaleLimits.PLOTCOLOR="#030AE4",JS9.ScaleLimits.XLOCOLOR="#FF0000",JS9.ScaleLimits.XHICOLOR="#00FF00",JS9.ScaleLimits.AXISFONT={size:12,family:"Ariel",color:"black"},JS9.ScaleLimits.AXISFANCY=!0,JS9.ScaleLimits.dataOpts={bars:{show:!0,align:"center",barWidth:.1},clickable:!0,hoverable:!0,data:[]},JS9.ScaleLimits.plotOpts={selection:{mode:"x"},grid:{hoverable:!0}},JS9.ScaleLimits.scalelimsHTML="<div class='JS9ScaleLinegroup'>$header</div><div class='JS9ScaleLinegroup'>$scales&nbsp;&nbsp;$limits&nbsp;&nbsp;$axes</div><p><div class='JS9ScaleLinegroup'>$plot</div><p><div class='JS9ScaleLinegroup'><span class='JS9ScaleSpan' style='float: left'>&nbsp;&nbsp;$lo&nbsp;&nbsp;&nbsp;&nbsp;$hi</span></div>",JS9.ScaleLimits.headerHTML="Set clipping limits via the Data Limits menu, or by selecting part of the Pixel Distribution plot, or by changing the Low and/or High limit.",JS9.ScaleLimits.scalesHTML="<select class=\"JS9ScaleSelect\" onchange=\"JS9.ScaleLimits.xsetscale('%s', '%s', this)\">%s</select>",JS9.ScaleLimits.limitsHTML='<select class="JS9ScaleSelect" onchange="JS9.ScaleLimits.xsetlims(\'%s\', \'%s\', this)"><option selected disabled>Data Limits</option><option value="dataminmax">data min/max</option><option value="zscale_z1_z2">zscale z1/z2</option><option value="zscale_z1_datamax">zscale z1/max</option></select>',JS9.ScaleLimits.axesHTML='<select class="JS9ScaleSelect" onchange="JS9.ScaleLimits.xaxes(\'%s\', \'%s\', this)"><option selected disabled>Plot Axes</option><option disabled>x axis:</option><option value="xlinear">linear</option><option value="xlog">log</option><option disabled>y axis:</option><option value="ylinear">linear</option><option value="ylog">log</option></select>',JS9.ScaleLimits.plotHTML='<div><center>Pixel Distribution: %s</center></div><div class="JS9ScalePlot" style="width:%spx;height:%spx"></div>',JS9.ScaleLimits.loHTML='Low:&nbsp;&nbsp;<input type="text" class="JS9ScaleValue" value=\'%s\' onchange="JS9.ScaleLimits.xsetlo(\'%s\', \'%s\', this)" size="16">',JS9.ScaleLimits.hiHTML='High:&nbsp;&nbsp;<input type="text" class="JS9ScaleValue" value=\'%s\' onchange="JS9.ScaleLimits.xsethi(\'%s\', \'%s\', this)" size="16">',JS9.ScaleLimits.xsetscale=function(e,t,a){var i=JS9.lookupImage(t,e);i&&i.setScale(a.value)},JS9.ScaleLimits.xsetlo=function(e,t,a){var i,s=JS9.lookupImage(t,e);s&&(i=parseFloat(a.value),s.setScale(i,s.params.scalemax))},JS9.ScaleLimits.xsethi=function(e,t,a){var i,s=JS9.lookupImage(t,e);s&&(i=parseFloat(a.value),s.setScale(s.params.scalemin,i))},JS9.ScaleLimits.xsetlims=function(e,t,a){var i=JS9.lookupImage(t,e);if(i)switch(a.value){case"dataminmax":i.setScale("dataminmax",i.raw.dmin,i.raw.dmax);break;case"zscale_z1_z2":i.setScale("zscale",i.params.z1,i.params.z2);break;case"zscale_z1_datamax":i.setScale("zmax",i.params.z1,i.raw.dmax)}},JS9.ScaleLimits.log10=function(e){return e<=0?null:Math.log(e)/Math.LN10},JS9.ScaleLimits.xaxes=function(e,t,a){var i,s=JS9.lookupImage(t,e);if(s){if(!(i=s.display.pluginInstances[JS9.ScaleLimits.BASE])||!i.plot)return;switch(a.value){case"xlinear":i.xscale="linear",JS9.ScaleLimits.doplot.call(i,s);break;case"xlog":i.xscale="log",JS9.ScaleLimits.doplot.call(i,s);break;case"ylinear":i.yscale="linear",JS9.ScaleLimits.doplot.call(i,s);break;case"ylog":i.yscale="log",JS9.ScaleLimits.doplot.call(i,s)}}$(a).val("Plot Axes").prop("selected",!0)},JS9.ScaleLimits.getPixelDist=function(e,t){var a,i,s=[],r=e.raw.dmin,n=e.raw.dmax-e.raw.dmin,o=e.raw.width*e.raw.height;for(a=0;a<t;a++)s[a]=0;for(a=0;a<o;a++)(i=Math.floor((e.raw.data[a]-r)/n*t+.5))>=0&&i<t&&(s[i]+=1);return s},JS9.ScaleLimits.to10E=function(e){return JS9.ScaleLimits.AXISFANCY&&e>=0&&e<=9?"10"+["\u2070","\xb9","\xb2","\xb3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079"][e]:"10E"+String(e)},JS9.ScaleLimits.doplot=function(e){var t,a,i,s,r,n,o,l,c,p,d,h,g=this,u=e.raw.dmin,m=e.raw.dmax-e.raw.dmin,f=$.extend(!0,{},JS9.ScaleLimits.dataOpts),y=$.extend(!0,{},JS9.ScaleLimits.plotOpts),b=function(e,t,a){var i=e.getCanvas().getContext("2d"),s=JS9.ScaleLimits.CARET,r=e.pointOffset({x:t,y:0});i.beginPath(),i.moveTo(r.left,r.top),i.lineTo(r.left-s,r.top-2*s),i.lineTo(r.left+s,r.top-2*s),i.lineTo(r.left,r.top),i.fillStyle=a,i.fill()};for(this.plotComplete=!1,this.plotColor&&(f.color=this.plotColor),o=JS9.ScaleLimits.getPixelDist(e,this.ndist),t=0;t<this.ndist;t++)f.data[t]=[t,o[t]];if(y.xaxis=y.xaxis||{},y.xaxis.font=JS9.ScaleLimits.AXISFONT,"linear"===this.xscale)for(y.xaxis.transform=null,y.xaxis.ticks=[],d=(h=m)<10?1:h<50?5:h<250?10:h<500?50:h<2500?100:h<5e3?500:h<25e3?1e3:h<5e4?5e3:h<25e4?1e4:h<5e5?5e4:h<25e5?1e5:h<5e6?5e5:h<25e6?1e6:1e7,p=Math.floor(m/d+.5)+1,t=0;t<p;t++)a=t*d,i=String(a),y.xaxis.ticks[t]=[(a-u)*this.ndist/m,i];else if("log"===this.xscale)for(y.xaxis.transform=JS9.ScaleLimits.log10,y.xaxis.min=1,y.xaxis.ticks=[],p=JS9.ScaleLimits.log10(this.ndist)+1,t=0;t<p;t++)a=Math.floor((Math.pow(10,t)-u)*this.ndist/m),y.xaxis.ticks[t]=[a,JS9.ScaleLimits.to10E(t)];if(r=(e.params.scalemin-u)/m*this.ndist,n=(e.params.scalemax-u)/m*this.ndist,y.yaxis=y.yaxis||{},y.yaxis.font=JS9.ScaleLimits.AXISFONT,"linear"===this.yscale)y.yaxis.transform=null,y.yaxis.ticks=null;else if("log"===this.yscale){for(y.yaxis.transform=JS9.ScaleLimits.log10,y.yaxis.min=1,y.yaxis.ticks=[],t=0;t<this.ndist;t++)(void 0===l||o[t]<l)&&(l=o[t]),(void 0===c||o[t]>c)&&(c=o[t]);for(p=JS9.ScaleLimits.log10(c-l+1),t=0;t<p;t++)y.yaxis.ticks[t]=[Math.pow(10,t),JS9.ScaleLimits.to10E(t)]}s=this.divjq.find(".JS9ScalePlot"),this.timeout&&(window.clearTimeout(this.timeout),this.timeout=null),s.off("plotselected"),s.on("plotselected",function(t,a){var i=a.xaxis.from,s=a.xaxis.to;"log"===g.xscale&&(i=Math.pow(10,i),s=Math.pow(10,s)),e.setScale("user",i=i*m/g.ndist+u,s=s*m/g.ndist+u)}),s.off("plothover"),s.on("plothover",function(e,t){var a,i,s,r,n,o,l,c=t.x;g.plot&&g.plotComplete&&("log"===g.xscale&&(c=Math.pow(10,c)),l=c*m/g.ndist+u,isFinite(l)&&(s=JS9.floatToString(l),(a=g.plot.getCanvas().getContext("2d")).save(),a.textBaseline="top",a.font=JS9.ScaleLimits.XTEXTHEIGHT+"px "+JS9.ScaleLimits.XTEXTFONT,a.fillStyle=JS9.ScaleLimits.XTEXTCOLOR||"black",i=a.measureText(s),o=Math.max(g.lastTextWidth,i.width+2),a.clearRect(r=g.plotWidth*JS9.ScaleLimits.XTEXTFRAC,n=g.plotHeight*JS9.ScaleLimits.YTEXTFRAC,o,JS9.ScaleLimits.XTEXTHEIGHT+2),a.fillText(s,r,n),a.restore(),g.lastTextWidth=o))}),this.timeout=window.setTimeout(function(){g.plot=$.plot(s,[f],y),g.timeout=null,b(g.plot,r,g.xlocolor),b(g.plot,n,g.xhicolor),g.plotComplete=!0},JS9.ScaleLimits.TIMEOUT)},JS9.ScaleLimits.display=function(){this.lastimage!==this.display.image&&JS9.ScaleLimits.init.call(this)},JS9.ScaleLimits.close=function(){JS9.ScaleLimits.init.call(this,{mode:"clear"})},JS9.ScaleLimits.init=function(e){var t,a,i,s,r;e=e||{},this.width=this.divjq.attr("data-width"),this.width||(this.width=JS9.ScaleLimits.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=JS9.ScaleLimits.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.plotWidth=this.plotWidth||this.divjq.attr("data-plotWidth"),this.plotWidth||(this.plotWidth=this.width-JS9.ScaleLimits.WIDTHOFFSET),this.plotHeight=this.plotHeight||this.divjq.attr("data-plotHeight"),this.plotHeight||(this.plotHeight=this.height-JS9.ScaleLimits.HEIGHTOFFSET),this.xscale=this.xscale||this.divjq.attr("data-xscale"),this.xscale||(this.xscale=JS9.ScaleLimits.XSCALE),this.yscale=this.yscale||this.divjq.attr("data-yscale"),this.yscale||(this.yscale=JS9.ScaleLimits.YSCALE),this.plotColor=this.plotColor||this.divjq.attr("data-plotColor"),this.plotColor||(this.plotColor=JS9.ScaleLimits.PLOTCOLOR),this.xlocolor=this.xlocolor||this.divjq.attr("data-xlocolor"),this.xlocolor||(this.xlocolor=JS9.ScaleLimits.XLOCOLOR),this.xhicolor=this.xhicolor||this.divjq.attr("data-xhicolor"),this.xhicolor||(this.xhicolor=JS9.ScaleLimits.XHICOLOR),this.ndist=this.divjq.attr("data-ndist"),this.ndist||(this.ndist=JS9.ScaleLimits.NDIST),this.divjq.html(""),this.lastTextWidth=0,this.scalelimsContainer=$("<div>").addClass(JS9.ScaleLimits.BASE+"Container").attr("id",this.id+"Container").attr("width",this.width).attr("height",this.height).appendTo(this.divjq),(a=this.display.image)&&"clear"!==e.mode?(s=a.id,r=a.display.id,(i=[]).push({name:"header",value:JS9.ScaleLimits.headerHTML}),i.push({name:"scales",value:sprintf(JS9.ScaleLimits.scalesHTML,r,s,function(){var e,t="<option selected disabled>Scales</option>";for(e=0;e<JS9.scales.length;e++)t+="<option>"+JS9.scales[e]+"</option>";return t}())}),i.push({name:"limits",value:sprintf(JS9.ScaleLimits.limitsHTML,r,s)}),i.push({name:"axes",value:sprintf(JS9.ScaleLimits.axesHTML,r,s)}),i.push({name:"plot",value:sprintf(JS9.ScaleLimits.plotHTML,s,this.plotWidth,this.plotHeight)}),i.push({name:"lo",value:sprintf(JS9.ScaleLimits.loHTML,JS9.floatToString(a.params.scalemin),r,s)}),i.push({name:"hi",value:sprintf(JS9.ScaleLimits.hiHTML,JS9.floatToString(a.params.scalemax),r,s)}),t=a.expandMacro(JS9.ScaleLimits.scalelimsHTML,i),this.lastimage=a):t="<p><center>Scale parameters will appear here.</center>",this.scalelimsContainer.html(t),a&&JS9.ScaleLimits.doplot.call(this,a)},JS9.RegisterPlugin(JS9.ScaleLimits.CLASS,JS9.ScaleLimits.NAME,JS9.ScaleLimits.init,{menu:"scale",menuItem:"Scale Controls ...",onplugindisplay:JS9.ScaleLimits.init,onsetscale:JS9.ScaleLimits.init,onimagedisplay:JS9.ScaleLimits.display,onimageclose:JS9.ScaleLimits.close,help:"help/scalelimits.html",winTitle:"Scale Controls",winDims:[JS9.ScaleLimits.WIDTH,JS9.ScaleLimits.HEIGHT]}),JS9.Separate={},JS9.Separate.CLASS="JS9",JS9.Separate.NAME="Separate",JS9.Separate.WIDTH=512,JS9.Separate.HEIGHT=336,JS9.Separate.BASE=JS9.Separate.CLASS+JS9.Separate.NAME,JS9.Separate.topHTML="$separate<p>$gather",JS9.Separate.separateHTML='<b>separate selected</b> images or <b>separate all</b> images into different displays. The topmost (selected) image remains in place, and the presence or absence of its menubar, toolbar, and colorbar will be replicated in the new displays:<p><div><input type="button" class="separateButton1" name="separate" value="separate selected" onclick="javascript:JS9.Separate.separate.call(this, \'%s\', \'selected\');">;<input type="button" class="separateButton2" name="separate" value="separate all" onclick="javascript:JS9.Separate.separate.call(this, \'%s\', \'all\');"><span style=\'float: right\'><select class="separateLayoutSelect" onchange="JS9.Separate.xlayout.call(this, \'%s\')"><option selected disabled>layout</option><option value="auto">auto</option><option value="horizontal">horizontal</option><option value="vertical">vertical</option></select></span></div><p>',JS9.Separate.gatherHTML='<b>gather selected</b> images or  <b>gather all</b> images into this display:<p><div><input type="button" class="separateButton1" name="gather" value="gather selected" onclick="javascript:JS9.Separate.gather.call(this, \'%s\', \'selected\');"><input type="button" class="separateButton2" name="gather" value="gather all" onclick="javascript:JS9.Separate.gather.call(this, \'%s\', \'all\');"></div><p>',JS9.Separate.imageHTML="<span style='float: left'>$active&nbsp;&nbsp;</span><span id='separateFile'>$imfile</span>",JS9.Separate.activeHTML='<input class="separateActiveCheck" type="checkbox" id="active" name="active" value="active" onclick="javascript:JS9.Separate.xactive.call(this, \'%s\')">select',JS9.Separate.imfileHTML="<b>%s</b>",JS9.Separate.nofileHTML='<p><span id="NoFile">[Images will appear here as they are loaded]</span>',JS9.Separate.xactive=function(e){var t=JS9.lookupImage(e);t&&(t.tmp.separateMode=this.checked)},JS9.Separate.xlayout=function(e){var t,a=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e));a&&(t=a.pluginInstances.JS9Separate)&&this.selectedIndex>=0&&(t.separateLayout=this.options[this.selectedIndex].value)},JS9.Separate.separate=function(e,t){var a,i,s,r,n={},o=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e));if(o){switch((s=o.pluginInstances.JS9Separate)&&s.separateLayout&&(n.layout=s.separateLayout),t){case"selected":for(r=[],a=0;a<JS9.images.length;a++)(i=JS9.images[a]).tmp.separateMode&&r.push(i);if(!r.length)return;n.images=r}o.separate(n)}},JS9.Separate.gather=function(e,t){var a,i,s,r={},n=JS9.getDynamicDisplayOr(JS9.lookupDisplay(e));if(n){switch(t){case"all":n.gather();break;case"selected":for(s=[],a=0;a<JS9.images.length;a++)(i=JS9.images[a]).tmp.separateMode&&s.push(i);if(!s.length)return;r.images=s}n.gather(r)}},JS9.Separate.imid=function(e){return(e.display.id+"_"+e.id).replace(/[^A-Za-z0-9_]/g,"_")+"SeparateImage"},JS9.Separate.dispclass=function(e){return(JS9.Separate.BASE+"_"+e.display.id).replace(/[^A-Za-z0-9_]/g,"_")},JS9.Separate.activeImage=function(e){var t,a;e&&(t=JS9.Separate.imid(e),a=JS9.Separate.dispclass(e)+"_Image",$("."+a).removeClass(JS9.Separate.BASE+"ImageActive").addClass(JS9.Separate.BASE+"ImageInactive"),$("#"+t).removeClass(JS9.Separate.BASE+"ImageInactive").addClass(JS9.Separate.BASE+"ImageActive"))},JS9.Separate.addImage=function(e){var t,a,i,s,r,n=[],o=JS9.Separate.BASE+"Image";e&&(r=e.id,a=JS9.Separate.imid(e),s=JS9.Separate.dispclass(e)+"_Image",n.push({name:"imid",value:e.id}),n.push({name:"active",value:sprintf(JS9.Separate.activeHTML,r)}),n.push({name:"imfile",value:sprintf(JS9.Separate.imfileHTML,r)}),this.separateDivs||this.separateImageContainer.html(""),t=JS9.Image.prototype.expandMacro.call(e,JS9.Separate.imageHTML,n),(i=$("<div>").addClass(o).addClass(s).attr("id",a).prop("imid",r).html(t).appendTo(this.separateImageContainer)).on("mousedown touchstart",function(){e.displayImage(),JS9.Separate.activeImage.call(this,e)}),this.separateDivs++,i.find(".separateActiveCheck").prop("checked",!0===e.tmp.separateMode),JS9.Separate.activeImage(e))},JS9.Separate.removeImage=function(e){var t;return!!e&&(t=JS9.Separate.imid(e),$("#"+t).remove(),this.separateDivs--,0===this.separateDivs&&this.separateImageContainer.html(JS9.Separate.nofileHTML),delete e.tmp.separateMode,!0)},JS9.Separate.init=function(){var e,t,a,i,s,r=this,n=[];for(this.divjq.html(""),this.separateDivs=0,this.divjq.addClass("JS9PluginScrolling"),this.separateContainer=$("<div>").addClass(JS9.Separate.BASE+"Container").attr("id",this.id+"SeparateContainer").css("overflow","auto").appendTo(this.divjq),s=this.display.id,n.push({name:"separate",value:sprintf(JS9.Separate.separateHTML,s,s,s)}),n.push({name:"gather",value:sprintf(JS9.Separate.gatherHTML,s,s)}),t=JS9.Image.prototype.expandMacro.call(null,JS9.Separate.topHTML,n),this.separateHeader=$("<div>").addClass(JS9.Separate.BASE+"Header").attr("id",s+"Header").html(t).appendTo(this.separateContainer),this.separateImageContainer=$("<div>").addClass(JS9.Separate.BASE+"ImageContainer").attr("id",this.id+"SeparateImageContainer").html(JS9.Separate.nofileHTML).appendTo(this.separateContainer),i=JS9.getDynamicDisplayOr(this.display),e=0;e<JS9.images.length;e++)(a=JS9.images[e]).display===i&&JS9.Separate.addImage.call(this,a);this.separateImageContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var a=t.item.index();JS9.images.splice(a,0,JS9.images.splice(this.oidx,1)[0]),r.display.image&&r.display.image.displayImage()}})},JS9.Separate.imageload=function(e){var t=JS9.getDynamicDisplayOr(this.display);e&&e.display===t&&JS9.Separate.addImage.call(this,e)},JS9.Separate.imagedisplay=function(e){JS9.Separate.activeImage.call(this,e)},JS9.Separate.imageclose=function(e){JS9.Separate.removeImage.call(this,e)},JS9.Separate.reinit=function(e){e&&JS9.Separate.init.call(this)},JS9.RegisterPlugin(JS9.Separate.CLASS,JS9.Separate.NAME,JS9.Separate.init,{menuItem:"Separate/Gather",dynamicSelect:!0,onplugindisplay:JS9.Separate.init,ondynamicselect:JS9.Separate.reinit,ongatherdisplay:JS9.Separate.reinit,onimageload:JS9.Separate.imageload,onimagedisplay:JS9.Separate.imagedisplay,onimageclose:JS9.Separate.imageclose,help:"help/separate.html",winTitle:"Separate/Gather Images",winResize:!0,winDims:[JS9.Separate.WIDTH,JS9.Separate.HEIGHT]}),JS9.Sync={},JS9.Sync.CLASS="JS9",JS9.Sync.NAME="Sync",JS9.Sync.getOps=function(e){var t,a,i,s=[];for(e=e||JS9.globalOpts.syncOps,$.isArray(e)||(e=[e]),t=0,a=0;t<e.length;t++)switch(i=e[t]){case"wcs":s[a++]="wcssys",s[a++]="wcunits";break;default:s[a++]=i}return s},JS9.Sync.getIms=function(e){var t,a,i,s=[];for(e=e||JS9.images,$.isArray(e)||(e=[e]),t=0,a=0;t<e.length;t++)!(i="string"==typeof e[t]?JS9.lookupImage(e[t]):e[t])||i.id===this.id&&i.display.id===this.display.id||(s[a++]=i);return s},JS9.Sync.sync=function(e,t,a){var i,s,r,n,o,l,c,p=[];if(this.syncs=this.syncs||{active:!0},a=a||{reciprocate:JS9.globalOpts.syncReciprocate},1!==arguments.length||"boolean"!=typeof e)if(o=JS9.Sync.getOps.call(this,e),c=(l=JS9.Sync.getIms.call(this,t)).length,a.reverse)for(delete a.reverse,i=0;i<c;i++)JS9.Sync.sync.call(l[i],o,[this]);else{for(i=0;i<o.length;i++)for(this.syncs[r=o[i]]=this.syncs[r]||[],t=this.syncs[r],s=0;s<c;s++)n=l[s],$.inArray(n,t)<0&&(t.push(n),p.push({im:this,xim:n,xop:r,xarg:null}));if(a.reciprocate){for(JS9.Sync.reciprocating=!0,a.reciprocate=!1,i=0,n=this;i<c;i++)l.push(n),n=l.shift(),JS9.Sync.sync.call(n,o,l,a);delete JS9.Sync.reciprocating}JS9.Sync.reciprocating||(JS9.Sync.xeqSync.call(this,p),JS9.Sync.ready=!0)}else this.syncs.active=e},JS9.Sync.unsync=function(e,t,a){var i,s,r,n,o,l,c;if(this.syncs)if(a=a||{reciprocate:JS9.globalOpts.syncReciprocate},n=JS9.Sync.getOps.call(this,e),l=(o=JS9.Sync.getIms.call(this,t)).length,a.reverse)for(delete a.reverse,i=0;i<l;i++)JS9.Sync.unsync.call(o[i],n,[this]);else{for(s in this.syncs)if(this.syncs.hasOwnProperty(s)){if(n&&$.inArray(s,n)<0)continue;if(o){for(i=(r=this.syncs[s]).length-1;i>=0;i--)$.inArray(r[i],o)>=0&&r.splice(i,1);r.length||delete this.syncs[s]}else delete this.syncs[s]}if(Object.keys(this.syncs).length||delete this.syncs,a.reciprocate){for(JS9.Sync.reciprocating=!0,a.reciprocate=!1,i=0,c=this;i<l;i++)o.push(c),c=o.shift(),JS9.Sync.unsync.call(c,n,o,a);delete JS9.Sync.reciprocating}}},JS9.Sync.xeqSync=function(e){var t,a,i,s,r,n,o,l,c,p,d,h,g,u,m,f=JS9.globalOpts.xeqPlugins,y=this.id+"_"+this.display.id;if(!this.syncs.running){this.syncs.running=!0;try{for(t=0;t<e.length;t++)if((o=(s=e[t]).xim).display.image===o){o.syncs&&(o.syncs.running=!0);try{switch(s.xop){case"colormap":o.setColormap(this.params.colormap);break;case"contrastbias":o.setColormap(this.params.contrast,this.params.bias);break;case"pan":this.raw.wcs>0&&(r=this.displayToImagePos({x:this.display.width/2,y:this.display.height/2}),n=JS9.pix2wcs(this.raw.wcs,r.x,r.y),o.setPan({wcs:n}));break;case"regions":if(m=[],l=null,s.xarg)m.push(s.xarg);else for(g||(g=this.getShapes("regions")),l=o.getShapes("regions"),a=0;a<g.length;a++){for(g[a].mode="add",i=0;i<l.length;i++)if(S=g[a],(b=l[i]).data&&b.data.syncid&&S.data&&S.data.syncid&&b.data.syncid===S.data.syncid){g[a].mode="update";break}m.push(g[a])}for(a=0;a<m.length;a++)switch(h=(d=$.extend(!0,{},m[a])).data&&d.data.syncid?d.data.syncid:y+"_"+d.id,d.mode){case"add":p={doexport:!1,syncid:h},JS9.globalOpts.xeqPlugins=!1,this.changeShapes("regions",d.id,{data:p}),JS9.globalOpts.xeqPlugins=f,u=this.listRegions(d.id,{mode:1}),o.addShapes("regions",u,{data:p});break;case"remove":for(l||(l=o.getShapes("regions")),i=0;i<l.length;i++)(c=l[i].data)&&c.syncid&&c.syncid===h&&o.removeShapes("regions",l[i].id);break;case"move":case"update":for(delete d.sizeScale,this.raw.wcsinfo&&o.raw.wcsinfo&&(o.raw.wcsinfo.cdelt1&&(d.sizeScale=this.raw.wcsinfo.cdelt1/o.raw.wcsinfo.cdelt1),o.raw.wcsinfo.crot&&("box"===d.shape||"ellipse"===d.shape||"text"===d.shape&&!d.parent)&&(d.angle+=o.raw.wcsinfo.crot)),l||(l=o.getShapes("regions")),i=0;i<l.length;i++)(c=l[i].data)&&c.syncid&&c.syncid===h&&o.changeShapes("regions",l[i].id,d)}break;case"scale":o.setScale(this.params.scale);break;case"wcssys":o.setWCSSys(this.params.wcssys);break;case"wcsunits":o.setWCSUnits(this.params.wcsunits);break;case"zoom":o.setZoom(this.params.zoom)}}catch(v){}finally{o.syncs&&delete o.syncs.running}}}catch(v){}finally{delete this.syncs.running}var b,S}},JS9.Sync.maybeSync=function(e,t){var a,i,s=[];if(JS9.Sync.ready&&this.syncs&&!this.syncs.running&&this.syncs&&this.syncs.active&&$.isArray(this.syncs[e])&&this.syncs[e].length){for(i=this.syncs[e],a=0;a<i.length;a++)s.push({xim:i[a],xop:e,xarg:t});JS9.Sync.xeqSync.call(this,s)}},JS9.Sync.init=function(){return this},JS9.Sync.setcolormap=function(e){e&&JS9.Sync.maybeSync.call(e,"colormap")},JS9.Sync.changecontrastbias=function(e){e&&JS9.Sync.maybeSync.call(e,"contrastbias")},JS9.Sync.setpan=function(e){e&&JS9.Sync.maybeSync.call(e,"pan")},JS9.Sync.regionschange=function(e,t){e&&JS9.Sync.maybeSync.call(e,"regions",t)},JS9.Sync.setscale=function(e){e&&JS9.Sync.maybeSync.call(e,"scale")},JS9.Sync.setwcssys=function(e){e&&JS9.Sync.maybeSync.call(e,"wcssys")},JS9.Sync.setwcsunits=function(e){e&&JS9.Sync.maybeSync.call(e,"wcsunits")},JS9.Sync.setzoom=function(e){e&&JS9.Sync.maybeSync.call(e,"zoom")},JS9.Sync.closeimage=function(e){var t;if(e)for(t=0;t<JS9.images.length;t++)JS9.Sync.unsync.call(JS9.images[t],null,[e])},JS9.Image.prototype.syncImages=JS9.Sync.sync,JS9.mkPublic("SyncImages","syncImages"),JS9.Image.prototype.unsyncImages=JS9.Sync.unsync,JS9.mkPublic("UnsyncImages","unsyncImages"),JS9.RegisterPlugin(JS9.Sync.CLASS,JS9.Sync.NAME,JS9.Sync.init,{onsetcolormap:JS9.Sync.setcolormap,onsetpan:JS9.Sync.setpan,onregionschange:JS9.Sync.regionschange,onsetscale:JS9.Sync.setscale,onsetwcssys:JS9.Sync.setwcssys,onsetwcsunits:JS9.Sync.setwcsunits,onsetzoom:JS9.Sync.setzoom,onchangecontrastbias:JS9.Sync.changecontrastbias,onimageload:JS9.Sync.loadimage,onimageclose:JS9.Sync.closeimage,winDims:[0,0]}),JS9.Toolbar={},JS9.Toolbar.CLASS="JS9",JS9.Toolbar.NAME="Toolbar",JS9.Toolbar.WIDTH=512,JS9.Toolbar.HEIGHT=36,JS9.Toolbar.BASE=JS9.Toolbar.CLASS+JS9.Toolbar.NAME,JS9.Toolbar.IMAGEWIDTH=24,JS9.Toolbar.IMAGEHEIGHT=24,JS9.Toolbar.TOOLBARHEIGHT=36,JS9.Toolbar.TOOLTIPX=30,JS9.Toolbar.TOOLTIPY=50,JS9.Toolbar.TOOLTIPLX=30,JS9.Toolbar.TOOLTIPLY=82,JS9.Toolbar.tools=[{name:"linear",tip:"linear scale",cmd:"SetScale",args:["linear"]},{name:"log",tip:"log scale",cmd:"SetScale",args:["log"]},{name:"histeq",tip:"histogram equalization",cmd:"SetScale",args:["histeq"]},{name:"power",tip:"power scale",cmd:"SetScale",args:["power"]},{name:"sqrt",tip:"square root scale",cmd:"SetScale",args:["sqrt"]},{name:"asinh",tip:"asinh scale",cmd:"SetScale",args:["asinh"]},{name:"sinh",tip:"sinh scale",cmd:"SetScale",args:["sinh"]},{name:"squared",tip:"squared scale",cmd:"SetScale",args:["squared"]},{name:"annulus",tip:"annulus region",image:"images/toolbar/svg/annulus.svg",cmd:"AddRegions",args:["annulus"]},{name:"box",tip:"box region",image:"images/toolbar/svg/box.svg",cmd:"AddRegions",args:["box"]},{name:"circle",tip:"circle region",image:"images/toolbar/svg/circle.svg",cmd:"AddRegions",args:["circle"]},{name:"ellipse",tip:"ellipse region",image:"images/toolbar/svg/ellipse.svg",cmd:"AddRegions",args:["ellipse"]},{name:"line",tip:"line region",image:"images/toolbar/svg/line.svg",cmd:"AddRegions",args:["line"]},{name:"polygon",tip:"polygon region",image:"images/toolbar/svg/polygon.svg",cmd:"AddRegions",args:["polygon"]},{name:"text",tip:"text region",image:"images/toolbar/svg/txt.svg",cmd:"AddRegions",args:["text"]},{name:"inc/excl",tip:"toggle selected region incl/excl",cmd:"ToggleRegionTags",args:["selected","include","exclude"]},{name:"src/bkg",tip:"toggle selected region src/bkg",cmd:"ToggleRegionTags",args:["selected","source","background"]},{name:"remove",tip:"remove selected region",cmd:"RemoveRegions",args:["selected"]},{name:"zoom+",tip:"zoom in",cmd:"SetZoom",args:["x2"]},{name:"zoom-",tip:"zoom out",cmd:"SetZoom",args:["/2"]},{name:"zoom1",tip:"zoom 1",cmd:"SetZoom",args:[1]},{name:"open",tip:"open local file dialog box",cmd:"OpenFileMenu",args:[]},{name:"infobox",tip:"toggle infobox display",cmd:"DisplayPlugin",args:["JS9Info"]},{name:"magnifier",tip:"toggle magnifier display",cmd:"DisplayPlugin",args:["JS9Magnifier"]},{name:"panner",tip:"toggle panner display",cmd:"DisplayPlugin",args:["JS9Panner"]},{name:"prefs",tip:"toggle preferences display",cmd:"DisplayPlugin",args:["JS9Preferences"]}],JS9.Toolbar.tooltip=function(e,t,a){var i,s,r,n;t?(n=$(a.currentTarget).position(),this.tooltip.html(t),"light"===this.winType?(i=n.left+JS9.Toolbar.TOOLTIPLX,s=n.top-JS9.Toolbar.TOOLTIPLY):(i=n.left+JS9.Toolbar.TOOLTIPX,s=n.top-JS9.Toolbar.TOOLTIPY),i+(r=this.tooltip.width())+20>this.width&&(i=n.left-r-20),this.tooltip.css({left:i,top:s,display:"inline-block"})):this.tooltip.html("").css({left:-9999,display:"none"})},JS9.Toolbar.addTool=function(e){var t,a,i,s=this;return e?"$break"!==e?(e.name&&e.cmd||JS9.error("invalid input to JS9.toolbar: "+JSON.stringify(e)),t=$("<div>").addClass(JS9.Toolbar.BASE+"ButtonDiv").appendTo(this.activeToolbar),e.image?(i=e.image,JS9.inline&&JS9.inline[i]?i=JS9.inline[i]:"/"!==i.charAt(0)&&(i=JS9.InstallDir(i)),a=$("<input>").addClass(JS9.Toolbar.BASE+"ImageButton").attr("type","image").attr("src",i).attr("width",JS9.Toolbar.IMAGEWIDTH).attr("height",JS9.Toolbar.IMAGEHEIGHT).attr("alt",e.name).appendTo(t)):a=$("<input>").addClass(JS9.Toolbar.BASE+"ButtonButton").attr("type","button").attr("value",e.name).appendTo(t),a.on("click",function(){var t,a=s.display;"function"==typeof JS9.publics[e.cmd]?((t=JSON.parse(JSON.stringify(e.args||[]))).push({display:a}),JS9.publics[e.cmd].apply(null,t)):JS9.error("unknown JS9 function for toolbar: "+e.cmd)}),JS9.globalOpts.toolbarTooltips&&(a.on("mouseover",function(t){JS9.Toolbar.tooltip.call(s,e,e.tip||e.name,t)}),a.on("mouseout",function(t){JS9.Toolbar.tooltip.call(s,e,null,t)})),e.btn=a,e):void $("<hr>").appendTo(this.activeToolbar):JS9.Toolbar.tools},JS9.Toolbar.init=function(e,t){var a,i,s,r;for(this.width=this.divjq.attr("data-width"),this.width||(this.width=e||JS9.Toolbar.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=t||JS9.Toolbar.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.divjq.html(""),this.toolbarContainer=$("<div>").addClass(JS9.Toolbar.BASE+"Container").attr("id",this.id+"Container").appendTo(this.divjq),this.activeToolbar=$("<div>").addClass(JS9.Toolbar.BASE+"Div").attr("id",this.id+"Toolbar").css("width",this.width).css("height",this.height).css("min-height",JS9.Toolbar.TOOLBARHEIGHT).appendTo(this.toolbarContainer),this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9ToolbarTooltip").appendTo(this.divjq),i=0;i<JS9.globalOpts.toolBar.length;i++)for(r=JS9.globalOpts.toolBar[i],a=0;a<JS9.Toolbar.tools.length;a++)r===(s=JS9.Toolbar.tools[a]).name&&JS9.Toolbar.addTool.call(this,s);for(a=0;a<JS9.Toolbar.tools.length;a++)s=JS9.Toolbar.tools[a],$.inArray(s.name,JS9.globalOpts.toolBar)<0&&JS9.Toolbar.addTool.call(this,s);return JS9.Toolbar.tools},JS9.mkPublic("GetToolbar",function(e){return"showTooltips"===(e=JS9.parsePublicArgs(arguments).argv[0])?JS9.globalOpts.toolbarTooltips:JS9.Toolbar.tools}),JS9.mkPublic("SetToolbar",function(e,t){var a,i=JS9.parsePublicArgs(arguments),s=function(){var e,t;for(e=0;e<JS9.displays.length;e++)(t=JS9.displays[e].pluginInstances.JS9Toolbar)&&JS9.Toolbar.init.call(t)};if(e=i.argv[0]){if("init"!==e){if("showTooltips"===e)return JS9.globalOpts.toolbarTooltips=!!(t=i.argv[1]),void s();if("string"==typeof e){try{e=JSON.parse(e)}catch(r){JS9.error("can't parse json for SetToolBar: "+e,r)}JS9.Toolbar.tools.push(e),s()}else if($.isArray(e)){for(a=0;a<e.length;a++)JS9.Toolbar.tools.push(e[a]);s()}else"object"==typeof e&&(JS9.Toolbar.tools.push(e),s());return null}s()}}),JS9.RegisterPlugin(JS9.Toolbar.CLASS,JS9.Toolbar.NAME,JS9.Toolbar.init,{menuItem:"Toolbar",help:"help/toolbar.html",winTitle:"Toolbar",winDims:[JS9.Toolbar.WIDTH,JS9.Toolbar.HEIGHT]}),require=function e(t,a,i){function s(n,o){if(!a[n]){if(!t[n]){var l="function"==typeof require&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=a[n]={exports:{}};t[n][0].call(p.exports,function(e){return s(t[n][1][e]||e)},p,p.exports,e,t,a,i)}return a[n].exports}for(var r="function"==typeof require&&require,n=0;n<i.length;n++)s(i[n]);return s}({"./imexam":[function(e,t,a){"use strict";var i=e("typed-array-function");(i=(i=i.extend(i,e("typed-array-ops"))).extend(i,e("typed-numeric-uncmin"))).rotate=e("typed-array-rotate"),i.mask=e("./mask.js");var s=e("./template"),r=i;i.zeros=function(e,t){var a,s=1,r=[];for(void 0===t&&(t=Float32Array),a=0;a<e.length;++a)r.push(Math.floor(e[a])),s*=r[a];return i.ndarray(new t(s),r)},i.fill=r(function(e,t){t.apply(void 0,[])}),a.fixupDiv=function(e){if("div"===e.winType){e.outerdivjq.find(".drag-handle").html(e.plugin.opts.winTitle);var t=e.outerdivjq.find(".JS9PluginToolbar-div");t.css("cursor","default"),t.css("right",0)}};var n={};function o(e){switch(e.shape){case"annulus":e.width=2*e.radii[e.radii.length-1],e.height=2*e.radii[e.radii.length-1];break;case"circle":e.width=2*e.radius,e.height=2*e.radius;break;case"ellipse":e.width=2*e.r1,e.height=2*e.r2;break;case"polygon":case"line":var t,a=0,i=0,s=1e6,r=0,o=1e6,l=0;for(t=0;t<e.pts.length;t++)a+=e.pts[t].x,i+=e.pts[t].y,e.pts[t].x>r&&(r=e.pts[t].x),e.pts[t].x<s&&(s=e.pts[t].x),e.pts[t].y>l&&(l=e.pts[t].y),e.pts[t].y<o&&(o=e.pts[t].y);e.x=a/e.pts.length,e.y=i/e.pts.length,"line"===e.shape&&2===e.pts.length?(e.width=Math.sqrt((e.pts[0].x-e.pts[1].x)*(e.pts[0].x-e.pts[1].x)+(e.pts[0].y-e.pts[1].y)*(e.pts[0].y-e.pts[1].y)),e.height=JS9.globalOpts.imexamLineHeight||1,e.angle=Math.atan2(e.pts[1].y-e.pts[0].y,e.pts[1].x-e.pts[0].x),e.angle=180*e.angle/Math.PI):(e.width=r-s,e.height=l-o);break;case"text":e.width=10,e.height=10}return n.mksection(e.x,e.y,e.width,e.height)}i.maxvalue=i.sup,i.minvalue=i.inf,i.size=function(e){var t,a=1;for(t=0;t<e.length;t++)a*=e[t];return a},i.reshape=function(e,t){if(e.size!==i.size(t))throw new Error("sizes not equil "+e.size+" != ",+i.size(t));return i.ndarray(e.data,t)},i.section=function(e,t){var a=t[0][0],i=t[0][1],s=t[1][0],r=t[1][1];return e.lo(s,a).hi(r-s,i-a)},i.print=function(e,t,a){var i,s,r;if(void 0===t&&(t=7),void 0===a&&(a=3),1===e.shape.length){for(r="",i=0;i<e.shape[0];++i)r+=e.get(i).toFixed(a)+" ";console.log(r)}else{for(s=e.shape[0]-1;s>=0;--s){for(r="",i=0;i<e.shape[1];++i)r+=e.get(s,i).toFixed(a)+" ";console.log(r)}console.log("\n")}},i._hist=r(function(e,t,a,i){var s=Math.floor((i-a)/t),r=new Int32Array(s+1);return isNaN(e)||r[0|Math.max(0,Math.min(s,Math.round((e-a)/t)))]++,r}),i.hist=function(e,t,a,s){var r,n={};return void 0===a&&(a=i.minvalue(e)),void 0===s&&(s=i.maxvalue(e)),void 0===t&&(t=Math.max(1,(s-a)/250)),n.raw=e,n.min=a,n.max=s,n.width=t,r=i._hist(e,t,a,s),n.data=i.ndarray(r,[r.length]),n},i.proj=function(e,t){var a,s,r={};r.n=e.shape[1===t?0:1],r.x=e.shape[t],r.sum=[],r.avg=[],r.med=[];var n=i.assign(i.zeros(e.shape),e);for(s=0;s<r.n;s++)a=i.section(n,0===t?[[s,s+1],[0,r.x]]:[[0,r.x],[s,s+1]]),r.sum[s]=i.sum(a),r.avg[s]=i.sum(a)/r.n,r.med[s]=i.median(a);return r},i.qcenter=r(function(e){var t,a=[],i=[],s=Number.MIN_VALUE;a[0]++,a[1]++,i[0]--,i[1]--;var r=+e[-1][-1]+e[-1][0]+e[-1][1]+e[0][-1]+e[0][0]+e[0][1]+e[1][-1]+e[1][0]+e[1][1];return s<r&&(s=r,t=[0,0]),t}),i._imcnts=r({consider:{c:!1}},function(e,t,a){e[a]+=t}),i.imcnts=function(e,t,a){var s={};return s.cnts=i.ndarray(i._imcnts(new Float32Array(a),e,t)),s.area=i.hist(t,1,0,a-1).data,s},i._centroid=r(function(e,t,a){var i=0,s=0,r=0,n=0,o=0;e>0&&0<t*t+a*a&&(i+=e,s+=0*e,n+=0*e*0,r+=0*e,o+=0*e*0);var l={};return l.sum=i,l.cenx=s/i,l.ceny=r/i,l.rmom=(n-s*s/i+o-r*r/i)/i,l.fwhm=l.rmom<=0?-1:2.354*Math.sqrt(l.rmom)/Math.sqrt(2),l}),i.centroid=function(e){return i._centroid(e,e.shape[0],e.shape[1])},i.flatten=function(){var e,t,a,s=0;for(e=0;e<arguments.length;e++)s+=arguments[e].size;var r=i.zeros([s]),n=0;for(t=0;t<arguments.length;t++)i.assign(i.ndarray(r.data,(a=arguments[t]).shape,void 0,n),a),n+=a.size;return r},i.median=function(e){var t=i.assign(i.zeros(e.shape),e);return Array.prototype.sort.call(t.data,function(e,t){return e-t}),t.data[Math.round((t.size-1)/2)]},i.rms=r(function(e){var t=0,a=0;isNaN(e)||(t+=e,a+=e*e);var i=t/e.size;return Math.sqrt((a-2*i*t+e.size*i*i)/(e.size-1))}),i.rmsClipped=r(function(e,t,a){var i=0,s=0,r=0;!isNaN(e)&&(null===t||e>t)&&(null===a||e<a)&&(i++,s+=e,r+=e*e);var n=s/i;return Math.sqrt((r-2*n*s+i*n*n)/(i-1))}),i.meanClipped=r(function(e,t,a){var i=0,s=0;return!isNaN(e)&&(null===t||e>t)&&(null===a||e<a)&&(i++,s+=e),s/i}),n.backgr=function(e,t){var a={},s=i.flatten(i.section(e,[[0,t],[0,e.shape[1]]]),i.section(e,[[e.shape[0]-t,e.shape[0]],[0,e.shape[1]]]),i.section(e,[[t,e.shape[0]-t],[0,t]]),i.section(e,[[t,e.shape[0]-t],[e.shape[1]-t,e.shape[1]]]));return a.noise=i.rms(s),a.value=i.median(s),a},n.mksection=function(e,t,a,i){return[[Math.floor(e-a/2),Math.floor(e+a/2)],[Math.floor(t-i/2),Math.floor(t+i/2)]]},n._rproj=r(function(e,t,a,i,s){var r=new Float32Array(s),n=new Float32Array(s),o=Math.sqrt(i*i),l=0,c=Math.sqrt((0-a)*(0-a)+(0-t)*(0-t));return c<=o&&!isNaN(e)&&(r[l]=c,n[l]=e,l++),{rad:r.subarray(0,l),val:n.subarray(0,l),n:l}}),n.rproj=function(e,t){var a,s,r,o=(e.shape[0]/2+e.shape[1]/2)/2,l=n._rproj(e,t[1],t[0],o,e.size);return a=l.rad,s=l.val,(r=Array.prototype.map.call(a,function(e,t){return[e,t,s[t]]})).sort(function(e,t){return e[0]-t[0]}),r.map(function(e,t){a[t]=e[0],s[t]=e[2]}),{radi:i.ndarray(l.rad,[l.rad.length]),data:i.ndarray(l.val,[l.rad.length]),radius:o}},n._encen=r(function(e,t,a,i){var s,r=new Float32Array(i),n=0,o=0,l=0-t,c=0-a,p=l*l+c*c;for(e>0&&p<i*i&&(r[Math.round(Math.sqrt(p))]+=e,n+=e),s=0;s<i;s++)r[s]=(o+=r[s])/n;return r}),n.encen=function(e,t){var a=Math.floor((e.shape[0]/2+e.shape[1]/2)/2),s=n._encen(e,t[1],t[0],a);return i.ndarray(s,[s.length])},i.indexof=function(e,t){var a;for(a=0;a<e.shape[0]&&!(t<e.get(a));a++);return 0===a?0:a===e.shape[0]?e.shape[0]:a+(t-e.get(a))/(e.get(a)-e.get(a-1))},i.gauss1d=function(e,t){var a=i.zeros(e.shape),s=t[0],r=t[1],n=t[2];return i.fill(a,function(t){var a=e.data[t]-0;return s*Math.pow(2.71828,-a*a/(2*r*r))+n}),a},i.gsfit1d=function(e,t,a){return r.uncmin(function(a){var s=i.gauss1d(e,a);i.sub(s,s,t),i.mul(s,s,s),i.fill(s,function(t){return s.get(t)/(e.get(t)*e.get(t))});var r=i.sum(s);return Math.sqrt(r/e.shape[0])},a,1e-6).solution},a.getRegionData=function(e,t){var a,s=o(t),r=i.ndarray(e.raw.data,[e.raw.height,e.raw.width]);return t.angle&&0!==t.angle?(a=i.zeros([t.height,t.width]),i.rotate(a,r,t.angle/57.29577951,t.y,t.x)):a=i.section(r,s),a},a.convolve1d=r(function(e,t,a){var i,s,r,n=Math.round(e.shape[0]/2);for(i=0;i<t.shape[0];i++)for(s=0;s<e.shape[0];s++)(r=i+s-n)>=0&&r<t.shape[0]&&(a[i]+=e[s]*t[r])}),a.convolve2dSep=function(e,t,a){var i,s,r,n,o,l=t.shape[1],c=t.shape[0],p=e.shape[0],d=Math.floor(p/2);for(s=0;s<c;s++)for(i=0;i<l;i++)for(a[s][i]=0,r=0;r<p;r++)(n=i+r-d)>0&&n<l&&(a[s][i]+=t[s][n]*e[r]);for(i=0;i<l;i++)for(s=0;s<c;s++)for(r=0;r<p;r++)(o=s+r-d)>0&&o<c&&(a[s][i]+=t[s+r][i]*e[r])},a.reg2section=o,a.template=s,a.ndops=i,a.typed=i,a.imops=n},{"./mask.js":1,"./template":12,"typed-array-function":4,"typed-array-ops":5,"typed-array-rotate":8,"typed-numeric-uncmin":10}],1:[function(e,t,a){"use strict";!function(){var t=e("./raster");function i(e,t){var a;for(a=0;a<e.tags.length;a++)if(e.tags[a]===t)return!0;return!1}a.hasTag=i,a.listRegions=function(e){var t,a,i,s=1,r=[];for(t=0;t<e.length;t++)switch((i=e[t]).shape){case"annulus":for(a=0;a<i.radii.length;a++)0!==i.radii[a]&&(r[s-1]=$.extend($.extend({},i),{regno:s++,shape:"circle",radius:i.radii[a]}));break;default:r[s-1]=$.extend({regno:s++},i)}return r},a.drawRegions=function(e,a,s){var r,n,o,l=["include","exclude"];for(n=0;n<2;n++)for(o=e.length-1;o>=0;o--)if(i(r=e[o],l[n]))switch(r.shape){case"polygon":t.drawPolygon(a,s,r.pts,r.regno);break;case"circle":t.drawCircle(a,s,r.x,r.y,r.radius,r.regno);break;case"box":t.drawBox(a,s,r.x,r.y,r.width,r.height,r.angle,r.regno);break;case"ellipse":t.drawEllipse(a,s,r.x,r.y,r.r1,r.r2,r.angle,r.regno)}}}()},{"./raster":11}],2:[function(e,t,a){"use strict";var i=e("iota-array"),s=["concat","join","slice","toString","indexOf","lastIndexOf","forEach","every","some","filter","map","reduce","reduceRight"];function r(e,t){return e[0]-t[0]}function n(){var e,t=this.stride,a=new Array(t.length);for(e=0;e<a.length;++e)a[e]=[Math.abs(t[e]),e];a.sort(r);var i=new Array(a.length);for(e=0;e<i.length;++e)i[e]=a[e][1];return i}function o(e,t){var a=["View",t,"d",e].join("");t<0&&(a="View_Nil"+e);var r="generic"===e;if(-1===t){var o="function "+a+"(a){this.data=a;};var proto="+a+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+a+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+a+"(a){return new "+a+"(a);}";return new Function(o)()}if(0===t)return o="function "+a+"(a,d) {this.data = a;this.offset = d};var proto="+a+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+a+"_copy() {return new "+a+"(this.data,this.offset)};proto.pick=function "+a+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+a+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+a+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+a+"(a,b,c,d){return new "+a+"(a,d)}",new Function("TrivialArray",o)(l[e][0]);o=["'use strict'"];var c=i(t),p=c.map(function(e){return"i"+e}),d="this.offset+"+c.map(function(e){return["this._stride",e,"*i",e].join("")}).join("+");o.push("function "+a+"(a,"+c.map(function(e){return"b"+e}).join(",")+","+c.map(function(e){return"c"+e}).join(",")+",d){this.data=a");for(var h=0;h<t;++h)o.push("this._shape"+h+"=b"+h+"|0");for(h=0;h<t;++h)o.push("this._stride"+h+"=c"+h+"|0");o.push("this.offset=d|0}","var proto="+a+".prototype","proto.dtype='"+e+"'","proto.dimension="+t);var g={stride:"VStride"+t+"d"+e,shape:"VShape"+t+"d"+e};for(var u in g){var m=g[u];o.push("function "+m+"(v) {this._v=v} var aproto="+m+".prototype","aproto.length="+t);var f=[];for(h=0;h<t;++h)f.push(["this._v._",u,h].join(""));for(o.push("aproto.toJSON=function "+m+"_toJSON(){return ["+f.join(",")+"]}","aproto.valueOf=aproto.toString=function "+m+"_toString(){return ["+f.join(",")+"].join()}"),h=0;h<t;++h)o.push(["Object.defineProperty(aproto,",h,",{get:function(){return this._v._",u,h,"},set:function(v){return this._v._",u,h,"=v|0},enumerable:true})"].join(""));for(h=0;h<s.length;++h)s[h]in Array.prototype&&o.push(["aproto.",s[h],"=Array.prototype.",s[h]].join(""));for(o.push(["Object.defineProperty(proto,'",u,"',{get:function ",m,"_get(){return new ",m,"(this)},set: function ",m,"_set(v){"].join("")),h=0;h<t;++h)o.push(["this._",u,h,"=v[",h,"]|0"].join(""));o.push("return v}})")}o.push(["Object.defineProperty(proto,'size',{get:function ",a,"_size(){return ",c.map(function(e){return["this._shape",e].join("")}).join("*"),"}})"].join("")),1===t?o.push("proto.order=[0]"):(o.push("Object.defineProperty(proto,'order',{get:"),t<4?(o.push(["function ",a,"_order(){"].join("")),2===t?o.push("return (Math.abs(this._stride0)>Math.abs(this._stride1))?[1,0]:[0,1]}})"):3===t&&o.push("var s0=Math.abs(this._stride0),s1=Math.abs(this._stride1),s2=Math.abs(this._stride2);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):o.push("ORDER})")),o.push(["proto.set=function ",a,"_set(",p.join(","),",v){"].join("")),o.push(r?["return this.data.set(",d,",v)}"].join(""):["return this.data[",d,"]=v}"].join("")),o.push(["proto.get=function ",a,"_get(",p.join(","),"){"].join("")),o.push(r?["return this.data.get(",d,")}"].join(""):["return this.data[",d,"]}"].join("")),o.push(["proto.index=function ",a,"_index(",p.join(),"){return ",d,"}"].join("")),o.push(["proto.hi=function ",a,"_hi(",p.join(","),"){return new ",a,"(this.data,",c.map(function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this._shape",e,":i",e,"|0"].join("")}).join(","),",",c.map(function(e){return"this._stride"+e}).join(","),",this.offset)}"].join(""));var y=c.map(function(e){return"a"+e+"=this._shape"+e}),b=c.map(function(e){return"c"+e+"=this._stride"+e});for(o.push(["proto.lo=function ",a,"_lo(",p.join(","),"){var b=this.offset,d=0,",y.join(","),",",b.join(",")].join("")),h=0;h<t;++h)o.push(["if(typeof i",h,"==='number'&&i",h,">=0){d=i",h,"|0;b+=c",h,"*d;a",h,"-=d}"].join(""));for(o.push(["return new ",a,"(this.data,",c.map(function(e){return"a"+e}).join(","),",",c.map(function(e){return"c"+e}).join(","),",b)}"].join("")),o.push(["proto.step=function ",a,"_step(",p.join(","),"){var ",c.map(function(e){return"a"+e+"=this._shape"+e}).join(","),",",c.map(function(e){return"b"+e+"=this._stride"+e}).join(","),",c=this.offset,d=0,ceil=Math.ceil"].join("")),h=0;h<t;++h)o.push(["if(typeof i",h,"==='number'){d=i",h,"|0;if(d<0){c+=b",h,"*(a",h,"-1);a",h,"=ceil(-a",h,"/d)}else{a",h,"=ceil(a",h,"/d)}b",h,"*=d}"].join(""));o.push(["return new ",a,"(this.data,",c.map(function(e){return"a"+e}).join(","),",",c.map(function(e){return"b"+e}).join(","),",c)}"].join(""));var S=new Array(t),v=new Array(t);for(h=0;h<t;++h)S[h]=["a[i",h,"]"].join(""),v[h]=["b[i",h,"]"].join("");for(o.push(["proto.transpose=function ",a,"_transpose(",p,"){",p.map(function(e,t){return e+"=("+e+"===undefined?"+t+":"+e+"|0)"}).join(";"),";var a=this.shape,b=this.stride;return new ",a,"(this.data,",S.join(","),",",v.join(","),",this.offset)}"].join("")),o.push(["proto.pick=function ",a,"_pick(",p,"){var a=[],b=[],c=this.offset"].join("")),h=0;h<t;++h)o.push(["if(typeof i",h,"==='number'&&i",h,">=0){c=(c+this._stride",h,"*i",h,")|0}else{a.push(this._shape",h,");b.push(this._stride",h,")}"].join(""));return o.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),o.push(["return function construct_",a,"(data,shape,stride,offset){return new ",a,"(data,",c.map(function(e){return"shape["+e+"]"}).join(","),",",c.map(function(e){return"stride["+e+"]"}).join(","),",offset)}"].join("")),new Function("CTOR_LIST","ORDER",o.join("\n"))(l[e],n)}var l={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],generic:[]};t.exports=function(e,t,a,i){if(void 0===e)return(0,l.array[0])([]);"number"==typeof e&&(e=[e]),void 0===t&&(t=[e.length]);var s=t.length;if(void 0===a){a=new Array(s);for(var r=s-1,n=1;r>=0;--r)a[r]=n,n*=t[r]}if(void 0===i)for(i=0,r=0;r<s;++r)a[r]<0&&(i-=(t[r]-1)*a[r]);for(var c=function(e){return e instanceof Float64Array?"float64":e instanceof Float32Array?"float32":e instanceof Int32Array?"int32":e instanceof Uint32Array?"uint32":e instanceof Uint8Array?"uint8":e instanceof Uint16Array?"uint16":e instanceof Int16Array?"int16":e instanceof Int8Array?"int8":e instanceof Uint8ClampedArray?"uint8_clamped":e instanceof Array?"array":"generic"}(e),p=l[c];p.length<=s+1;)p.push(o(c,p.length-1));return(0,p[s+1])(e,t,a,i)}},{"iota-array":3}],3:[function(e,t,a){"use strict";t.exports=function(e){for(var t=new Array(e),a=0;a<e;++a)t[a]=a;return t}},{}],4:[function(e,t,a){"use strict";!function(){var a=e("ndarray-nobuffer"),i={int8:Int8Array,uint8:Uint8Array,int16:Int16Array,uint16:Uint16Array,int32:Int32Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array};function s(e){if(e.shape)return e.shape;for(var t=[];"object"==typeof e;)t.push(e.length),e=e[0];return t}function r(e,t,a){void 0===t&&(t=0),void 0===a&&(a=0);var i,s=e[a],n=[];if(a===e.length-1){for(i=s-2;i>=0;i-=2)n[i+1]=t,n[i]=t;return-1===i&&(n[0]=t),n}for(i=s-1;i>=0;i--)n[i]=r(e,t,a+1);return n}function n(){var e,t,a,i,n,l=arguments,c={};if(void 0===this.cache){i="string"==typeof this.func?this.func:this.func.toString(),this.text=i;var p=i.match(/function [A-Za-z0-9_]*\(([^()]*)\)[^{]*\{([\S\s]*)\}[\S\s]*/);a=p[1].split(",").map(function(e){return e.trim()}),this.args=a,this.prep="",this.post="",(n=p[2].split(/\/\/ ----+/)).length>1?(this.prep=n[0],this.post=n[2],this.body=n[1]):this.body=n[0],""!==this.post&&void 0!==this.post||(this.post="\nreturn "+a[0]+";")}a=this.args,i=this.text;var d=this.opts;void 0===d&&(d={});var h,g="",u=0;for(e=0;e<a.length;e++)null!=l[e]&&"object"==typeof l[e]&&(void 0===d.consider||"object"==typeof d.consider&&!1!==d.consider[a[e]])?(c[a[e]]=l[e],l[e].shape||(l[e].shape=s(l[e])),u=Math.max(l[e].shape.length,u),g+=l[e].data?" "+l[e].dtype+" "+l[e].offset+"  "+l[e].stride:" O"):g+=" X";if(g=u+g,this.cache&&(h=this.cache[g]))return h;var m=this.prep,f=this.post,y=[],b=["iW","iV","iU","iZ","iY","iX"],S=!1;n=function t(a){return function(e,t){for(var a,i,s,r,n="",o=-1,l=0;l<e.length&&(a=e.match(/[a-zA-Z_][a-zA-Z0-9_]*/));){for(n+=e.substr(l,a.index),i=[],l=a.index+a[0].length,r=!0;r&&l<e.length;){for(;" "===e[l];)l++;switch(e[l]){case"[":for(o=1,s=l+1,l++;o;)"]"===e[l]&&(1===o&&i.push(e.substring(s,l)),o--),"["===e[l]&&o++,l++;break;case".":for(s=l,l++;" "===e[l];)l++;for(;null!==e[l].match(/[ a-zA-Z0-9_]/);)l++;i.push(e.substring(s,l));break;default:r=!1}}n+=t(a[0],i),e=e.substr(l),l=0}return n+e.substr(l)}(a,function(a,i){var s,r,n;for("index"===a&&(S=!0),s=0;s<i.length;s++)i[s]=t(i[s]);var o,l,p,h,g=c[a];if(void 0!==g&&"object"==typeof g)if(i.length>=1&&".length"===i[i.length-1].trim()&&(i[0]=".shape",i[1]=i.length-1,i.length=2),i.length>=1&&"."===i[0][0])n=i.length>=2&&".shape"===i[0].trim()?g.data?a+".shape["+i[1]+"]":a+function(e,t){if(t<1)return"";for(var a="";t>0;)1&t&&(a+=e),t>>=1,e+=e;return a}("[0]",i[1])+".length":a+i[0].trim();else{g.data?(o=g.dimension,0!==i.length&&i.length<g.dimension?(a+=".data.subarray",p="()",h=i.length):(a+=".data",p="[]",h=g.dimension),l=" + "):(o=g.shape.length,l="][",r="",p="[]");var u=b.slice(6-o);if(!(void 0!==d.loops&&!0!==d.loops||0!==i.length&&o!==i.length))for(e=0;e<o;e++)void 0===i[e]&&(i[e]=u[e]),void 0===y[e]&&(y[e]=0),y[e]=Math.max(y[e],g.shape[e]);if(g.data){for(e=0;e<h;e++)1!==g.stride[e]&&(i[e]="("+i[e]+")*"+g.stride[e]);r=0!==g.offset?g.offset+" + ":""}n=i.length?a+p[0]+r+i.join(l)+p[1]+" ":a}else{for(n=a,e=0;e<i.length;e++)n+="."===i[e][0]?i[e].trim():"["+i[e].trim()+"]";n+=" "}return n})}(n=this.body);var v=b.slice(6-y.length),w=b.slice(6-y.length).reverse();y.reverse();var x="\n",J="\n",k="",C="";if(void 0===d.loops||!0===d.loops){for(x+="\tvar index = ["+r([y.length],0).join(",")+"];\n",x+="\tvar start = ["+r([y.length],0).join(",")+"];\n",x+="\tvar   end = ["+r([y.length],0).join(",")+"];\n\n",e=0;e<y.length;e++)for(t=0;t<a.length;t++)if(c[a[t]]&&void 0!==l[t]&&"object"==typeof l[t]){x+="\tend["+e+"] = "+a[t]+".shape["+e+"];\n";break}for(x+="\n",e=0;e<y.length;e++)J+="\tvar "+v[e]+"start = start["+e+"];\n",J+="\tvar   "+v[e]+"end =   end["+e+"];\n";for(J+="\n",e=0;e<y.length;e++)S&&(k="index["+(y.length-e-1)+"] = 0;\n",C="\tindex["+(y.length-e-1)+"]++\n"),n=k+"for ( var "+w[e]+" = "+w[e]+"start; "+w[e]+" < "+w[e]+"end; "+w[e]+"++ ) {\n\t"+n+"\n"+C+"\n    }"}return h="// Array optimized funciton\n",h+="// "+g+"\n",h+="return function ("+a.join(",")+") {\n'use strict';\n\n"+x+m+J+n+f+"\n}",o.debug&&console.log(h),void 0===this.cache&&(this.cache={}),h=new Function(h)(),this.cache[g]=h,h}function o(e,t){void 0===t&&(t=e,e=void 0);var a={func:t,opts:e},i=(function(){return n.apply(this,arguments).apply(o,arguments)}).bind(a);return i.baked=n.bind(a),i}var l=o(function(e){return 1*e});t.exports=o,t.exports.ndarray=a,t.exports.section=function(e,t){var a=t[0][0],i=t[0][1],s=t[1][0],r=t[1][1];return e.lo(s,a).hi(r-s,i-a)},t.exports.extend=function(e){var t,a;for(t=1;t<arguments.length;t++)for(a in arguments[t])arguments[t].hasOwnProperty(a)&&(e[a]=arguments[t][a]);return e},t.exports.array=function(e,t,s){var n,o,c;if("number"!=typeof s&&(s=0),t&&t.dtype&&(t=t.dtype),"string"==typeof t&&(t=i[t]),"function"==typeof t)for(c=l(e),n=a(new t(c),e),o=0;o<c;o++)n.data[o]=s;else n=r(e,s);return n.shape=e,n},t.exports.clone=function(e){return o.assign(o.array(o.dim(e),e),e)},t.exports.print=function(e,t,a){var i,s,r;if(void 0===t&&(t=7),void 0===a&&(a=3),1===e.shape.length){for(r="",i=0;i<e.shape[0];++i)r+=e.get(i).toFixed(a)+" ";console.log(r)}else{for(s=e.shape[0]-1;s>=0;--s){for(r="",i=0;i<e.shape[1];++i)r+=e.get(s,i).toFixed(a)+" ";console.log(r)}console.log("\n")}},t.exports.iota=function(e,t){void 0===t&&(t=e,e=0);var a,i=[];for(a=0;a<t;a++)i[a]=e,e+=1;return i},t.exports.rep=r,t.exports.dim=s,t.exports.epsilon=2.220446049250313e-16}()},{"ndarray-nobuffer":2}],5:[function(e,t,a){"use strict";!function(){var a,i,s,r=e("typed-array-function"),n={};function o(e){var t,a;return function(i,s,n){return void 0===n&&(t=r.dim(i),a=r.dim(s),n=s,i=r.array(t.length>a.length?t:a,s=i)),e(i,s,n)}}function l(e){return function(t,a){return void 0===a&&(t=r.array(r.dim(a=t),a)),e(t,a)}}function c(e){return function(t,a,i){return void 0===i?o(e.baked(t,a,i)):e.baked(t,a,i)}}function p(e){return function(t,a){return void 0===a?l(e.baked(t,a)):e.baked(t,a)}}t.exports=n;var d={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};for(i in d)d.hasOwnProperty(i)&&(n[i+"3"]=r("function (a, b, c)    {            a = b "+(s=d[i])+" c; }"),n[i+"_mask"]=r("function (a, b, c, m) { if ( m ) { a = b "+s+" c; } }"),n[i+"eq"]=r("function (a, b   )    {            a "+s+"= b;    }  "),n[i+"eq_mask"]=r("function (a, b   , m) { if ( m ) { a "+s+"= b;    } }"),n[i]=o(n[i+"3"]),n[i].baked=c(n[i+"3"]),n[i+"s"]=n[i],n[i+"seq"]=n[i+"eq"]);var h={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};for(i in h)h.hasOwnProperty(i)&&(n[i+"3"]=r("function (a, b, c)    {            a = b "+(s=h[i])+" c; }"),n[i+"_mask"]=r("function (a, b, c, m) { if ( m ) { a = b "+s+" c; } }"),n[i+"eq"]=r("function (a, b   )    {            a = a "+s+" b; }  "),n[i+"eq_mask"]=r("function (a, b   , m) { if ( m ) { a = a "+s+" b; } }"),n[i]=o(n[i+"3"]),n[i].baked=c(n[i+"3"]),n[i+"s"]=n[i],n[i+"seq"]=n[i+"eq"]);var g={not:"!",bnot:"~",neg:"-",recip:"1.0/"};for(i in g)g.hasOwnProperty(i)&&(n[i+"2"]=r("function (a, b   )    {            a = "+(s=g[i])+" b; }"),n[i+"_mask"]=r("function (a, b   , m) { if ( m ) { a = "+s+" b; } }"),n[i+"eq"]=r("function (a      )    {            a = "+s+" a; }"),n[i+"eq_mask"]=r("function (a      , m) { if ( m ) { a = "+s+" a; } }"),n[i]=l(n[i+"2"]),n[i].baked=p(n[i+"2"]));var u=["Math.abs","Math.exp","Math.floor","Math.log","Math.round","Math.sqrt","Math.acos","Math.asin","Math.atan","Math.ceil","Math.cos","Math.sin","Math.tan","isFinite","isNaN"];for(a=0;a<u.length;a++)i=(s=u[a]).split("."),n[(i=2==i.length?i[1]:i[0])+"2"]=r("function (a, b   )    {            a = "+s+"(b); }"),n[i+"_mask"]=r("function (a, b   , m) { if ( m ) { a = "+s+"(b); } }"),n[i+"eq"]=r("function (a      )    {            a = "+s+"(a); }"),n[i+"eq_mask"]=r("function (a      , m) { if ( m ) { a = "+s+"(a); } }"),n[i]=l(n[i+"2"]),n[i].baked=p(n[i+"2"]);var m=["max","min"];for(a=0;a<m.length;a++)i=s=m[a],n[i+"3"]=r("function (a, b, c)    {            a = Math."+s+"(b, c); }"),n[i+"_mask"]=r("function (a, b, c, m) { if ( m ) { a = Math."+s+"(b, c); } }"),n[i]=o(n[i+"3"]),n[i].baked=c(n[i+"3"]),n[i+"s"]=n[i],n[i+"seq"]=n[i];var f=["atan2","pow"];for(a=0;a<f.length;a++)i=s=f[a],n[i+"3"]=r("function (a, b, c)    {            a = Math."+s+"(b, c); }"),n[i+"_mask"]=r("function (a, b, c, m) { if ( m ) { a = Math."+s+"(b, c); } }"),n[i]=o(n[i+"3"]),n[i].baked=c(n[i+"3"]),n[i+"s"]=n[i],n[i+"seq"]=n[i];n.assign=r(function(e,t){}),n.equals=r(function(e,t){if(e!==t)return!1}),n.any=r(function(e){if(e)return!0}),n.all=r(function(e){if(!e)return!1}),n.random=r(function(e){Math.random()}),n.sum=r(function(e){return 0+e}),n.prod=r(function(e){return 1*e}),n.inf=r(function(e){var t=1/0;return e<t&&(t=e),t}),n.sup=r(function(e){var t=-1/0;return e>t&&(t=e),t}),n.norm2Squared=r(function(e){return 0+e*e}),n.norm2=function(e){return Math.sqrt(n.norm2Squared(e))}}()},{"typed-array-function":4}],6:[function(e,t,a){"use strict";function i(e,t){var a=Math.floor(t),i=t-a,s=0<=a+1&&a+1<e.shape[0];return(1-i)*(0<=a&&a<e.shape[0]?+e.get(a):0)+i*(s?+e.get(a+1):0)}function s(e,t,a){var i=Math.floor(t),s=t-i,r=0<=i&&i<e.shape[0],n=0<=i+1&&i+1<e.shape[0],o=Math.floor(a),l=a-o,c=0<=o&&o<e.shape[1],p=0<=o+1&&o+1<e.shape[1],d=r&&c?e.get(i,o):0,h=r&&p?e.get(i,o+1):0;return(1-l)*((1-s)*d+s*(n&&c?e.get(i+1,o):0))+l*((1-s)*h+s*(n&&p?e.get(i+1,o+1):0))}function r(e,t,a,i){var s=Math.floor(t),r=t-s,n=0<=s&&s<e.shape[0],o=0<=s+1&&s+1<e.shape[0],l=Math.floor(a),c=a-l,p=0<=l&&l<e.shape[1],d=0<=l+1&&l+1<e.shape[1],h=Math.floor(i),g=i-h,u=0<=h&&h<e.shape[2],m=0<=h+1&&h+1<e.shape[2],f=n&&p&&u?e.get(s,l,h):0,y=n&&d&&u?e.get(s,l+1,h):0,b=o&&p&&u?e.get(s+1,l,h):0,S=o&&d&&u?e.get(s+1,l+1,h):0,v=n&&p&&m?e.get(s,l,h+1):0,w=n&&d&&m?e.get(s,l+1,h+1):0;return(1-g)*((1-c)*((1-r)*f+r*b)+c*((1-r)*y+r*S))+g*((1-c)*((1-r)*v+r*(o&&p&&m?e.get(s+1,l,h+1):0))+c*((1-r)*w+r*(o&&d&&m?e.get(s+1,l+1,h+1):0)))}t.exports=function(e,t,a,n){switch(e.shape.length){case 0:return 0;case 1:return i(e,t);case 2:return s(e,t,a);case 3:return r(e,t,a,n);default:return(function(e){var t,a,i=0|e.shape.length,s=new Array(i),r=new Array(i),n=new Array(i),o=new Array(i);for(t=0;t<i;++t)a=+arguments[t+1],s[t]=Math.floor(a),r[t]=a-s[t],n[t]=0<=s[t]&&s[t]<e.shape[t],o[t]=0<=s[t]+1&&s[t]+1<e.shape[t];var l,c,p,d=0;e:for(t=0;t<1<<i;++t){for(c=1,p=e.offset,l=0;l<i;++l)if(t&1<<l){if(!o[l])continue e;c*=r[l],p+=e.stride[l]*(s[l]+1)}else{if(!n[l])continue e;c*=1-r[l],p+=e.stride[l]*s[l]}d+=c*e.data[p]}return d}).apply(void 0,arguments)}},t.exports.d1=i,t.exports.d2=s,t.exports.d3=r},{}],7:[function(e,t,a){"use strict";var i=e("ndarray-linear-interpolate"),s=e("typed-array-function"),r=s(function(e,t,a){var i=e.shape.slice(0);t(i,[0,0,0]),e=a.apply(void 0,i)}),n=s(function(e,t,a,i){var s=[0],r=i;t(s,[0]),a(r,s[0])}),o=s(function(e,t,a,i){var s=[0,0],r=i;t(s,[0,0]),a(r,s[0],s[1])}),l=s(function(e,t,a,i){var s=[0,0,0],r=i;t(s,[0,0,0]),a(r,s[0],s[1],s[2])});t.exports=function(e,t,a){switch(t.shape.length){case 1:n(e,a,i.d1,t);break;case 2:o(e,a,i.d2,t);break;case 3:l(e,a,i.d3,t);break;default:r(e,a,i.bind(void 0,t))}return e}},{"ndarray-linear-interpolate":6,"typed-array-function":4}],8:[function(e,t,a){"use strict";var i=e("typed-array-warp");t.exports=function(e,t,a,s,r,n,o){var l=Math.cos(a),c=Math.sin(-a),p=(s=s||t.shape[0]/2)-l*(n=n||e.shape[0]/2)+c*(o=o||e.shape[1]/2),d=(r=r||t.shape[1]/2)-c*n-l*o;return i(e,t,function(e,t){e[0]=l*t[0]-c*t[1]+p,e[1]=c*t[0]+l*t[1]+d}),e}},{"typed-array-warp":7}],9:[function(e,t,a){"use strict";var i=e("typed-array-function"),s=i;i.dot=function(e,t){var a=s.dim,i=a(e),r=a(t);switch(1e3*a(e).length+a(t).length){case 2002:return s.dotMM(s.array([i[0],r[1]],e.dtype),e,t);case 2001:return s.dotMV(e,t);case 1002:return s.dotVM(e,t);case 1001:return s.dotVV(e,t);case 1e3:return s.mulVS(e,t);case 1:return s.mulSV(e,t);case 0:return e*t;default:throw new Error("numeric.dot only works on vectors and matrices")}},s.dotVV=function(e,t){var a,i,s=e.length,r=e[s-1]*t[s-1];for(a=s-2;a>=1;a-=2)r+=e[a]*t[a]+e[i=a-1]*t[i];return 0===a&&(r+=e[0]*t[0]),r},s.dotMV=function(e,t){var a,i=e.length,s=this.array([i],e.dtype),r=this.dotVV;for(a=i-1;a>=0;a--)s[a]=r(e[a],t);return s},s.dotVM=function(e,t){var a,i,r,n,o,l,c;for(r=e.length,o=s.array([n=t[0].length],e.dtype),i=n-1;i>=0;i--){for(l=e[r-1]*t[r-1][i],a=r-2;a>=1;a-=2)l+=e[a]*t[a][i]+e[c=a-1]*t[c][i];0===a&&(l+=e[0]*t[0][i]),o[i]=l}return o},s.dotMM=function(e,t,a){var i,s,r,n,o,l,c,p=e.shape[1],d=a.length;for(i=t.length-1;i>=0;i--)for(n=e[i],o=t[i],r=p-1;r>=0;r--){for(l=o[d-1]*a[d-1][r],s=d-2;s>=1;s-=2)l+=o[s]*a[s][r]+o[c=s-1]*a[c][r];0===s&&(l+=o[0]*a[0][r]),n[r]=l}},s.diag=function(e){var t,a,i,s,r=e.length,n=this.array([r,r],e.dtype);for(t=r-1;t>=0;t--){for(s=n[t],a=t+2,i=r-1;i>=a;i-=2)s[i]=0,s[i-1]=0;for(i>t&&(s[i]=0),s[t]=e[t],i=t-1;i>=1;i-=2)s[i]=0,s[i-1]=0;0===i&&(s[0]=0)}return n},s.identity=function(e,t){return this.diag(this.array([e],t,1))},s.tensorXX=function(e,t,a){var i,s,r,n,o=a.length;for(s=t.length-1;s>=0;s--){for(i=e[s],n=t[s],r=o-1;r>=3;--r)i[r]=n*a[r],i[--r]=n*a[r],i[--r]=n*a[r],i[--r]=n*a[r];for(;r>=0;)i[r]=n*a[r],--r}},s.tensorXX=i({loops:!1},s.tensorXX),s.tensor=function(e,t){if("number"==typeof e||"number"==typeof t)return s.mul(e,t);var a=s.dim(e),i=s.dim(t);if(1!==a.length||1!==i.length)throw new Error("numeric: tensor product is only defined for vectors");return s.tensorXX(s.array([a[0],i[0]],e.dtype),e,t)},s.dotVV=i({loops:!1},s.dotVV),s.dotVM=i({loops:!1},s.dotVM),s.dotMV=i({loops:!1},s.dotMV),s.dotMM=i({loops:!1},s.dotMM),s.diag=i({loops:!1},s.diag)},{"typed-array-function":4}],10:[function(e,t,a){var i=e("typed-array-function");i=(i=i.extend(i,e("typed-array-ops"))).extend(i,e("typed-matrix-ops")),a.gradient=function(e,t){var a=t.length,s=e(t);if(isNaN(s))throw new Error("gradient: f(x) is a NaN!");var r,n,o,l,c,p,d,h,g,u=i.clone(t),m=Array(a),f=Math.max,y=Math.abs,b=Math.min,S=0;for(r=0;r<a;r++)for(var v=f(1e-6*s,1e-8);;){if(++S>20)throw new Error("Numerical gradient fails");if(u[r]=t[r]+v,n=e(u),u[r]=t[r]-v,o=e(u),u[r]=t[r],isNaN(n)||isNaN(o))v/=16;else{if(m[r]=(n-o)/(2*v),l=t[r]-v,c=t[r],p=t[r]+v,d=(n-s)/v,h=(s-o)/v,g=f(y(m[r]),y(s),y(n),y(o),y(l),y(c),y(p),1e-8),!(b(f(y(d-m[r]),y(h-m[r]),y(d-h))/g,v/g)>.001))break;v/=16}}return m},a.uncmin=function(e,t,s,r,n,o,l){var c=a.gradient;void 0===l&&(l={}),void 0===s&&(s=1e-8),void 0===r&&(r=function(t){return c(e,t)}),void 0===n&&(n=1e3);var p,d,h=(t=i.clone(t)).length,g=e(t);if(isNaN(g))throw new Error("uncmin: f(x0) is a NaN!");var u=Math.max,m=i.norm2;s=u(s,i.epsilon);var f,y,b,S,v,w,x,J,k,C,I=l.Hinv||i.identity(h),M=i.dot,T=i.sub,A=i.add,O=i.tensor,P=i.div,D=i.mul,L=i.all,j=i.isFinite,E=i.neg,R=0,F="";for(y=r(t);R<n;){if("function"==typeof o&&o(R,t,g,y,I)){F="Callback returned true";break}if(!L(j(y))){F="Gradient has Infinity or NaN";break}if(!L(j(f=E(M(I,y))))){F="Search direction has Infinity or NaN";break}if((C=m(f))<s){F="Newton step smaller than tol";break}for(k=1,d=M(y,f),v=t;R<n&&!(k*C<s)&&(v=A(t,S=D(f,k)),(p=e(v))-g>=.1*k*d||isNaN(p));)k*=.5,++R;if(k*C<s){F="Line search step size smaller than tol";break}if(R===n){F="maxit reached during line search";break}J=M(w=T(b=r(v),y),S),x=M(I,w),I=T(A(I,D((J+M(w,x))/(J*J),O(S,S))),P(A(O(x,S),O(S,x)),J)),t=v,g=p,y=b,++R}return{solution:t,f:g,gradient:y,invHessian:I,iterations:R,message:F}}},{"typed-array-function":4,"typed-array-ops":5,"typed-matrix-ops":9}],11:[function(e,t,a){"use strict";!function(){function e(e,t,a,i,s,r,n){a<0&&(a=0),i>t&&(i=t);var o,l=a+s*t;switch(n){case void 0:case"set":for(o=a;o<i;o++)e[l++]=r;break;case"add":for(o=a;o<i;o++)e[l++]+=r}}function t(e,t,a,i,s,r){var n,o,l;t>i&&(o=t,t=i,i=o,n=e,e=a,a=n),t=Math.floor(t)+1,n=e;var c=(a-e)/((i=Math.floor(i))-t),p=Math.round(t-s);for(o=t;o<=i;o++)l=Math.floor(n)+1,r[p].minx>l&&(r[p].minx=l),r[p].maxx<l&&(r[p].maxx=l),n+=c,p++}function i(a,i,s,r,n){var o,l=s[0].y-1,c=s[0].y-1;for(o=1;o<s.length;o++)s[o].y-1<l&&(l=s[o].y-1),s[o].y-1>c&&(c=s[o].y-1);var p=c-l,d=[];for(o=0;o<=p+1;o++)d.push({minx:1e6,maxx:-1e6});for(o=0;o<s.length-1;o++)t(s[o].x-1,s[o].y-1,s[o+1].x-1,s[o+1].y-1,l,d);for(t(s[o].x-1,s[o].y-1,s[0].x-1,s[0].y-1,l,d),o=0;o<d.length;o++)e(a,i,Math.floor(d[o].minx),Math.floor(d[o].maxx),Math.floor(o+l),r,n)}function s(e,t,a){var i,s=[];t*=Math.PI/180;var r=Math.sin(t),n=Math.cos(t);for(i=0;i<e.length;i++)s.push({x:a.x+((e[i].x-a.x)*n-(e[i].y-a.y)*r),y:a.y+((e[i].x-a.x)*r+(e[i].y-a.y)*n)});return s}function r(e,t,a,i){var s,r,n,o=[];for(n=0;n<2*Math.PI;n+=.01)s=e+a*Math.cos(n),r=t+i*Math.sin(n),o.push({x:s,y:r});return o}a.drawPolygon=function(e,t,a,s,r){i(e,t,a,s,r)},a.drawCircle=function(e,t,a,s,n,o,l){i(e,t,r(a,s,n,n),o,l)},a.drawEllipse=function(e,t,a,n,o,l,c,p,d){i(e,t,s(r(a,n,o,l),c,{x:a,y:n}),p,d)},a.drawBox=function(e,t,a,r,n,o,l,c,p){i(e,t,s(function(e,t,a,i){return[{x:e-a/2,y:t-i/2},{x:e-a/2,y:t+i/2},{x:e+a/2,y:t+i/2},{x:e+a/2,y:t-i/2}]}(a,r,n,o),l,{x:a,y:r}),c,p)}}()},{}],12:[function(e,t,a){"use strict";function i(e,t){var a,i="";for(a=0;a<t;a++)i+=e;return i}t.exports=function(e,t){return e.replace(/\{([a-zA-Z0-9_.%]*)\}/g,function(e,a){var s,r,n,o,l,c=t;for(o=(a=a.split("%")).length<=1?"%s":a[1],a=(a=a[0]).split("."),l=0;l<a.length;l++){if(!c.hasOwnProperty(a[l]))return"";c=c[a[l]]}switch(s=o.substring(o.length-1),n=0|(r=(r=o.substring(0,o.length-1)).split("."))[0],r=0|r[1],s){case"s":c=c.toString();break;case"f":c=c.toFixed(r);break;case"d":c=c.toFixed(0)}return 0!==n&&n>c.length&&(n>0?c=i(" ",n-c.length)+c:c+=i(" ",n-c.length)),c})}},{}]},{},[]),function(){var e=require("./imexam");JS9.RegisterPlugin("ImExam","EncEnergy",function(){e.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see encircled energy<br>")},{menu:"analysis",menuItem:"Encircled Energy",winTitle:"Encircled Energy",help:"imexam/imexam.html#enener",dynamicSelect:!0,toolbarSeparate:!0,onregionschange:function(t,a){var i=this.div,s=e.getRegionData(t,a),r=e.imops.backgr(s,4).value,n=e.ndops.assign(e.ndops.zeros(s.shape),s);e.ndops.subs(n,s,r);var o=e.ndops.qcenter(n),l=e.ndops.centroid(n,o),c=e.imops.encen(n,[l.ceny,l.cenx]),p={};p.ee80=e.ndops.indexof(c,.8),p.ee50=e.ndops.indexof(c,.5);var d,h=[];for(d=0;d<c.shape[0];d++)h[d]=[d,c.get(d)];$(i).empty(),$.plot(i,[h],{selection:{mode:"xy"}}),$(i).append(e.template(" \t\t\t\t\t\t    \t<div style='position:absolute;right: 10px;bottom:50px'>\t\t        <table>\t\t\t\t\t\t\t\t\t    <tr><td>ee50</td><td align=right>{ee50%.2f}</td><tr>\t\t    <tr><td>ee80</td><td align=right>{ee80%.2f}</td><tr>\t        </table>\t\t\t\t\t\t\t\t</div>",p))},winDims:[250,250]})}(),function(){var e=require("./imexam");function t(e,t,a){var i,s=new RegExp(a,"g"),r="";for(i=0;i<t;i++)r+=e.replace(s,i);return r}JS9.RegisterPlugin("ImExam","PxTabl",function(){var a;e.fixupDiv(this),$(this.div).html("<form class=pxtabl>"+(a="<table cellpadding=0 cellspacing=0>",a+=t("<tr>"+t("<td ><input class='col%x row%y' type=entry size=6 name=cell%y.%x value=0></td>",10,"%x")+"</tr>\n",10,"%y"),a+="</table>")+"</form>"),$(this.div).find(".row5").css("background","lightblue"),$(this.div).find(".col5").css("background","lightblue"),$(this.div).find(":input").css("font-size","11")},{menu:"view",menuItem:"Pixel Table",winTitle:"Pixel Table",winResize:!0,toolbarSeparate:!0,onmousemove:function(t,a){var i,s,r=e.ndops.ndarray(t.raw.data,[t.raw.height,t.raw.width]),n=0,o=0,l=$(this.div).find(".pxtabl")[0];for(l["cell"+o+"."+n].value="col\\row",o=0,n=1;n<10;n++)l["cell"+o+"."+n].value=(i=a.x+n-5)>0&&i<=t.raw.width?i.toFixed(0):"";for(n=0,o=1;o<10;o++)l["cell"+(10-o)+"."+n].value=(s=a.y+o-5)>0&&s<=t.raw.height?s.toFixed(0):"";for(o=1;o<10;o++)for(n=1;n<10;n++)s=a.y+o-5-.5|0,l["cell"+(10-o)+"."+n].value=(i=a.x+n-5-.5|0)>=0&&i<t.raw.width&&s>=0&&s<t.raw.height?r.get(s,i).toPrecision(4):""},winDims:[625,240]})}(),function(){var e=require("./imexam");JS9.RegisterPlugin("ImExam","RadialProj",function(){e.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see radial projection<br>")},{menu:"analysis",menuItem:"Radial Proj",winTitle:"Radial Proj",help:"imexam/imexam.html#r_proj",dynamicSelect:!0,toolbarSeparate:!0,onregionschange:function(t,a){var i=this.div,s=e.getRegionData(t,a),r=e.ndops.maxvalue(s),n=e.imops.backgr(s,4).value,o=e.ndops.assign(e.ndops.zeros(s.shape),s);e.ndops.subs(o,s,n);var l,c=e.ndops.qcenter(o),p=e.ndops.centroid(o,c),d=e.imops.rproj(s,[p.ceny,p.cenx]),h=e.ndops.gsfit1d(d.radi,d.data,[r,p.fwhm/2.355,n]),g={a:h[0],b:0,c:h[1],d:h[2]},u=[],m=[];for(l=0;l<d.radi.shape[0];l++)u[l]=[d.radi.get(l),d.data.get(l)];for(d.samp=e.ndops.zeros([i.offsetWidth/2]),e.ndops.fill(d.samp,function(e){return d.radius*e/(i.offsetWidth/2)}),d.modl=e.ndops.gauss1d(d.samp,h),l=0;l<d.modl.shape[0];l++)m[l]=[d.samp.get(l),d.modl.get(l)];$(i).empty(),$.plot(i,[{data:u,points:{radius:1,show:!0}},{data:m}],{zoomStack:!0,selection:{mode:"xy"}}),$(i).append(e.template("<div style='position:absolute;right: 10px;top:30px'>                     <table>                                     <tr><td>peak        </td><td align=right>{a%.2f}</td><tr>                                     <tr><td>sigma       </td><td align=right>{c%.2f}</td><tr>                                     <tr><td>bias        </td><td align=right>{d%.2f}</td><tr>                     </table>                     </div>",g))},winDims:[250,250]})}(),function(){var e=require("./imexam"),t="<div class='annotation' style='position:absolute;right: 10px;top:30px'>                     <table>                                     <tr><td>rms        </td><td align=right>{rms%.2f}</td><tr>                                     <tr><td>mean       </td><td align=right>{mean%.2f}</td><tr>                     </table>                     </div>";function a(a,i,s){var r=i.getAxes(),n=r.xaxis.options.min,o=r.xaxis.options.max,l=$(a).data("hist").raw,c=e.ndops.rmsClipped(l,n,o),p=e.ndops.meanClipped(l,n,o);$(a).find(".annotation").empty(),$(a).append(e.template(t,{rms:c,mean:p}))}JS9.RegisterPlugin("ImExam","Histogram",function(){e.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see histogram<br>")},{menu:"analysis",menuItem:"Histogram",winTitle:"Histogram",help:"imexam/imexam.html#rghist",dynamicSelect:!0,toolbarSeparate:!0,toolbarHTML:" ",onregionschange:function(t,i){var s=this.div,r=e.getRegionData(t,i),n=e.ndops.hist(r);n.sum=e.ndops.sum(n.data),$(s).data("hist",n);var o,l,c=0,p=.001*n.sum,d=0;$(s).empty();var h=[];for(o=0;o<n.data.shape[0];o++)(c+=n.data.get(o))>p&&c<n.sum-p&&(l=n.data.get(o),h[d]=[o*n.width+n.min,l],d++);a(s,$.plot(s,[h],{zoomStack:!0,zoomFunc:a,selection:{mode:"x"}}))},winDims:[250,250]})}(),function(){var e=require("./imexam");function t(t,a){var i=e.reg2section(a),s=e.getRegionData(t,a),r=e.ndops.assign(e.ndops.zeros(s.shape),s),n=e.ndops.assign(e.ndops.zeros(s.shape),s),o={};return t&&a?(o.reg=a,o.min=e.ndops.minvalue(s),o.max=e.ndops.maxvalue(s),o.bkgd=e.imops.backgr(s,4),e.ndops.subs(r,s,o.bkgd.value),o.bscnts=e.ndops.centroid(r,e.ndops.qcenter(r)),o.bscnts.cenx+=i[0][0],o.bscnts.ceny+=i[1][0],o.totcnts=e.ndops.centroid(n,e.ndops.qcenter(n)),o.totcnts.cenx+=i[0][0],o.totcnts.ceny+=i[1][0],o):null}JS9.Image.prototype.getRegionStats=function(e){return t(this,e)},JS9.mkPublic("GetRegionStats","getRegionStats"),JS9.RegisterPlugin("ImExam","RegionStats",function(){e.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see stats<br>")},{menu:"analysis",winTitle:"Region Stats",menuItem:"Region Stats",help:"imexam/imexam.html#rgstat",dynamicSelect:!0,toolbarSeparate:!0,onregionschange:function(a,i){$(this.div).html(e.template("                                                                                        <table width=100% style='padding-right: 6px; padding-left: 0px'>                                            <tr><td align=right>position x</td> <td align=right>{reg.x%.2f}              </td>                      <td align=right>y</td>              <td align=right>{reg.y%.2f}             </td></tr>                  <tr><td align=right>box width</td>      <td align=right>{reg.width%.2f}         </td>                   <td align=right>height</td>         <td align=right>{reg.height%.2f}        </td></tr>                  <tr><td align=right>min</td>        <td align=right>{min%.2f}               </td>                       <td align=right>max</td>            <td align=right>{max%.2f}               </td></tr>                  <tr><td align=right>totcounts</td>     <td align=right colspan=3>{totcnts.sum%.2f}</tr>               <tr><td align=right>bscounts</td>     <td align=right colspan=3>{bscnts.sum%.2f}</tr>                 <tr><td align=right>bkgd</td>     <td align=right>{bkgd.value%.2f}      </td>                         <td align=right>noise</td>          <td align=right>{bkgd.noise%.2f}      </td></tr>                  <tr><td align=right>centroid x</td> <td align=right>{bscnts.cenx%.2f}     </td>                       <td align=right>y</td>              <td align=right>{bscnts.ceny%.2f}     </td></tr>                  <tr><td align=right>FWHM</td>       <td align=right>{bscnts.fwhm%.2f}     </td>                       <td align=right></td>            <td align=right>{bscnts.rms%.2f}      </td></tr>                 </table>",t(a,i)))},winDims:[250,250]})}(),function(){"use strict";var e=require("./imexam"),t="                                \t\t\t<div style='float: right;'>\t\t                 <select  class='proj_menu'>\t\t                        <option>sum</option>                                    <option>avg</option>                                    <option>med</option>            \t\t </select>\t\t\t\t\t\t</div>";function a(t,i){var s,r,n,o;void 0===t?(s=i.div,r=i.proj,n=i.menu,o=i.chek):(s=this.div,n=this.outerdivjq.find(".proj_menu")[0],o=this.outerdivjq.find(".proj_chek")[0],r=e.ndops.proj(e.getRegionData(t,i),this.plugin.opts.xyproj),$(n).change(function(e){a(void 0,{div:s,proj:r,menu:n,chek:o})}),$(o).change(function(e){a(void 0,{div:s,proj:r,menu:n,chek:o})}));var l,c,p=[],d=n.options[n.selectedIndex].value;for($(s).empty(),"sum"===d&&(l=r.sum),"avg"===d&&(l=r.avg),"med"===d&&(l=r.med),c=0;c<l.length;c++)p[c]=[c,l[c]];$.plot(s,[p],{zoomStack:!0,selection:{mode:"xy"}})}function i(){e.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see projection<br>")}JS9.RegisterPlugin("ImExam","XProj",i,{menu:"analysis",menuItem:"X Projection",winTitle:"X Projection",help:"imexam/imexam.html#xyproj",dynamicSelect:!0,toolbarSeparate:!0,toolbarHTML:t,onregionschange:a,winDims:[250,250],xyproj:0}),JS9.RegisterPlugin("ImExam","YProj",i,{menu:"analysis",menuItem:"Y Projection",winTitle:"Y Projection",help:"imexam/imexam.html#xyproj",dynamicSelect:!0,toolbarSeparate:!0,toolbarHTML:t,onregionschange:a,winDims:[250,250],xyproj:1})}(),function e(t,a,i){function s(n,o){if(!a[n]){if(!t[n]){var l="function"==typeof require&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=a[n]={exports:{}};t[n][0].call(p.exports,function(e){return s(t[n][1][e]||e)},p,p.exports,e,t,a,i)}return a[n].exports}for(var r="function"==typeof require&&require,n=0;n<i.length;n++)s(i[n]);return s}({1:[function(e,t,a){!function(){"use strict";var t=e("./imexam");e("./JSSurfacePlot-V1.7/javascript/SurfacePlot"),e("./JSSurfacePlot-V1.7/javascript/ColourGradient"),JS9.RegisterPlugin("ImExam","3dPlot",function(){t.fixupDiv(this),$(this.div).append("<p style='padding: 20px 0px 0px 20px; margin: 0px'>create, click, move, or resize a region to see 3d plot<br>")},{menu:"analysis",menuItem:"3dPlot",winTitle:"3dPlot",help:"imexam/imexam.html#3dplot",dynamicSelect:!0,toolbarSeparate:!0,onregionschange:function(e,a){!function(e,a){var i=t.ndops.zeros(a.shape),s=t.ndops.minvalue(a),r=t.ndops.maxvalue(a)-s,n=$(e).data("surfplot");i.getNumberOfRows=function(){return this.shape[1]},i.getNumberOfColumns=function(){return this.shape[0]},i.getFormattedValue=function(e,t){return this.get(t,e).toString()},void 0===n&&(e.innerHTML="",n=new greg.ross.visualisation.SurfacePlot(e),$(e).data("surfplot",n));var o,l,c,p=[],d=i.getNumberOfRows(),h=i.getNumberOfColumns(),g=0,u=e.offsetHeight,m=e.offsetWidth;for(o=0;o<d;o++)for(l=0;l<h;l++)c=a.get(l,o),i.set(l,o,(c-s)/(2.25*r)),void 0!==c&&(p[g]="x:"+o+", y:"+l+" = "+c.toFixed(2)),g++;n.draw(i,{xPos:0,yPos:0,width:m,height:u,colourGradient:[{red:0,green:0,blue:255},{red:0,green:255,blue:255},{red:0,green:255,blue:0},{red:255,green:255,blue:0},{red:255,green:0,blue:0}],fillPolygons:!0,tooltips:p,xTitle:"X",yTitle:"Y",zTitle:"Z",restrictXRotation:!1})}(this.div,t.getRegionData(e,a))},winDims:[250,250]})}()},{"./JSSurfacePlot-V1.7/javascript/ColourGradient":2,"./JSSurfacePlot-V1.7/javascript/SurfacePlot":3,"./imexam":void 0}],2:[function(e,t,a){greg.ross.visualisation.ColourGradient=function(e,t,a){function i(e){return e.red*e.red+e.green*e.green+e.blue*e.blue}function s(e,t,a){return t==a?0:(e-t)/(a-t)}this.getColour=function(r){return isNaN(r)||r<e||r>t||1==a.length?{red:a[0].red,green:a[0].green,blue:a[0].blue}:function(e){var t,r,n,o=a.length,l=1/(o-1),c=e/l,p=(c=parseInt(c+""),a[c=c>=o-1?o-2:c]),d=a[c+1];i(p)>i(d)?(t=d,r=p):(t=p,r=d);var h=[(n=t==d?1-s(e,c*l,(c+1)*l):s(e,c*l,(c+1)*l))*(r.red-t.red),n*(r.green-t.green),n*(r.blue-t.blue)],g=t.red+h[0],u=t.green+h[1],m=t.blue+h[2];return{red:g=parseInt(g),green:u=parseInt(u),blue:m=parseInt(m)}}(s(r,e,t))}}},{}],3:[function(e,t,a){function s(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}!function(e){for(var t="greg.ross.visualisation".split("."),a=window,i=t.length,s=0;s<i;s++)void 0===a[t[s]]&&(a[t[s]]=new Object),a=a[t[s]]}(),greg.ross.visualisation.SurfacePlot=function(e){this.containerElement=e},greg.ross.visualisation.SurfacePlot.prototype.draw=function(e,t){null==this.surfacePlot&&(this.surfacePlot=new greg.ross.visualisation.JSSurfacePlot(t.xPos,t.yPos,t.width,t.height,t.colourGradient,this.containerElement,t.tooltips,t.fillPolygons,t.xTitle,t.yTitle,t.zTitle,t.restrictXRotation)),this.surfacePlot.redraw(e)},greg.ross.visualisation.JSSurfacePlot=function(e,t,a,r,n,o,l,c,p,d,h,g){var u,m=function(){var e=0;do{e++}while(document.getElementById("surfacePlot"+e));return"surfacePlot"+e}(),f=null,y=greg.ross.visualisation.JSSurfacePlot.DEFAULT_SCALE,b=greg.ross.visualisation.JSSurfacePlot.DEFAULT_Z_ANGLE,S=greg.ross.visualisation.JSSurfacePlot.DEFAULT_X_ANGLE;this.data=null;var v,w,x,J,k,C=!1,I=!0,M=null,T=!1,A=!1,O=!1,P=null,D=null,L=new greg.ross.visualisation.Point(0,0),j=null,E=null,R=new greg.ross.visualisation.Point(0,0),F=new greg.ross.visualisation.Point(0,0),N=null,$=(new greg.ross.visualisation.Tooltip(!0),new greg.ross.visualisation.Tooltip(!0),new greg.ross.visualisation.Tooltip(!0),new greg.ross.visualisation.Tooltip(!1));function z(){$.hide()}function B(e){f.clearRect(0,0,u.width,u.height),f.fillStyle="#000",f.fillRect(0,0,u.width,u.height),this.data=e;var t=a-40;if(x.init(),x.rotate(S,0,b),x.scale(y),x.translate(t/2+20,t/3*2+20,0),J=new greg.ross.visualisation.Point3D(t/2+20,t/2+20,-1e3),T)for(i=0;i<M.length;i++){var r=M[i];f.fillStyle="#ff2222";var n=x.ChangeObjectPoint(r);n.dist=s(n,J);var o=n.ax,l=n.ay;f.beginPath();var g=greg.ross.visualisation.JSSurfacePlot.DATA_DOT_SIZE;f.arc(o-g/2,l-g/2,1,0,2*self.Math.PI,!0),f.fill()}var m=function(){var e=new greg.ross.visualisation.Point3D(-.5,.5,0),t=new greg.ross.visualisation.Point3D(.5,.5,0),a=new greg.ross.visualisation.Point3D(-.5,-.5,0),i=new greg.ross.visualisation.Point3D(-.5,.5,1),s=x.ChangeObjectPoint(e),r=x.ChangeObjectPoint(t),n=x.ChangeObjectPoint(a),o=x.ChangeObjectPoint(i),l=new Array,c=new greg.ross.visualisation.Polygon(J,!0);c.addPoint(s),c.addPoint(r),c.calculateCentroid(),c.calculateDistance(),l[l.length]=c;var p=new greg.ross.visualisation.Polygon(J,!0);p.addPoint(s),p.addPoint(n),p.calculateCentroid(),p.calculateDistance(),l[l.length]=p;var d=new greg.ross.visualisation.Polygon(J,!0);return d.addPoint(s),d.addPoint(o),d.calculateCentroid(),d.calculateDistance(),l[l.length]=d,l}(),C=function(e){var t,a,i=new Array,s=0;for(t=0;t<v-1;t++)for(a=0;a<w-1;a++){var r=new greg.ross.visualisation.Polygon(J,!1),n=x.ChangeObjectPoint(e[a+t*w]),o=x.ChangeObjectPoint(e[a+t*w+w]),l=x.ChangeObjectPoint(e[a+t*w+w+1]),c=x.ChangeObjectPoint(e[a+t*w+1]);r.addPoint(n),r.addPoint(o),r.addPoint(l),r.addPoint(c),r.calculateCentroid(),r.calculateDistance(),i[s]=r,s++}return i}(M);for(i=0;i<m.length;i++)C[C.length]=m[i];for(C.sort(greg.ross.visualisation.PolygonComaparator),f.lineWidth=1,f.strokeStyle="#888",f.lineJoin="round",i=0;i<C.length;i++){var I=C[i];if(I.isAnAxis()){var A=I.getPoint(0),O=I.getPoint(1);f.beginPath(),f.moveTo(A.ax,A.ay),f.lineTo(O.ax,O.ay),f.stroke()}else{A=I.getPoint(0),O=I.getPoint(1);var P=I.getPoint(2),D=I.getPoint(3),L=k.getColour((1*A.lz+1*O.lz+1*P.lz+1*D.lz)/4);f.fillStyle="rgb("+L.red+","+L.green+","+L.blue+")",f.beginPath(),f.moveTo(A.ax,A.ay),f.lineTo(O.ax,O.ay),f.lineTo(P.ax,P.ay),f.lineTo(D.ax,D.ay),f.lineTo(A.ax,A.ay),c?f.fill():f.stroke()}}f.stroke(),q()&&function(e){var t=new greg.ross.visualisation.Point3D(0,.5,0),a=new greg.ross.visualisation.Point3D(-.5,0,0),i=new greg.ross.visualisation.Point3D(-.5,.5,.5),s=x.ChangeObjectPoint(t),r=x.ChangeObjectPoint(a),n=x.ChangeObjectPoint(i),o=e[0],l=e[1],c=e[2];f.fillStyle="#fff",o.distanceFromCamera>l.distanceFromCamera&&f.fillText(p,s.ax,s.ay),o.distanceFromCamera<l.distanceFromCamera&&f.fillText(d,r.ax,r.ay),o.distanceFromCamera<c.distanceFromCamera&&f.fillText(h,n.ax,n.ay)}(m)}function q(){return C?I:(C=!0,I=!!document.createElement("canvas").getContext)}function H(e){!function(e){if(parseInt(navigator.appVersion)>3){var t="Netscape"==navigator.appName?e:event;if("Netscape"==navigator.appName&&4==parseInt(navigator.appVersion)?"1"==(e.modifiers+32).toString(2).substring(3,6).charAt(0):t.shiftKey)return!0}return!1}(e)?(A=!0,R=G(e)):(O=!0,F=G(e))}function _(e){A?j=L:O&&(E=L),A=!1,O=!1}function W(e){var t=G(e);if(A)z(),function(e){L=new greg.ross.visualisation.Point(greg.ross.visualisation.JSSurfacePlot.DEFAULT_Z_ANGLE,greg.ross.visualisation.JSSurfacePlot.DEFAULT_X_ANGLE),null==j&&(j=new greg.ross.visualisation.Point(greg.ross.visualisation.JSSurfacePlot.DEFAULT_Z_ANGLE,greg.ross.visualisation.JSSurfacePlot.DEFAULT_X_ANGLE)),null!=R&&(L=new greg.ross.visualisation.Point(j.x+(R.x-e.x),j.y+(R.y-e.y))),b=L.x%360,S=L.y%360,g&&(S<0?S=0:S>90&&(S=90)),N=null,B(data)}(t);else if(O)z(),function(e){L=new greg.ross.visualisation.Point(0,greg.ross.visualisation.JSSurfacePlot.DEFAULT_SCALE/greg.ross.visualisation.JSSurfacePlot.SCALE_FACTOR),null==E&&(E=new greg.ross.visualisation.Point(0,greg.ross.visualisation.JSSurfacePlot.DEFAULT_SCALE/greg.ross.visualisation.JSSurfacePlot.SCALE_FACTOR)),null!=F&&(L=new greg.ross.visualisation.Point(E.x+(F.x-e.x),E.y+(F.y-e.y))),(y=L.y*greg.ross.visualisation.JSSurfacePlot.SCALE_FACTOR)<greg.ross.visualisation.JSSurfacePlot.MIN_SCALE?y=greg.ross.visualisation.JSSurfacePlot.MIN_SCALE+1:y>greg.ross.visualisation.JSSurfacePlot.MAX_SCALE&&(y=greg.ross.visualisation.JSSurfacePlot.MAX_SCALE-1),L.y=y/greg.ross.visualisation.JSSurfacePlot.SCALE_FACTOR,N=null,B(data)}(t);else{N=null;for(var a=Number.MAX_VALUE,i=0;i<M.length;i++){var r=M[i],n=s({x:r.ax,y:r.ay},t);n<a&&(a=n,N=i)}if(a>16)return void z();new greg.ross.visualisation.Point(t.x,t.y),$.show(l[N],200)}return!1}function G(e){if(function(){var e=-1;if("Microsoft Internet Explorer"==navigator.appName){var t=navigator.userAgent;null!=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(t)&&(e=parseFloat(RegExp.$1))}return e}()>-1)if(1==(e=window.event).srcElement.getAttribute("Stroked")){if(null==P||null==D)return}else P=e.offsetX,D=e.offsetY;else e.layerX||0==e.layerX?(P=e.layerX,D=e.layerY):e.offsetX||0==e.offsetX?(P=e.offsetX,D=e.offsetY):(e.touches[0].pageX||0==e.touches[0].pageX)&&(P=e.touches[0].pageX,D=e.touches[0].pageY);return new greg.ross.visualisation.Point(P,D)}this.redraw=function(e){v=1*e.getNumberOfRows(),w=1*e.getNumberOfColumns();for(var t=Number.MAX_VALUE,a=Number.MIN_VALUE,i=0;i<v;i++)for(var s=0;s<w;s++){var r=1*e.getFormattedValue(i,s);r<t&&(t=r),r>a&&(a=r)}k=new greg.ross.visualisation.ColourGradient(t,a,n||[{red:0,green:0,blue:255},{red:0,green:255,blue:255},{red:0,green:255,blue:0},{red:255,green:255,blue:0},{red:255,green:0,blue:0}]);var o,l,c=1/(v-1),p=1/(w-1);M=new Array;var d=0;for(i=0,o=-.5;i<v;i++,o+=c)for(s=0,l=.5;s<w;s++,l-=p)M[d]=new greg.ross.visualisation.Point3D(o,l,e.getFormattedValue(i,s)),d++;B(e)},x=new greg.ross.visualisation.Th3dtran,function(){this.targetDiv=document.createElement("div"),this.targetDiv.id=m,this.targetDiv.className="surfaceplot",this.targetDiv.style.background="#ffffff",this.targetDiv.style.position="absolute",o?(this.targetDiv.style.position="relative",o.appendChild(this.targetDiv)):document.body.appendChild(this.targetDiv),this.targetDiv.style.left=e+"px",this.targetDiv.style.top=t+"px"}(),targetDiv&&(u=document.createElement("canvas"),q()||(G_vmlCanvasManager.initElement(u),u.style.width=a,u.style.height=r),u.className="surfacePlotCanvas",u.setAttribute("width",a),u.setAttribute("height",r),u.style.left="0px",u.style.top="0px",targetDiv.appendChild(u),(f=u.getContext("2d")).font="bold 18px sans-serif",f.clearRect(0,0,u.width,u.height),f.fillStyle="#000",f.fillRect(0,0,u.width,u.height),f.beginPath(),f.rect(0,0,u.width,u.height),f.strokeStyle="#888",f.stroke(),u.onmousemove=W,u.onmouseout=z,u.onmousedown=H,u.onmouseup=_,u.addEventListener("touchstart",H,!1),u.addEventListener("touchmove",W,!1),u.addEventListener("touchend",_,!1),u.addEventListener("touchcancel",z,!1))},greg.ross.visualisation.Matrix3d=function(){this.matrix=new Array,this.numRows=4,this.numCols=4,this.init=function(){this.matrix=new Array;for(var e=0;e<this.numRows;e++)this.matrix[e]=new Array},this.getMatrix=function(){return this.matrix},this.matrixReset=function(){for(var e=0;e<this.numRows;e++)for(var t=0;t<this.numCols;t++)this.matrix[e][t]=0},this.matrixIdentity=function(){this.matrixReset(),this.matrix[0][0]=this.matrix[1][1]=this.matrix[2][2]=this.matrix[3][3]=1},this.matrixCopy=function(e){var t,a,i=new greg.ross.visualisation.Matrix3d;for(t=0;t<this.numRows;t++)for(a=0;a<this.numCols;a++)i.getMatrix()[t][a]=this.matrix[t][0]*e.getMatrix()[0][a]+this.matrix[t][1]*e.getMatrix()[1][a]+this.matrix[t][2]*e.getMatrix()[2][a]+this.matrix[t][3]*e.getMatrix()[3][a];for(t=0;t<this.numRows;t++)this.matrix[t][0]=i.getMatrix()[t][0],this.matrix[t][1]=i.getMatrix()[t][1],this.matrix[t][2]=i.getMatrix()[t][2],this.matrix[t][3]=i.getMatrix()[t][3]},this.matrixMult=function(e,t){var a,i,s=new greg.ross.visualisation.Matrix3d;for(a=0;a<this.numRows;a++)for(i=0;i<this.numCols;i++)s.getMatrix()[a][i]=t.getMatrix()[a][0]*e.getMatrix()[0][i]+t.getMatrix()[a][1]*e.getMatrix()[1][i]+t.getMatrix()[a][2]*e.getMatrix()[2][i]+t.getMatrix()[a][3]*e.getMatrix()[3][i];for(a=0;a<this.numRows;a++)e.getMatrix()[a][0]=s.getMatrix()[a][0],e.getMatrix()[a][1]=s.getMatrix()[a][1],e.getMatrix()[a][2]=s.getMatrix()[a][2],e.getMatrix()[a][3]=s.getMatrix()[a][3]},this.init()},greg.ross.visualisation.Point3D=function(e,t,a){this.displayValue="",this.initPoint=function(){this.lx=this.ly=this.lz=this.ax=this.ay=this.az=this.at=this.wx=this.wy=this.wz=0,this.lt=this.wt=1},this.init=function(e,t,a){this.initPoint(),this.lx=e,this.ly=t,this.lz=a,this.ax=this.lx,this.ay=this.ly,this.az=this.lz},this.init(e,t,a)},greg.ross.visualisation.Polygon=function(e,t){this.points=new Array,this.cameraPosition=e,this.isAxis=t,this.centroid=null,this.distanceFromCamera=null,this.isAnAxis=function(){return this.isAxis},this.addPoint=function(e){this.points[this.points.length]=e},this.distance=function(){return this.distance2(this.cameraPosition,this.centroid)},this.calculateDistance=function(){this.distanceFromCamera=this.distance()},this.calculateCentroid=function(){for(var e=0,t=0,a=0,i=1*this.points.length,s=0;s<i;s++)e+=this.points[s].ax,t+=this.points[s].ay,a+=this.points[s].az;e/=i,t/=i,a/=i,this.centroid=new greg.ross.visualisation.Point3D(e,t,a)},this.distance2=function(e,t){return(e.ax-t.ax)*(e.ax-t.ax)+(e.ay-t.ay)*(e.ay-t.ay)+(e.az-t.az)*(e.az-t.az)},this.getPoint=function(e){return this.points[e]}},greg.ross.visualisation.PolygonComaparator=function(e,t){var a=e.distanceFromCamera-t.distanceFromCamera;return 0==a?0:a<0?-1:a>0?1:0},greg.ross.visualisation.Th3dtran=function(){this.local=!0,this.init=function(){this.matrix=new greg.ross.visualisation.Matrix3d,this.rMat=new greg.ross.visualisation.Matrix3d,this.rMatrix=new greg.ross.visualisation.Matrix3d,this.objectMatrix=new greg.ross.visualisation.Matrix3d,this.initMatrix()},this.initMatrix=function(){this.matrix.matrixIdentity(),this.objectMatrix.matrixIdentity()},this.translate=function(e,t,a){this.rMat.matrixIdentity(),this.rMat.getMatrix()[3][0]=e,this.rMat.getMatrix()[3][1]=t,this.rMat.getMatrix()[3][2]=a,this.local?this.objectMatrix.matrixCopy(this.rMat):this.matrix.matrixCopy(this.rMat)},this.rotate=function(e,t,a){var i=e*(Math.PI/180),s=t*(Math.PI/180),r=a*(Math.PI/180);this.rMatrix.matrixIdentity(),this.rMat.matrixIdentity(),this.rMat.getMatrix()[1][1]=Math.cos(i),this.rMat.getMatrix()[1][2]=Math.sin(i),this.rMat.getMatrix()[2][1]=-Math.sin(i),this.rMat.getMatrix()[2][2]=Math.cos(i),this.rMatrix.matrixMult(this.rMatrix,this.rMat),this.rMat.matrixIdentity(),this.rMat.getMatrix()[0][0]=Math.cos(s),this.rMat.getMatrix()[0][2]=-Math.sin(s),this.rMat.getMatrix()[2][0]=Math.sin(s),this.rMat.getMatrix()[2][2]=Math.cos(s),this.rMat.matrixMult(this.rMatrix,this.rMat),this.rMat.matrixIdentity(),this.rMat.getMatrix()[0][0]=Math.cos(r),this.rMat.getMatrix()[0][1]=Math.sin(r),this.rMat.getMatrix()[1][0]=-Math.sin(r),this.rMat.getMatrix()[1][1]=Math.cos(r),this.rMat.matrixMult(this.rMatrix,this.rMat),this.local?this.objectMatrix.matrixCopy(this.rMatrix):this.matrix.matrixCopy(this.rMatrix)},this.scale=function(e){this.rMat.matrixIdentity(),this.rMat.getMatrix()[0][0]=e,this.rMat.getMatrix()[1][1]=e,this.rMat.getMatrix()[2][2]=e,this.local?this.objectMatrix.matrixCopy(this.rMat):this.matrix.matrixCopy(this.rMat)},this.changeLocalObject=function(e){return e.wx=e.ax*this.matrix.getMatrix()[0][0]+e.ay*this.matrix.getMatrix()[1][0]+e.az*this.matrix.getMatrix()[2][0]+this.matrix.getMatrix()[3][0],e.wy=e.ax*this.matrix.getMatrix()[0][1]+e.ay*this.matrix.getMatrix()[1][1]+e.az*this.matrix.getMatrix()[2][1]+this.matrix.getMatrix()[3][1],e.wz=e.ax*this.matrix.getMatrix()[0][2]+e.ay*this.matrix.getMatrix()[1][2]+e.az*this.matrix.getMatrix()[2][2]+this.matrix.getMatrix()[3][2],e},this.ChangeObjectPoint=function(e){return e.ax=e.lx*this.objectMatrix.getMatrix()[0][0]+e.ly*this.objectMatrix.getMatrix()[1][0]+e.lz*this.objectMatrix.getMatrix()[2][0]+this.objectMatrix.getMatrix()[3][0],e.ay=e.lx*this.objectMatrix.getMatrix()[0][1]+e.ly*this.objectMatrix.getMatrix()[1][1]+e.lz*this.objectMatrix.getMatrix()[2][1]+this.objectMatrix.getMatrix()[3][1],e.az=e.lx*this.objectMatrix.getMatrix()[0][2]+e.ly*this.objectMatrix.getMatrix()[1][2]+e.lz*this.objectMatrix.getMatrix()[2][2]+this.objectMatrix.getMatrix()[3][2],e},this.init()},greg.ross.visualisation.Point=function(e,t){this.x=e,this.y=t},greg.ross.visualisation.Tooltip=function(e){var t,a,i,s,r,n=10,o=95,l=0,c=!!document.all;function p(e){if(l!=o&&1==e||0!=l&&-1==e){var a=n;o-l<n&&1==e?a=o-l:l<n&&-1==e&&(a=l),t.style.opacity=.01*(l+=a*e),t.style.filter="alpha(opacity="+l+")"}else clearInterval(t.timer),-1==e&&(t.style.display="none")}this.show=function(n,o){null==t&&((t=document.createElement("div")).style.color="#fff",t.style.position="absolute",t.style.display="block",(a=document.createElement("div")).style.display="block",a.style.height="5px",a.style.marginleft="5px",a.style.overflow="hidden",i=document.createElement("div"),s=document.createElement("div"),t.appendChild(a),t.appendChild(i),t.appendChild(s),document.body.appendChild(t),c?t.style.opacity=1:(t.style.opacity=0,t.style.filter="alpha(opacity=0)")),e||(document.onmousemove=this.pos),t.style.display="block",i.innerHTML='<span style="font-weight:bold; font-family: arial;">'+n+"</span>",t.style.width=o?o+"px":"auto",!o&&c&&(a.style.display="none",s.style.display="none",t.style.width=t.offsetWidth,a.style.display="block",s.style.display="block"),t.offsetWidth>300&&(t.style.width="300px"),r=parseInt(t.offsetHeight)+3,c||(clearInterval(t.timer),t.timer=setInterval(function(){p(1)},20))},this.setPos=function(e){t.style.top=e.y+"px",t.style.left=e.x+"px"},this.pos=function(e){var a=c?event.clientY+document.documentElement.scrollTop:e.pageY,i=c?event.clientX+document.documentElement.scrollLeft:e.pageX;t.style.top=a-r+"px",t.style.left=i+3+"px"},this.hide=function(){null!=t&&(c?t.style.display="none":(clearInterval(t.timer),t.timer=setInterval(function(){p(-1)},20)))}},greg.ross.visualisation.JSSurfacePlot.DEFAULT_X_ANGLE=47,greg.ross.visualisation.JSSurfacePlot.DEFAULT_Z_ANGLE=47,greg.ross.visualisation.JSSurfacePlot.DATA_DOT_SIZE=3,greg.ross.visualisation.JSSurfacePlot.DEFAULT_SCALE=350,greg.ross.visualisation.JSSurfacePlot.MIN_SCALE=50,greg.ross.visualisation.JSSurfacePlot.MAX_SCALE=1100,greg.ross.visualisation.JSSurfacePlot.SCALE_FACTOR=1.4},{}]},{},[1]),function e(t,a,i){function s(n,o){if(!a[n]){if(!t[n]){var l="function"==typeof require&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=a[n]={exports:{}};t[n][0].call(p.exports,function(e){return s(t[n][1][e]||e)},p,p.exports,e,t,a,i)}return a[n].exports}for(var r="function"==typeof require&&require,n=0;n<i.length;n++)s(i[n]);return s}({1:[function(e,t,a){!function(){"use strict";var t=e("./imexam");a.bin1d=t.typed(function(e,a){var i=t.typed.clone(e.shape).map(function(e){return e/a+.5|0}),s=t.typed.array(e.type,i);return s[0/a|0]+=e,s});var i=t.typed(function(e,t,a){return t[0/a|0][0/a|0]+=e,t});a.bin2d=function(e,a){var s=t.typed.clone(e.shape).map(function(e){return e/a+.5|0}),r=t.typed.array(s,e);return i(e,r,a)},a.smooth_gaussian2d=function(e,a){var i,s,r,n=t.typed.array(e.shape,"float32"),o=t.typed.array(e.shape,"float32"),l=a,c=[];for(i=0;i<10;i++)c[i]=1*Math.pow(2.71828,-i*i/(2*l*l))+0;for(i=0;i<c.length&&!(c[i]<.001);i++);c.length=i-1;var p=t.typed.clone(c);for(c=c.reverse(),i=1;i<p.length;i++)c[c.length]=p[i];c.shape[0]=c.length,c=t.typed.div(c,t.typed.sum(c));var d=e.shape[1],h=e.shape[0],g=c.shape[0];for(s=0;s<h;s++)for(i=0;i<d;i++)for(r=-g/2|0;r<g/2|0;r++)i+r>=0&&i+r<h&&(n.data[s*d+i]+=c[r+g/2|0]*e.data[s*d+i+r]);for(s=0;s<h;s++)for(i=0;i<d;i++)for(r=-g/2|0;r<g/2|0;r++)s+r>=0&&s+r<h&&(o.data[s*d+i]+=c[r+g/2|0]*n.data[(s+r)*d+i]);return o}}()},{"./imexam":void 0}],2:[function(e,t,a){var i=function(){var e=function(e,t){var a=e.x-t.x,i=e.y-t.y;return a*a+i*i<1e-20},t=function(e){for(var t=e.head;t;){var a=t.next;t.next=t.prev,t.prev=a,t=a}a=e.head,e.head=e.tail,e.tail=a},a=function(e){this.count=0,this.level=e,this.s=null,this.count=0};a.prototype.remove_seq=function(e){e.prev?e.prev.next=e.next:this.s=e.next,e.next&&(e.next.prev=e.prev),--this.count},a.prototype.addSegment=function(a,i){var s=this.s,r=null,n=null,o=!1,l=!1;if(this.count++>1e5)throw new Error("Too many calls to coutour AddSegment");for(;s&&(null==r&&(e(a,s.head.p)?(r=s,o=!0):e(a,s.tail.p)&&(r=s)),null==n&&(e(i,s.head.p)?(n=s,l=!0):e(i,s.tail.p)&&(n=s)),null==n||null==r);)s=s.next;switch((null!=r?1:0)|(null!=n?2:0)){case 0:var c={p:a,prev:null},p={p:i,next:null};c.next=p,p.prev=c,r={head:c,tail:p,next:this.s,prev:null,closed:!1},this.s&&(this.s.prev=r),this.s=r,++this.count;break;case 1:var d={p:i};o?(d.next=r.head,d.prev=null,r.head.prev=d,r.head=d):(d.next=null,d.prev=r.tail,r.tail.next=d,r.tail=d);break;case 2:d={p:a},l?(d.next=n.head,d.prev=null,n.head.prev=d,n.head=d):(d.next=null,d.prev=n.tail,n.tail.next=d,n.tail=d);break;case 3:if(r===n){r.head.prev=d={p:r.tail.p,next:r.head,prev:null},r.head=d,r.closed=!0;break}switch((o?1:0)|(l?2:0)){case 0:t(r);case 1:n.tail.next=r.head,r.head.prev=n.tail,n.tail=r.tail,this.remove_seq(r);break;case 3:t(r);case 2:r.tail.next=n.head,n.head.prev=r.tail,r.tail=n.tail,this.remove_seq(n)}}};var i=function(e){if(e)this.drawContour=e;else{var t=this;t.contours={},this.drawContour=function(e,i,s,r,n,o){var l=t.contours[o];l||(l=t.contours[o]=new a(n)),l.addSegment({x:i,y:e},{x:r,y:s})},this.contourList=function(){var e=[],a=t.contours;for(var i in a)for(var s=a[i].s,r=a[i].level;s;){var n=s.head,o=[];for(o.level=r,o.k=i;n&&n.p;)o.push(n.p),n=n.next;e.push(o),s=s.next}return e.sort(function(e,t){return t.k-e.k}),e}}this.h=new Array(5),this.sh=new Array(5),this.xh=new Array(5),this.yh=new Array(5)};return i.prototype.contour=function(e,t,a,i,s,r,n,o,l){var c=this.h,p=this.sh,d=this.xh,h=this.yh,g=this.drawContour;this.contours={};for(var u,m,f,y,b,S=function(e,t){return(c[t]*d[e]-c[e]*d[t])/(c[t]-c[e])},v=function(e,t){return(c[t]*h[e]-c[e]*h[t])/(c[t]-c[e])},w=0,x=0,J=0,k=0,C=[0,1,1,0],I=[0,0,1,1],M=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]],T=s-1;T>=i;T--)for(var A=t;A<=a-1;A++){var O,P;if(O=Math.min(e.get(A,T),e.get(A,T+1)),P=Math.min(e.get(A+1,T),e.get(A+1,T+1)),y=Math.min(O,P),O=Math.max(e.get(A,T),e.get(A,T+1)),P=Math.max(e.get(A+1,T),e.get(A+1,T+1)),(b=Math.max(O,P))>=l[0]&&y<=l[o-1])for(var D=0;D<o;D++)if(l[D]>=y&&l[D]<=b){for(var L=4;L>=0;L--)L>0?(c[L]=e.get(A+C[L-1],T+I[L-1])-l[D],d[L]=r[A+C[L-1]],h[L]=n[T+I[L-1]]):(c[0]=.25*(c[1]+c[2]+c[3]+c[4]),d[0]=.5*(r[A]+r[A+1]),h[0]=.5*(n[T]+n[T+1])),p[L]=c[L]>0?1:c[L]<0?-1:0;for(L=1;L<=4;L++)if(0!=(f=M[p[u=L]+1][p[0]+1][p[m=4!=L?L+1:1]+1])){switch(f){case 1:w=d[u],J=h[u],x=d[0],k=h[0];break;case 2:w=d[0],J=h[0],x=d[m],k=h[m];break;case 3:w=d[m],J=h[m],x=d[u],k=h[u];break;case 4:w=d[u],J=h[u],x=S(0,m),k=v(0,m);break;case 5:w=d[0],J=h[0],x=S(m,u),k=v(m,u);break;case 6:w=d[m],J=h[m],x=S(u,0),k=v(u,0);break;case 7:w=S(u,0),J=v(u,0),x=S(0,m),k=v(0,m);break;case 8:w=S(0,m),J=v(0,m),x=S(m,u),k=v(m,u);break;case 9:w=S(m,u),J=v(m,u),x=S(u,0),k=v(u,0)}g(w,J,x,k,l[D],D)}}}},i}();void 0!==a&&(a.Conrec=i)},{}],3:[function(e,t,a){"use strict";!function(){var e=0,a=1,i=2,s=3,r=4;function n(t,n,o,l,c,p,d,h,g){for(var u,m,f,y,b,S,v,w=l,x=c,J=p,k=1,C=w<0||w>=t-1||x<0&&x>=n-1;!C;){if(u=0,m=d[x*t+w],f=d[x*t+w+1],y=d[(x+1)*t+w+1],b=d[(x+1)*t+w],k)switch(k=0,p){case e:S=(o-m)/(f-m)+w,v=x;break;case a:S=w+1,v=(o-f)/(y-f)+x;break;case i:S=(o-y)/(b-y)+w,v=x+1;break;case s:S=w,v=(o-m)/(b-m)+x}else{p==e&&(h[x*t+w]=1);do{switch(++p==r&&(p=e),p){case e:m>=o&&o>f&&(u=1,S=(o-m)/(f-m)+w,v=x,x--);break;case a:f>=o&&o>y&&(u=1,S=w+1,v=(o-f)/(y-f)+x,w++);break;case i:y>=o&&o>b&&(u=1,S=(o-b)/(y-b)+w,v=x+1,x++);break;case s:b>=o&&o>m&&(u=1,S=w,v=(o-m)/(b-m)+x,w--)}}while(!u);++p===r&&(p=e),++p===r&&(p=e),w==l&&x==c&&p==J&&(C=1),(w<0||w>=t-1||x<0||x>=n-1)&&(C=1)}g(S+.5,v+.5,o),C&&g(0,0,void 0)}}t.exports=function(t,r,o,l,c){var p,d,h,g,u=new Uint8Array(r*o);for(p=0;p<t.length;p++){for(d=t[p],h=0;h<r*o;h++)u[h]=0;for(g=0,h=0;h<r-1;h++)l[g*r+h]<d&&d<=l[g*r+h+1]&&n(r,o,d,h,g,e,l,u,c);for(g=0;g<o-1;g++)l[g*r+h]<d&&d<=l[(g+1)*r+h]&&n(r,o,d,h-1,g,a,l,u,c);for(h--;h>=0;h--)l[g*r+h+1]<d&&d<=l[g*r+h]&&n(r,o,d,h,g-1,i,l,u,c);for(h=0,g--;g>=0;g--)l[(g+1)*r+h]<d&&d<=l[g*r+h]&&n(r,o,d,h,g,s,l,u,c);for(g=1;g<o-1;g++)for(h=0;h<r-1;h++)!u[g*r+h]&&l[g*r+h]<d&&d<=l[g*r+h+1]&&n(r,o,d,h,g,e,l,u,c)}}}()},{}],4:[function(e,t,a){!function(){"use strict";var t=e("./imexam"),a=e("./conrec"),i=e("./contfv"),s=e("./bin");function r(e,a){var i=JS9.GetImage({display:a});if(i){var s=$(e).find(".contour-form")[0],r=t.ndops.ndarray(i.raw.data,[i.raw.width,i.raw.height]);s.min.value=t.ndops.minvalue(r).toFixed(2),s.max.value=t.ndops.maxvalue(r).toFixed(2)}}function n(e,a){var i;if(JS9.GetImage({display:a})){var s=$(e).find(".contour-form")[0],r=Number(s.nlevel.value),n=t.ndops.ndarray(t.ndops.iota(1,r)),o=Number(s.min.value),l=Number(s.max.value);t.ndops.divs(n,n,r+1),t.ndops.muls(n,n,l-o),t.ndops.adds(n,n,o);var c=[];for(i=0;i<n.shape[0];i++)c.push(n.data[i].toFixed(2));s.level.value=c.join("\n")}}JS9.RegisterPlugin("ImExam","Contours",function(){var e=JS9.GetImage({display:this.display}),o=this.div;o.innerHTML='<form class="contour-form js9Form">\t\t\t\t\t\t\t\t    <table style="border-collapse: separate; border-spacing: 10px 5px;"><tr>\t<td><b>num:</b></td>\t\t\t\t<td><input type=text name=nlevel value=5 size="10" style="text-align:right;"></td>\t\t\t\t\t\t       \t<td><input type=button value="Draw contours" class="drw-contour"></td></tr>\t\t           <tr>\t<td><b>min:</b></td>\t\t\t\t\t\t\t\t\t\t\t\t<td><input type=text name=min size="10" style="text-align:right;"></td>\t\t\t\t\t\t\t       \t<td><input type=button value="Reset min/max" class="get-min-max"></td></tr>\t\t           <tr>\t<td><b>max:</b></td>\t\t\t\t\t\t\t\t\t\t\t\t<td><input type=text name=max size="10" style="text-align:right;"></td></tr>\t\t\t\t\t           <tr>\t<td valign=top><b>levels:</b></td>\t\t\t\t\t\t\t\t    \t\t<td rowspan=5><textarea rows=12 cols="10" name=level class="contour-levels" style="text-align:right;">\t\t\t\t    </textarea>\t\t\t\t\t\t\t\t\t\t\t       \t<td valign=top><input type=button value="Make levels" class="make-levels"></td>\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t\t   <tr><td></td><td valign=top>\t\t\t\t\t\t\t\t\t\t\t\t<b>binning:</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\t\t\t\t\t\t\t\t<select id=binning name=binpix>\t\t\t\t\t\t\t\t\t\t<option>none</option>\t\t\t\t\t\t\t\t\t\t\t<option>2</option>\t\t\t\t\t\t\t\t\t\t\t<option>3</option>\t\t\t\t\t\t\t\t\t\t\t<option>4</option>\t\t\t\t\t\t\t\t\t\t\t<option>5</option>\t\t\t\t\t\t\t\t\t\t\t<option>6</option>\t\t\t\t\t\t\t\t\t\t\t<option>7</option>\t\t\t\t\t\t\t\t\t\t\t<option>8</option>\t\t\t\t\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t\t\t\t\t\tpix\t\t\t\t\t\t\t\t\t\t\t\t</td>\t\t\t\t\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t\t   <tr><td></td><td valign=top>\t\t\t\t\t\t\t\t\t\t\t\t<b>smoothing:</b>&nbsp;\t\t\t\t\t\t\t\t\t\t\t\t<select id=smooth name=smopix>\t\t\t\t\t\t\t\t\t\t<option>none</option>\t\t\t\t\t\t\t\t\t\t\t<option value=0.75 selected>3</option>\t\t\t\t\t\t\t\t\t<option value=1.00>5</option>\t\t\t\t\t\t\t\t\t\t<option value=1.25>7</option>\t\t\t\t\t\t\t\t\t\t</select>\t\t\t\t\t\t\t\t\t\t\t\tpix\t\t\t\t\t\t\t\t\t\t\t\t</td>\t\t\t\t\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t\t   <tr><td></td><td valign=top>\t\t\t\t\t\t\t\t\t\t\t\t<b>quality:</b>&nbsp;\t\t\t\t\t\t\t\t\t\t\t<input type=radio name=quality value=faster checked>faster\t\t\t\t\t\t<input type=radio name=quality value=better>better\t\t\t\t\t\t</td>\t\t\t\t\t\t\t\t\t\t\t\t   </tr>\t\t\t\t\t\t\t\t\t\t\t    </table>\t\t\t\t\t\t\t\t\t\t\t\t    <p>\t\t\t\t\t\t\t\t\t\t\t\t\t    </form>';var l=this.display;$(o).find(".drw-contour").on("mouseup",function(){!function(e,r){var n=JS9.GetImage({display:r}),o=$(e).find(".contour-form")[0],l=t.ndops.ndarray(n.raw.data,[n.raw.height,n.raw.width]),c=o.level.value,p=$(o).find("#binning").val(),d=$(o).find("#smooth").val(),h=$(o).find("input[type=radio]:checked").val();"none"===p?p=1:l=s.bin2d(l,parseInt(p));var g,u=JSON.parse("["+c.trim().split(/\s+/).join(",")+"]").map(function(e){return e*p*p});"none"!==d&&(l=s.smooth_gaussian2d(l,parseFloat(d))),JS9.waiting(!0),setTimeout(function(){try{if("better"===h){var e=new a.Conrec;try{var s=t.ndops.iota(0,l.shape[0]-1).map(function(e){return e*p+(p-1)/2+1}),r=t.ndops.iota(0,l.shape[1]-1).map(function(e){return e*p+(p-1)/2+1});e.contour(l,0,l.shape[0]-1,0,l.shape[1]-1,s,r,u.length,u)}catch(c){return void alert("Too many coutour segments: Check your coutour levels.\n\nAre you trying to coutour the background levels of an image?")}g=e.contourList().map(function(e){return{shape:"polygon",pts:e}})}else{var o=[];(g=[]).push({shape:"polygon",pts:o}),i(u,l.shape[0],l.shape[1],l.data,function(e,t,a){void 0===a?g.push({shape:"polygon",pts:o=[]}):o.push({x:e*p+.5,y:t*p+.5})}),g.length=g.length-1}JS9.NewShapeLayer("contour",JS9.Catalogs.opts,{display:n}),JS9.RemoveShapes("contour",{display:n}),JS9.AddShapes("contour",g,{color:"yellow"},{display:n})}finally{JS9.waiting(!1)}},200)}(o,l)}),$(o).find(".get-min-max").on("mouseup",function(){r(o,l)}),$(o).find(".make-levels").on("mouseup",function(){n(o,l)}),void 0!==e&&(r(o,l),n(o,l)),t.fixupDiv(this)},{menu:"view",winTitle:"Contours",menuItem:"Contours",help:"imexam/contours.html",toolbarSeparate:!0,winDims:[370,300]})}()},{"./bin":1,"./conrec":2,"./contfv":3,"./imexam":void 0}]},{},[4]);